<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>codeisa</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts (2 Ú¯Ø²ÛŒÙ†Ù‡ ÙØ§Ø±Ø³ÛŒ) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&family=Sahel:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --surface:#0f1b33;
      --text:#e8eefc;
      --primary:#38bdf8;
      --secondary:#a78bfa;
      --gradA:#22c55e;
      --gradB:#38bdf8;
      --radius:18px;
      --fs:16px;
      --ff: "Vazirmatn", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Tahoma", Arial;
      --line: color-mix(in srgb, var(--text) 12%, transparent 88%);
      --muted: color-mix(in srgb, var(--text) 72%, transparent 28%);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }

    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 70% 0%, color-mix(in srgb, var(--gradA) 14%, transparent 86%), transparent 60%),
        radial-gradient(900px 600px at 10% 20%, color-mix(in srgb, var(--gradB) 14%, transparent 86%), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:var(--ff);
      font-size:var(--fs);
      line-height:1.7;
      overflow-x:hidden;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .soft{
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
    }
    .btn{
      border-radius: 14px;
      transition: .15s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .tabActive{background: color-mix(in srgb, var(--primary) 18%, transparent 82%); border:1px solid color-mix(in srgb, var(--primary) 45%, transparent 55%);}
    .tabIdle{background: color-mix(in srgb, var(--surface) 72%, transparent 28%); border:1px solid var(--line);}
    .grad{background: linear-gradient(135deg, var(--gradA), var(--gradB));}
    .muted{color:var(--muted);}
    .tiny{font-size:.85em;}
    .focusable:focus{outline:2px solid color-mix(in srgb, var(--primary) 80%, white 20%); outline-offset:2px}

    /* Full-height on desktop nicer */
    @media (min-width: 1024px){
      .appShell{ min-height: calc(100vh - 28px); }
    }

    /* Tiny animated Telegram icon */
    .tgFab{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--primary) 45%, transparent 55%);
      background: color-mix(in srgb, var(--primary) 10%, transparent 90%);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      transform-origin: 50% 50%;
      animation: wiggle 2.8s ease-in-out infinite;
    }
    .tgFab:hover{ filter: brightness(1.08); transform: translateY(-1px); }
    @keyframes wiggle{
      0%, 100% { transform: translateY(0) rotate(0deg); }
      35% { transform: translateY(-2px) rotate(-2deg); }
      70% { transform: translateY(0) rotate(2deg); }
    }

    /* Mini sparklines */
    canvas.spark{ width: 110px; height: 36px; }

    /* Analog clock */
    .clockWrap{
      width:min(360px, 84vw);
      aspect-ratio: 1/1;
      margin-inline:auto;
      position:relative;
      border-radius:999px;
      border:1px solid var(--line);
      background:
        radial-gradient(circle at 50% 38%, rgba(255,255,255,.10), rgba(255,255,255,.03) 55%, rgba(0,0,0,.18) 100%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 28px 80px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .clockRing{
      position:absolute; inset:10px;
      border-radius:999px;
      border:1px dashed rgba(255,255,255,.12);
      opacity:.55;
    }
    .tick{
      position:absolute; left:50%; top:50%;
      width:2px; height:10px;
      background: rgba(255,255,255,.22);
      transform-origin: 50% calc(100% + 130px);
      border-radius:2px;
    }
    .tick.big{ height:16px; width:3px; background: rgba(255,255,255,.30); }
    .num{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      font-weight:800;
      color: rgba(231,240,255,.85);
      text-shadow: 0 10px 30px rgba(0,0,0,.5);
      user-select:none;
    }
    .hand{
      position:absolute; left:50%; top:50%;
      transform-origin: 50% 100%;
      border-radius: 999px;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.45));
    }
    .hand.hour{ width:8px; height:82px; background: rgba(231,240,255,.88); }
    .hand.min{ width:6px; height:112px; background: rgba(231,240,255,.70); }
    .hand.sec{ width:3px; height:132px; background: color-mix(in srgb, var(--primary) 70%, white 30%); }
    .pin{
      position:absolute; left:50%; top:50%;
      width:18px; height:18px;
      transform: translate(-50%,-50%);
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.35));
      box-shadow: 0 0 0 6px rgba(0,0,0,.18);
    }
    .clockBrand{
      position:absolute;
      left:50%; top:72%;
      transform: translate(-50%,-50%);
      font-weight:900;
      letter-spacing:.4px;
      opacity:.82;
      user-select:none;
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-5 md:py-7 appShell">
    <!-- Header -->
    <header class="card p-4 md:p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="grad w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow">â—¼ï¸</div>
        <div>
          <h1 class="text-lg md:text-xl font-extrabold">codeisa</h1>
          <p class="muted tiny">Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ â€¢ Ø³Ø¨Ú© Ùˆ Ø³Ø±ÛŒØ¹ â€¢ Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ø¯Ø³Ú©ØªØ§Ù¾</p>
        </div>
      </div>

      <nav id="topNav" class="flex flex-wrap gap-2">
        <button type="button" data-nav="converter" class="navBtn btn px-3.5 py-2 tabActive focusable">ØªØ¨Ø¯ÛŒÙ„ ÙˆØ§Ø­Ø¯Ù‡Ø§</button>
        <button type="button" data-nav="health" class="navBtn btn px-3.5 py-2 tabIdle focusable">Ø³Ù„Ø§Ù…ØªÛŒ</button>
        <button type="button" data-nav="datetime" class="navBtn btn px-3.5 py-2 tabIdle focusable">ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</button>
        <button type="button" data-nav="crypto" class="navBtn btn px-3.5 py-2 tabIdle focusable">Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§</button>
        <button type="button" data-nav="iran" class="navBtn btn px-3.5 py-2 tabIdle focusable">Ø¨Ø§Ø²Ø§Ø± Ø§ÛŒØ±Ø§Ù†</button>
        <button type="button" data-nav="weather" class="navBtn btn px-3.5 py-2 tabIdle focusable">Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</button>
        <button type="button" data-nav="calculator" class="navBtn btn px-3.5 py-2 tabIdle focusable">Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨</button>
        <button type="button" data-nav="settings" class="navBtn btn px-3.5 py-2 tabIdle focusable">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
        <button type="button" data-nav="help" class="navBtn btn px-3.5 py-2 tabIdle focusable">Ø±Ø§Ù‡Ù†Ù…Ø§</button>
      </nav>
    </header>

    <main class="mt-5 md:mt-7 space-y-4 md:space-y-5">
      <!-- ================= Converter (kept simple) ================= -->
      <section id="page-converter" class="space-y-4 md:space-y-5">
        <div class="card p-4 md:p-5">
          <h2 class="text-base md:text-lg font-bold">ØªØ¨Ø¯ÛŒÙ„ ÙˆØ§Ø­Ø¯</h2>
          <p class="muted tiny mt-1">Ø¨Ø±Ø§ÛŒ Ø³Ø¨Ú© Ù…Ø§Ù†Ø¯Ù†ØŒ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…Ø«Ù„ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¨Ø¹Ø¯Ø§Ù‹ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ± Ù‡Ù… Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ).</p>

          <div class="mt-4 grid md:grid-cols-5 gap-3">
            <div class="md:col-span-2">
              <label class="muted tiny">Ù…Ù‚Ø¯Ø§Ø±</label>
              <input id="ucVal" class="w-full mt-1 px-3 py-2.5 rounded-xl focusable soft" placeholder="Ù…Ø«Ù„Ø§Ù‹ 12.5" inputmode="decimal"/>
            </div>
            <div>
              <label class="muted tiny">Ø§Ø²</label>
              <select id="ucFrom" class="w-full mt-1 px-3 py-2.5 rounded-xl focusable soft"></select>
            </div>
            <div>
              <label class="muted tiny">Ø¨Ù‡</label>
              <select id="ucTo" class="w-full mt-1 px-3 py-2.5 rounded-xl focusable soft"></select>
            </div>
            <div class="flex items-end">
              <button id="ucSwap" class="btn w-full px-3 py-2.5 soft focusable">Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ â‡„</button>
            </div>
          </div>

          <div class="mt-3 soft p-3 flex items-center justify-between gap-2">
            <div>
              <div class="muted tiny">Ù†ØªÛŒØ¬Ù‡</div>
              <div id="ucOut" class="text-xl font-extrabold">â€”</div>
            </div>
            <button id="ucCopy" class="btn px-3 py-2 soft focusable">Ú©Ù¾ÛŒ</button>
          </div>
        </div>
      </section>

      <!-- ================= Health ================= -->
      <section id="page-health" class="hidden space-y-4 md:space-y-5">
        <div class="grid lg:grid-cols-2 gap-4 md:gap-5">
          <div class="card p-4 md:p-5">
            <h2 class="text-base md:text-lg font-bold">BMI (Ø´Ø§Ø®Øµ ØªÙˆØ¯Ù‡ Ø¨Ø¯Ù†ÛŒ)</h2>
            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div>
                <label class="muted tiny">ÙˆØ²Ù† (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…)</label>
                <input id="bmiW" class="w-full mt-1 px-3 py-2.5 rounded-xl focusable soft" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 72.5"/>
              </div>
              <div>
                <label class="muted tiny">Ù‚Ø¯ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
                <input id="bmiH" class="w-full mt-1 px-3 py-2.5 rounded-xl focusable soft" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 175"/>
              </div>
            </div>
            <div class="mt-3 soft p-3">
              <div class="muted tiny">Ù†ØªÛŒØ¬Ù‡</div>
              <div class="text-2xl font-extrabold"><span id="bmiOut">â€”</span></div>
              <div class="muted tiny mt-1">ÙˆØ¶Ø¹ÛŒØª: <span id="bmiCat" class="font-bold">â€”</span></div>
            </div>
          </div>

          <div class="card p-4 md:p-5">
            <h2 class="text-base md:text-lg font-bold">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹ ØªÙØ³ÛŒØ± Ø¢Ø²Ù…Ø§ÛŒØ´</h2>
            <p class="muted tiny mt-1">Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø§Ø³Øª Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù¾Ø²Ø´Ú© Ù†ÛŒØ³ØªØ› Ø§Ù…Ø§ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¹Ø¯Ø¯Ù‡Ø§ Ø±Ø§ Ø¨Ù‡ØªØ± Ø¨ÙÙ‡Ù…ÛŒØ¯.</p>

            <div class="mt-4 grid gap-2">
              <div class="soft p-3">
                <div class="font-bold">CBC (Ø®ÙˆÙ†)</div>
                <ul class="mt-2 list-disc pr-5 muted tiny">
                  <li><b>WBC</b>: Ø¨Ø§Ù„Ø§ â†’ Ø§Ù„ØªÙ‡Ø§Ø¨/Ø¹ÙÙˆÙ†Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ â€¢ Ù¾Ø§ÛŒÛŒÙ† â†’ Ø¨Ø±Ø®ÛŒ Ø¯Ø§Ø±ÙˆÙ‡Ø§/ÙˆÛŒØ±ÙˆØ³â€ŒÙ‡Ø§</li>
                  <li><b>Hb/Hct</b>: Ù¾Ø§ÛŒÛŒÙ† â†’ Ú©Ù…â€ŒØ®ÙˆÙ†ÛŒ â€¢ Ø¨Ø§Ù„Ø§ â†’ Ú©Ù…â€ŒØ¢Ø¨ÛŒ/Ù¾Ù„ÛŒâ€ŒØ³ÛŒØªÙ…ÛŒ</li>
                  <li><b>PLT</b>: Ù¾Ø§ÛŒÛŒÙ† â†’ Ø±ÛŒØ³Ú© Ø®ÙˆÙ†Ø±ÛŒØ²ÛŒ â€¢ Ø¨Ø§Ù„Ø§ â†’ Ø§Ù„ØªÙ‡Ø§Ø¨/Ú©Ù…Ø¨ÙˆØ¯ Ø¢Ù‡Ù†</li>
                </ul>
              </div>

              <div class="soft p-3">
                <div class="font-bold">Ù‚Ù†Ø¯ Ùˆ Ú†Ø±Ø¨ÛŒ</div>
                <ul class="mt-2 list-disc pr-5 muted tiny">
                  <li><b>FBS</b>: Ø¨Ø§Ù„Ø§ â†’ Ø¯ÛŒØ§Ø¨Øª/Ù¾ÛŒØ´â€ŒØ¯ÛŒØ§Ø¨Øª (Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ) </li>
                  <li><b>HbA1c</b>: Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‚Ù†Ø¯ Û³ Ù…Ø§Ù‡Ù‡</li>
                  <li><b>LDL/HDL/TG</b>: Ø±ÛŒØ³Ú© Ù‚Ù„Ø¨ÛŒ Ùˆ Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ</li>
                </ul>
              </div>

              <div class="soft p-3">
                <div class="font-bold">Ú©Ø¨Ø¯ Ùˆ Ú©Ù„ÛŒÙ‡</div>
                <ul class="mt-2 list-disc pr-5 muted tiny">
                  <li><b>ALT/AST</b>: Ø¨Ø§Ù„Ø§ â†’ Ø¢Ø³ÛŒØ¨ Ø³Ù„ÙˆÙ„ Ú©Ø¨Ø¯/Ø¹Ø¶Ù„Ù‡</li>
                  <li><b>Creatinine/eGFR</b>: Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ù„ÛŒÙ‡</li>
                  <li><b>Urea(BUN)</b>: Ø¢Ø¨ Ø¨Ø¯Ù†/Ú©Ù„ÛŒÙ‡/Ù¾Ø±ÙˆØªØ¦ÛŒÙ†</li>
                </ul>
              </div>

              <div class="soft p-3">
                <div class="font-bold">Ø§Ø¯Ø±Ø§Ø± / Ù…Ø¯ÙÙˆØ¹</div>
                <ul class="mt-2 list-disc pr-5 muted tiny">
                  <li><b>Urine</b>: WBC/RBC Ø¨Ø§Ù„Ø§ â†’ Ø¹ÙÙˆÙ†Øª/Ø³Ù†Ú¯ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ</li>
                  <li><b>Stool</b>: Ø®ÙˆÙ† Ù…Ø®ÙÛŒ/Ø§Ù†Ú¯Ù„/Ø§Ù„ØªÙ‡Ø§Ø¨</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ================= DateTime ================= -->
      <section id="page-datetime" class="hidden space-y-4 md:space-y-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <h2 class="text-base md:text-lg font-bold">ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</h2>
              <p class="muted tiny mt-1">Ø³Ø§Ø¹Øª Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù‡Ù… Ø§ÛŒØ±Ø§Ù† Ù‡Ù… Ø¬Ù‡Ø§Ù†ÛŒ.</p>
            </div>
            <div class="soft px-3 py-2 tiny">
              <span class="muted">ÙˆØ¶Ø¹ÛŒØª:</span>
              <span id="timeStatus" class="font-bold">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„â€¦</span>
            </div>
          </div>

          <div class="mt-4 grid lg:grid-cols-3 gap-3">
            <div class="soft p-3">
              <div class="font-bold">ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ)</div>
              <div id="dtJ" class="text-2xl font-extrabold mt-2">â€”</div>
            </div>
            <div class="soft p-3">
              <div class="font-bold">ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² (Ù…ÛŒÙ„Ø§Ø¯ÛŒ)</div>
              <div id="dtG" class="text-2xl font-extrabold mt-2">â€”</div>
            </div>
            <div class="soft p-3">
              <div class="font-bold">Ø³Ø§Ø¹Øª Ø¬Ù‡Ø§Ù†ÛŒ (UTC)</div>
              <div id="dtUTC" class="text-2xl font-extrabold mt-2">â€”</div>
            </div>
          </div>

          <div class="mt-4 grid lg:grid-cols-2 gap-3 items-start">
            <div class="soft p-3">
              <div class="flex items-center justify-between">
                <div class="font-bold">Ø³Ø§Ø¹Øª Ø§ÛŒØ±Ø§Ù† (Ø¯ÛŒØ¬ÛŒØªØ§Ù„)</div>
                <div class="muted tiny">Asia/Tehran</div>
              </div>
              <div id="dtIR" class="text-4xl md:text-5xl font-extrabold mt-3">â€”</div>
              <div class="muted tiny mt-2">Ø¢Ø®Ø±ÛŒÙ† Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: <span id="dtSync">â€”</span></div>
            </div>

            <div class="soft p-3">
              <div class="font-bold text-center">Ø³Ø§Ø¹Øª Ø¢Ù†Ø§Ù„ÙˆÚ¯ (Ø§ÛŒØ±Ø§Ù†)</div>
              <div class="clockWrap mt-3" aria-label="Ø³Ø§Ø¹Øª Ø¢Ù†Ø§Ù„ÙˆÚ¯ Ø§ÛŒØ±Ø§Ù†">
                <div class="clockRing"></div>
                <div id="clockTicks"></div>
                <div id="clockNums"></div>

                <div id="handH" class="hand hour"></div>
                <div id="handM" class="hand min"></div>
                <div id="handS" class="hand sec"></div>
                <div class="pin"></div>
                <div class="clockBrand">codeisa</div>
              </div>
              <div class="mt-3 text-center">
                <span class="inline-flex items-center gap-2 soft px-3 py-2 tiny">
                  <span class="grad w-2.5 h-2.5 rounded-full"></span>
                  <span>Ø«Ø§Ù†ÛŒÙ‡â€ŒØ´Ù…Ø§Ø± ÙØ¹Ø§Ù„ Ø§Ø³ØªØ› Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙÙ‚Ø· Ù‡Ø± Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒÚ©Ø¨Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.</span>
                </span>
              </div>
            </div>
          </div>

          <div class="mt-4 soft p-3">
            <div class="font-bold">Ù…Ù†Ø§Ø³Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
            <div id="eventsBox" class="muted tiny mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØªâ€¦</div>
          </div>
        </div>
      </section>

      <!-- ================= Crypto ================= -->
      <section id="page-crypto" class="hidden space-y-4 md:space-y-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <h2 class="text-base md:text-lg font-bold">Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ (Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ)</h2>
              <p class="muted tiny mt-1">Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ + Ú©Ù…ÛŒÙ†Ù‡/Ø¨ÛŒØ´ÛŒÙ†Ù‡ Û· Ø±ÙˆØ² + Ù†Ù…ÙˆØ¯Ø§Ø± Ú©ÙˆÚ†Ú©. ÙˆØ§Ø­Ø¯ Ù†Ù…Ø§ÛŒØ´: ØªÙˆÙ…Ø§Ù†.</p>
            </div>
            <div class="flex gap-2 flex-wrap">
              <div class="soft px-3 py-2 tiny"><span class="muted">Ø¢Ù¾Ø¯ÛŒØª Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§:</span> <b id="cryptoStatus">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„â€¦</b></div>
              <button id="cryptoRefresh" class="btn px-3 py-2 soft focusable">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
            </div>
          </div>

          <div class="mt-4 soft p-3">
            <div class="flex items-center justify-between gap-2 flex-wrap">
              <div class="tiny muted">Ù†Ø±Ø® Ø¯Ù„Ø§Ø± (Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†)</div>
              <div class="font-bold" id="usdIrrBox">â€”</div>
            </div>
          </div>

          <div id="cryptoGrid" class="mt-4 grid gap-2"></div>
          <div class="mt-3 muted tiny" id="cryptoHint"></div>
        </div>
      </section>

      <!-- ================= Iran market ================= -->
      <section id="page-iran" class="hidden space-y-4 md:space-y-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <h2 class="text-base md:text-lg font-bold">Ø¨Ø§Ø²Ø§Ø± Ø§ÛŒØ±Ø§Ù† (Ø§Ø±Ø² Ùˆ ÙÙ„Ø²Ø§Øª)</h2>
              <p class="muted tiny mt-1">Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø§ Ú†Ù†Ø¯ Ù…Ù†Ø¨Ø¹ Ø¹Ù…ÙˆÙ…ÛŒ ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ú¯ÛŒØ±Ø¯. Ø§Ú¯Ø± ÛŒÚ© Ù…Ù†Ø¨Ø¹ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² Ù…Ù†Ø¨Ø¹ Ø¨Ø¹Ø¯ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
            </div>
            <div class="flex gap-2 flex-wrap">
              <div class="soft px-3 py-2 tiny"><span class="muted">ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²Ø§Ø± Ø§ÛŒØ±Ø§Ù†:</span> <b id="iranStatus">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„â€¦</b></div>
              <button id="iranRefresh" class="btn px-3 py-2 soft focusable">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
            </div>
          </div>

          <div id="iranGrid" class="mt-4 grid gap-2"></div>
          <div class="mt-3 muted tiny" id="iranHint"></div>
        </div>
      </section>

      <!-- ================= Weather ================= -->
      <section id="page-weather" class="hidden space-y-4 md:space-y-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <h2 class="text-base md:text-lg font-bold">Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</h2>
              <p class="muted tiny mt-1">Ø¨Ø¯ÙˆÙ† GPS: Ø´Ù‡Ø±/Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯. (Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Openâ€‘Meteo Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯.)</p>
            </div>
            <div class="flex gap-2 flex-wrap">
              <div class="soft px-3 py-2 tiny"><span class="muted">ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§:</span> <b id="wxStatus">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±â€¦</b></div>
              <button id="wxRefresh" class="btn px-3 py-2 soft focusable">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
            </div>
          </div>

          <div class="mt-4 grid lg:grid-cols-3 gap-3">
            <div class="soft p-3 lg:col-span-2">
              <div class="font-bold">Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø±ÛŒØ¹ Ù…Ø±Ø§Ú©Ø² Ø§Ø³ØªØ§Ù†</div>
              <select id="provinceSel" class="w-full mt-2 px-3 py-2.5 rounded-xl focusable soft"></select>
              <div class="muted tiny mt-2">ÛŒØ§ Ø´Ù‡Ø± Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯ (ØªÙ…Ø§Ù… Ø´Ù‡Ø±Ù‡Ø§):</div>
              <div class="mt-2 flex gap-2">
                <input id="cityQuery" class="flex-1 px-3 py-2.5 rounded-xl focusable soft" placeholder="Ù…Ø«Ù„Ø§Ù‹ Shiraz ÛŒØ§ Ø´ÛŒØ±Ø§Ø²"/>
                <button id="citySearchBtn" class="btn px-3 py-2.5 soft focusable">Ø¬Ø³ØªØ¬Ùˆ</button>
              </div>
              <div id="cityResults" class="mt-2 grid gap-2"></div>
            </div>

            <div class="soft p-3">
              <div class="font-bold">Ø´Ù‡Ø± Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</div>
              <div id="wxCity" class="text-xl font-extrabold mt-2">â€”</div>
              <div class="muted tiny mt-2">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="wxUpdated">â€”</span></div>
            </div>
          </div>

          <div class="mt-4 grid lg:grid-cols-3 gap-3">
            <div class="soft p-3 lg:col-span-2">
              <div class="font-bold">ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</div>
              <div id="wxCurrent" class="muted tiny mt-2">â€”</div>
            </div>
            <div class="soft p-3">
              <div class="font-bold">Ø¬Ø²Ø¦ÛŒØ§Øª</div>
              <div id="wxKpi" class="muted tiny mt-2">â€”</div>
            </div>
          </div>

          <div class="mt-4 soft p-3">
            <div class="font-bold">Û²Û´ Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡</div>
            <div id="wxHourly" class="muted tiny mt-2">â€”</div>
          </div>

          <div class="mt-4 soft p-3">
            <div class="font-bold">Û· Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡</div>
            <div id="wxDaily" class="muted tiny mt-2">â€”</div>
          </div>
        </div>
      </section>

      <!-- ================= Calculator (simple + scientific toggle placeholder) ================= -->
      <section id="page-calculator" class="hidden space-y-4 md:space-y-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <h2 class="text-base md:text-lg font-bold">Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨</h2>
              <p class="muted tiny mt-1">Ø³Ø§Ø¯Ù‡ + Ù…Ù‡Ù†Ø¯Ø³ÛŒ (Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ)</p>
            </div>
            <div class="flex gap-2">
              <button id="calcModeBtn" class="btn px-3 py-2 soft focusable">Ø­Ø§Ù„Øª: Ø³Ø§Ø¯Ù‡</button>
              <button id="calcClear" class="btn px-3 py-2 soft focusable">Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù†</button>
            </div>
          </div>

          <div class="mt-4 soft p-3">
            <div class="muted tiny">Ø¹Ø¨Ø§Ø±Øª</div>
            <div id="calcExpr" class="text-lg font-bold mt-1">â€”</div>
            <div class="muted tiny mt-2">Ù†ØªÛŒØ¬Ù‡</div>
            <div id="calcRes" class="text-3xl md:text-5xl font-extrabold mt-1">0</div>
          </div>

          <div class="mt-4 grid grid-cols-4 gap-2 select-none" id="calcPad">
            <button class="btn soft py-3 focusable" data-k="7">7</button>
            <button class="btn soft py-3 focusable" data-k="8">8</button>
            <button class="btn soft py-3 focusable" data-k="9">9</button>
            <button class="btn soft py-3 focusable" data-k="/">Ã·</button>
            <button class="btn soft py-3 focusable" data-k="4">4</button>
            <button class="btn soft py-3 focusable" data-k="5">5</button>
            <button class="btn soft py-3 focusable" data-k="6">6</button>
            <button class="btn soft py-3 focusable" data-k="*">Ã—</button>
            <button class="btn soft py-3 focusable" data-k="1">1</button>
            <button class="btn soft py-3 focusable" data-k="2">2</button>
            <button class="btn soft py-3 focusable" data-k="3">3</button>
            <button class="btn soft py-3 focusable" data-k="-">âˆ’</button>
            <button class="btn soft py-3 focusable" data-k="0">0</button>
            <button class="btn soft py-3 focusable" data-k=".">.</button>
            <button class="btn soft py-3 focusable" data-k="=">=</button>
            <button class="btn soft py-3 focusable" data-k="+">+</button>
          </div>

          <div id="calcSci" class="hidden mt-3 grid grid-cols-4 gap-2">
            <button class="btn soft py-3 focusable" data-k="(">(</button>
            <button class="btn soft py-3 focusable" data-k=")">)</button>
            <button class="btn soft py-3 focusable" data-k="%">%</button>
            <button class="btn soft py-3 focusable" data-k="DEL">âŒ«</button>

            <button class="btn soft py-3 focusable" data-k="pow2">xÂ²</button>
            <button class="btn soft py-3 focusable" data-k="sqrt">âˆš</button>
            <button class="btn soft py-3 focusable" data-k="sin">sin</button>
            <button class="btn soft py-3 focusable" data-k="cos">cos</button>

            <button class="btn soft py-3 focusable" data-k="tan">tan</button>
            <button class="btn soft py-3 focusable" data-k="ln">ln</button>
            <button class="btn soft py-3 focusable" data-k="log">log10</button>
            <button class="btn soft py-3 focusable" data-k="pi">Ï€</button>
          </div>

          <div class="mt-3 muted tiny">Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¹Ù„Ù…ÛŒØŒ Ø¨Ø¹Ø¯Ø§Ù‹ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… parser Ø±Ø§ Ú¯Ø³ØªØ±Ø¯Ù‡â€ŒØªØ± Ú©Ù†ÛŒÙ…. ÙØ¹Ù„Ø§Ù‹ Ù¾Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø± Ø§Ø³Øª.</div>
        </div>
      </section>

      <!-- ================= Settings ================= -->
      <section id="page-settings" class="hidden space-y-4 md:space-y-5">
        <div class="card p-4 md:p-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-base md:text-lg font-bold">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
              <p class="muted tiny mt-1">Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ùˆ ÙÙˆÙ†Øª (Ø¯Ùˆ ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ). Ù„ÙˆÚ¯Ùˆ Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ù†ÛŒØ³Øª.</p>
            </div>
            <button id="resetCfg" class="btn px-3 py-2 soft focusable">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ</button>
          </div>

          <div class="mt-4 grid md:grid-cols-2 lg:grid-cols-3 gap-3">
            <div class="soft p-3">
              <div class="muted tiny">ÙÙˆÙ†Øª</div>
              <select id="fontSel" class="w-full mt-2 px-3 py-2.5 rounded-xl focusable soft">
                <option value="vazirmatn">Vazirmatn</option>
                <option value="sahel">Sahel</option>
              </select>
            </div>

            <div class="soft p-3">
              <div class="muted tiny">Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡</div>
              <input id="bgColor" type="color" class="w-full mt-2 h-12 rounded-xl focusable"/>
            </div>

            <div class="soft p-3">
              <div class="muted tiny">Ø±Ù†Ú¯ Ú©Ø§Ø±Øª</div>
              <input id="surfaceColor" type="color" class="w-full mt-2 h-12 rounded-xl focusable"/>
            </div>

            <div class="soft p-3">
              <div class="muted tiny">Ø±Ù†Ú¯ Ù…ØªÙ†</div>
              <input id="textColor" type="color" class="w-full mt-2 h-12 rounded-xl focusable"/>
            </div>

            <div class="soft p-3">
              <div class="muted tiny">Ú¯Ø±Ø§Ø¯ÛŒØ§Ù† (Ø´Ø±ÙˆØ¹)</div>
              <input id="gradA" type="color" class="w-full mt-2 h-12 rounded-xl focusable"/>
            </div>

            <div class="soft p-3">
              <div class="muted tiny">Ú¯Ø±Ø§Ø¯ÛŒØ§Ù† (Ù¾Ø§ÛŒØ§Ù†)</div>
              <input id="gradB" type="color" class="w-full mt-2 h-12 rounded-xl focusable"/>
            </div>

            <div class="soft p-3 md:col-span-2 lg:col-span-3">
              <div class="muted tiny">Ù†Ú©ØªÙ‡</div>
              <div class="tiny mt-1 muted">Ø§Ú¯Ø± VPN ÛŒØ§ ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø¨Ø§Ø¹Ø« Ù…Ø´Ú©Ù„ Ø¯Ø± API Ø´Ø¯ØŒ ÛŒÚ©â€ŒØ¨Ø§Ø± Ø®Ø§Ù…ÙˆØ´/Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø± Ø¨Ø®Ø´ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ================= Help ================= -->
      <section id="page-help" class="hidden space-y-4 md:space-y-5">
        <div class="card p-4 md:p-5">
          <h2 class="text-base md:text-lg font-bold">Ø±Ø§Ù‡Ù†Ù…Ø§</h2>
          <div class="mt-3 space-y-3 leading-7">
            <div class="soft p-3">
              <div class="font-bold">Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§</div>
              <ul class="mt-2 list-disc pr-5 muted">
                <li>Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ù‡Ø± Û±Ûµ Ø«Ø§Ù†ÛŒÙ‡ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
                <li>Ú©Ù…ÛŒÙ†Ù‡/Ø¨ÛŒØ´ÛŒÙ†Ù‡ Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Û· Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡ Ø§Ø³Øª.</li>
                <li>Ø§Ú¯Ø± Â«Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„Â» Ù…Ø§Ù†Ø¯ØŒ Ø§ÛŒÙ†ØªØ±Ù†Øª/ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ùˆ ÛŒÚ©â€ŒØ¨Ø§Ø± Â«Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒÂ» Ø¨Ø²Ù†ÛŒØ¯.</li>
              </ul>
            </div>
            <div class="soft p-3">
              <div class="font-bold">Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</div>
              <ul class="mt-2 list-disc pr-5 muted">
                <li>Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ: Ù…Ø±Ú©Ø² Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯.</li>
                <li>Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±ØŒ Ø¯Ú©Ù…Ù‡ Â«Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒÂ» ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</li>
              </ul>
            </div>
            <div class="soft p-3">
              <div class="font-bold">Ø³Ø§Ø¹Øª</div>
              <ul class="mt-2 list-disc pr-5 muted">
                <li>Ø³Ø§Ø¹Øª Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø­Ø±Ú©Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ ÙÙ‚Ø· Ù‡Ø± Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒÚ©â€ŒØ¨Ø§Ø± Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡Ù…Ú¯Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
                <li>Ø§Ú¯Ø± Ø§Ø®ØªÙ„Ø§Ù Ø¯ÛŒØ¯ÛŒØ¯ØŒ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯.</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="mt-6 md:mt-8 pb-6 text-center muted tiny">
      <div class="flex flex-col gap-3 items-center">
        <div class="flex items-center gap-3">
          <span>ğŸ¨ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· FARHAD</span>
          <a class="tgFab" href="https://t.me/ShadowPsychologist" target="_blank" rel="noopener" title="Ø§Ø±ØªØ¨Ø§Ø· Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù…">
            <!-- Telegram icon (SVG) -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21.9 5.1 19.4 20c-.2 1.1-.9 1.4-1.8.9l-5-3.7-2.4 2.3c-.3.3-.5.5-1 .5l.4-5.4 9.8-8.9c.4-.4-.1-.6-.7-.2L6.6 13.1 1.9 11.6c-1-.3-1-1 .2-1.5L20.3 3c.9-.4 1.7.2 1.6 2.1Z" fill="currentColor"/>
            </svg>
            <span class="font-bold">Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø§Ø²Ù†Ø¯Ù‡</span>
          </a>
        </div>
        <div class="muted tiny">Â© codeisa</div>
      </div>
    </footer>
  </div>

<script>
/* ========================= Utilities ========================= */
const $ = (id) => document.getElementById(id);
const clamp = (n,min,max)=>Math.min(max,Math.max(min,n));
const escapeHtml = (s)=>String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
const toFaDigits = (str)=>String(str).replace(/\d/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[d]);
const toEnDigits = (str)=>String(str).replace(/[Û°-Û¹]/g, d => "0123456789"["Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)]);
const formatMoney = (n) => {
  if(!Number.isFinite(n)) return "â€”";
  const s = Math.round(n).toLocaleString("en-US");
  return toFaDigits(s);
};
const fmtPct = (n) => {
  if(!Number.isFinite(n)) return "â€”";
  const s = (Math.round(n*100)/100).toFixed(2);
  return toFaDigits(s);
};
const nowFaTime = () => toFaDigits(new Date().toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"}));

/* ========================= Navigation ========================= */
const pages = ["converter","health","datetime","crypto","iran","weather","calculator","settings","help"];
function showPage(id){
  const target = pages.includes(id) ? id : "converter";
  pages.forEach(p=>{
    const el = $("page-"+p);
    if(el) el.classList.toggle("hidden", p!==target);
  });
  document.querySelectorAll(".navBtn").forEach(btn=>{
    const active = btn.dataset.nav === target;
    btn.classList.toggle("tabActive", active);
    btn.classList.toggle("tabIdle", !active);
  });
  try{ history.replaceState(null,"",`#${target}`); }catch{}
}
$("topNav").addEventListener("click", (e)=>{
  const b = e.target.closest(".navBtn");
  if(!b) return;
  showPage(b.dataset.nav);
});
showPage((location.hash||"").replace("#","") || "converter");

/* ========================= Settings (simple) ========================= */
const CFG_KEY="codeisa.cfg.v8";
const defaultCfg = {
  font:"vazirmatn",
  bg:"#0b1220",
  surface:"#0f1b33",
  text:"#e8eefc",
  gradA:"#22c55e",
  gradB:"#38bdf8"
};
function loadCfg(){
  try{ return {...defaultCfg, ...(JSON.parse(localStorage.getItem(CFG_KEY)||"{}")||{})}; }
  catch{ return {...defaultCfg}; }
}
function saveCfg(cfg){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }
function applyCfg(cfg){
  const r=document.documentElement.style;
  r.setProperty("--bg", cfg.bg);
  r.setProperty("--surface", cfg.surface);
  r.setProperty("--text", cfg.text);
  r.setProperty("--gradA", cfg.gradA);
  r.setProperty("--gradB", cfg.gradB);
  r.setProperty("--ff", cfg.font==="sahel" ? '"Sahel", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Tahoma", Arial' :
                                         '"Vazirmatn", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Tahoma", Arial');
}
let cfg = loadCfg();
applyCfg(cfg);

$("fontSel").value = cfg.font;
$("bgColor").value = cfg.bg;
$("surfaceColor").value = cfg.surface;
$("textColor").value = cfg.text;
$("gradA").value = cfg.gradA;
$("gradB").value = cfg.gradB;

["fontSel","bgColor","surfaceColor","textColor","gradA","gradB"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    cfg = {
      font: $("fontSel").value,
      bg: $("bgColor").value,
      surface: $("surfaceColor").value,
      text: $("textColor").value,
      gradA: $("gradA").value,
      gradB: $("gradB").value
    };
    saveCfg(cfg);
    applyCfg(cfg);
    // redraw sparklines with new theme
    requestAnimationFrame(()=> renderAllSparks());
  });
});
$("resetCfg").addEventListener("click", ()=>{
  localStorage.removeItem(CFG_KEY);
  cfg = loadCfg();
  $("fontSel").value = cfg.font;
  $("bgColor").value = cfg.bg;
  $("surfaceColor").value = cfg.surface;
  $("textColor").value = cfg.text;
  $("gradA").value = cfg.gradA;
  $("gradB").value = cfg.gradB;
  applyCfg(cfg);
});

/* ========================= Unit Converter (demo: length m<->km<->cm) ========================= */
const ucUnits = [
  {k:"cm", label:"Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±", toM:(v)=>v/100, fromM:(m)=>m*100},
  {k:"m", label:"Ù…ØªØ±", toM:(v)=>v, fromM:(m)=>m},
  {k:"km", label:"Ú©ÛŒÙ„ÙˆÙ…ØªØ±", toM:(v)=>v*1000, fromM:(m)=>m/1000},
  {k:"in", label:"Ø§ÛŒÙ†Ú†", toM:(v)=>v*0.0254, fromM:(m)=>m/0.0254},
  {k:"ft", label:"ÙÙˆØª", toM:(v)=>v*0.3048, fromM:(m)=>m/0.3048},
];
function ucInit(){
  ucUnits.forEach(u=>{
    const o1=document.createElement("option"); o1.value=u.k; o1.textContent=u.label;
    const o2=document.createElement("option"); o2.value=u.k; o2.textContent=u.label;
    $("ucFrom").appendChild(o1); $("ucTo").appendChild(o2);
  });
  $("ucFrom").value="m"; $("ucTo").value="km";
}
function ucCompute(){
  const v = Number(toEnDigits($("ucVal").value||"").replace(/,/g,"").trim());
  if(!Number.isFinite(v)){ $("ucOut").textContent="â€”"; return; }
  const f=ucUnits.find(x=>x.k===$("ucFrom").value) || ucUnits[0];
  const t=ucUnits.find(x=>x.k===$("ucTo").value) || ucUnits[1];
  const m=f.toM(v);
  const out=t.fromM(m);
  $("ucOut").textContent = toFaDigits(out.toLocaleString("en-US",{maximumFractionDigits:8})) + " " + t.label;
}
$("ucVal").addEventListener("input", ucCompute);
$("ucFrom").addEventListener("change", ucCompute);
$("ucTo").addEventListener("change", ucCompute);
$("ucSwap").addEventListener("click", ()=>{
  const a=$("ucFrom").value, b=$("ucTo").value;
  $("ucFrom").value=b; $("ucTo").value=a;
  ucCompute();
});
$("ucCopy").addEventListener("click", async ()=>{
  const txt = $("ucOut").textContent;
  try{ await navigator.clipboard.writeText(toEnDigits(txt)); }catch{}
});
ucInit(); ucCompute();

/* ========================= Health (BMI) ========================= */
function bmiCat(b){
  if(!Number.isFinite(b)) return "â€”";
  if(b<18.5) return "Ú©Ù…â€ŒÙˆØ²Ù†";
  if(b<25) return "Ù†Ø±Ù…Ø§Ù„";
  if(b<30) return "Ø§Ø¶Ø§ÙÙ‡â€ŒÙˆØ²Ù†";
  if(b<35) return "Ú†Ø§Ù‚ÛŒ Û±";
  if(b<40) return "Ú†Ø§Ù‚ÛŒ Û²";
  return "Ú†Ø§Ù‚ÛŒ Û³";
}
function bmiCompute(){
  const w=Number(toEnDigits($("bmiW").value||"").trim());
  const h=Number(toEnDigits($("bmiH").value||"").trim());
  if(!(w>0) || !(h>0)){ $("bmiOut").textContent="â€”"; $("bmiCat").textContent="â€”"; return; }
  const m=h/100;
  const b=w/(m*m);
  $("bmiOut").textContent=toFaDigits(b.toFixed(2));
  $("bmiCat").textContent=bmiCat(b);
}
$("bmiW").addEventListener("input", bmiCompute);
$("bmiH").addEventListener("input", bmiCompute);
bmiCompute();

/* ========================= DateTime (auto, precise) =========================
   - Sync with TimeAPI.io every 5 minutes
   - Run local ticker every second without extra requests
*/
const TIMEAPI_BASE="https://timeapi.io/api/Time/current/zone?timeZone=";
const TZ_IR="Asia/Tehran";
const TZ_UTC="Etc/UTC";

let timeSync = {
  ok:false,
  perf0: performance.now(),
  utcMillis: null, // base UTC instant at perf0
  lastSyncText: "â€”"
};

function jalaliFromGregorian(gy,gm,gd){
  const g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334];
  let jy;
  if(gy>1600){ jy=979; gy-=1600; } else { jy=0; gy-=621; }
  const gy2=(gm>2)?(gy+1):gy;
  let days=365*gy + Math.floor((gy2+3)/4) - Math.floor((gy2+99)/100) + Math.floor((gy2+399)/400) - 80 + gd + g_d_m[gm-1];
  jy += 33*Math.floor(days/12053); days%=12053;
  jy += 4*Math.floor(days/1461); days%=1461;
  if(days>365){ jy += Math.floor((days-1)/365); days=(days-1)%365; }
  const jm=(days<186)?(1+Math.floor(days/31)):(7+Math.floor((days-186)/30));
  const jd=1+((days<186)?(days%31):((days-186)%30));
  return {jy,jm,jd};
}
const pad2=(n)=>String(n).padStart(2,"0");

async function fetchTimeAPI(tz){
  const res = await fetch(TIMEAPI_BASE+encodeURIComponent(tz), {cache:"no-store"});
  if(!res.ok) throw new Error("bad_status");
  const data = await res.json();
  // prefer dateTime (ISO) if present
  const iso = data.dateTime || `${data.year}-${pad2(data.month)}-${pad2(data.day)}T${pad2(data.hour)}:${pad2(data.minute)}:${pad2(data.seconds||0)}`;
  const ms = Date.parse(iso);
  if(!Number.isFinite(ms)) throw new Error("bad_payload");
  return {data, ms};
}

async function syncTime(){
  try{
    $("timeStatus").textContent="Ø¯Ø± Ø­Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒâ€¦";
    const utc = await fetchTimeAPI(TZ_UTC);
    // store base
    timeSync.ok=true;
    timeSync.perf0 = performance.now();
    timeSync.utcMillis = utc.ms;
    timeSync.lastSyncText = nowFaTime();
    $("dtSync").textContent = timeSync.lastSyncText;
    $("timeStatus").textContent="âœ“ Ù‡Ù…Ú¯Ø§Ù… Ø´Ø¯";
  }catch{
    timeSync.ok=false;
    $("timeStatus").textContent="Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„";
  }
}
function getNowUTCInstant(){
  if(!timeSync.ok || !Number.isFinite(timeSync.utcMillis)) return null;
  return timeSync.utcMillis + (performance.now() - timeSync.perf0);
}
function formatInTZ(ms, tz, opt){
  return new Intl.DateTimeFormat("fa-IR", {timeZone: tz, ...opt}).format(new Date(ms));
}
function partsInTZ(ms, tz){
  const parts = new Intl.DateTimeFormat("en-US", {
    timeZone: tz, hour12:false,
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  }).formatToParts(new Date(ms));
  const obj={};
  parts.forEach(p=>{ if(p.type!=="literal") obj[p.type]=p.value; });
  return {
    y:Number(obj.year), mo:Number(obj.month), d:Number(obj.day),
    hh:Number(obj.hour), mm:Number(obj.minute), ss:Number(obj.second)
  };
}
function renderClock(){
  const ms = getNowUTCInstant();
  if(ms==null) return;

  // Tehran
  const ir = partsInTZ(ms, TZ_IR);
  const utc = partsInTZ(ms, TZ_UTC);

  $("dtIR").textContent = toFaDigits(`${pad2(ir.hh)}:${pad2(ir.mm)}:${pad2(ir.ss)}`);
  $("dtUTC").textContent = toFaDigits(`${pad2(utc.hh)}:${pad2(utc.mm)}:${pad2(utc.ss)}`);

  // Gregorian date (Tehran)
  const g = `${ir.y}-${pad2(ir.mo)}-${pad2(ir.d)}`;
  $("dtG").textContent = toFaDigits(g);

  // Jalali date
  const j = jalaliFromGregorian(ir.y, ir.mo, ir.d);
  $("dtJ").textContent = toFaDigits(`${j.jy}/${pad2(j.jm)}/${pad2(j.jd)}`);

  // Analog hands
  const sec = ir.ss;
  const min = ir.mm + sec/60;
  const hr = (ir.hh%12) + min/60;

  const degS = sec*6;       // 360/60
  const degM = min*6;
  const degH = hr*30;

  $("handS").style.transform = `translate(-50%,-100%) rotate(${degS}deg)`;
  $("handM").style.transform = `translate(-50%,-100%) rotate(${degM}deg)`;
  $("handH").style.transform = `translate(-50%,-100%) rotate(${degH}deg)`;
}
let __clockLast = 0;
function buildClockFace(){
  const el = $("analogClock");
  if(!el) return;

  // Determine size (responsive)
  const rect = el.getBoundingClientRect();
  const size = Math.max(240, Math.min(380, rect.width || 320));
  if (Math.abs(size - __clockLast) < 2 && el.querySelector(".num")) return; // already built for this size
  __clockLast = size;

  // Clear old marks
  el.querySelectorAll(".tick,.num").forEach(n => n.remove());

  const R = size/2;
  const tickR = R - 18;   // tick ring radius
  const numR  = R - 52;   // number radius

  // Scale hand lengths/thicknesses
  const hourLen = R * 0.42;
  const minLen  = R * 0.60;
  const secLen  = R * 0.70;

  $("handH").style.height = `${hourLen}px`;
  $("handM").style.height = `${minLen}px`;
  $("handS").style.height = `${secLen}px`;

  $("handH").style.width = `${Math.max(7, R*0.05)}px`;
  $("handM").style.width = `${Math.max(5, R*0.035)}px`;
  $("handS").style.width = `${Math.max(2, R*0.02)}px`;

  // Create ticks
  for(let i=0;i<60;i++){
    const t=document.createElement("div");
    t.className="tick"+(i%5===0?" big":"");
    // Place at center and rotate, then push outward
    t.style.left="50%";
    t.style.top="50%";
    t.style.transform = `translateX(-50%) rotate(${i*6}deg) translateY(${-tickR}px)`;
    el.appendChild(t);
  }

  // Create numbers 1..12
  for(let n=1;n<=12;n++){
    const angle=(n*30-90)*Math.PI/180;
    const x=R + Math.cos(angle)*numR;
    const y=R + Math.sin(angle)*numR;
    const d=document.createElement("div");
    d.className="num";
    d.style.left=`${x}px`;
    d.style.top =`${y}px`;
    d.textContent = n;
    el.appendChild(d);
  }

  // Brand text position stays relative
  const brand = el.querySelector(".clockBrand");
  if(brand){
    brand.style.bottom = `${Math.max(16, R*0.18)}px`;
  }
}
buildClockFace();
syncTime();
setInterval(syncTime, 5*60*1000);
setInterval(renderClock, 250); // smooth
renderClock();
  // Rebuild clock marks on resize (fixes mobile/desktop scaling issues)
  window.addEventListener('resize', ()=>requestAnimationFrame(buildClockFace));

/* ========================= Events (simple: Nager for Iran? fallback message) =========================
   NOTE: Reliable Persian holiday APIs often need keys.
   We try a public JSON from GitHub (raw) with CORS, else fallback.
*/
async function loadEvents(){
  const box=$("eventsBox");
  const ms = getNowUTCInstant();
  if(ms==null){ box.textContent="â€”"; return; }

  // Tehran date
  const ir = partsInTZ(ms, TZ_IR);
  const iso = `${ir.y}-${pad2(ir.mo)}-${pad2(ir.d)}`;

  // Try a lightweight public source (may fail depending on CORS)
  const candidates = [
    // Example community list (may change): kept as best-effort
    `https://raw.githubusercontent.com/ashkanrad/iranian-holidays/master/holidays.json`,
  ];

  for(const url of candidates){
    try{
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error("bad");
      const data = await res.json();
      // data: array or object - best effort
      let items = [];
      if(Array.isArray(data)){
        items = data.filter(x => (x.date===iso || x.gregorian===iso || x.iso===iso));
      }else if(typeof data==="object" && data){
        if(Array.isArray(data[iso])) items = data[iso];
        else if(data[iso]) items = [data[iso]];
      }
      if(!items.length) { box.innerHTML = `<div class="muted tiny">Ù…Ù†Ø§Ø³Ø¨ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>`; return; }

      const rows = items.slice(0,10).map(it=>{
        const title = (it.title || it.name || it.event || JSON.stringify(it)).toString();
        const isHoliday = !!(it.holiday || it.isHoliday || it.off);
        return `<div class="mt-1 ${isHoliday?'text-rose-200 font-bold':''}">
          â€¢ ${escapeHtml(title)} ${isHoliday ? '<span class="mr-2">(ØªØ¹Ø·ÛŒÙ„)</span>':''}
        </div>`;
      }).join("");
      box.innerHTML = rows;
      return;
    }catch{}
  }

  box.innerHTML = `<div class="muted tiny">ÙØ¹Ù„Ø§Ù‹ Ù…Ù†Ø¨Ø¹ Ù…Ù†Ø§Ø³Ø¨Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. (Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø§Ú¯Ø± ÛŒÚ© API/JSON Ù…Ø·Ù…Ø¦Ù† Ù…Ø¹Ø±ÙÛŒ Ú©Ù†ÛŒØŒ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ ÙˆØµÙ„Ø´ Ú©Ù†Ù….)</div>`;
}
setInterval(loadEvents, 10*60*1000);
loadEvents();

/* ========================= Crypto (CoinGecko + FX USD->IRR) ========================= */
const COINS = [
  {id:"bitcoin",   nxSrc:"btc",  sym:"BTC",  name:"Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†",     icon:"â‚¿"},
  {id:"ethereum",  nxSrc:"eth",  sym:"ETH",  name:"Ø§ØªØ±ÛŒÙˆÙ…",       icon:"â—†"},
  {id:"tether",    nxSrc:"usdt", sym:"USDT", name:"ØªØªØ±",          icon:"â‚®"},
  {id:"toncoin",   nxSrc:"ton",  sym:"TON",  name:"ØªÙˆÙ†",          icon:"â—ˆ"},
  {id:"tron",      nxSrc:"trx",  sym:"TRX",  name:"ØªØ±ÙˆÙ†",         icon:"â—"},
  {id:"pax-gold",  nxSrc:"paxg", sym:"PAXG", name:"Ø·Ù„Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„", icon:"âŸ¡"},
];

// ---- Robust fetch helpers (CORS-friendly) ----
async function fetchTextAny(url, {timeout=12000} = {}){
  const targets = [
    {name:"direct", u:url},
    // Jina AI proxy returns the remote content with permissive CORS in most cases.
    {name:"jina", u:`https://r.jina.ai/${url}`},
    // AllOrigins raw proxy (best-effort).
    {name:"allorigins", u:`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`}
  ];
  let lastErr = null;
  for (const t of targets){
    try{
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), timeout);
      const res = await fetch(t.u, {cache:"no-store", signal: ctrl.signal});
      clearTimeout(id);
      if(!res.ok) throw new Error(`${t.name}_bad_status_${res.status}`);
      const txt = await res.text();
      if(!txt || txt.length < 2) throw new Error(`${t.name}_empty`);
      return txt;
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("fetch_failed");
}
async function fetchJSONAny(url, opts){
  const txt = await fetchTextAny(url, opts);
  // Sometimes proxies prepend BOM / whitespace
  const clean = txt.replace(/^\uFEFF/, "").trim();
  return JSON.parse(clean);
}

async function fetchNobitexStats(src, dst){
  const url = `https://api.nobitex.ir/market/stats?srcCurrency=${encodeURIComponent(src)}&dstCurrency=${encodeURIComponent(dst)}`;
  const data = await fetchJSONAny(url, {timeout: 12000});
  // Expected: {status:"ok", stats:{ "btc-rls": {latest, ...}}}
  return data;
}

// ---- TGJU parsing helpers (robust to schema changes) ----
function extractTGJURecords(payload){
  const out = [];
  const seen = new Set();

  const walk = (obj) => {
    if(!obj || typeof obj !== "object") return;

    // candidate record
    const title = obj.title || obj.name || obj.label || obj.slug || obj.symbol;
    const price = obj.p ?? obj.price ?? obj.value ?? obj.last ?? obj.current ?? obj.latest;
    const change = obj.dp ?? obj.change_percent ?? obj.percent ?? obj.changePercent ?? obj.change;
    const high = obj.high ?? obj.max ?? obj.high24 ?? obj.dayHigh;
    const low  = obj.low  ?? obj.min ?? obj.low24  ?? obj.dayLow;

    if(title && (price!=null) && (typeof price==="number" || typeof price==="string")){
      const t = String(title).trim();
      const pr = Number(String(price).replace(/[^\d\.\-]/g,""));
      if(Number.isFinite(pr)){
        const id = t+"|"+pr;
        if(!seen.has(id)){
          seen.add(id);
          out.push({
            title: t,
            price: pr,
            changePct: (change!=null && !Number.isNaN(Number(change))) ? Number(change) : null,
            high: (high!=null && !Number.isNaN(Number(high))) ? Number(high) : null,
            low:  (low!=null && !Number.isNaN(Number(low)))  ? Number(low) : null,
          });
        }
      }
    }

    for (const k in obj){
      if(Object.prototype.hasOwnProperty.call(obj,k)){
        const v = obj[k];
        if(Array.isArray(v)) v.forEach(walk);
        else if(typeof v === "object") walk(v);
      }
    }
  };

  walk(payload);
  return out;
}

function makeIranRow(label, code, rec){
  if(!rec) return null;
  return {
    label,
    code,
    price: rec.price,
    changePct: rec.changePct,
    high: rec.high,
    low: rec.low,
    source: "TGJU"
  };
}


let fx = { usdIrr:null, updatedAt:"â€”" };
let coinState = {}; // id -> {usd, chg24, min7, max7, series7:[...], updatedAt}

function coinRowSkeleton(c){
  return `
  <div class="soft p-3 flex items-center justify-between gap-3 flex-wrap">
    <div class="flex items-center gap-3 min-w-[220px]">
      <div class="w-10 h-10 rounded-2xl grad flex items-center justify-center text-lg font-extrabold">${escapeHtml(c.icon)}</div>
      <div>
        <div class="font-extrabold">${escapeHtml(c.name)} <span class="muted tiny">(${escapeHtml(c.sym)})</span></div>
        <div class="muted tiny">Ú©Ù…ÛŒÙ†Ù‡/Ø¨ÛŒØ´ÛŒÙ†Ù‡ Û· Ø±ÙˆØ²: <span id="mm-${c.id}">â€”</span></div>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <div class="text-left">
        <div class="muted tiny">Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ</div>
        <div class="text-xl font-extrabold" id="p-${c.id}">â€”</div>
      </div>
      <div class="text-left">
        <div class="muted tiny">ØªØºÛŒÛŒØ± Û²Û´Ø³Ø§Ø¹Øª</div>
        <div class="font-extrabold" id="c-${c.id}">â€”</div>
      </div>
      <div class="hidden md:block">
        <canvas class="spark" id="s-${c.id}" width="220" height="72"></canvas>
      </div>
    </div>
  </div>`;
}
function renderCryptoGrid(){
  $("cryptoGrid").innerHTML = COINS.map(coinRowSkeleton).join("");
}
renderCryptoGrid();

async function fetchUsdIrr(){
  // USD â‰ˆ USDT in Iran market; use Nobitex USDT/RLS as the most reliable live rate for our conversions
  try{
    const st = await fetchNobitexStats("usdt","rls");
    const rls = st?.lastPrice ? Number(st.lastPrice) : NaN;
    return Number.isFinite(rls) ? rls : null;
  }catch(_){
    return null;
  }
}

async function fetchCoinLive(){
  const ids = COINS.map(c=>c.id).join(",");
  const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids)}&vs_currencies=usd&include_24hr_change=true&include_last_updated_at=true`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("cg_live_fail");
  const j = await res.json();

  COINS.forEach(c=>{
    const it = j[c.id];
    if(!it) return;
    const usd = Number(it.usd);
    const chg = Number(it.usd_24h_change);
    const upd = Number(it.last_updated_at)*1000;
    coinState[c.id] = {...(coinState[c.id]||{}), usd, chg24: chg, liveAt: upd};
  });
}

async function fetchCoin7d(coinId){
  const url = `https://api.coingecko.com/api/v3/coins/${encodeURIComponent(coinId)}/market_chart?vs_currency=usd&days=7&interval=hourly`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("cg_7d_fail");
  const j = await res.json();
  const prices = (j?.prices||[]).map(p=>Number(p[1])).filter(Number.isFinite);
  if(!prices.length) throw new Error("no_prices");
  const min7 = Math.min(...prices);
  const max7 = Math.max(...prices);
  coinState[coinId] = {...(coinState[coinId]||{}), series7: prices, min7, max7, seriesAt: Date.now()};
}

function spark(canvasId, series){
  const c = document.getElementById(canvasId);
  if(!c || !c.getContext) return;
  const ctx = c.getContext("2d");
  const w = c.width, h = c.height;
  ctx.clearRect(0,0,w,h);

  if(!series || series.length<2){
    ctx.globalAlpha=.5;
    ctx.fillText("â€”", 6, 20);
    return;
  }
  const min = Math.min(...series);
  const max = Math.max(...series);
  const range = Math.max(1e-9, max-min);

  // line
  ctx.lineWidth = 3;
  ctx.lineJoin = "round";
  ctx.lineCap = "round";

  // subtle grid
  ctx.globalAlpha = 0.12;
  ctx.strokeStyle = "#ffffff";
  for(let i=1;i<=3;i++){
    const y = (h/4)*i;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }
  ctx.globalAlpha = 1;

  const accent = getComputedStyle(document.documentElement).getPropertyValue("--primary") || "#38bdf8";
  ctx.strokeStyle = accent.trim();

  ctx.beginPath();
  for(let i=0;i<series.length;i++){
    const x = (i/(series.length-1))*(w-10) + 5;
    const y = h - (((series[i]-min)/range)*(h-14) + 7);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // last dot
  const last = series[series.length-1];
  const lx = w-5;
  const ly = h - (((last-min)/range)*(h-14) + 7);
  ctx.fillStyle = accent.trim();
  ctx.beginPath(); ctx.arc(lx, ly, 4.5, 0, Math.PI*2); ctx.fill();
}

function renderAllSparks(){
  COINS.forEach(c=>{
    const s = coinState[c.id]?.series7;
    spark(`s-${c.id}`, s);
  });
}

function renderCoinUI(){
  const irr = fx.usdIrr;
  COINS.forEach(c=>{
    const st = coinState[c.id] || {};
    const priceEl = $(`p-${c.id}`);
    const chgEl = $(`c-${c.id}`);
    const mmEl = $(`mm-${c.id}`);

    // price
    if(Number.isFinite(st.usd) && Number.isFinite(irr)){
      const toman = st.usd * irr / 10;
      priceEl.textContent = `${formatMoney(toman)} ØªÙˆÙ…Ø§Ù†`;
    }else{
      priceEl.textContent = "â€”";
    }

    // change 24h
    if(Number.isFinite(st.chg24)){
      const up = st.chg24 >= 0;
      chgEl.className = "font-extrabold " + (up ? "text-emerald-300" : "text-rose-300");
      chgEl.innerHTML = `${up ? "â–²" : "â–¼"} ${fmtPct(Math.abs(st.chg24))}%`;
    }else{
      chgEl.className = "font-extrabold";
      chgEl.textContent = "â€”";
    }

    // min/max
    if(Number.isFinite(st.min7) && Number.isFinite(st.max7) && Number.isFinite(irr)){
      const minT = st.min7*irr/10, maxT = st.max7*irr/10;
      mmEl.textContent = `${formatMoney(minT)} ØªØ§ ${formatMoney(maxT)} ØªÙˆÙ…Ø§Ù†`;
    }else{
      mmEl.textContent = "â€”";
    }
  });

  renderAllSparks();
}

async function refreshCrypto(all=false){
  try{
    $("cryptoStatus").textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØªâ€¦";
    const okFx = await fetchUsdIrr();
    if(!okFx) $("cryptoHint").textContent = "Ù†Ø±Ø® Ø¯Ù„Ø§Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ø› Ø¨Ø¯ÙˆÙ† Ø¢Ù† Ø§Ù…Ú©Ø§Ù† ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† Ù†ÛŒØ³Øª.";
    else $("cryptoHint").textContent = "";

    await fetchCoinLive();

    if(all){
      // fetch 7d in parallel (limited)
      for(const c of COINS){
        try{ await fetchCoin7d(c.id); }catch{}
      }
    }else{
      // refresh 7d occasionally (every 30 minutes)
      const now=Date.now();
      for(const c of COINS){
        const st=coinState[c.id];
        if(!st?.seriesAt || (now - st.seriesAt) > 30*60*1000){
          try{ await fetchCoin7d(c.id); }catch{}
        }
      }
    }

    renderCoinUI();
    $("cryptoStatus").textContent = "âœ“ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯ ("+nowFaTime()+")";
  }catch(e){
    $("cryptoStatus").textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª";
    $("cryptoHint").textContent = "Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø´ØªØŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª/Ø§Ø®ØªÙ„Ø§Ù„ Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø§Ø³Øª. Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.";
  }
}

$("cryptoRefresh").addEventListener("click", ()=>refreshCrypto(true));
refreshCrypto(true);
setInterval(()=>refreshCrypto(false), 15*1000);

/* ========================= Iran Market (FX-based, best-effort metals) ========================= */
const IR_ITEMS = [
  {key:"EUR", name:"ÛŒÙˆØ±Ùˆ", icon:"â‚¬"},
  {key:"GBP", name:"Ù¾ÙˆÙ†Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³", icon:"Â£"},
  {key:"TRY", name:"Ù„ÛŒØ± ØªØ±Ú©ÛŒÙ‡", icon:"â‚º"},
  {key:"AED", name:"Ø¯Ø±Ù‡Ù… Ø§Ù…Ø§Ø±Ø§Øª", icon:"Ø¯.Ø¥"},
  {key:"XAU", name:"Ø·Ù„Ø§ Ø¬Ù‡Ø§Ù†ÛŒ (Ø§ÙˆÙ†Ø³) ~", icon:"Au"},
  {key:"XAG", name:"Ù†Ù‚Ø±Ù‡ Ø¬Ù‡Ø§Ù†ÛŒ (Ø§ÙˆÙ†Ø³) ~", icon:"Ag"},
];
let fxRates = { base:"USD", rates:null, at:null };
let metals = { xauUsd:null, xagUsd:null, at:null };

function iranRow(it, valueText, note=""){
  return `<div class="soft p-3 flex items-center justify-between gap-3 flex-wrap">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl grad flex items-center justify-center font-extrabold">${escapeHtml(it.icon)}</div>
      <div>
        <div class="font-extrabold">${escapeHtml(it.name)}</div>
        <div class="muted tiny">${escapeHtml(note)}</div>
      </div>
    </div>
    <div class="text-left">
      <div class="muted tiny">Ù‚ÛŒÙ…Øª</div>
      <div class="text-xl font-extrabold">${valueText}</div>
    </div>
  </div>`;
}
function renderIranGrid(){
  const irr = fx.usdIrr;
  const rates = fxRates.rates;
  const out=[];
  if(Number.isFinite(irr) && rates){
    // For 1 unit of currency in USD:
    // rates.X is X per USD. so 1 X = 1/rates.X USD
    const calc = (code)=>{
      const perUsd = Number(rates[code]); // currency per 1 USD
      if(!Number.isFinite(perUsd) || perUsd<=0) return null;
      const usdPer1 = 1/perUsd;
      return usdPer1 * irr / 10;
    };
    for(const it of IR_ITEMS){
      if(["EUR","GBP","TRY","AED"].includes(it.key)){
        const t = calc(it.key);
        out.push(iranRow(it, t?`${formatMoney(t)} ØªÙˆÙ…Ø§Ù†`:"â€”", "ØªØ¨Ø¯ÛŒÙ„ Ø§Ø² Ù†Ø±Ø® Ø¬Ù‡Ø§Ù†ÛŒ"));
      }
    }
  }else{
    out.push(`<div class="soft p-3 muted tiny">Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø§ÛŒØ±Ø§Ù†ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ù†Ø±Ø® USDâ†’IRR Ø¯Ø±ÛŒØ§ÙØª Ø´ÙˆØ¯.</div>`);
  }

  // Metals best-effort
  if(Number.isFinite(fx.usdIrr)){
    const irr = fx.usdIrr;
    const xau = metals.xauUsd;
    const xag = metals.xagUsd;
    const xauT = Number.isFinite(xau) ? xau*irr/10 : NaN;
    const xagT = Number.isFinite(xag) ? xag*irr/10 : NaN;
    out.push(iranRow(IR_ITEMS.find(x=>x.key==="XAU"), Number.isFinite(xauT)?`${formatMoney(xauT)} ØªÙˆÙ…Ø§Ù†`:"â€”", "ØªÙ‚Ø±ÛŒØ¨ÛŒ (Ø§ÙˆÙ†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ)"));
    out.push(iranRow(IR_ITEMS.find(x=>x.key==="XAG"), Number.isFinite(xagT)?`${formatMoney(xagT)} ØªÙˆÙ…Ø§Ù†`:"â€”", "ØªÙ‚Ø±ÛŒØ¨ÛŒ (Ø§ÙˆÙ†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ)"));
  }

  $("iranGrid").innerHTML = out.join("");
}

async function fetchFxRates(){
  // re-use USD base sources for more currencies too
  const sources = [
    {url:"https://api.exchangerate-api.com/v4/latest/USD", parse:(j)=>j?.rates},
    {url:"https://open.er-api.com/v6/latest/USD", parse:(j)=>j?.rates},
  ];
  for(const s of sources){
    try{
      const res = await fetch(s.url, {cache:"no-store"});
      if(!res.ok) throw new Error("bad");
      const j = await res.json();
      const rates = s.parse(j);
      if(rates && typeof rates==="object"){
        fxRates.rates = rates;
        fxRates.at = nowFaTime();
        return true;
      }
    }catch{}
  }
  fxRates.rates = null;
  return false;
}

async function fetchMetals(){
  // Best effort; may fail due to CORS on some endpoints
  const sources = [
    // metals.live sometimes offers free spot JSON
    {url:"https://api.metals.live/v1/spot", parse:(j)=>{
      // expected: [["gold", 2030.12], ["silver", 22.3], ...]
      if(!Array.isArray(j)) return null;
      const m = Object.fromEntries(j.map(x=>[String(x[0]).toLowerCase(), Number(x[1])]));
      return {xau: m.gold, xag: m.silver};
    }},
  ];
  for(const s of sources){
    try{
      const res = await fetch(s.url, {cache:"no-store"});
      if(!res.ok) throw new Error("bad");
      const j = await res.json();
      const got = s.parse(j);
      if(got && Number.isFinite(got.xau)){
        metals.xauUsd = got.xau;
        metals.xagUsd = Number(got.xag);
        metals.at = nowFaTime();
        return true;
      }
    }catch{}
  }
  metals.xauUsd = null;
  metals.xagUsd = null;
  return false;
}

async function refreshIran(all=false){
  const started = Date.now();
  const btn = $("iranRefresh");
  if(btn){ btn.disabled = true; btn.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€¦"; }
  $("iranStatus").textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ø§Ø± Ø§ÛŒØ±Ø§Ù† (TGJU)â€¦";
  $("iranHint").textContent = "Ø§Ú¯Ø± Ú†ÛŒØ²ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯ØŒ VPN/Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";

  try{
    const batch = async (batchName) => {
    const url = `https://api.tgju.org/v1/market/newsearch?batch=${encodeURIComponent(batchName)}&module=markets.internal`;
    const data = await fetchJSONAny(url, {timeout: 12000});
    return data;
  };

    const results = await Promise.allSettled([
      batch("internal_currency"),
      batch("internal_gold"),
      batch("coin"),
      batch("silver")
    ]);

    const records = [];
    for (const res of results){
      if(res.status==="fulfilled") records.push(...extractTGJURecords(res.value));
    }

    const pick = (rxList) => {
      for (const rx of rxList){
        const hit = records.find(r => rx.test(r.title));
        if(hit) return hit;
      }
      return null;
    };

    // Note: TGJU prices are usually in Ø±ÛŒØ§Ù„. We display ØªÙˆÙ…Ø§Ù† by default.
    const toToman = (v) => (v!=null && Number.isFinite(v)) ? v/10 : null;

    const usd = pick([/Ø¯Ù„Ø§Ø±/i, /USD/i]);
    const eur = pick([/ÛŒÙˆØ±Ùˆ/i, /EUR/i]);
    const gbp = pick([/Ù¾ÙˆÙ†Ø¯/i, /GBP/i, /Ø§Ù†Ú¯Ù„ÛŒØ³/i]);
    const aed = pick([/Ø¯Ø±Ù‡Ù…/i, /AED/i, /Ø§Ù…Ø§Ø±Ø§Øª/i]);
    const tryy = pick([/Ù„ÛŒØ±/i, /TRY/i, /ØªØ±Ú©ÛŒ/i]);
    const gold18 = pick([/Û±Û¸\s*Ø¹ÛŒØ§Ø±/i, /Û±Û¸Ø¹ÛŒØ§Ø±/i, /Ø·Ù„Ø§ÛŒ\s*Û±Û¸/i]);
    const seke = pick([/Ø³Ú©Ù‡\s*Ø§Ù…Ø§Ù…ÛŒ/i, /Ø³Ú©Ù‡\s*ØªÙ…Ø§Ù…/i, /Ø§Ù…Ø§Ù…ÛŒ/i]);
    const silver = pick([/Ù†Ù‚Ø±Ù‡/i, /Silver/i]);

    const out = [];
    const add = (key, rec, note="TGJU") => {
      const it = IR_ITEMS.find(x=>x.key===key);
      if(!it || !rec) return;
      const t = toToman(rec.price);
      const ch = rec.changePct;
      const arrow = (ch==null) ? "â€¢" : (ch>0 ? "â–²" : (ch<0 ? "â–¼" : "â– "));
      const chTxt = (ch==null) ? "" : ` ${arrow} ${toFaDigits(Math.abs(ch).toFixed(2))}%`;
      out.push(iranRow(it, t?`${formatMoney(t)} ØªÙˆÙ…Ø§Ù†`:"â€”", note + chTxt));
    };

    add("USD", usd);
    add("EUR", eur);
    add("GBP", gbp);
    add("TRY", tryy);
    add("AED", aed);
    add("G18", gold18);
    add("SEKE", seke);
    add("AG", silver);

    $("iranGrid").innerHTML = out.length ? out.join("") : `<div class="note">âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯. (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø³Ø±ÙˆÛŒØ³ TGJU ÛŒØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ø§Ø´Ø¯)</div>`;

    const elapsed = Math.round((Date.now()-started)/1000);
    $("iranStatus").textContent = out.length ? `âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯ â€¢ ${toFaDigits(elapsed)} Ø«Ø§Ù†ÛŒÙ‡` : "âš ï¸ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.";
  }catch(err){
    console.error(err);
    $("iranStatus").textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§Ø²Ø§Ø± Ø§ÛŒØ±Ø§Ù†. Ø§ÛŒÙ†ØªØ±Ù†Øª/VPN Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
  }finally{
    if(btn){ btn.disabled=false; btn.textContent="Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ"; }
  }
}


$("iranRefresh").addEventListener("click", ()=>refreshIran(true));
refreshIran(true);
setInterval(()=>refreshIran(false), 60*1000);

/* ========================= Weather (NO GPS) ========================= */
const PROVINCES = [
  ["ØªÙ‡Ø±Ø§Ù†", 35.6892, 51.3890],
  ["Ù…Ø´Ù‡Ø¯ (Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ)", 36.2605, 59.6168],
  ["Ø§ØµÙÙ‡Ø§Ù†", 32.6539, 51.6660],
  ["Ø´ÛŒØ±Ø§Ø² (ÙØ§Ø±Ø³)", 29.5918, 52.5837],
  ["ØªØ¨Ø±ÛŒØ² (Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ)", 38.0962, 46.2738],
  ["Ø±Ø´Øª (Ú¯ÛŒÙ„Ø§Ù†)", 37.2808, 49.5832],
  ["Ø§Ù‡ÙˆØ§Ø² (Ø®ÙˆØ²Ø³ØªØ§Ù†)", 31.3183, 48.6706],
  ["Ú©Ø±Ø¬ (Ø§Ù„Ø¨Ø±Ø²)", 35.8400, 50.9391],
  ["Ù‚Ù…", 34.6416, 50.8746],
  ["Ú©Ø±Ù…Ø§Ù†", 30.2839, 57.0834],
  ["ÛŒØ²Ø¯", 31.8974, 54.3569],
  ["Ø§Ø±ÙˆÙ…ÛŒÙ‡ (Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† ØºØ±Ø¨ÛŒ)", 37.5527, 45.0760],
  ["Ù‡Ù…Ø¯Ø§Ù†", 34.7983, 48.5148],
  ["Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡", 34.3142, 47.0650],
  ["Ù‚Ø²ÙˆÛŒÙ†", 36.2688, 50.0041],
  ["Ø³Ø§Ø±ÛŒ (Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†)", 36.5633, 53.0601],
  ["Ø³Ù†Ù†Ø¯Ø¬ (Ú©Ø±Ø¯Ø³ØªØ§Ù†)", 35.3149, 46.9988],
  ["Ø²Ø§Ù‡Ø¯Ø§Ù† (Ø³ÛŒØ³ØªØ§Ù†â€ŒÙˆØ¨Ù„ÙˆÚ†Ø³ØªØ§Ù†)", 29.4963, 60.8629],
  ["Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³ (Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†)", 27.1832, 56.2666],
  ["Ø¨ÙˆØ´Ù‡Ø±", 28.9220, 50.8203],
  ["Ø§Ø±Ø§Ú© (Ù…Ø±Ú©Ø²ÛŒ)", 34.0954, 49.7013],
  ["Ú¯Ø±Ú¯Ø§Ù† (Ú¯Ù„Ø³ØªØ§Ù†)", 36.8456, 54.4393],
  ["Ø¨Ø¬Ù†ÙˆØ±Ø¯ (Ø®Ø±Ø§Ø³Ø§Ù† Ø´Ù…Ø§Ù„ÛŒ)", 37.4750, 57.3304],
  ["Ø¨ÛŒØ±Ø¬Ù†Ø¯ (Ø®Ø±Ø§Ø³Ø§Ù† Ø¬Ù†ÙˆØ¨ÛŒ)", 32.8649, 59.2262],
  ["Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯ (Ù„Ø±Ø³ØªØ§Ù†)", 33.4878, 48.3558],
  ["Ø²Ù†Ø¬Ø§Ù†", 36.6736, 48.4787],
  ["Ø´Ù‡Ø±Ú©Ø±Ø¯ (Ú†Ù‡Ø§Ø±Ù…Ø­Ø§Ù„)", 32.3256, 50.8644],
  ["ÛŒØ§Ø³ÙˆØ¬ (Ú©Ù‡Ú¯ÛŒÙ„ÙˆÛŒÙ‡)", 30.6682, 51.5880],
  ["Ø§ÛŒÙ„Ø§Ù…", 33.6374, 46.4227],
  ["Ø§Ø±Ø¯Ø¨ÛŒÙ„", 38.2498, 48.2933],
  ["Ø³Ù…Ù†Ø§Ù†", 35.5729, 53.3971],
  ["Ù‚Ø´Ù… (Ú¯Ø²ÛŒÙ†Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†)", 26.9581, 56.2719],
];

let wx = { city:null, lat:null, lon:null, last:null };

function wxDescribe(code){
  if(code===0) return "ØµØ§Ù";
  if(code===1) return "Ø¹Ù…Ø¯ØªØ§Ù‹ ØµØ§Ù";
  if(code===2) return "Ù†ÛŒÙ…Ù‡ Ø§Ø¨Ø±ÛŒ";
  if(code===3) return "Ø§Ø¨Ø±ÛŒ";
  if([45,48].includes(code)) return "Ù…Ù‡/ØºØ¨Ø§Ø±";
  if([51,53,55].includes(code)) return "Ù†Ù…â€ŒÙ†Ù… Ø¨Ø§Ø±Ø§Ù†";
  if([61,63,65].includes(code)) return "Ø¨Ø§Ø±Ø§Ù†ÛŒ";
  if([71,73,75,77].includes(code)) return "Ø¨Ø±ÙÛŒ";
  if([80,81,82].includes(code)) return "Ø±Ú¯Ø¨Ø§Ø±";
  if([95,96,99].includes(code)) return "Ø·ÙˆÙØ§Ù†/Ø±Ø¹Ø¯ÙˆØ¨Ø±Ù‚";
  return "Ù†Ø§Ù…Ø´Ø®Øµ";
}

function wxRenderEmpty(){
  $("wxCurrent").textContent="â€”";
  $("wxKpi").textContent="â€”";
  $("wxHourly").textContent="â€”";
  $("wxDaily").textContent="â€”";
}

async function wxFetch(lat, lon){
  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
    `&current_weather=true&timezone=auto`+
    `&hourly=temperature_2m,weathercode,precipitation,windspeed_10m`+
    `&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum&forecast_days=7`;

  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("wx_fail");
  return await res.json();
}

function wxRender(data){
  const cur = data.current_weather;
  if(!cur){ wxRenderEmpty(); return; }

  const desc = wxDescribe(cur.weathercode);
  const temp = Number(cur.temperature);
  const wind = Number(cur.windspeed);

  $("wxUpdated").textContent = nowFaTime();
  $("wxCurrent").innerHTML = `
    <div class="flex items-center justify-between gap-3 flex-wrap">
      <div class="font-extrabold">${escapeHtml(wx.city||"â€”")} â€¢ ${escapeHtml(desc)}</div>
      <div class="text-left">
        <div class="text-4xl font-extrabold">${toFaDigits(temp.toFixed(1))}Â°C</div>
        <div class="muted tiny">Ø¨Ø§Ø¯: ${toFaDigits(wind.toFixed(0))} km/h</div>
      </div>
    </div>
  `;

  $("wxKpi").innerHTML = `
    <div class="grid grid-cols-2 gap-2">
      <div class="soft p-2">
        <div class="muted tiny">Ú©Ø¯ ÙˆØ¶Ø¹ÛŒØª</div>
        <div class="font-extrabold">${toFaDigits(cur.weathercode)}</div>
      </div>
      <div class="soft p-2">
        <div class="muted tiny">Ø³Ø§Ø¹Øª Ù…Ø­Ù„ÛŒ</div>
        <div class="font-extrabold">${toFaDigits(new Date(cur.time).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"}))}</div>
      </div>
    </div>
  `;

  // hourly next 24
  const times = data.hourly.time;
  const t2m = data.hourly.temperature_2m;
  const wcode = data.hourly.weathercode;
  const pr = data.hourly.precipitation;
  const ws = data.hourly.windspeed_10m;

  const nowIso = cur.time;
  let start = times.indexOf(nowIso);
  if(start<0) start=0;
  const end = Math.min(start+24, times.length);

  let hhtml = `<div class="flex gap-2 overflow-auto pb-1">`;
  for(let i=start;i<end;i++){
    const d = new Date(times[i]);
    const hh = String(d.getHours()).padStart(2,"0");
    hhtml += `
      <div class="soft p-2 min-w-[92px] text-center">
        <div class="muted tiny">${toFaDigits(hh)}:Û°Û°</div>
        <div class="font-extrabold">${toFaDigits(Number(t2m[i]).toFixed(0))}Â°</div>
        <div class="muted tiny">${escapeHtml(wxDescribe(wcode[i]))}</div>
        <div class="muted tiny">ğŸ’§ ${toFaDigits(Number(pr[i]).toFixed(1))}</div>
      </div>`;
  }
  hhtml += `</div>`;
  $("wxHourly").innerHTML = hhtml;

  // daily 7
  const dtime = data.daily.time;
  const tmax = data.daily.temperature_2m_max;
  const tmin = data.daily.temperature_2m_min;
  const dcode = data.daily.weathercode;
  const dpr = data.daily.precipitation_sum;

  let dhtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">`;
  for(let i=0;i<Math.min(7,dtime.length);i++){
    dhtml += `
      <div class="soft p-3">
        <div class="font-extrabold">${i===0?"Ø§Ù…Ø±ÙˆØ²":toFaDigits(new Date(dtime[i]).toLocaleDateString("fa-IR",{weekday:"long"}))}</div>
        <div class="muted tiny">${toFaDigits(new Date(dtime[i]).toLocaleDateString("fa-IR"))}</div>
        <div class="mt-2">${escapeHtml(wxDescribe(dcode[i]))}</div>
        <div class="muted tiny mt-1">Ú©Ù…ÛŒÙ†Ù‡ ${toFaDigits(Number(tmin[i]).toFixed(0))}Â° / Ø¨ÛŒØ´ÛŒÙ†Ù‡ ${toFaDigits(Number(tmax[i]).toFixed(0))}Â°</div>
        <div class="muted tiny">Ø¨Ø§Ø±Ø´: ${toFaDigits(Number(dpr[i]).toFixed(1))}</div>
      </div>`;
  }
  dhtml += `</div>`;
  $("wxDaily").innerHTML = dhtml;
}

async function wxUpdate(){
  if(wx.lat==null || wx.lon==null){
    $("wxStatus").textContent="Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±â€¦";
    return;
  }
  try{
    $("wxStatus").textContent="Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØªâ€¦";
    const data = await wxFetch(wx.lat, wx.lon);
    wx.last = data;
    wxRender(data);
    $("wxStatus").textContent="âœ“ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯ ("+nowFaTime()+")";
  }catch{
    $("wxStatus").textContent="Ø®Ø·Ø§";
    $("wxCurrent").innerHTML = `<div class="text-rose-200 font-bold">Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§. Ø§ÛŒÙ†ØªØ±Ù†Øª/ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</div>`;
  }
}

function setWxCity(name, lat, lon){
  wx.city = name; wx.lat = lat; wx.lon = lon;
  $("wxCity").textContent = name;
  $("cityResults").innerHTML = "";
  wxUpdate();
}

function initProvinces(){
  const sel=$("provinceSel");
  sel.innerHTML = `<option value="">â€” Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø±Ú©Ø² Ø§Ø³ØªØ§Ù† â€”</option>`;
  PROVINCES.forEach((p, idx)=>{
    const o=document.createElement("option");
    o.value = String(idx);
    o.textContent = p[0];
    sel.appendChild(o);
  });
  sel.addEventListener("change", ()=>{
    const i = Number(sel.value);
    if(!Number.isFinite(i)) return;
    const p = PROVINCES[i];
    if(!p) return;
    setWxCity(p[0], p[1], p[2]);
  });
}
initProvinces();

$("citySearchBtn").addEventListener("click", async ()=>{
  const q = ($("cityQuery").value||"").trim();
  if(!q) return;
  try{
    $("wxStatus").textContent="Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆâ€¦";
    const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=8&language=fa&format=json`;
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("geo_fail");
    const j = await res.json();
    const arr = j?.results || [];
    if(!arr.length){
      $("cityResults").innerHTML = `<div class="soft p-3 muted tiny">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</div>`;
      $("wxStatus").textContent="Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";
      return;
    }
    $("cityResults").innerHTML = arr.map(r=>{
      const name = `${r.name}${r.admin1 ? "ØŒ "+r.admin1 : ""}${r.country ? " ("+r.country+")" : ""}`;
      return `<button class="btn soft px-3 py-2 text-right focusable" data-lat="${r.latitude}" data-lon="${r.longitude}" data-name="${escapeHtml(name)}">
        <div class="font-bold">${escapeHtml(name)}</div>
        <div class="muted tiny">Ù…Ø®ØªØµØ§Øª: ${toFaDigits(r.latitude.toFixed(3))}, ${toFaDigits(r.longitude.toFixed(3))}</div>
      </button>`;
    }).join("");
    $("wxStatus").textContent="ÛŒÚ© Ù…ÙˆØ±Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.";
  }catch{
    $("wxStatus").textContent="Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ";
  }
});

$("cityResults").addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-lat]");
  if(!btn) return;
  const lat = Number(btn.getAttribute("data-lat"));
  const lon = Number(btn.getAttribute("data-lon"));
  const name = btn.getAttribute("data-name") || "â€”";
  if(Number.isFinite(lat) && Number.isFinite(lon)){
    setWxCity(name, lat, lon);
  }
});

$("wxRefresh").addEventListener("click", wxUpdate);
wxRenderEmpty();

/* ========================= Calculator (simple + small scientific) ========================= */
let calcMode = "simple";
let expr = "";
function calcRender(){
  $("calcExpr").textContent = expr.trim() ? expr : "â€”";
  let val = NaN;
  try{
    const safe = expr
      .replace(/Ã—/g,"*").replace(/Ã·/g,"/")
      .replace(/Ï€/g, String(Math.PI));
    // basic sanitize
    if(/[^0-9+\-*/().% \sA-Za-z]/.test(safe)) throw new Error("bad");
    // percent: convert "x%" -> (x/100)
    const replaced = safe.replace(/(\d+(\.\d+)?)%/g, "($1/100)");
    // functions
    const f = new Function("sin","cos","tan","sqrt","ln","log10","return ("+replaced+")");
    val = f(Math.sin, Math.cos, Math.tan, Math.sqrt, Math.log, (x)=>Math.log10(x));
  }catch{ val = NaN; }
  $("calcRes").textContent = Number.isFinite(val) ? val.toLocaleString("en-US",{maximumFractionDigits:10}) : "â€”";
}
function push(k){
  if(k==="="){
    calcRender();
    return;
  }
  if(k==="DEL"){
    expr = expr.slice(0,-1);
    calcRender();
    return;
  }
  if(k==="pow2"){ expr += "**2"; calcRender(); return; }
  if(k==="sqrt"){ expr += "sqrt("; calcRender(); return; }
  if(k==="sin"){ expr += "sin("; calcRender(); return; }
  if(k==="cos"){ expr += "cos("; calcRender(); return; }
  if(k==="tan"){ expr += "tan("; calcRender(); return; }
  if(k==="ln"){ expr += "ln("; calcRender(); return; }
  if(k==="log"){ expr += "log10("; calcRender(); return; }
  if(k==="pi"){ expr += "Ï€"; calcRender(); return; }

  expr += k;
  calcRender();
}
$("calcPad").addEventListener("click",(e)=>{
  const b = e.target.closest("[data-k]");
  if(!b) return;
  const k=b.dataset.k;
  push(k);
});
$("calcSci").addEventListener("click",(e)=>{
  const b = e.target.closest("[data-k]");
  if(!b) return;
  const k=b.dataset.k;
  push(k);
});
$("calcClear").addEventListener("click", ()=>{ expr=""; calcRender(); });
$("calcModeBtn").addEventListener("click", ()=>{
  calcMode = (calcMode==="simple") ? "sci" : "simple";
  $("calcSci").classList.toggle("hidden", calcMode!=="sci");
  $("calcModeBtn").textContent = "Ø­Ø§Ù„Øª: " + (calcMode==="sci" ? "Ù…Ù‡Ù†Ø¯Ø³ÛŒ" : "Ø³Ø§Ø¯Ù‡");
});
calcRender();

/* ========================= Boot: make sure initial statuses look ok ========================= */
$("cryptoStatus").textContent="Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„â€¦";
$("iranStatus").textContent="Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„â€¦";
</script>
</body>
</html>
