<!DOCTYPE html>

<html dir="rtl" lang="fa">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>codeisa</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- WebSocket (Socket.IO) برای دریافت قیمت لحظه‌ای رمزارزها از والکس -->
<script src="https://cdn.socket.io/2.5.0/socket.io.min.js"></script>
<style>
    :root{
      --bg:#0b1220;
      --surface:#0f1b33;
      --text:#e8eefc;
      --primary:#38bdf8;
      --secondary:#a78bfa;
      --gradA:#22c55e;
      --gradB:#38bdf8;
      --radius:18px;
      --fs:16px;
      --ff: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{height:100%}
    body{background:var(--bg); color:var(--text); font-family:var(--ff); font-size:var(--fs)}
    .card{
      background:color-mix(in srgb, var(--surface) 92%, black 8%);
      border:1px solid color-mix(in srgb, var(--text) 10%, transparent 90%);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .soft{
      border:1px solid color-mix(in srgb, var(--text) 12%, transparent 88%);
      background:color-mix(in srgb, var(--surface) 82%, black 18%);
      border-radius:14px;
    }
    .focusable:focus{outline:2px solid color-mix(in srgb, var(--primary) 80%, white 20%); outline-offset:2px}
    .btn{border-radius:14px; transition:.18s transform,.18s filter,.18s background,.18s box-shadow}
    .btn:active{transform:translateY(1px) scale(.99)}
    .glass{
      background:linear-gradient(135deg, color-mix(in srgb, var(--surface) 88%, transparent 12%), color-mix(in srgb, var(--surface) 72%, transparent 28%));
      backdrop-filter: blur(10px);
      border:1px solid color-mix(in srgb, var(--text) 12%, transparent 88%);
      border-radius:var(--radius);
    }
    .grad{background:linear-gradient(135deg, var(--gradA), var(--gradB));}
    .muted{color:color-mix(in srgb, var(--text) 72%, transparent 28%)}
    .tiny{font-size:.85em}
    .tabActive{background:color-mix(in srgb, var(--primary) 18%, transparent 82%); border:1px solid color-mix(in srgb, var(--primary) 45%, transparent 55%);}
    .tabIdle{background:color-mix(in srgb, var(--surface) 72%, transparent 28%); border:1px solid color-mix(in srgb, var(--text) 10%, transparent 90%);}
    input,select,textarea{
      background:color-mix(in srgb, var(--surface) 78%, black 22%);
      border:1px solid color-mix(in srgb, var(--text) 14%, transparent 86%);
      color:var(--text);
    }
    input::placeholder,textarea::placeholder{color:color-mix(in srgb, var(--text) 45%, transparent 55%)}
    option{background:#0b1220}
    .toast{animation:toastIn .22s ease-out}
    @keyframes toastIn{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
    .calcDisplay{font-variant-numeric: tabular-nums; letter-spacing:.02em; word-break: break-word;}

    /* Calculator */
    .calcShell{
      background: radial-gradient(1200px 500px at 80% 0%, color-mix(in srgb, var(--primary) 18%, transparent 82%), transparent 60%),
                  radial-gradient(900px 400px at 15% 20%, color-mix(in srgb, var(--secondary) 14%, transparent 86%), transparent 55%),
                  linear-gradient(180deg, color-mix(in srgb, var(--surface) 85%, black 15%), color-mix(in srgb, var(--surface) 75%, black 25%));
      border:1px solid color-mix(in srgb, var(--text) 10%, transparent 90%);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      position: relative;
      overflow: hidden;
    }
    .calcShell::before{
      content:"";
      position:absolute; inset:-2px;
      background:linear-gradient(135deg, color-mix(in srgb, var(--gradA) 55%, transparent 45%), color-mix(in srgb, var(--gradB) 55%, transparent 45%));
      opacity:.10;
      filter: blur(18px);
      pointer-events:none;
    }
    .calcTop{
      position:relative;
      background:linear-gradient(135deg, color-mix(in srgb, var(--surface) 85%, transparent 15%), color-mix(in srgb, var(--surface) 70%, transparent 30%));
      border:1px solid color-mix(in srgb, var(--text) 12%, transparent 88%);
      border-radius: 22px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    .calcKey{
      min-height:52px;
      border-radius: 18px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--surface) 90%, transparent 10%), color-mix(in srgb, var(--surface) 75%, black 25%));
      border:1px solid color-mix(in srgb, var(--text) 10%, transparent 90%);
      box-shadow: 0 10px 18px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.06);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    .calcKey:hover{filter:brightness(1.06)}
    .calcKey:active{
      transform: translateY(1px) scale(.99);
      box-shadow: 0 6px 12px rgba(0,0,0,.24), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .calcKeyOp{
      background: linear-gradient(135deg, color-mix(in srgb, var(--gradA) 80%, white 20%), color-mix(in srgb, var(--gradB) 80%, white 20%));
      color:#06101f;
      border:none;
      box-shadow: 0 12px 22px rgba(0,0,0,.28), 0 0 24px color-mix(in srgb, var(--primary) 35%, transparent 65%);
    }
    .calcKeyDanger{
      background: linear-gradient(135deg, color-mix(in srgb, #fb7185 70%, white 30%), color-mix(in srgb, #f97316 70%, white 30%));
      color:#14070a;
      border:none;
    }
    .calcKeyUtil{
      background: linear-gradient(180deg, color-mix(in srgb, var(--surface) 92%, transparent 8%), color-mix(in srgb, var(--surface) 72%, black 28%));
    }

    /* Crypto cards */
    .cryptoCard{
      position:relative;
      overflow:hidden;
    }
    .cryptoCard::before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(400px 180px at 80% 0%, color-mix(in srgb, var(--primary) 20%, transparent 80%), transparent 60%),
                  radial-gradient(420px 220px at 20% 10%, color-mix(in srgb, var(--secondary) 16%, transparent 84%), transparent 65%);
      opacity:.9;
      pointer-events:none;
    }
    .cryptoBadge{
      border:1px solid color-mix(in srgb, var(--text) 10%, transparent 90%);
      background: color-mix(in srgb, var(--surface) 70%, transparent 30%);
      border-radius: 999px;
      padding: .25rem .6rem;
      font-size: .78rem;
      white-space: nowrap;
    }
  
/* Analog clock */
.analogWrap{width:100%; display:flex; justify-content:center}

.analogWrap{width:min(360px,100%); aspect-ratio:1/1; margin-inline:auto}
.analogSvg{
  width:100%; height:100%;
  display:block;
  border-radius:9999px;
  background: radial-gradient(circle at 30% 25%, color-mix(in srgb, var(--primary) 18%, transparent 82%), transparent 55%),
              radial-gradient(circle at 70% 75%, color-mix(in srgb, var(--secondary) 16%, transparent 84%), transparent 55%),
              linear-gradient(180deg, color-mix(in srgb, var(--surface) 90%, transparent 10%), color-mix(in srgb, var(--surface) 70%, black 30%));
  border: 1px solid color-mix(in srgb, var(--text) 12%, transparent 88%);
  box-shadow: 0 18px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
}
.analogRing{stroke: color-mix(in srgb, var(--text) 14%, transparent 86%); stroke-dasharray: 2 5; opacity:.55}
.analogTick{stroke: color-mix(in srgb, var(--text) 22%, transparent 78%); stroke-linecap:round}
.analogTickMajor{stroke: color-mix(in srgb, var(--text) 40%, transparent 60%); stroke-width:3}
.analogNum{fill: color-mix(in srgb, var(--text) 82%, transparent 18%); font-weight:900; font-size:14px; text-anchor:middle; dominant-baseline:middle; user-select:none}
.analogBrand{fill: color-mix(in srgb, var(--text) 85%, transparent 15%); font-weight:900; font-size:12px; text-anchor:middle; dominant-baseline:middle; opacity:.92; letter-spacing:.03em}
.handLine{stroke-linecap:round}
.handHourLine{stroke: color-mix(in srgb, var(--text) 92%, transparent 8%); stroke-width:6}
.handMinLine{stroke: color-mix(in srgb, var(--text) 86%, transparent 14%); stroke-width:5}
.handSecLine{stroke: color-mix(in srgb, var(--primary) 82%, white 18%); stroke-width:2.5; filter: drop-shadow(0 0 10px color-mix(in srgb, var(--primary) 35%, transparent 65%))}
.analogHub{fill: url(#gradHub); filter: drop-shadow(0 10px 18px rgba(0,0,0,.25))}

.phoneWiggle{display:inline-block;animation:wiggle 1.8s ease-in-out infinite;transform-origin:50% 80%}
@keyframes wiggle{0%,100%{transform:rotate(0deg) translateY(0)}25%{transform:rotate(10deg) translateY(-1px)}50%{transform:rotate(-10deg) translateY(0)}75%{transform:rotate(6deg) translateY(-1px)}}


    @font-face{font-family:"Sahel";src:url("https://cdn.jsdelivr.net/gh/rastikerdar/sahel-font@v3.4.0/dist/Farsi-Digits/Sahel-FD.woff2") format("woff2");font-weight:400;font-style:normal;font-display:swap;}

/* Responsive fixes */
*,*::before,*::after{box-sizing:border-box}
html{scrollbar-gutter: stable;}
/* prevent accidental horizontal scroll from long text/buttons */
body{overflow-x:hidden}
#topNav{gap:.5rem}
/* make nav buttons wrap nicely on very small screens */
#topNav .navBtn{white-space:nowrap}
@media (max-width:420px){
  #topNav{justify-content:center}
  #topNav .navBtn{padding:.5rem .65rem;font-size:.85rem}
  #logoBadge{width:44px;height:44px;border-radius:16px}
}
/* Weather hourly cards sizing */
.weatherHourCard{min-width:78px; flex:0 0 auto}
@media (min-width:768px){
  .weatherHourCard{min-width:92px}
}

/* Hide horizontal scrollbar (mobile) */
.scrollbar-hide::-webkit-scrollbar{display:none}
.scrollbar-hide{-ms-overflow-style:none;scrollbar-width:none}
/* Weather: tighter layout on small screens */
@media (max-width:640px){
  #page-weather .calcDisplay{letter-spacing:-.5px}
  #page-weather #weatherCityTitle{font-size:1.25rem}
  #page-weather #weatherTemp{display:inline-block;min-width:2.5ch}
  #page-weather #weatherNarrative{align-items:flex-start;text-align:right}
  #page-weather #weatherNarrative .tiny{font-size:.78rem}
  #page-weather #weatherHourly{padding-bottom:.25rem}
  #page-weather #weatherDaily{grid-template-columns:repeat(2,minmax(0,1fr))}
}
</style>
</head>
<body class="min-h-screen overflow-x-hidden">
<div class="w-full mx-auto max-w-6xl px-3 sm:px-4 py-4 md:py-7">
<!-- Header -->
<header class="glass p-4 md:p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
<div class="flex items-center gap-3">
<div class="grad w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow" id="logoBadge"><svg aria-hidden="true" class="drop-shadow" height="28" viewbox="0 0 64 64" width="28"><defs><lineargradient id="lgCodeisa" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="var(--gradA)"></stop><stop offset="1" stop-color="var(--gradB)"></stop></lineargradient></defs><path d="M32 6c11 0 20 9 20 20v12c0 11-9 20-20 20S12 49 12 38V26c0-11 9-20 20-20Z" fill="url(#lgCodeisa)" opacity=".95"></path><path d="M22 28h20v4H22zm0 10h14v4H22z" fill="rgba(6,16,31,.9)"></path><path d="M44 22l6 6-6 6" fill="none" stroke="rgba(6,16,31,.9)" stroke-linecap="round" stroke-linejoin="round" stroke-width="4"></path></svg></div>
<div>
<h1 class="text-lg md:text-xl font-bold">codeisa</h1>
<p class="muted tiny">تبدیل دقیق واحدها + ابزارهای کاربردی</p>
</div>
</div>
<nav class="flex flex-wrap gap-2" id="topNav">
<button class="navBtn btn px-3.5 py-2 tabActive focusable" data-nav="converter" type="button">تبدیل واحدها</button>
<button class="navBtn btn px-3.5 py-2 tabIdle focusable" data-nav="health" type="button">محاسبات سلامتی</button>
<button class="navBtn btn px-3.5 py-2 tabIdle focusable" data-nav="datetime" type="button">تاریخ و ساعت</button>
<button class="navBtn btn px-3.5 py-2 tabIdle focusable" data-nav="weather" type="button">آب و هوا</button>
<button class="navBtn btn px-3.5 py-2 tabIdle focusable" data-nav="crypto" type="button">رمزارزها</button>
<button class="navBtn btn px-3.5 py-2 tabIdle focusable" data-nav="calculator" type="button">ماشین حساب</button>
<button class="navBtn btn px-3.5 py-2 tabIdle focusable" data-nav="settings" type="button">تنظیمات</button>
<button class="navBtn btn px-3.5 py-2 tabIdle focusable" data-nav="help" type="button">راهنما</button>
</nav>
</header>
<!-- Main -->
<main class="mt-5 md:mt-7">
<!-- Converter Page -->
<section class="space-y-4 md:space-y-5" id="page-converter">
<div class="grid md:grid-cols-3 gap-4 md:gap-5">
<div class="card p-4 md:p-5 md:col-span-2">
<div class="flex items-start justify-between gap-3">
<div>
<h2 class="text-base md:text-lg font-bold">تبدیل واحد</h2>
<p class="muted tiny mt-1">مقدار را وارد کنید، واحد مبدا و مقصد را انتخاب کنید. نتیجه فوری محاسبه می‌شود.</p>
</div>
<button class="btn px-3 py-2 soft focusable" id="swapBtn" title="جابجایی واحدها" type="button">
<span class="inline-flex items-center gap-2"><span>جابجایی</span> <span aria-hidden="true">⇄</span></span>
</button>
</div>
<div class="mt-4 grid sm:grid-cols-2 gap-3">
<div class="space-y-2">
<label class="tiny muted" for="categorySel">دسته‌بندی</label>
<select class="w-full px-3 py-2.5 rounded-xl focusable" id="categorySel"></select>
</div>
<div class="space-y-2">
<label class="tiny muted" for="precisionRange">دقت نمایش (اعشار)</label>
<div class="flex items-center gap-3">
<input class="w-full" id="precisionRange" max="8" min="0" step="1" type="range"/>
<div class="soft px-3 py-2 rounded-xl text-sm w-16 text-center" id="precisionLabel">2</div>
</div>
</div>
<div class="space-y-2">
<label class="tiny muted" for="valueInput">مقدار</label>
<input autocomplete="off" class="w-full px-3 py-2.5 rounded-xl focusable" id="valueInput" inputmode="decimal" placeholder="مثلاً 12.5"/>
<div class="muted tiny" id="valueHint">نکته: می‌توانید از نقطه برای اعشار استفاده کنید.</div>
</div>
<div class="space-y-2">
<label class="tiny muted" for="fromUnitSel">از</label>
<select class="w-full px-3 py-2.5 rounded-xl focusable" id="fromUnitSel"></select>
</div>
<div class="space-y-2">
<label class="tiny muted" for="toUnitSel">به</label>
<select class="w-full px-3 py-2.5 rounded-xl focusable" id="toUnitSel"></select>
</div>
<div class="space-y-2">
<label class="tiny muted">نتیجه</label>
<div class="soft p-3 rounded-xl flex items-center justify-between gap-2">
<div>
<div class="text-lg md:text-xl font-bold" id="resultValue">—</div>
<div class="muted tiny mt-1" id="resultUnit">—</div>
</div>
<div class="flex gap-2">
<button class="btn px-3 py-2 soft focusable" id="copyResultBtn" type="button">کپی</button>
</div>
</div>
<div class="muted tiny" id="converterNote"></div>
</div>
</div>
</div>
<div class="card p-4 md:p-5">
<h3 class="font-bold">تبدیل‌های رایج</h3>
<p class="muted tiny mt-1">با یک کلیک، مقادیر نمونه را تنظیم کنید.</p>
<div class="mt-3 grid gap-2" id="quickGrid"></div>
<div class="mt-4 soft p-3">
<div class="flex items-center justify-between gap-2">
<span class="tiny muted">نمایش اعداد فارسی</span>
<label class="inline-flex items-center cursor-pointer">
<input class="sr-only" id="uiPersianDigitsToggle" type="checkbox"/>
<span class="w-12 h-7 rounded-full relative soft">
<span class="absolute top-1 right-1 w-5 h-5 rounded-full grad transition-all" id="uiPersianDigitsDot"></span>
</span>
</label>
</div>
<div class="muted tiny mt-2">کپی معمولاً با اعداد استاندارد انجام می‌شود.</div>
</div>
</div>
</div>
</section>
<!-- Health Page -->
<section class="hidden space-y-4 md:space-y-5" id="page-health">
<div class="grid lg:grid-cols-2 gap-4 md:gap-5">
<div class="card p-4 md:p-5">
<div class="flex items-start justify-between gap-3">
<div>
<h2 class="text-base md:text-lg font-bold">شاخص توده بدنی (BMI)</h2>
<p class="muted tiny mt-1">BMI = وزن / (قد به متر)^۲</p>
</div>
<button class="btn px-3 py-2 soft focusable" id="copyBmiBtn" type="button">کپی</button>
</div>
<div class="mt-4 grid sm:grid-cols-2 gap-3">
<div class="space-y-2">
<label class="tiny muted" for="bmiWeight">وزن (کیلوگرم)</label>
<input class="w-full px-3 py-2.5 rounded-xl focusable" id="bmiWeight" inputmode="decimal" placeholder="مثلاً 72.5"/>
<div class="muted tiny">وزن فعلی خود را وارد کنید.</div>
</div>
<div class="space-y-2">
<label class="tiny muted" for="bmiHeight">قد (سانتی‌متر)</label>
<input class="w-full px-3 py-2.5 rounded-xl focusable" id="bmiHeight" inputmode="decimal" placeholder="مثلاً 175"/>
<div class="muted tiny">قد بدون کفش.</div>
</div>
</div>
<div class="mt-3 soft p-3 rounded-xl">
<div class="flex items-center justify-between gap-2">
<div>
<div class="muted tiny">نتیجه</div>
<div class="text-xl font-bold"><span id="bmiValue">—</span></div>
<div class="muted tiny mt-1">وضعیت: <span class="font-semibold" id="bmiCat">—</span></div>
</div>
<label class="inline-flex items-center gap-2 cursor-pointer">
<input class="w-4 h-4 rounded focusable" id="idealWeightToggle" type="checkbox"/>
<span class="tiny">نمایش وزن ایده‌آل</span>
</label>
</div>
<div class="hidden mt-2 muted tiny" id="idealWeightBox">
                محدوده وزن سالم: <span class="font-semibold" id="idealWeightRange"></span> کیلوگرم
              </div>
<div class="mt-2 hidden tiny" id="bmiWarn"></div>
</div>
</div>
<div class="card p-4 md:p-5">
<div class="flex items-start justify-between gap-3">
<div>
<h2 class="text-base md:text-lg font-bold">محاسبه کالری روزانه</h2>
<p class="muted tiny mt-1">BMR و TDEE و کالری هدف بر اساس Mifflin–St Jeor</p>
</div>
<button class="btn px-3 py-2 soft focusable" id="copyGoalBtn" type="button">کپی کالری هدف</button>
</div>
<div class="mt-4 grid sm:grid-cols-2 gap-3">
<div class="space-y-2">
<label class="tiny muted" for="sexSel">جنسیت</label>
<select class="w-full px-3 py-2.5 rounded-xl focusable" id="sexSel">
<option value="male">مرد</option>
<option value="female">زن</option>
</select>
</div>
<div class="space-y-2">
<label class="tiny muted" for="ageInput">سن (سال)</label>
<input class="w-full px-3 py-2.5 rounded-xl focusable" id="ageInput" inputmode="numeric" placeholder="مثلاً 30"/>
</div>
<div class="space-y-2">
<label class="tiny muted" for="calHeight">قد (سانتی‌متر)</label>
<input class="w-full px-3 py-2.5 rounded-xl focusable" id="calHeight" inputmode="decimal" placeholder="مثلاً 175"/>
</div>
<div class="space-y-2">
<label class="tiny muted" for="calWeight">وزن (کیلوگرم)</label>
<input class="w-full px-3 py-2.5 rounded-xl focusable" id="calWeight" inputmode="decimal" placeholder="مثلاً 72.5"/>
</div>
<div class="space-y-2 sm:col-span-2">
<label class="tiny muted" for="activitySel">سطح فعالیت</label>
<select class="w-full px-3 py-2.5 rounded-xl focusable" id="activitySel">
<option value="1.2">کم‌تحرک (1.2)</option>
<option value="1.375">فعالیت سبک (1.375)</option>
<option selected="" value="1.55">فعالیت متوسط (1.55)</option>
<option value="1.725">فعالیت زیاد (1.725)</option>
<option value="1.9">خیلی زیاد (1.9)</option>
</select>
</div>
<div class="space-y-2 sm:col-span-2">
<label class="tiny muted" for="goalSel">هدف</label>
<select class="w-full px-3 py-2.5 rounded-xl focusable" id="goalSel">
<option selected="" value="0">نگهداری وزن (0)</option>
<option value="-250">کاهش وزن ملایم (−250)</option>
<option value="-500">کاهش وزن (−500)</option>
<option value="250">افزایش وزن ملایم (+250)</option>
<option value="500">افزایش وزن (+500)</option>
</select>
</div>
</div>
<div class="mt-3 soft p-3 rounded-xl">
<div class="hidden mb-2 text-sm font-semibold" id="calError"></div>
<div class="grid sm:grid-cols-3 gap-2">
<div class="soft p-3">
<div class="muted tiny">BMR</div>
<div class="text-lg font-bold"><span id="bmrOut">—</span> <span class="muted tiny">کیلوکالری</span></div>
</div>
<div class="soft p-3">
<div class="muted tiny">کالری نگهداری (TDEE)</div>
<div class="text-lg font-bold"><span id="tdeeOut">—</span></div>
</div>
<div class="soft p-3">
<div class="muted tiny">کالری هدف</div>
<div class="text-lg font-bold"><span id="goalOut">—</span></div>
</div>
</div>
<div class="mt-2 hidden tiny" id="calWarn"></div>
</div>
</div>
</div>
<div class="card p-4 md:p-5">
<div class="flex items-start justify-between gap-3 flex-wrap">
<div>
<h2 class="text-base md:text-lg font-bold">راهنمای سریع تفسیر آزمایش‌ها</h2>
<p class="muted tiny mt-1">این بخش صرفاً آموزشی است و جایگزین نظر پزشک نیست.</p>
</div>
<button class="btn px-3 py-2 soft focusable" id="copyLabBtn" type="button">کپی نتیجه</button>
</div>
<div class="mt-4 grid md:grid-cols-3 gap-3">
<div class="space-y-2">
<label class="tiny muted" for="labType">نوع آزمایش</label>
<select class="w-full px-3 py-2.5 rounded-xl focusable" id="labType"></select>
<div class="muted tiny" id="labUnitHint">—</div>
</div>
<div class="space-y-2">
<label class="tiny muted" for="labValue">عدد شما</label>
<input class="w-full px-3 py-2.5 rounded-xl focusable" id="labValue" inputmode="decimal" placeholder="مثلاً 95"/>
<div class="muted tiny">می‌توانید با اعداد فارسی یا انگلیسی وارد کنید.</div>
</div>
<div class="space-y-2">
<label class="tiny muted" for="labSex">جنسیت (در صورت نیاز)</label>
<select class="w-full px-3 py-2.5 rounded-xl focusable" id="labSex">
<option value="any">فرقی ندارد</option>
<option value="male">مرد</option>
<option value="female">زن</option>
</select>
<div class="muted tiny">برخی رنج‌ها وابسته به جنسیت هستند.</div>
</div>
</div>
<div class="mt-3 soft p-3 rounded-xl">
<div class="grid md:grid-cols-3 gap-2">
<div class="soft p-3">
<div class="muted tiny">وضعیت</div>
<div class="text-lg font-extrabold" id="labStatus">—</div>
</div>
<div class="soft p-3 md:col-span-2">
<div class="muted tiny">توضیح</div>
<div class="leading-7" id="labExplain">برای شروع، نوع آزمایش و عدد خود را وارد کنید.</div>
</div>
</div>
<div class="mt-2 muted tiny" id="labRange">رنج مرجع: —</div>
</div>
</div>
<div class="mt-3 grid md:grid-cols-2 gap-2">
<details class="soft p-3 rounded-xl min-w-0">
<summary class="cursor-pointer font-bold">نکات مهم</summary>
<ul class="mt-2 list-disc pr-5 muted tiny leading-7">
<li>نتیجهٔ آزمایش به سن، شرایط بدنی، داروها و روش آزمایشگاه هم وابسته است.</li>
<li>اگر «خیلی بالا/خیلی پایین» نمایش داده شد یا علائم دارید، برای تفسیر قطعی با پزشک مشورت کنید.</li>
<li>بهتر است چند نتیجه پشت‌سرهم را مقایسه کنید، نه فقط یک عدد.</li>
</ul>
</details>
<details class="soft p-3 rounded-xl min-w-0">
<summary class="cursor-pointer font-bold">راهنمای سریع رنگ‌ها</summary>
<div class="mt-2 muted tiny leading-7">
<div><span class="font-bold text-emerald-200">نرمال</span> یعنی در محدوده مرجع.</div>
<div><span class="font-bold text-amber-200">مرزی</span> یعنی نزدیک حد پایین/بالا و نیازمند توجه.</div>
<div><span class="font-bold text-rose-200">غیرنرمال</span> یعنی خارج از محدوده و بهتر است بررسی شود.</div>
</div>
</details>
</div>
</section>
<!-- DateTime Page -->
<section class="hidden space-y-4 md:space-y-5" id="page-datetime">
<div class="card p-4 md:p-5">
<div class="flex items-start justify-between gap-3 flex-wrap">
<div>
<h2 class="text-base md:text-lg font-bold">تاریخ و ساعت ایران</h2>
<p class="muted tiny mt-1">به‌روزرسانی خودکار (با سرویس آنلاین) + ساعت آنالوگ</p>
</div>
<div class="flex gap-2 flex-wrap">
<button class="btn px-3 py-2 soft focusable" id="timeRefreshBtn" type="button">به‌روزرسانی</button>
<button class="btn px-3 py-2 soft focusable" id="timeCopyBtn" type="button">کپی</button>
</div>
</div>
<div class="mt-4 grid lg:grid-cols-2 gap-3">
<div class="soft p-4 rounded-2xl">
<div class="flex items-center justify-between gap-2">
<div class="font-bold">ساعت ایران</div>
<div class="muted tiny">Asia/Tehran</div>
</div>
<div class="calcDisplay text-4xl md:text-5xl font-extrabold mt-3" id="timeIR">—</div>
<div class="mt-2 soft p-3 flex items-center justify-between gap-2">
<div class="muted tiny">ساعت جهانی (UTC)</div>
<div class="calcDisplay text-xl font-extrabold" id="timeUTC">—</div>
</div>
<div class="mt-3 grid sm:grid-cols-2 gap-2">
<div class="soft p-3">
<div class="muted tiny">تاریخ شمسی</div>
<div class="calcDisplay text-2xl font-extrabold mt-2" id="todayJalali">—</div>
</div>
<div class="soft p-3">
<div class="muted tiny">تاریخ میلادی</div>
<div class="calcDisplay text-2xl font-extrabold mt-2" id="todayGreg">—</div>
</div>
</div>
<div class="muted tiny mt-3">آخرین بروزرسانی: <span id="timeUpdatedAt">—</span></div>
</div>
<div class="soft p-4 rounded-2xl flex flex-col items-center justify-center gap-3">
<div class="font-bold">ساعت آنالوگ (ایران)</div>
<div class="analogWrap">
<svg aria-label="ساعت آنالوگ ایران" class="analogSvg" id="analogSvg" role="img" viewbox="0 0 200 200">
<defs>
<lineargradient id="gradHub" x1="0" x2="1" y1="0" y2="1">
<stop offset="0%" stop-color="var(--gradA)"></stop>
<stop offset="100%" stop-color="var(--gradB)"></stop>
</lineargradient>
<radialgradient cx="35%" cy="25%" id="dialGlow" r="70%">
<stop offset="0%" stop-color="color-mix(in srgb, var(--primary) 22%, transparent 78%)"></stop>
<stop offset="55%" stop-color="transparent"></stop>
<stop offset="100%" stop-color="rgba(0,0,0,.25)"></stop>
</radialgradient>
</defs>
<circle cx="100" cy="100" fill="url(#dialGlow)" r="96"></circle>
<circle class="analogRing" cx="100" cy="100" fill="transparent" r="86"></circle>
<g id="analogTicks"></g>
<g id="analogNums"></g>
<!-- Hands (origin: center) -->
<g id="hands">
<line class="handLine handHourLine" id="handHour" x1="100" x2="100" y1="104" y2="60"></line>
<line class="handLine handMinLine" id="handMin" x1="100" x2="100" y1="106" y2="42"></line>
<line class="handLine handSecLine" id="handSec" x1="100" x2="100" y1="112" y2="36"></line>
</g>
<circle class="analogHub" cx="100" cy="100" r="7.5"></circle>
<circle cx="100" cy="100" fill="rgba(255,255,255,.8)" r="2.2"></circle>
<text class="analogBrand" x="100" y="142">codeisa</text>
</svg>
</div>
<div class="tiny text-amber-200" id="timeStatusText">در حال دریافت…</div>
</div>
</div>
</div>
<div class="soft p-4 rounded-2xl mt-3" id="occCard">
<div class="flex items-center justify-between gap-2 flex-wrap">
<div class="font-bold">مناسبت‌های امروز</div>
<div class="tiny font-semibold text-rose-200 hidden" id="occHolidayBadge">تعطیل</div>
</div>
<div class="mt-3 space-y-2" id="occList"></div>
<div class="muted tiny mt-2" id="occHint">این بخش بر اساس تاریخ امروز ایران بارگذاری می‌شود.</div>
</div>
</section>
<!-- Weather Page -->
<section class="hidden space-y-4 md:space-y-5" id="page-weather">
<div class="card p-4 md:p-5">
<div class="flex items-start justify-between gap-3 flex-wrap">
<div>
<h2 class="text-base md:text-lg font-bold">آب‌ و هوا</h2>
<p class="muted tiny mt-1">نمایش جزئیات شبیه Google Weather (با داده‌های Open‑Meteo) • مراکز استان + جستجوی شهرهای ایران</p>
</div>
<div class="flex gap-2 flex-wrap">
<button class="btn px-3 py-2 soft focusable" id="weatherRefreshBtn" type="button">به‌روزرسانی</button>
<button class="btn px-3 py-2 soft focusable" id="weatherCopyBtn" type="button">کپی</button>
</div>
</div>
<div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3 items-start">
<!-- Left: choose city -->
<div class="soft p-4 rounded-2xl min-w-0 w-full overflow-hidden">
<div class="font-bold">انتخاب سریع (مراکز استان)</div>
<div class="muted tiny mt-1">یکی از مراکز استان را انتخاب کنید.</div>
<select class="mt-3 w-full px-3 py-2.5 rounded-xl focusable" id="weatherCapitalSel"></select>
<div class="mt-4">
<div class="font-bold">جستجوی شهر</div>
<div class="muted tiny mt-1">نام شهر را تایپ کنید (مثلاً «شیراز» یا «Shiraz»).</div>
<input autocomplete="off" class="mt-3 w-full px-3 py-2.5 rounded-xl focusable" id="weatherSearchInput" placeholder="جستجو در شهرهای ایران…"/>
<div class="mt-3 space-y-2" id="weatherSearchResults"></div>
</div>
<div class="mt-4 tiny text-amber-200" id="weatherStatus">برای شروع، یک شهر انتخاب کنید.</div>
</div>
<!-- Right: weather details -->
<div class="soft p-4 rounded-2xl min-w-0 w-full overflow-hidden">
<div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 min-w-0">
<div>
<div class="muted tiny">شهر انتخاب‌شده</div>
<div class="text-xl md:text-2xl font-extrabold mt-1" id="weatherCityTitle">—</div>
<div class="muted tiny mt-1" id="weatherSubTitle">—</div>
</div>
<div class="flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-start">
<div class="text-5xl sm:text-6xl leading-none shrink-0" id="weatherIcon">⛅</div>
<div class="text-right min-w-0">
<div class="muted tiny">اکنون</div>
<div class="text-4xl sm:text-5xl font-extrabold calcDisplay"><span id="weatherTemp">—</span></div>
<div class="muted tiny mt-1">دمای احساسی: <span class="font-semibold" id="weatherFeels">—</span></div>
</div>
</div>
</div>
<!-- Narrative banner -->
<div class="mt-4 soft p-3 rounded-xl flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2" id="weatherNarrative">
<div class="flex items-center gap-2">
<span class="text-xl">☂️</span>
<div class="tiny">
<div class="font-semibold" id="weatherNarrativeTitle">—</div>
<div class="muted" id="weatherNarrativeSub">—</div>
</div>
</div>
<div class="tiny muted">آخرین بروزرسانی: <span id="weatherUpdatedAt">—</span></div>
</div>
<!-- small stats row -->
<div class="mt-3 grid sm:grid-cols-3 gap-2">
<div class="soft p-3">
<div class="muted tiny">رطوبت</div>
<div class="text-xl font-extrabold calcDisplay"><span id="weatherHumidity">—</span></div>
</div>
<div class="soft p-3">
<div class="muted tiny">باد</div>
<div class="text-xl font-extrabold calcDisplay"><span id="weatherWind">—</span></div>
</div>
<div class="soft p-3">
<div class="muted tiny">وضعیت</div>
<div class="text-xl font-extrabold calcDisplay"><span id="weatherDesc">—</span></div>
</div>
</div>
<!-- Tabs -->
<div class="mt-4 flex gap-2 flex-wrap">
<button class="weatherTab btn px-3 py-2 focusable tabActive" data-wtab="overview" type="button">نمای کلی</button>
<button class="weatherTab btn px-3 py-2 focusable tabIdle" data-wtab="precip" type="button">بارش</button>
<button class="weatherTab btn px-3 py-2 focusable tabIdle" data-wtab="wind" type="button">باد</button>
<button class="weatherTab btn px-3 py-2 focusable tabIdle" data-wtab="humidity" type="button">رطوبت</button>
</div>
<!-- Hourly strip -->
<div class="mt-3 soft p-3 rounded-2xl">
<div class="flex items-center justify-between gap-2">
<div class="font-bold">ساعتی (۱۲ ساعت آینده)</div>
<div class="muted tiny" id="weatherHourlyHint">—</div>
</div>
<div class="mt-3 flex gap-2 overflow-x-auto pb-2 -mx-1 px-1 scrollbar-hide snap-x snap-mandatory" id="weatherHourly"></div>
</div>
<!-- Daily cards -->
<div class="mt-3 soft p-3 rounded-2xl">
<div class="font-bold">چند روز آینده</div>
<div class="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2" id="weatherDaily"></div>
</div>
</div>
</div>
</div>
</section>
<!-- Crypto Page -->
<section class="hidden space-y-4 md:space-y-5" id="page-crypto">
<div class="card p-4 md:p-5">
<div class="flex items-start justify-between gap-3 flex-wrap">
<div>
<h2 class="text-base md:text-lg font-bold">رمزارزها (قیمت لحظه‌ای)</h2>
<p class="muted tiny mt-1">قیمت‌ها از بازار ریالی نوبیتکس دریافت می‌شوند و هر چند ثانیه به‌روزرسانی می‌گردند.</p>
</div>
<div class="flex items-center gap-2 flex-wrap">
<div class="soft px-3 py-2 rounded-xl flex items-center gap-2">
<span class="w-2.5 h-2.5 rounded-full bg-amber-400" id="cryptoStatusDot"></span>
<span class="font-semibold text-amber-200 tiny" id="cryptoStatusText">در حال اتصال…</span>
</div>
<button class="btn px-3 py-2 soft focusable" id="cryptoRefreshBtn" type="button">به‌روزرسانی</button>
<button class="btn px-3 py-2 soft focusable" id="cryptoCopyAllBtn" type="button">کپی همه</button>
</div>
</div>
<div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-3" id="cryptoGrid"></div>
<div class="mt-3 soft p-3 rounded-xl flex items-center justify-between gap-2">
<div class="tiny muted">آخرین بروزرسانی: <span id="cryptoUpdatedAt">—</span></div>
<div class="tiny muted">واحد: تومان</div>
</div>
</div>
</section>
<!-- Calculator Page -->
<section class="hidden space-y-4 md:space-y-5" id="page-calculator">
<div class="calcShell p-4 md:p-6">
<div class="relative flex items-start justify-between gap-3">
<div>
<h2 class="text-base md:text-lg font-extrabold">ماشین حساب حرفه‌ای</h2>
<p class="muted tiny mt-1">نمایشگر طبق انتخاب شما در تنظیمات: فارسی یا انگلیسی</p>
</div>
<div class="flex gap-2">
<button class="btn px-3 py-2 soft focusable" id="calcModeBtn" type="button">مهندسی</button>
<button class="btn px-3 py-2 soft focusable" id="calcCopyBtn" type="button">کپی</button>
<button class="btn px-3 py-2 soft focusable" id="calcClearBtn" type="button">پاک‌کردن</button>
</div>
</div>
<div class="mt-4 calcTop p-4 md:p-5">
<div class="flex items-center justify-between gap-3">
<div class="muted tiny">عبارت</div>
<div class="muted tiny">حافظه: <span class="font-bold" id="memBadge">0</span></div>
</div>
<div class="mt-2 soft p-3">
<div class="calcDisplay text-base md:text-lg font-semibold min-h-[28px]" id="calcExpr">—</div>
<div class="muted tiny mt-2">نتیجه</div>
<div class="calcDisplay text-3xl md:text-5xl font-extrabold mt-1" id="calcResult">0</div>
</div>
<div class="mt-3 text-xs muted text-left">
<div class="soft inline-flex items-center gap-2 px-3 py-2">
<span class="grad w-2.5 h-2.5 rounded-full"></span>
<span>Enter = محاسبه</span>
</div>
</div>
</div>
<div class="mt-4 grid grid-cols-4 gap-2 select-none" id="calcPad">
<button class="calcKey calcKeyUtil focusable" data-k="MC" type="button">MC</button>
<button class="calcKey calcKeyUtil focusable" data-k="MR" type="button">MR</button>
<button class="calcKey calcKeyUtil focusable" data-k="M+" type="button">M+</button>
<button class="calcKey calcKeyUtil focusable" data-k="M-" type="button">M-</button>
<button class="calcKey calcKeyUtil focusable" data-k="(" type="button">(</button>
<button class="calcKey calcKeyUtil focusable" data-k=")" type="button">)</button>
<button class="calcKey calcKeyUtil focusable" data-k="%" type="button">٪</button>
<button class="calcKey calcKeyDanger focusable" data-k="DEL" type="button">⌫</button>
<button class="calcKey focusable calcDigit" data-en="7" data-fa="۷" data-k="7" type="button">۷</button>
<button class="calcKey focusable calcDigit" data-en="8" data-fa="۸" data-k="8" type="button">۸</button>
<button class="calcKey focusable calcDigit" data-en="9" data-fa="۹" data-k="9" type="button">۹</button>
<button class="calcKey calcKeyOp focusable" data-k="/" type="button">÷</button>
<button class="calcKey focusable calcDigit" data-en="4" data-fa="۴" data-k="4" type="button">۴</button>
<button class="calcKey focusable calcDigit" data-en="5" data-fa="۵" data-k="5" type="button">۵</button>
<button class="calcKey focusable calcDigit" data-en="6" data-fa="۶" data-k="6" type="button">۶</button>
<button class="calcKey calcKeyOp focusable" data-k="*" type="button">×</button>
<button class="calcKey focusable calcDigit" data-en="1" data-fa="۱" data-k="1" type="button">۱</button>
<button class="calcKey focusable calcDigit" data-en="2" data-fa="۲" data-k="2" type="button">۲</button>
<button class="calcKey focusable calcDigit" data-en="3" data-fa="۳" data-k="3" type="button">۳</button>
<button class="calcKey calcKeyOp focusable" data-k="-" type="button">−</button>
<button class="calcKey focusable calcDigit" data-en="0" data-fa="۰" data-k="0" type="button">۰</button>
<button class="calcKey focusable" data-k="." type="button">.</button>
<button class="calcKey calcKeyOp focusable" data-k="=" type="button">=</button>
<button class="calcKey calcKeyOp focusable" data-k="+" type="button">+</button>
</div>
<div class="mt-3 hidden grid grid-cols-4 gap-2 select-none" id="calcPadSci">
<button class="calcKey calcKeyUtil focusable" data-k="pi" type="button">π</button>
<button class="calcKey calcKeyUtil focusable" data-k="e" type="button">e</button>
<button class="calcKey calcKeyUtil focusable" data-k="^" type="button">xʸ</button>
<button class="calcKey calcKeyUtil focusable" data-k="sqrt(" type="button">√</button>
<button class="calcKey calcKeyUtil focusable" data-k="sin(" type="button">sin</button>
<button class="calcKey calcKeyUtil focusable" data-k="cos(" type="button">cos</button>
<button class="calcKey calcKeyUtil focusable" data-k="tan(" type="button">tan</button>
<button class="calcKey calcKeyUtil focusable" data-k="abs(" type="button">abs</button>
<button class="calcKey calcKeyUtil focusable" data-k="log(" type="button">log</button>
<button class="calcKey calcKeyUtil focusable" data-k="ln(" type="button">ln</button>
<button class="calcKey calcKeyUtil focusable" data-k="pow(" type="button">pow</button>
<button class="calcKey calcKeyUtil focusable" data-k="," type="button">,</button>
</div>
<div class="mt-4 soft p-3 rounded-xl">
<div class="tiny muted">ورود با کیبورد</div>
<div class="muted tiny mt-1">۰-۹ یا 0-9، + - * / ( ) . Enter Backspace</div>
</div>
</div>
</section>
<!-- Settings Page -->
<section class="hidden space-y-4 md:space-y-5" id="page-settings">
<div class="card p-4 md:p-5">
<div class="flex items-start justify-between gap-3">
<div>
<h2 class="text-base md:text-lg font-bold">تنظیمات و شخصی‌سازی</h2>
<p class="muted tiny mt-1">ظاهر و رفتار برنامه را مطابق سلیقه خود تغییر دهید. تنظیمات در همین مرورگر ذخیره می‌شود.</p>
</div>
<button class="btn px-3 py-2 soft focusable" id="resetBtn" type="button">بازنشانی</button>
</div>
<div class="mt-4 grid md:grid-cols-2 lg:grid-cols-3 gap-3">
<div class="soft p-3">
<label class="tiny muted">رنگ پس‌زمینه</label>
<div class="mt-2 flex items-center gap-3">
<input class="w-12 h-10 rounded-xl focusable" id="bgColor" type="color"/>
<input class="flex-1 px-3 py-2 rounded-xl focusable" id="bgColorText" placeholder="#0b1220"/>
</div>
</div>
<div class="soft p-3">
<label class="tiny muted">رنگ کارت‌ها</label>
<div class="mt-2 flex items-center gap-3">
<input class="w-12 h-10 rounded-xl focusable" id="surfaceColor" type="color"/>
<input class="flex-1 px-3 py-2 rounded-xl focusable" id="surfaceColorText" placeholder="#0f1b33"/>
</div>
</div>
<div class="soft p-3">
<label class="tiny muted">رنگ متن</label>
<div class="mt-2 flex items-center gap-3">
<input class="w-12 h-10 rounded-xl focusable" id="textColor" type="color"/>
<input class="flex-1 px-3 py-2 rounded-xl focusable" id="textColorText" placeholder="#e8eefc"/>
</div>
</div>
<div class="soft p-3">
<label class="tiny muted">رنگ اقدام اصلی</label>
<div class="mt-2 flex items-center gap-3">
<input class="w-12 h-10 rounded-xl focusable" id="primaryColor" type="color"/>
<input class="flex-1 px-3 py-2 rounded-xl focusable" id="primaryColorText" placeholder="#38bdf8"/>
</div>
</div>
<div class="soft p-3">
<label class="tiny muted">رنگ اقدام ثانویه</label>
<div class="mt-2 flex items-center gap-3">
<input class="w-12 h-10 rounded-xl focusable" id="secondaryColor" type="color"/>
<input class="flex-1 px-3 py-2 rounded-xl focusable" id="secondaryColorText" placeholder="#a78bfa"/>
</div>
</div>
<div class="soft p-3">
<label class="tiny muted">فونت</label>
<select class="mt-2 w-full px-3 py-2.5 rounded-xl focusable" id="fontFamily">
<option value='ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"'>پیش‌فرض (سیستمی)</option>
<option value='"Vazirmatn", ui-sans-serif, system-ui'>Vazirmatn (اگر نصب باشد)</option>
<option value='"IRANSans", ui-sans-serif, system-ui'>IRANSans (اگر نصب باشد)</option>
<option value='"Tahoma", ui-sans-serif, system-ui'>Tahoma</option>
<option system-ui\'="" ui-sans-serif,="" value="\'&quot;Sahel&quot;,">Sahel (پیشنهادی)</option>
</select>
<div class="muted tiny mt-2">در صورت نبود فونت، به فونت‌های جایگزین می‌رود.</div>
</div>
<div class="soft p-3">
<label class="tiny muted">اندازه متن</label>
<div class="mt-2 flex items-center gap-3">
<input class="w-full" id="fontSize" max="20" min="13" step="1" type="range"/>
<div class="soft px-3 py-2 rounded-xl text-sm w-16 text-center" id="fontSizeLabel">16</div>
</div>
</div>
<div class="soft p-3">
<label class="tiny muted">گرادیان برجسته (شروع)</label>
<div class="mt-2 flex items-center gap-3">
<input class="w-12 h-10 rounded-xl focusable" id="gradA" type="color"/>
<input class="flex-1 px-3 py-2 rounded-xl focusable" id="gradAText" placeholder="#22c55e"/>
</div>
</div>
<div class="soft p-3">
<label class="tiny muted">گرادیان برجسته (پایان)</label>
<div class="mt-2 flex items-center gap-3">
<input class="w-12 h-10 rounded-xl focusable" id="gradB" type="color"/>
<input class="flex-1 px-3 py-2 rounded-xl focusable" id="gradBText" placeholder="#38bdf8"/>
</div>
</div>
<div class="soft p-3 md:col-span-2 lg:col-span-3">
<div class="flex items-center justify-between gap-2">
<div>
<div class="tiny muted">نمایش اعداد فارسی (در کل برنامه)</div>
<div class="muted tiny mt-1">برای خروجی‌ها و بیشتر نمایش‌ها.</div>
</div>
<label class="inline-flex items-center cursor-pointer">
<input class="sr-only" id="persianDigitsToggle" type="checkbox"/>
<span class="w-12 h-7 rounded-full relative soft">
<span class="absolute top-1 right-1 w-5 h-5 rounded-full grad transition-all" id="persianDigitsDot"></span>
</span>
</label>
</div>
<div class="mt-3 flex items-center justify-between gap-2">
<div>
<div class="tiny muted">کپی با اعداد فارسی</div>
<div class="muted tiny mt-1">اگر روشن باشد، متن کپی‌شده هم فارسی می‌شود.</div>
</div>
<label class="inline-flex items-center cursor-pointer">
<input class="sr-only" id="copyPersianToggle" type="checkbox"/>
<span class="w-12 h-7 rounded-full relative soft">
<span class="absolute top-1 right-1 w-5 h-5 rounded-full grad transition-all" id="copyPersianDot"></span>
</span>
</label>
</div>
<div class="mt-3 flex items-center justify-between gap-2">
<div>
<div class="tiny muted">نمایشگر ماشین حساب</div>
<div class="muted tiny mt-1">عددها و نمایشگر ماشین حساب فارسی یا انگلیسی.</div>
</div>
<select class="px-3 py-2 rounded-xl focusable" id="calcDisplayLang">
<option value="fa">فارسی</option>
<option value="en">انگلیسی</option>
</select>
</div>
<div class="mt-3 flex items-center justify-between gap-2">
<div>
<div class="tiny muted">صدای کلیک ماشین حساب</div>
<div class="muted tiny mt-1">صدای ریز هنگام فشردن کلیدها.</div>
</div>
<label class="inline-flex items-center cursor-pointer">
<input class="sr-only" id="soundToggle" type="checkbox"/>
<span class="w-12 h-7 rounded-full relative soft">
<span class="absolute top-1 right-1 w-5 h-5 rounded-full grad transition-all" id="soundDot"></span>
</span>
</label>
</div>
<div class="mt-3">
<div class="tiny muted">شدت صدا</div>
<div class="mt-2 flex items-center gap-3">
<input class="w-full" id="soundVolume" max="100" min="0" step="1" type="range"/>
<div class="soft px-3 py-2 rounded-xl text-sm w-16 text-center" id="soundVolumeLabel">30</div>
</div>
</div>
<div class="mt-4 soft p-3">
<div class="font-bold">پیکربندی (Config)</div>
<p class="muted tiny mt-1">کپی/وارد کردن پیکربندی برای بکاپ گرفتن از تنظیمات.</p>
<div class="mt-2 grid md:grid-cols-2 gap-2">
<button class="btn px-3 py-2 soft focusable" id="exportConfig" type="button">کپی پیکربندی</button>
<button class="btn px-3 py-2 soft focusable" id="importConfig" type="button">وارد کردن پیکربندی</button>
</div>
</div>
</div>
</div>
</div>
</section>
<!-- Help Page -->
<section class="hidden space-y-4 md:space-y-5" id="page-help">
<div class="card p-4 md:p-5">
<h2 class="text-base md:text-lg font-bold">راهنما</h2>
<div class="mt-3 space-y-3 leading-7">
<div class="soft p-3">
<div class="font-bold">شروع سریع</div>
<ul class="mt-2 list-disc pr-5 muted">
<li>از نوار بالا بخش موردنظر را انتخاب کنید (تبدیل واحد، سلامتی، تاریخ و ساعت، کریپتو، ماشین حساب، تنظیمات).</li>
<li>همه محاسبات داخل مرورگر انجام می‌شود و اطلاعات شما روی سرور ذخیره نمی‌شود (به‌جز دریافت داده‌های آنلاین مثل ساعت و قیمت‌ها).</li>
</ul>
</div>
<div class="soft p-3">
<div class="font-bold">تبدیل واحد</div>
<ul class="mt-2 list-disc pr-5 muted">
<li>مقدار را وارد کنید، واحد مبدا و مقصد را انتخاب کنید؛ نتیجه فوری نمایش داده می‌شود.</li>
<li>با «جابجایی» واحدها سریع جای مبدا/مقصد را عوض کنید.</li>
<li>دقت اعشار را از اسلایدر دقت تنظیم کنید.</li>
</ul>
</div>
<div class="soft p-3">
<div class="font-bold">تاریخ و ساعت</div>
<ul class="mt-2 list-disc pr-5 muted">
<li>ساعت ایران و ساعت جهانی از سرویس آنلاین به‌روز می‌شوند.</li>
<li>ساعت آنالوگ هر دقیقه همگام می‌شود و ثانیه‌شمار بدون قطع شدن ادامه می‌دهد.</li>
<li>مناسبت‌های همان روز نمایش داده می‌شود؛ موارد تعطیل با رنگ قرمز و برچسب «تعطیل» مشخص هستند.</li>
</ul>
</div>
<div class="soft p-3">
<div class="font-bold">کریپتو</div>
<ul class="mt-2 list-disc pr-5 muted">
<li>قیمت ارزها به‌صورت زنده نمایش داده می‌شود و هر چند ثانیه یکبار به‌روزرسانی می‌گردد.</li>
<li>اگر اینترنت یا سرویس قیمت‌دهی مشکل داشته باشد، ممکن است برای لحظاتی «—» نمایش داده شود.</li>
</ul>
</div>
<div class="soft p-3">
<div class="font-bold">ماشین حساب</div>
<ul class="mt-2 list-disc pr-5 muted">
<li>ماشین حساب دو حالت دارد: ساده و مهندسی (با دکمه «مهندسی/ساده» جابجا شوید).</li>
<li>با کیبورد هم می‌توانید وارد کنید: ۰-۹ یا 0-9، + - * / ( ) . Enter Backspace</li>
<li>نمایشگر و اعداد کلیدها از تنظیمات قابل تغییر بین فارسی و انگلیسی است.</li>
</ul>
</div>
<div class="soft p-3">
<div class="font-bold">سلامتی</div>
<ul class="mt-2 list-disc pr-5 muted">
<li>BMI و کالری روزانه برای تخمین استفاده می‌شوند و جایگزین نظر پزشک نیستند.</li>
<li>در «راهنمای آزمایش» می‌توانید نام آیتم را انتخاب کنید و یک تفسیر سریع و آموزشی ببینید.</li>
</ul>
</div>
<div class="soft p-3">
<div class="font-bold">تنظیمات</div>
<ul class="mt-2 list-disc pr-5 muted">
<li>رنگ‌ها، فونت و نمایش اعداد را شخصی‌سازی کنید؛ تنظیمات در همین مرورگر ذخیره می‌شود.</li>
<li>برای برگشت به حالت اولیه از دکمه بازنشانی استفاده کنید.</li>
</ul>
</div>
</div>
</div>
</section>
</main>
<!-- Footer -->
<footer class="mt-6 md:mt-8 pb-6 text-center muted tiny">
<div class="flex flex-col gap-2 items-center">
<span id="footerOut">طراحی شده توسط FARHAD 🎨</span>
<a class="text-sky-300 underline underline-offset-4" href="https://t.me/ShadowPsychologist" rel="noopener" target="_blank"><span class="inline-flex items-center gap-2"><svg aria-hidden="true" height="18" viewbox="0 0 24 24" width="18"><path d="M9.04 15.15 8.8 19.1c.37 0 .54-.16.74-.35l1.78-1.7 3.69 2.7c.68.38 1.16.18 1.34-.63l2.43-11.37c.21-.99-.36-1.38-1.02-1.13L3.39 10.13c-.95.37-.94.9-.17 1.14l3.96 1.24 9.2-5.8c.43-.27.82-.12.5.15z" fill="#38bdf8"></path><path d="M7.35 12.51 16.3 6.86c.41-.26.79-.12.48.16L9.04 15.15l-.3 3.95c.46 0 .66-.21.92-.47l2.21-2.12 4.6 3.37c.85.47 1.45.23 1.66-.79l2.99-13.8c.24-1.09-.41-1.54-1.18-1.24L2.6 9.9c-1.11.43-1.09 1.05-.19 1.33z" fill="#38bdf8"></path></svg><span>ارتباط با سازنده</span></span></a>
</div>
</footer>
</div>
<!-- Toasts -->
<div class="fixed bottom-4 left-4 right-4 md:left-auto md:right-6 md:bottom-6 z-50 space-y-2 w-auto max-w-md" id="toastHost"></div>
<script>
/* ========================= Utilities ========================= */
const clamp=(n,min,max)=>Math.min(max,Math.max(min,n));
const escapeHtml=(s)=>String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

const toLatinDigits = (str) => {
  const map = {
    '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9',
    '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9',
    '−':'-','–':'-','—':'-','٫':'.','٬':'',',':''
  };
  return String(str ?? '').replace(/[۰-۹٠-٩−–—٫٬,]/g, ch => map[ch] ?? ch);
};

const safeNum=(v)=> {
  if (typeof v === "number") return Number.isFinite(v) ? v : NaN;
  const s=toLatinDigits((v??"").toString().trim());
  if(!s) return NaN;
  const x=Number(s);
  return Number.isFinite(x) ? x : NaN;
};

const toPersianDigits=(str)=>{
  const map = {'0':'۰','1':'۱','2':'۲','3':'۳','4':'۴','5':'۵','6':'۶','7':'۷','8':'۸','9':'۹','-':'−'};
  return String(str).replace(/[0-9-]/g, ch => map[ch] ?? ch);
};

const formatNumber=(n, precision)=>{
  if(!Number.isFinite(n)) return "—";
  const p=clamp(precision,0,12);
  const fixed = n.toFixed(p);
  const cleaned = (Math.abs(Number(fixed))===0) ? (0).toFixed(p) : fixed;
  if(p===0) return String(Number(cleaned));
  return cleaned.replace(/(\.\d*?)0+$/,'$1').replace(/\.$/,'');
};

const showToast=(msg,type="info")=>{
  const host=document.getElementById("toastHost");
  const el=document.createElement("div");
  const tone = {
    info: "border-sky-400/40 bg-sky-400/10",
    ok: "border-emerald-400/40 bg-emerald-400/10",
    warn: "border-amber-400/40 bg-amber-400/10",
    err: "border-rose-400/40 bg-rose-400/10"
  }[type] || "border-sky-400/40 bg-sky-400/10";
  el.className=`toast card p-3 ${tone}`;
  el.innerHTML = `<div class="flex items-start gap-3">
    <div class="grad w-9 h-9 rounded-xl flex items-center justify-center shrink-0">✦</div>
    <div class="text-sm leading-6">${escapeHtml(msg)}</div>
  </div>`;
  host.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; el.style.transition="250ms"; }, 2400);
  setTimeout(()=>el.remove(), 2750);
};

const copyText = async (text, okMsg="کپی شد ✅") => {
  try{
    await navigator.clipboard.writeText(text);
    showToast(okMsg, "ok");
  }catch{
    showToast("امکان کپی وجود ندارد. لطفاً مجوز کلیپ‌بورد را بررسی کنید.", "err");
  }
};

/* ========================= Config System ========================= */
const FIXED_FOOTER_TEXT = "طراحی شده توسط FARHAD 🎨";

const defaultConfig = {
  background_color:"#0b1220",
  surface_color:"#0f1b33",
  text_color:"#e8eefc",
  primary_action:"#38bdf8",
  secondary_action:"#a78bfa",
  font_family:'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"',
  font_size:16,
  accent_gradient_start:"#22c55e",
  accent_gradient_end:"#38bdf8",
  app_logo_emoji:"🔄",
  enable_persian_digits:true,
  copy_with_persian_digits:false,
  precision:2,
  enable_click_sound:true,
  click_volume:30,
  calculator_display_lang:"fa"
};

const elementSdk = (() => {
  const listeners = new Set();
  let config = loadConfig();
  function sanitize(partial){
    const p = {...(partial||{})};
    if ("footer_text" in p) delete p.footer_text;
    if ("app_logo_emoji" in p) delete p.app_logo_emoji;
    return p;
  }
  function loadConfig(){
    try{
      const raw=localStorage.getItem("proUnitConverter.config");
      if(!raw) return {...defaultConfig};
      const parsed=sanitize(JSON.parse(raw));
      return {...defaultConfig, ...(parsed||{})};
    }catch{ return {...defaultConfig}; }
  }
  function saveConfig(){ localStorage.setItem("proUnitConverter.config", JSON.stringify(config)); }
  function setConfig(partial){
    const clean = sanitize(partial);
    config = {...config, ...(clean||{})};
    saveConfig();
    listeners.forEach(fn=>fn(config));
  }
  function onConfigChange(fn){ listeners.add(fn); return ()=>listeners.delete(fn); }
  function mapToCapabilities(cfg){
    return {
      theme:{
        background: cfg.background_color,
        surface: cfg.surface_color,
        text: cfg.text_color,
        primary: cfg.primary_action,
        secondary: cfg.secondary_action,
        gradA: cfg.accent_gradient_start,
        gradB: cfg.accent_gradient_end
      },
      typography:{ fontFamily: cfg.font_family, fontSize: cfg.font_size },
      behavior:{
        enablePersianDigits: !!cfg.enable_persian_digits,
        copyWithPersianDigits: !!cfg.copy_with_persian_digits,
        precision: clamp(Number(cfg.precision ?? 2),0,8)
      },
      branding:{ logoEmoji: cfg.app_logo_emoji },
      sound:{ enabled: !!cfg.enable_click_sound, volume: clamp(Number(cfg.click_volume ?? 30),0,100) },
      calculator:{ displayLang: (cfg.calculator_display_lang==="en" ? "en" : "fa") }
    };
  }
  function attachExternal(){
    if (window.elementSdk && window.elementSdk !== api) return;
    window.elementSdk = api;
  }
  const api = { getConfig:()=>({...config}), setConfig, onConfigChange, mapToCapabilities, _attachExternal:attachExternal };
  attachExternal();
  return api;
})();

const displayNum = (x) => {
  const cfg = elementSdk.getConfig();
  const s = String(x);
  return cfg.enable_persian_digits ? toPersianDigits(s) : s;
};

const setToggleUI = (input, dot, on) => {
  input.checked = !!on;
  dot.style.right = on ? "1.75rem" : "0.25rem";
  dot.style.left = "auto";
};

const updateCalculatorDigitLabels = (lang) => {
  document.querySelectorAll(".calcDigit").forEach(btn=>{
    const fa = btn.getAttribute("data-fa");
    const en = btn.getAttribute("data-en");
    btn.textContent = (lang==="en") ? en : fa;
  });
};

const applyConfig = (cfg) => {
  const caps = elementSdk.mapToCapabilities(cfg);
  const r = document.documentElement.style;
  r.setProperty("--bg", caps.theme.background);
  r.setProperty("--surface", caps.theme.surface);
  r.setProperty("--text", caps.theme.text);
  r.setProperty("--primary", caps.theme.primary);
  r.setProperty("--secondary", caps.theme.secondary);
  r.setProperty("--gradA", caps.theme.gradA);
  r.setProperty("--gradB", caps.theme.gradB);
  r.setProperty("--ff", caps.typography.fontFamily);
  r.setProperty("--fs", `${caps.typography.fontSize}px`);

  document.getElementById("footerOut").textContent = FIXED_FOOTER_TEXT;

  setToggleUI(document.getElementById("persianDigitsToggle"), document.getElementById("persianDigitsDot"), caps.behavior.enablePersianDigits);
  setToggleUI(document.getElementById("uiPersianDigitsToggle"), document.getElementById("uiPersianDigitsDot"), caps.behavior.enablePersianDigits);
  setToggleUI(document.getElementById("copyPersianToggle"), document.getElementById("copyPersianDot"), caps.behavior.copyWithPersianDigits);

  setToggleUI(document.getElementById("soundToggle"), document.getElementById("soundDot"), caps.sound.enabled);
  document.getElementById("soundVolume").value = caps.sound.volume;
  document.getElementById("soundVolumeLabel").textContent = displayNum(caps.sound.volume);

  document.getElementById("precisionRange").value = caps.behavior.precision;
  document.getElementById("precisionLabel").textContent = displayNum(caps.behavior.precision);

  document.getElementById("calcDisplayLang").value = caps.calculator.displayLang;
  updateCalculatorDigitLabels(caps.calculator.displayLang);
};

/* ========================= Navigation ========================= */
const pages = ["converter","health","datetime","weather","crypto","calculator","settings","help"];
const showPage = (id) => {
  const target = pages.includes(id) ? id : "converter";
  for(const p of pages){
    const el=document.getElementById(`page-${p}`);
    if(el) el.classList.toggle("hidden", p!==target);
  }
  document.querySelectorAll(".navBtn").forEach(btn=>{
    const active = btn.dataset.nav===target;
    btn.classList.toggle("tabActive", active);
    btn.classList.toggle("tabIdle", !active);
  });
  try{ history.replaceState(null,"",`#${target}`); }catch{}
};

const bindNav = () => {
  document.getElementById("topNav").addEventListener("click", (e)=>{
    const btn = e.target.closest(".navBtn");
    if(!btn) return;
    showPage(btn.dataset.nav);
  });
};

const maybePersianForCopy = (txt) => {
  const cfg=elementSdk.getConfig();
  return cfg.copy_with_persian_digits ? toPersianDigits(txt) : txt;
};

/* ========================= Unit Converter Data (10+ دسته) ========================= */
const UNIT = (label, symbol, toBase, fromBase) => ({label, symbol, toBase, fromBase});
const linearUnits = (units) => ({type:"linear", units});
const tempUnits = () => ({
  type:"temp",
  units:[
    {label:"سلسیوس", symbol:"°C", toBase:(c)=>c, fromBase:(c)=>c},
    {label:"فارنهایت", symbol:"°F", toBase:(f)=>(f-32)*5/9, fromBase:(c)=>c*9/5+32},
    {label:"کلوین", symbol:"K", toBase:(k)=>k-273.15, fromBase:(c)=>c+273.15},
  ]
});

const CATEGORIES = [
  { id:"length", name:"طول",
    def: linearUnits([
      UNIT("میلی‌متر","mm", v=>v/1000, v=>v*1000),
      UNIT("سانتی‌متر","cm", v=>v/100, v=>v*100),
      UNIT("متر","m", v=>v, v=>v),
      UNIT("کیلومتر","km", v=>v*1000, v=>v/1000),
      UNIT("اینچ","in", v=>v*0.0254, v=>v/0.0254),
      UNIT("فوت","ft", v=>v*0.3048, v=>v/0.3048),
      UNIT("یارد","yd", v=>v*0.9144, v=>v/0.9144),
      UNIT("مایل","mi", v=>v*1609.344, v=>v/1609.344),
      UNIT("مایل دریایی","nmi", v=>v*1852, v=>v/1852),
    ]),
    quick:[
      {title:"۱ کیلومتر → متر", value:1, from:"کیلومتر", to:"متر"},
      {title:"۱ مایل → کیلومتر", value:1, from:"مایل", to:"کیلومتر"},
      {title:"۳۰ سانتی‌متر → اینچ", value:30, from:"سانتی‌متر", to:"اینچ"},
      {title:"۶ فوت → سانتی‌متر", value:6, from:"فوت", to:"سانتی‌متر"},
    ]
  },
  { id:"mass", name:"جرم",
    def: linearUnits([
      UNIT("میلی‌گرم","mg", v=>v/1e6, v=>v*1e6),
      UNIT("گرم","g", v=>v/1000, v=>v*1000),
      UNIT("کیلوگرم","kg", v=>v, v=>v),
      UNIT("تن","t", v=>v*1000, v=>v/1000),
      UNIT("اونس","oz", v=>v*0.028349523125, v=>v/0.028349523125),
      UNIT("پوند","lb", v=>v*0.45359237, v=>v/0.45359237),
    ]),
    quick:[
      {title:"۱ کیلوگرم → گرم", value:1, from:"کیلوگرم", to:"گرم"},
      {title:"۱ پوند → کیلوگرم", value:1, from:"پوند", to:"کیلوگرم"},
      {title:"۵۰۰ گرم → پوند", value:500, from:"گرم", to:"پوند"},
      {title:"۲ اونس → گرم", value:2, from:"اونس", to:"گرم"},
    ]
  },
  { id:"temp", name:"دما", def: tempUnits(),
    quick:[
      {title:"۰°C → °F", value:0, from:"سلسیوس", to:"فارنهایت"},
      {title:"۱۰۰°C → °F", value:100, from:"سلسیوس", to:"فارنهایت"},
      {title:"۳۷°C → °F", value:37, from:"سلسیوس", to:"فارنهایت"},
      {title:"۲۷۳.۱۵K → °C", value:273.15, from:"کلوین", to:"سلسیوس"},
    ]
  },
  { id:"area", name:"مساحت",
    def: linearUnits([
      UNIT("میلی‌متر مربع","mm²", v=>v/1e6, v=>v*1e6),
      UNIT("سانتی‌متر مربع","cm²", v=>v/1e4, v=>v*1e4),
      UNIT("متر مربع","m²", v=>v, v=>v),
      UNIT("کیلومتر مربع","km²", v=>v*1e6, v=>v/1e6),
      UNIT("هکتار","ha", v=>v*10000, v=>v/10000),
      UNIT("اینچ مربع","in²", v=>v*0.00064516, v=>v/0.00064516),
      UNIT("فوت مربع","ft²", v=>v*0.09290304, v=>v/0.09290304),
      UNIT("یارد مربع","yd²", v=>v*0.83612736, v=>v/0.83612736),
      UNIT("ایکر","acre", v=>v*4046.8564224, v=>v/4046.8564224),
    ]),
    quick:[
      {title:"۱ هکتار → متر مربع", value:1, from:"هکتار", to:"متر مربع"},
      {title:"۱ متر مربع → فوت مربع", value:1, from:"متر مربع", to:"فوت مربع"},
      {title:"۱ ایکر → متر مربع", value:1, from:"ایکر", to:"متر مربع"},
      {title:"۵۰ متر مربع → سانتی‌متر مربع", value:50, from:"متر مربع", to:"سانتی‌متر مربع"},
    ]
  },
  { id:"volume", name:"حجم",
    def: linearUnits([
      UNIT("میلی‌لیتر","mL", v=>v/1000, v=>v*1000),
      UNIT("لیتر","L", v=>v, v=>v),
      UNIT("متر مکعب","m³", v=>v*1000, v=>v/1000),
      UNIT("سانتی‌متر مکعب","cm³", v=>v/1000, v=>v*1000),
      UNIT("گالن (آمریکا)","gal", v=>v*3.785411784, v=>v/3.785411784),
      UNIT("کوارت (آمریکا)","qt", v=>v*0.946352946, v=>v/0.946352946),
      UNIT("پینت (آمریکا)","pt", v=>v*0.473176473, v=>v/0.473176473),
      UNIT("فنجان (آمریکا)","cup", v=>v*0.2365882365, v=>v/0.2365882365),
      UNIT("اونس مایع (آمریکا)","fl oz", v=>v*0.0295735295625, v=>v/0.0295735295625),
    ]),
    quick:[
      {title:"۱ لیتر → میلی‌لیتر", value:1, from:"لیتر", to:"میلی‌لیتر"},
      {title:"۱ گالن → لیتر", value:1, from:"گالن (آمریکا)", to:"لیتر"},
      {title:"۲۵۰ میلی‌لیتر → لیتر", value:250, from:"میلی‌لیتر", to:"لیتر"},
      {title:"۱ متر مکعب → لیتر", value:1, from:"متر مکعب", to:"لیتر"},
    ]
  },
  { id:"speed", name:"سرعت",
    def: linearUnits([
      UNIT("متر بر ثانیه","m/s", v=>v, v=>v),
      UNIT("کیلومتر بر ساعت","km/h", v=>v/3.6, v=>v*3.6),
      UNIT("مایل بر ساعت","mph", v=>v*0.44704, v=>v/0.44704),
      UNIT("گره (نات)","kt", v=>v*0.514444, v=>v/0.514444),
      UNIT("فوت بر ثانیه","ft/s", v=>v*0.3048, v=>v/0.3048),
    ]),
    quick:[
      {title:"۱۰۰ km/h → m/s", value:100, from:"کیلومتر بر ساعت", to:"متر بر ثانیه"},
      {title:"۱۰ m/s → km/h", value:10, from:"متر بر ثانیه", to:"کیلومتر بر ساعت"},
      {title:"۶۰ mph → km/h", value:60, from:"مایل بر ساعت", to:"کیلومتر بر ساعت"},
      {title:"۲۰ kt → km/h", value:20, from:"گره (نات)", to:"کیلومتر بر ساعت"},
    ]
  },
  { id:"time", name:"زمان",
    def: linearUnits([
      UNIT("میلی‌ثانیه","ms", v=>v/1000, v=>v*1000),
      UNIT("ثانیه","s", v=>v, v=>v),
      UNIT("دقیقه","min", v=>v*60, v=>v/60),
      UNIT("ساعت","h", v=>v*3600, v=>v/3600),
      UNIT("روز","day", v=>v*86400, v=>v/86400),
      UNIT("هفته","week", v=>v*604800, v=>v/604800),
    ]),
    quick:[
      {title:"۹۰ دقیقه → ساعت", value:90, from:"دقیقه", to:"ساعت"},
      {title:"۱ روز → ساعت", value:1, from:"روز", to:"ساعت"},
      {title:"۳۶۰۰ ثانیه → ساعت", value:3600, from:"ثانیه", to:"ساعت"},
      {title:"۲ هفته → روز", value:2, from:"هفته", to:"روز"},
    ]
  },
  { id:"pressure", name:"فشار",
    def: linearUnits([
      UNIT("پاسکال","Pa", v=>v, v=>v),
      UNIT("کیلوپاسکال","kPa", v=>v*1000, v=>v/1000),
      UNIT("بار","bar", v=>v*100000, v=>v/100000),
      UNIT("اتمسفر","atm", v=>v*101325, v=>v/101325),
      UNIT("میلی‌متر جیوه","mmHg", v=>v*133.322368421, v=>v/133.322368421),
      UNIT("psi","psi", v=>v*6894.757293168, v=>v/6894.757293168),
    ]),
    quick:[
      {title:"۱ atm → kPa", value:1, from:"اتمسفر", to:"کیلوپاسکال"},
      {title:"۲ bar → psi", value:2, from:"بار", to:"psi"},
      {title:"۷۶۰ mmHg → atm", value:760, from:"میلی‌متر جیوه", to:"اتمسفر"},
      {title:"۱۰۰ kPa → bar", value:100, from:"کیلوپاسکال", to:"بار"},
    ]
  },
  { id:"energy", name:"انرژی",
    def: linearUnits([
      UNIT("ژول","J", v=>v, v=>v),
      UNIT("کیلوژول","kJ", v=>v*1000, v=>v/1000),
      UNIT("کالری","cal", v=>v*4.184, v=>v/4.184),
      UNIT("کیلوکالری","kcal", v=>v*4184, v=>v/4184),
      UNIT("وات‌ساعت","Wh", v=>v*3600, v=>v/3600),
      UNIT("کیلووات‌ساعت","kWh", v=>v*3.6e6, v=>v/3.6e6),
      UNIT("الکترون‌ولت","eV", v=>v*1.602176634e-19, v=>v/1.602176634e-19),
    ]),
    quick:[
      {title:"۱۰۰۰ J → kJ", value:1000, from:"ژول", to:"کیلوژول"},
      {title:"۵۰۰ kcal → kJ", value:500, from:"کیلوکالری", to:"کیلوژول"},
      {title:"۱ kWh → J", value:1, from:"کیلووات‌ساعت", to:"ژول"},
      {title:"۲۵۰ Wh → kWh", value:250, from:"وات‌ساعت", to:"کیلووات‌ساعت"},
    ]
  },
  { id:"data", name:"داده (حجم فایل)",
    def: linearUnits([
      UNIT("بیت","b", v=>v/8, v=>v*8),
      UNIT("بایت","B", v=>v, v=>v),
      UNIT("کیلوبایت","KB", v=>v*1000, v=>v/1000),
      UNIT("مگابایت","MB", v=>v*1e6, v=>v/1e6),
      UNIT("گیگابایت","GB", v=>v*1e9, v=>v/1e9),
      UNIT("ترابایت","TB", v=>v*1e12, v=>v/1e12),
      UNIT("کیبی‌بایت","KiB", v=>v*1024, v=>v/1024),
      UNIT("مبی‌بایت","MiB", v=>v*1024*1024, v=>v/(1024*1024)),
      UNIT("گیبی‌بایت","GiB", v=>v*1024*1024*1024, v=>v/(1024*1024*1024)),
    ]),
    quick:[
      {title:"۱۰۲۴ KiB → MiB", value:1024, from:"کیبی‌بایت", to:"مبی‌بایت"},
      {title:"۱ GB → MB", value:1, from:"گیگابایت", to:"مگابایت"},
      {title:"۸ بیت → بایت", value:8, from:"بیت", to:"بایت"},
      {title:"۵۰۰ MB → GB", value:500, from:"مگابایت", to:"گیگابایت"},
    ]
  },,
{ id:"power", name:"توان",
  def: linearUnits([
    UNIT("وات","W", v=>v, v=>v),
    UNIT("کیلووات","kW", v=>v*1000, v=>v/1000),
    UNIT("مگاوات","MW", v=>v*1e6, v=>v/1e6),
    UNIT("اسب‌بخار (متریک)","hp", v=>v*735.49875, v=>v/735.49875),
  ]),
  quick:[
    {title:"۱ kW → W", value:1, from:"کیلووات", to:"وات"},
    {title:"۱ hp → kW", value:1, from:"اسب‌بخار (متریک)", to:"کیلووات"},
    {title:"۵۰۰ W → kW", value:500, from:"وات", to:"کیلووات"},
  ]
},
{ id:"force", name:"نیرو",
  def: linearUnits([
    UNIT("نیوتن","N", v=>v, v=>v),
    UNIT("کیلو نیوتن","kN", v=>v*1000, v=>v/1000),
    UNIT("داین","dyn", v=>v*1e-5, v=>v/1e-5),
    UNIT("کیلوگرم-نیرو","kgf", v=>v*9.80665, v=>v/9.80665),
    UNIT("پوند-نیرو","lbf", v=>v*4.4482216152605, v=>v/4.4482216152605),
  ]),
  quick:[
    {title:"۱ kgf → N", value:1, from:"کیلوگرم-نیرو", to:"نیوتن"},
    {title:"۱۰۰ N → kgf", value:100, from:"نیوتن", to:"کیلوگرم-نیرو"},
    {title:"۱۰ lbf → N", value:10, from:"پوند-نیرو", to:"نیوتن"},
  ]
},
{ id:"angle", name:"زاویه",
  def: linearUnits([
    UNIT("درجه","°", v=>v, v=>v),
    UNIT("رادیان","rad", v=>v*180/Math.PI, v=>v*Math.PI/180),
    UNIT("گرادیان","gon", v=>v*0.9, v=>v/0.9),
  ]),
  quick:[
    {title:"π رادیان → درجه", value:Math.PI, from:"رادیان", to:"درجه"},
    {title:"۱۸۰ درجه → رادیان", value:180, from:"درجه", to:"رادیان"},
  ]
},
{ id:"frequency", name:"فرکانس",
  def: linearUnits([
    UNIT("هرتز","Hz", v=>v, v=>v),
    UNIT("کیلوهرتز","kHz", v=>v*1000, v=>v/1000),
    UNIT("مگاهرتز","MHz", v=>v*1e6, v=>v/1e6),
    UNIT("گیگاهرتز","GHz", v=>v*1e9, v=>v/1e9),
  ]),
  quick:[
    {title:"۱ GHz → MHz", value:1, from:"گیگاهرتز", to:"مگاهرتز"},
    {title:"۴۴۱۰۰ Hz → kHz", value:44100, from:"هرتز", to:"کیلوهرتز"},
  ]
},
];

let state = { categoryId: CATEGORIES[0].id, fromLabel: null, toLabel: null };
const getCategory = (id)=>CATEGORIES.find(c=>c.id===id) || CATEGORIES[0];
const findUnitByLabel = (cat, label) => cat.def.units.find(u=>u.label===label) || cat.def.units[0];
const convertValue = (cat, value, fromUnit, toUnit) => {
  if(!Number.isFinite(value)) return NaN;
  const base = fromUnit.toBase(value);
  return toUnit.fromBase(base);
};

const renderQuick = (cat) => {
  const grid=document.getElementById("quickGrid");
  grid.innerHTML="";
  (cat.quick||[]).slice(0,8).forEach(q=>{
    const b=document.createElement("button");
    b.type="button";
    b.className="btn soft px-3 py-2 text-right focusable";
    b.innerHTML=`<div class="font-semibold text-sm">${escapeHtml(q.title)}</div>
                 <div class="muted tiny mt-0.5">تنظیم سریع</div>`;
    b.addEventListener("click", ()=>{
      document.getElementById("valueInput").value = q.value;
      const fromSel=document.getElementById("fromUnitSel");
      const toSel=document.getElementById("toUnitSel");
      if([...fromSel.options].some(o=>o.value===q.from)) fromSel.value=q.from;
      if([...toSel.options].some(o=>o.value===q.to)) toSel.value=q.to;
      state.fromLabel = fromSel.value;
      state.toLabel = toSel.value;
      computeConverter();
      showToast("تنظیم انجام شد ✅", "ok");
    });
    grid.appendChild(b);
  });
};

const setUnitsForCategory = (catId) => {
  const cat=getCategory(catId);
  const fromSel=document.getElementById("fromUnitSel");
  const toSel=document.getElementById("toUnitSel");
  fromSel.innerHTML=""; toSel.innerHTML="";
  cat.def.units.forEach(u=>{
    const o1=document.createElement("option"); o1.value=u.label; o1.textContent=`${u.label} (${u.symbol})`;
    const o2=document.createElement("option"); o2.value=u.label; o2.textContent=`${u.label} (${u.symbol})`;
    fromSel.appendChild(o1); toSel.appendChild(o2);
  });
  const fromKeep = state.fromLabel && cat.def.units.some(u=>u.label===state.fromLabel) ? state.fromLabel : cat.def.units[0].label;
  const toKeep   = state.toLabel   && cat.def.units.some(u=>u.label===state.toLabel)   ? state.toLabel   : cat.def.units[Math.min(1,cat.def.units.length-1)].label;
  fromSel.value = fromKeep;
  toSel.value = toKeep;
  state.fromLabel = fromKeep;
  state.toLabel = toKeep;
  renderQuick(cat);
  computeConverter();
};

const computeConverter = () => {
  const cfg = elementSdk.getConfig();
  const cat = getCategory(document.getElementById("categorySel").value);
  const fromUnit = findUnitByLabel(cat, document.getElementById("fromUnitSel").value);
  const toUnit = findUnitByLabel(cat, document.getElementById("toUnitSel").value);
  const inputVal = safeNum(document.getElementById("valueInput").value);
  const precision = clamp(Number(cfg.precision ?? 2),0,8);

  const result = convertValue(cat, inputVal, fromUnit, toUnit);
  const rawText = formatNumber(result, precision);
  const shown = cfg.enable_persian_digits ? toPersianDigits(rawText) : rawText;

  document.getElementById("resultValue").textContent = (Number.isFinite(result) ? shown : "—");
  document.getElementById("resultUnit").textContent = `${toUnit.label} (${toUnit.symbol})`;
  document.getElementById("converterNote").textContent = Number.isFinite(inputVal) ? "" : "برای دیدن نتیجه، یک مقدار عددی معتبر وارد کنید.";
};

const swapUnits = () => {
  const fromSel=document.getElementById("fromUnitSel");
  const toSel=document.getElementById("toUnitSel");
  const a=fromSel.value, b=toSel.value;
  fromSel.value=b; toSel.value=a;
  state.fromLabel = fromSel.value;
  state.toLabel = toSel.value;
  computeConverter();
  showToast("واحدها جابجا شدند.", "info");
};

/* ========================= Health Logic ========================= */
const bmiCategory = (bmi) => {
  if(!Number.isFinite(bmi)) return "—";
  if(bmi < 18.5) return "کم‌وزن";
  if(bmi < 25) return "نرمال";
  if(bmi < 30) return "اضافه‌وزن";
  if(bmi < 35) return "چاقی درجه ۱";
  if(bmi < 40) return "چاقی درجه ۲";
  return "چاقی درجه ۳";
};

const calculateBMI = (wKg, hCm) => {
  const h = hCm / 100;
  if(!(wKg>0) || !(h>0)) return NaN;
  return wKg / (h*h);
};

const healthyWeightRange = (hCm) => {
  const h = hCm/100;
  if(!(h>0)) return {min:NaN,max:NaN};
  return {min:18.5*h*h, max:24.9*h*h};
};

const calculateBMR = (sex, wKg, hCm, age) => {
  if(!(wKg>0) || !(hCm>0) || !(age>0)) return NaN;
  const base = 10*wKg + 6.25*hCm - 5*age;
  return sex==="male" ? base + 5 : base - 161;
};

const calculateTDEE = (bmr, activityFactor) => {
  if(!Number.isFinite(bmr) || !Number.isFinite(activityFactor)) return NaN;
  return bmr * activityFactor;
};

const computeBMIUI = () => {
  const cfg=elementSdk.getConfig();
  const p=clamp(Number(cfg.precision ?? 2),0,8);
  const w=safeNum(document.getElementById("bmiWeight").value);
  const h=safeNum(document.getElementById("bmiHeight").value);
  const bmi=calculateBMI(w,h);

  const valRaw = formatNumber(bmi, p);
  document.getElementById("bmiValue").textContent = (Number.isFinite(bmi) ? (cfg.enable_persian_digits ? toPersianDigits(valRaw) : valRaw) : "—");
  document.getElementById("bmiCat").textContent = (Number.isFinite(bmi) ? bmiCategory(bmi) : "—");

  const showIdeal = document.getElementById("idealWeightToggle").checked;
  const box = document.getElementById("idealWeightBox");
  box.classList.toggle("hidden", !showIdeal);
  if(showIdeal && Number.isFinite(h) && h>0){
    const r=healthyWeightRange(h);
    const minS = formatNumber(r.min, p);
    const maxS = formatNumber(r.max, p);
    const out = cfg.enable_persian_digits ? `${toPersianDigits(minS)} تا ${toPersianDigits(maxS)}` : `${minS} تا ${maxS}`;
    document.getElementById("idealWeightRange").textContent = out;
  }else if(showIdeal){
    document.getElementById("idealWeightRange").textContent = "—";
  }

  const warn=document.getElementById("bmiWarn");
  warn.classList.add("hidden");
  warn.className="mt-2 hidden tiny";
  if((w && w<25) || (w && w>300) || (h && h<100) || (h && h>230)){
    warn.classList.remove("hidden");
    warn.classList.add("text-amber-200");
    warn.textContent = "هشدار: مقادیر وارد شده کمی غیرمعمول به نظر می‌رسند. لطفاً بررسی کنید.";
  }
};

const computeCaloriesUI = () => {
  const cfg=elementSdk.getConfig();
  const p=clamp(Number(cfg.precision ?? 2),0,8);
  const sex=document.getElementById("sexSel").value;
  const age=safeNum(document.getElementById("ageInput").value);
  const h=safeNum(document.getElementById("calHeight").value);
  const w=safeNum(document.getElementById("calWeight").value);
  const activity=safeNum(document.getElementById("activitySel").value);
  const goalAdj=safeNum(document.getElementById("goalSel").value);

  const err=document.getElementById("calError");
  err.classList.add("hidden");
  err.className="hidden mb-2 text-sm font-semibold";

  if((age && age<=0) || (h && h<=0) || (w && w<=0)){
    err.classList.remove("hidden");
    err.classList.add("text-rose-200");
    err.textContent="خطا: سن، قد و وزن باید بزرگتر از صفر باشند.";
  }

  const bmr=calculateBMR(sex,w,h,age);
  const tdee=calculateTDEE(bmr,activity);
  const goal = Number.isFinite(tdee) ? (tdee + (Number.isFinite(goalAdj)?goalAdj:0)) : NaN;

  const bmrS = Number.isFinite(bmr) ? formatNumber(bmr, p) : "—";
  const tdeeS = Number.isFinite(tdee) ? formatNumber(tdee, p) : "—";
  const goalS = Number.isFinite(goal) ? formatNumber(goal, p) : "—";

  document.getElementById("bmrOut").textContent = cfg.enable_persian_digits ? toPersianDigits(bmrS) : bmrS;
  document.getElementById("tdeeOut").textContent = cfg.enable_persian_digits ? toPersianDigits(tdeeS) : tdeeS;
  document.getElementById("goalOut").textContent = cfg.enable_persian_digits ? toPersianDigits(goalS) : goalS;

  const warn=document.getElementById("calWarn");
  warn.classList.add("hidden");
  warn.className="mt-2 hidden tiny";
  const odd = (age && (age<10 || age>90)) || (h && (h<120 || h>220)) || (w && (w<35 || w>250));
  if(odd){
    warn.classList.remove("hidden");
    warn.classList.add("text-amber-200");
    warn.textContent="هشدار: اعداد وارد شده ممکن است خارج از محدوده معمول باشند. نتیجه صرفاً تخمینی است.";
  }
};

/* ========================= Lab Helper (آموزشی) ========================= */
const LAB_TESTS = [
  { id:"fbs", name:"قند ناشتا (FBS)", unit:"mg/dL", ranges:{ any:{min:70,max:99}}, notes:"قند ناشتا معمولاً باید بین ۷۰ تا ۹۹ باشد. اگر بالاتر باشد، ممکن است نیاز به بررسی بیشتر (پیش‌دیابت/دیابت) باشد." },
  { id:"hba1c", name:"HbA1c (میانگین قند ۳ ماه)", unit:"%", ranges:{ any:{min:4.0,max:5.6}}, notes:"HbA1c زیر ۵.۷ معمولاً نرمال است. ۵.۷ تا ۶.۴ پیش‌دیابت و ۶.۵ به بالا ممکن است دیابت باشد (با تشخیص پزشک)." },
  { id:"chol", name:"کلسترول تام (Chol)", unit:"mg/dL", ranges:{ any:{min:0,max:199}}, notes:"کلسترول تام زیر ۲۰۰ مطلوب است. ۲۰۰–۲۳۹ مرزی، ۲۴۰ به بالا بالا محسوب می‌شود." },
  { id:"ldl", name:"LDL (کلسترول بد)", unit:"mg/dL", ranges:{ any:{min:0,max:129}}, notes:"LDL پایین‌تر بهتر است. زیر ۱۳۰ معمولاً قابل قبول است؛ اهداف دقیق به ریسک قلبی بستگی دارد." },
  { id:"hdl", name:"HDL (کلسترول خوب)", unit:"mg/dL", ranges:{ male:{min:40,max:200}, female:{min:50,max:200}, any:{min:40,max:200}}, notes:"HDL بالاتر بهتر است. در آقایان معمولاً ۴۰ به بالا و در خانم‌ها ۵۰ به بالا مطلوب‌تر است." },
  { id:"tg", name:"تری‌گلیسرید (TG)", unit:"mg/dL", ranges:{ any:{min:0,max:149}}, notes:"TG زیر ۱۵۰ نرمال است. ۱۵۰–۱۹۹ مرزی و ۲۰۰ به بالا بالا محسوب می‌شود." },
  { id:"cr", name:"کراتینین (Creatinine)", unit:"mg/dL", ranges:{ male:{min:0.74,max:1.35}, female:{min:0.59,max:1.04}, any:{min:0.6,max:1.3}}, notes:"کراتینین شاخصی از عملکرد کلیه است. رنج‌ها بسته به آزمایشگاه و عضله بدنی فرق می‌کند." },
  { id:"bun", name:"اوره خون (BUN)", unit:"mg/dL", ranges:{ any:{min:7,max:20}}, notes:"BUN به عملکرد کلیه و وضعیت آب بدن مرتبط است. کم‌آبی می‌تواند آن را بالا ببرد." },
  { id:"alt", name:"ALT (آنزیم کبد)", unit:"U/L", ranges:{ any:{min:0,max:56}}, notes:"ALT بالا می‌تواند در مشکلات کبدی، چربی کبد، داروها یا التهاب دیده شود." },
  { id:"ast", name:"AST (آنزیم کبد)", unit:"U/L", ranges:{ any:{min:0,max:40}}, notes:"AST نیز مشابه ALT است اما در عضله هم می‌تواند بالا رود." },
  { id:"tsh", name:"TSH (تیروئید)", unit:"mIU/L", ranges:{ any:{min:0.4,max:4.0}}, notes:"TSH خارج از محدوده می‌تواند نشانه کم‌کاری/پرکاری تیروئید باشد. تفسیر دقیق با FT4/FT3 انجام می‌شود." },
  { id:"vitd", name:"ویتامین D (25(OH)D)", unit:"ng/mL", ranges:{ any:{min:30,max:100}}, notes:"کمتر از ۲۰ کمبود، ۲۰–۲۹ ناکافی، ۳۰ به بالا معمولاً کافی در نظر گرفته می‌شود (بسته به منبع)." },
  { id:"hb", name:"هموگلوبین (Hb)", unit:"g/dL", ranges:{ male:{min:13.5,max:17.5}, female:{min:12.0,max:15.5}, any:{min:12.0,max:17.5}}, notes:"Hb پایین می‌تواند نشان‌دهنده کم‌خونی باشد؛ علت‌ها متنوع است (آهن، B12، خونریزی و…)." },
  { id:"wbc", name:"WBC (گلبول سفید)", unit:"×10^3/µL", ranges:{ any:{min:4.0,max:11.0}}, notes:"WBC بالا می‌تواند در عفونت/التهاب دیده شود. مقادیر خیلی پایین/بالا نیاز به بررسی دارند." },
];

const getLabRange = (test, sex) => {
  const r = test.ranges || {};
  return (sex && r[sex]) ? r[sex] : (r.any || null);
};

const labStatusFor = (v, r) => {
  if(!r || !Number.isFinite(v)) return {label:"—", tone:"muted"};
  if(v < r.min) return {label:"پایین‌تر از رنج", tone:"warn"};
  if(v > r.max) return {label:"بالاتر از رنج", tone:"warn"};
  return {label:"در محدوده نرمال", tone:"ok"};
};

let labLastText = "";

const computeLabUI = () => {
  const typeSel = document.getElementById("labType");
  const valIn = document.getElementById("labValue");
  const sexSel = document.getElementById("labSex");
  if(!typeSel || !valIn || !sexSel) return;

  const t = LAB_TESTS.find(x=>x.id===typeSel.value) || LAB_TESTS[0];
  const sex = sexSel.value || "any";
  const v = safeNum(valIn.value);
  const r = getLabRange(t, sex);
  const st = labStatusFor(v, r);

  const statusEl = document.getElementById("labStatus");
  const explainEl = document.getElementById("labExplain");
  const rangeEl = document.getElementById("labRange");
  const unitEl = document.getElementById("labUnitHint");

  const cfg = elementSdk.getConfig();
  const valStr = Number.isFinite(v) ? (cfg.enable_persian_digits ? toPersianDigits(String(v)) : String(v)) : "—";
  unitEl.textContent = `واحد: ${t.unit}`;

  statusEl.textContent = st.label;
  statusEl.className = "text-lg font-extrabold " + (st.tone==="ok" ? "text-emerald-200" : st.tone==="warn" ? "text-amber-200" : "muted");

  if(!Number.isFinite(v)){
    explainEl.textContent = "برای شروع، نوع آزمایش و عدد خود را وارد کنید.";
    rangeEl.textContent = "رنج مرجع: —";
    labLastText = "";
    return;
  }

  const rangeTxt = r ? `${r.min} تا ${r.max} (${t.unit})` : `—`;
  rangeEl.textContent = `رنج مرجع: ${cfg.enable_persian_digits ? toPersianDigits(rangeTxt) : rangeTxt}`;

  const explain = `${t.notes} (عدد شما: ${valStr} ${t.unit})`;
  explainEl.textContent = explain;

  labLastText = `${t.name}: ${toLatinDigits(String(v))} ${t.unit}\nوضعیت: ${st.label}\nرنج مرجع: ${rangeTxt}\nیادآوری: این خروجی صرفاً آموزشی است و جایگزین نظر پزشک نیست.`;
};

/* ========================= Sound ========================= */
let audioCtx = null;
const ensureAudio = () => {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
};
const playClick = () => {
  const cfg = elementSdk.getConfig();
  if (!cfg.enable_click_sound) return;
  ensureAudio();
  const vol = clamp(Number(cfg.click_volume ?? 30),0,100) / 100;
  try{
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = "square";
    osc.frequency.setValueAtTime(1200, t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(Math.max(0.0001, vol*0.05), t + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);
    osc.connect(g);
    g.connect(audioCtx.destination);
    osc.start(t);
    osc.stop(t + 0.035);
  }catch{}
};

/* ========================= Calculator ========================= */
let calcExpr = "";
let calcMode = "basic"; // basic | sci

const safeEvalSci = (expr) => {
  // whitelist expression characters
  let s = normalizeCalcInput(expr).replace(/\s+/g,'');
  if(!s) return NaN;

  // percent (rough): replace % with /100
  s = s.replace(/%/g, "/100");

  // constants
  // replace standalone pi and e
  s = s.replace(/\bpi\b/gi, "Math.PI");
  s = s.replace(/\be\b/g, "Math.E");

  // functions
  s = s.replace(/\bln\(/gi, "Math.log(");
  s = s.replace(/\blog\(/gi, "Math.log10(");
  s = s.replace(/\bsin\(/gi, "Math.sin(");
  s = s.replace(/\bcos\(/gi, "Math.cos(");
  s = s.replace(/\btan\(/gi, "Math.tan(");
  s = s.replace(/\bsqrt\(/gi, "Math.sqrt(");
  s = s.replace(/\babs\(/gi, "Math.abs(");
  s = s.replace(/\bpow\(/gi, "Math.pow(");

  // exponent
  s = s.replace(/\^/g, "**");

  // final whitelist (numbers, operators, dots, commas, parentheses, Math. letters)
  if(!/^[0-9+\-*/().,**MathPIElog10sinsqrtabspow]*$/.test(s.replace(/Math\./g,"Math"))){
    // fallback strict check:
  }
  // stronger check: allow only these chars after replacements
  if(!/^[0-9+\-*/().,A-Za-z_]*$/.test(s)) return NaN;
  // prevent other identifiers
  const bad = s.match(/\b(?!Math\b)[A-Za-z_]+\b/g);
  if(bad) return NaN;

  try{
    // eslint-disable-next-line no-new-func
    const fn = new Function("Math", `return (${s});`);
    const v = fn(Math);
    return Number.isFinite(v) ? v : NaN;
  }catch{ return NaN; }
};

const setCalcMode = (mode) => {
  calcMode = (mode==="sci") ? "sci" : "basic";
  const sci = document.getElementById("calcPadSci");
  if(sci) sci.classList.toggle("hidden", calcMode!=="sci");
  const btn = document.getElementById("calcModeBtn");
  if(btn) btn.textContent = (calcMode==="sci") ? "معمولی" : "مهندسی";
  calcEvaluate();
};


let calcMem = 0;

const normalizeCalcInput = (s) => {
  const latin = toLatinDigits(s)
    .replace(/×/g,'*').replace(/÷/g,'/')
    .replace(/٪/g,'%');
  return latin;
};

const isOperator = (t) => ["+","-","*","/"].includes(t);
const precedence = (op) => (op==="+"||op==="-"?1:2);

const tokenize = (expr) => {
  const s = normalizeCalcInput(expr).replace(/\s+/g,'');
  const tokens = [];
  let i=0;
  while(i<s.length){
    const ch=s[i];
    if(/[0-9.]/.test(ch)){
      let j=i+1;
      while(j<s.length && /[0-9.]/.test(s[j])) j++;
      tokens.push({type:"num", value:s.slice(i,j)});
      i=j; continue;
    }
    if(ch==="("||ch===")"){ tokens.push({type:"paren", value:ch}); i++; continue; }
    if(isOperator(ch)){ tokens.push({type:"op", value:ch}); i++; continue; }
    if(ch==="%"){ tokens.push({type:"pct", value:"%"}); i++; continue; }
    i++;
  }
  return tokens;
};

const toRPN = (tokens) => {
  const out=[], st=[];
  for(let idx=0; idx<tokens.length; idx++){
    const t=tokens[idx];
    if(t.type==="num"){ out.push(t); continue; }
    if(t.type==="pct"){ out.push(t); continue; }

    if(t.type==="op"){
      if(t.value==="-" && (idx===0 || (tokens[idx-1].type==="op") || (tokens[idx-1].type==="paren" && tokens[idx-1].value==="("))){
        out.push({type:"num", value:"0"});
      }
      while(st.length){
        const top=st[st.length-1];
        if(top.type==="op" && precedence(top.value) >= precedence(t.value)){
          out.push(st.pop());
        }else break;
      }
      st.push(t);
      continue;
    }
    if(t.type==="paren" && t.value==="("){ st.push(t); continue; }
    if(t.type==="paren" && t.value===")"){
      while(st.length && !(st[st.length-1].type==="paren" && st[st.length-1].value==="(")){
        out.push(st.pop());
      }
      if(st.length && st[st.length-1].type==="paren") st.pop();
      continue;
    }
  }
  while(st.length) out.push(st.pop());
  return out;
};

const evalRPN = (rpn) => {
  const st=[];
  for(const t of rpn){
    if(t.type==="num"){
      const v=Number(t.value);
      if(!Number.isFinite(v)) return NaN;
      st.push(v);
      continue;
    }
    if(t.type==="pct"){
      if(st.length<1) return NaN;
      const a=st.pop();
      st.push(a/100);
      continue;
    }
    if(t.type==="op"){
      if(st.length<2) return NaN;
      const b=st.pop(), a=st.pop();
      let r=NaN;
      if(t.value==="+") r=a+b;
      else if(t.value==="-") r=a-b;
      else if(t.value==="*") r=a*b;
      else if(t.value==="/") r=b===0 ? NaN : a/b;
      st.push(r);
      continue;
    }
  }
  return st.length===1 ? st[0] : NaN;
};

const calcEvaluate = () => {
  const cfg=elementSdk.getConfig();
  const caps=elementSdk.mapToCapabilities(cfg);
  const p=clamp(Number(cfg.precision ?? 2),0,8);

  const lang = caps.calculator.displayLang;
  const exprShown = calcExpr.trim() ? calcExpr : "—";
  const memStr = formatNumber(calcMem, 2).replace(/\.0+$/,'');

  document.getElementById("calcExpr").textContent = (lang==="fa" ? toPersianDigits(exprShown) : toLatinDigits(exprShown));
  document.getElementById("memBadge").textContent = (lang==="fa" ? toPersianDigits(memStr) : toLatinDigits(memStr));

  if(!calcExpr.trim()){
    document.getElementById("calcResult").textContent = (lang==="fa" ? "۰" : "0");
    return;
  }

  const val = (calcMode==="sci") ? safeEvalSci(calcExpr) : evalRPN(toRPN(tokenize(calcExpr)));
  const out = Number.isFinite(val) ? formatNumber(val, p) : "—";
  document.getElementById("calcResult").textContent = (lang==="fa" ? toPersianDigits(out) : toLatinDigits(out));
};

const calcPush = (k) => {
  playClick();
  const mapped = (k==="÷")?"/":(k==="×")?"*":(k==="٪")?"%":k;

  if(mapped==="="){
    const val = (calcMode==="sci") ? safeEvalSci(calcExpr) : evalRPN(toRPN(tokenize(calcExpr)));
    if(!Number.isFinite(val)){
      showToast("عبارت نامعتبر است.", "warn");
      return;
    }
    const cfg=elementSdk.getConfig();
    const p=clamp(Number(cfg.precision ?? 2),0,8);
    calcExpr = formatNumber(val, p);
    calcEvaluate();
    return;
  }

  if(mapped==="DEL"){
    calcExpr = calcExpr.slice(0, -1);
    calcEvaluate();
    return;
  }

  if(mapped==="MC"){ calcMem=0; calcEvaluate(); showToast("حافظه پاک شد.", "info"); return; }
  if(mapped==="MR"){ calcExpr += String(calcMem); calcEvaluate(); return; }
  if(mapped==="M+" || mapped==="M-"){
    const val=evalRPN(toRPN(tokenize(calcExpr)));
    if(!Number.isFinite(val)){ showToast("برای حافظه، ابتدا یک عبارت معتبر وارد کنید.", "warn"); return; }
    calcMem += (mapped==="M+") ? val : -val;
    calcEvaluate();
    showToast("حافظه به‌روزرسانی شد.", "ok");
    return;
  }

  // کلیدهای مهندسی
  if(calcMode==="sci"){
    const sciTokens = ["pi","e","^","sqrt(","cbrt(","sin(","cos(","tan(","asin(","acos(","atan(","ln(","log(","abs(","exp(","pow(",",",")"];
    if(sciTokens.includes(mapped)){
      calcExpr += (mapped==="^" ? "^" : mapped);
      calcEvaluate();
      return;
    }
  }

  const norm = toLatinDigits(mapped);
  const allowed = /[0-9+\-*/().%]/;
  if(norm.length===1 && allowed.test(norm)){
    calcExpr += norm;
    calcEvaluate();
  }
};
const calcClear = () => { playClick(); calcExpr=""; calcEvaluate(); };

/* ========================= DateTime via TimeAPI.io (Iran Only + Analog) =========================
   - دریافت زمان از TimeAPI.io (بدون اتکا به ساعت دستگاه برای زمان مطلق)
   - ساخت یک "ساعت مرجع" و تیک محلی برای نمایش روان
*/
const TIMEAPI_BASE = "https://timeapi.io/api/Time/current/zone";
const TZ_IR = "Asia/Tehran";
const TZ_UTC = "Etc/UTC";


const HOLIDAY_API = (jy,jm,jd)=>`https://holidayapi.ir/jalali/${jy}/${jm}/${jd}`;


const setOccStatus = (state) => {
  const hint = document.getElementById("occHint");
  if(!hint) return;
  if(state==="loading"){
    hint.textContent = "در حال دریافت مناسبت‌های امروز…";
    hint.className = "muted leading-7";
  }else if(state==="ok"){
    hint.textContent = "به‌روزرسانی شد ✅";
    hint.className = "text-emerald-200 leading-7";
  }else{
    hint.textContent = "امکان دریافت مناسبت‌ها وجود ندارد.";
    hint.className = "text-amber-200 leading-7";
  }
};




const renderOccasions = (events, dayHoliday) => {
  const listEl = document.getElementById("occList");
  const badge = document.getElementById("occHolidayBadge");
  if(!listEl) return;

  if(badge){
    badge.classList.toggle("hidden", !dayHoliday);
    if(dayHoliday) badge.textContent = "تعطیل";
  }

  if(!events || events.length===0){
    listEl.innerHTML = `<div class="muted leading-7">مناسبتی برای امروز ثبت نشده است.</div>`;
    return;
  }

  const ul = document.createElement("ul");
  ul.className = "space-y-2 leading-7";
  events.forEach(ev=>{
    const isH = !!ev.isHoliday;
    const li = document.createElement("li");
    li.className = `soft p-3 flex items-start justify-between gap-3 ${isH ? "border border-rose-400/30" : ""}`;
    li.innerHTML = `
      <div class="${isH ? "text-rose-200 font-semibold" : ""}">${escapeHtml(ev.title)}</div>
      ${isH ? `<span class="text-rose-200 tiny font-bold">تعطیل</span>` : ``}
    `;
    ul.appendChild(li);
  });

  listEl.innerHTML = "";
  listEl.appendChild(ul);
};



let occCacheKey = "";
const fetchOccasions = async (jy,jm,jd) => {
  const key = `${jy}/${jm}/${jd}`;
  if(key===occCacheKey) return;
  occCacheKey = key;
  try{
    const res = await fetch(HOLIDAY_API(jy,jm,jd), { cache:"no-store" });
    if(!res.ok) throw new Error("bad_status");
    const data = await res.json();
    weatherState.lastData = data;
    renderOccasions(data);
  }catch{
    // در صورت خطا، این بخش خالی می‌ماند
    const list = document.getElementById("occList");
    if(list) list.innerHTML = `<div class="muted tiny">امکان دریافت مناسبت‌ها وجود ندارد.</div>`;
    const badge = document.getElementById("occHolidayBadge");
    if(badge) badge.classList.add("hidden");
  }
};


let timeTicker = {
  irBaseEpochMs: null,
  utcBaseEpochMs: null,
  fetchedPerfMs: null,
  lastPayloadIR: null,
  lastPayloadUTC: null
};

const pad2 = (n) => String(n).padStart(2,"0");

const fmtMaybeFaDigits = (s) => {
  const cfg = elementSdk.getConfig();
  if(s==null || s==="—") return "—";
  return cfg.enable_persian_digits ? toPersianDigits(String(s)) : String(s);
};

const gregorianToJalali = (gy, gm, gd) => {
  const g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
  let jy;
  if (gy > 1600) { jy = 979; gy -= 1600; } else { jy = 0; gy -= 621; }
  const gy2 = (gm > 2) ? (gy + 1) : gy;
  let days = 365*gy
    + Math.floor((gy2 + 3)/4)
    - Math.floor((gy2 + 99)/100)
    + Math.floor((gy2 + 399)/400)
    - 80
    + gd
    + g_d_m[gm-1];
  jy += 33 * Math.floor(days / 12053);
  days %= 12053;
  jy += 4 * Math.floor(days / 1461);
  days %= 1461;
  if (days > 365) {
    jy += Math.floor((days - 1) / 365);
    days = (days - 1) % 365;
  }
  const jm = (days < 186) ? (1 + Math.floor(days / 31)) : (7 + Math.floor((days - 186) / 30));
  const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
  return { jy, jm, jd };
};

const buildTimeString = (h,m,s) => `${pad2(h)}:${pad2(m)}:${pad2(s)}`;


let analogBuilt = false;

const buildAnalogSvgOnce = () => {
  if (analogBuilt) return;
  const svg = document.getElementById("analogSvg");
  if (!svg) return;

  const NS = "http://www.w3.org/2000/svg";
  const ticksG = document.getElementById("analogTicks");
  const numsG  = document.getElementById("analogNums");

  // Clear (in case of hot reload)
  ticksG.innerHTML = "";
  numsG.innerHTML = "";

  // Ticks
  for (let i = 0; i < 60; i++) {
    const ang = (i * 6) * Math.PI / 180;
    const isMajor = (i % 5 === 0);
    const r1 = isMajor ? 80 : 84;
    const r2 = 92;

    const x1 = 100 + Math.sin(ang) * r1;
    const y1 = 100 - Math.cos(ang) * r1;
    const x2 = 100 + Math.sin(ang) * r2;
    const y2 = 100 - Math.cos(ang) * r2;

    const line = document.createElementNS(NS, "line");
    line.setAttribute("x1", x1.toFixed(2));
    line.setAttribute("y1", y1.toFixed(2));
    line.setAttribute("x2", x2.toFixed(2));
    line.setAttribute("y2", y2.toFixed(2));
    line.setAttribute("stroke-width", isMajor ? "3" : "1.8");
    line.setAttribute("class", isMajor ? "analogTick analogTickMajor" : "analogTick");
    ticksG.appendChild(line);
  }

  // Numbers (1..12)
  for (let n = 1; n <= 12; n++) {
    const ang = (n * 30) * Math.PI / 180;
    const r = 64;
    const x = 100 + Math.sin(ang) * r;
    const y = 100 - Math.cos(ang) * r;

    const t = document.createElementNS(NS, "text");
    t.setAttribute("x", x.toFixed(2));
    t.setAttribute("y", y.toFixed(2));
    t.setAttribute("class", "analogNum");
    t.textContent = n;
    numsG.appendChild(t);
  }

  analogBuilt = true;
};

const setHandRotation = (el, deg) => {
  if (!el) return;
  el.setAttribute("transform", `rotate(${deg} 100 100)`);
};

const renderAnalog = (h, m, s) => {
  buildAnalogSvgOnce();

  // Normalize
  const hh = ((Number(h) % 12) + 12) % 12;
  const mm = ((Number(m) % 60) + 60) % 60;
  const ss = ((Number(s) % 60) + 60) % 60;

  // Angles
  const hourDeg = hh * 30 + mm * 0.5 + ss * (0.5 / 60);
  const minDeg  = mm * 6  + ss * 0.1;
  const secDeg  = ss * 6;

  setHandRotation(document.getElementById("handHour"), hourDeg);
  setHandRotation(document.getElementById("handMin"),  minDeg);
  setHandRotation(document.getElementById("handSec"),  secDeg);
};


const renderTimeUI = (payload, h, m, s) => {
  // دیجیتال
  document.getElementById("timeIR").textContent = fmtMaybeFaDigits(buildTimeString(h,m,s));

  // تاریخ
  if(payload){
    const g = `${payload.year}-${pad2(payload.month)}-${pad2(payload.day)}`;
    document.getElementById("todayGreg").textContent = fmtMaybeFaDigits(g);

    const j = gregorianToJalali(payload.year, payload.month, payload.day);
    const jStr = `${j.jy}/${pad2(j.jm)}/${pad2(j.jd)}`;
    document.getElementById("todayJalali").textContent = fmtMaybeFaDigits(jStr);
    fetchOccasions(j.jy, j.jm, j.jd);
  }

  // بروزرسانی
  const up = buildTimeString(h,m,s);
  document.getElementById("timeUpdatedAt").textContent = fmtMaybeFaDigits(up);

  // آنالوگ
  renderAnalog(h,m,s);
};

const setTimeStatus = (kind, text) => {
  const el = document.getElementById("timeStatusText");
  if(!el) return;
  if(kind==="ok") el.className="tiny text-emerald-200";
  else if(kind==="warn") el.className="tiny text-amber-200";
  else el.className="tiny text-rose-200";
  el.textContent = text || "—";
};

const fetchTimeApiZone = async (timeZone) => {
  const url = `${TIMEAPI_BASE}?timeZone=${encodeURIComponent(timeZone)}`;
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("bad_status");
  const data = await res.json();
    weatherState.lastData = data;
  if(!data || typeof data.year !== "number" || typeof data.hour !== "number") throw new Error("bad_payload");
  return data;
};

// تبدیل تقریبی داده دریافتی به epoch برای تیک روان
const payloadToEpochMsApprox = (p) => {
  // p.dateTime معمولاً رشته ISO است. اگر نبود، با اجزا می‌سازیم.
  if(p.dateTime){
    const t = Date.parse(p.dateTime);
    if(Number.isFinite(t)) return t;
  }
  // fallback: ساخت به صورت UTC با فرض اینکه اجزا مربوط به همان zone هستند.
  // برای نمایش، ما فقط با اختلاف ثانیه جلو می‌رویم؛ در نتیجه حتی اگر آفست دقیق نباشد،
  // ساعت دیجیتال از روی خود اجزا نمایش داده می‌شود.
  return Date.now();
};

const fetchTimeApi = async () => {
  try{
    setTimeStatus("warn","در حال دریافت…");
    const [ir, utc] = await Promise.all([
      fetchTimeApiZone(TZ_IR),
      fetchTimeApiZone(TZ_UTC)
    ]);

    timeTicker.lastPayloadIR = ir;
    timeTicker.lastPayloadUTC = utc;
    timeTicker.irBaseEpochMs = payloadToEpochMsApprox(ir);
    timeTicker.utcBaseEpochMs = payloadToEpochMsApprox(utc);
    timeTicker.fetchedPerfMs = performance.now();

    // نمایش اولیه (مستقیم از روی hour/minute/seconds)
    renderTimeUI(ir, ir.hour, ir.minute, ir.seconds ?? 0);
    const utcText = `${pad2(utc.hour)}:${pad2(utc.minute)}:${pad2(utc.seconds ?? 0)}`;
    const utcEl = document.getElementById("timeUTC");
    if(utcEl) utcEl.textContent = fmtMaybeFaDigits(utcText);

    setTimeStatus("ok","به‌روزرسانی شد ✅");
  }catch{
    setTimeStatus("err","خطا در دریافت اطلاعات.");
  }
};

const tickTime = () => {
  const ir = timeTicker.lastPayloadIR;
  const utc = timeTicker.lastPayloadUTC;
  if(!ir || !utc){ return; }

  const elapsed = Math.max(0, Math.floor((performance.now() - timeTicker.fetchedPerfMs)/1000));

  const baseSecIR = (ir.hour*3600) + (ir.minute*60) + (ir.seconds ?? 0);
  const curIR = baseSecIR + elapsed;
  const hIR = Math.floor(curIR/3600) % 24;
  const mIR = Math.floor((curIR%3600)/60);
  const sIR = curIR%60;

  renderTimeUI(ir, hIR, mIR, sIR);

  const baseSecUTC = (utc.hour*3600) + (utc.minute*60) + (utc.seconds ?? 0);
  const curUTC = baseSecUTC + elapsed;
  const hU = Math.floor(curUTC/3600) % 24;
  const mU = Math.floor((curUTC%3600)/60);
  const sU = curUTC%60;
  const utcText = `${pad2(hU)}:${pad2(mU)}:${pad2(sU)}`;
  const utcEl = document.getElementById("timeUTC");
  if(utcEl) utcEl.textContent = fmtMaybeFaDigits(utcText);
};


/* ========================= Weather (Open-Meteo) =========================
   - جستجوی شهرهای ایران با Geocoding عمومی Open‑Meteo (بدون کلید)
   - دریافت وضعیت لحظه‌ای با Forecast API (current)
*/
const OM_GEO = "https://geocoding-api.open-meteo.com/v1/search";
const OM_FORECAST = "https://api.open-meteo.com/v1/forecast";
const WEATHER_TZ = "Asia/Tehran";

const IRAN_CAPITALS = [
  "تهران","کرج","قم","اراک","اصفهان","اهواز","ایلام","اردبیل","تبریز","بندرعباس",
  "بوشهر","بیرجند","زاهدان","زنجان","سمنان","سنندج","شهرکرد","شیراز","قزوین","گرگان",
  "مشهد","کرمان","کرمانشاه","یاسوج","رشت","خرم‌آباد","همدان","یزد","ارومیه","بجنورد","ساری"
];

let weatherState = {
  place: null, // {name, admin1, admin2, lat, lon}
  tab: "overview",
  lastData: null,
  lastText: ""
};

const weatherCodeInfo = (code) => {
  const c = Number(code);
  // بر اساس مستندات WMO weather codes در Open‑Meteo
  if(c===0) return {emoji:"☀️", text:"صاف"};
  if([1,2].includes(c)) return {emoji:"⛅", text:"کمی ابری"};
  if(c===3) return {emoji:"☁️", text:"ابری"};
  if([45,48].includes(c)) return {emoji:"🌫️", text:"مه‌آلود"};
  if([51,53,55].includes(c)) return {emoji:"🌦️", text:"نم‌نم باران"};
  if([56,57].includes(c)) return {emoji:"🌧️", text:"باران یخ‌زده"};
  if([61,63,65].includes(c)) return {emoji:"🌧️", text:"بارانی"};
  if([66,67].includes(c)) return {emoji:"🌧️", text:"باران یخ‌زده"};
  if([71,73,75,77].includes(c)) return {emoji:"🌨️", text:"برفی"};
  if([80,81,82].includes(c)) return {emoji:"🌧️", text:"رگبار"};
  if([85,86].includes(c)) return {emoji:"🌨️", text:"رگبار برف"};
  if([95,96,99].includes(c)) return {emoji:"⛈️", text:"رعد و برق"};
  return {emoji:"🌡️", text:"نامشخص"};
};

const setWeatherStatus = (kind, text) => {
  const el = document.getElementById("weatherStatus");
  if(!el) return;
  if(kind==="ok") el.className="mt-4 tiny text-emerald-200";
  else if(kind==="warn") el.className="mt-4 tiny text-amber-200";
  else el.className="mt-4 tiny text-rose-200";
  el.textContent = text || "—";
};

const weatherPersist = () => {
  try{
    if(weatherState.place){
      localStorage.setItem("codeisa.weather.last", JSON.stringify(weatherState.place));
    }else{
      localStorage.removeItem("codeisa.weather.last");
    }
  }catch{}
};
const weatherRestore = () => {
  try{
    const raw = localStorage.getItem("codeisa.weather.last");
    if(!raw) return null;
    const p = JSON.parse(raw);
    if(p && Number.isFinite(Number(p.lat)) && Number.isFinite(Number(p.lon)) && p.name) return p;
  }catch{}
  return null;
};

const weatherGeocode = async (q) => {
  const url = `${OM_GEO}?name=${encodeURIComponent(q)}&count=8&language=fa&format=json&country=IR`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error("bad_status");
  const data = await res.json();
    weatherState.lastData = data;
  const results = (data && Array.isArray(data.results)) ? data.results : [];
  return results.map(r=>({
    name: r.name,
    admin1: r.admin1 || "",
    admin2: r.admin2 || "",
    lat: Number(r.latitude),
    lon: Number(r.longitude)
  })).filter(x=>x.name && Number.isFinite(x.lat) && Number.isFinite(x.lon));
};

const weatherSetPlace = async (place) => {
  weatherState.place = place;
  weatherPersist();
  const title = document.getElementById("weatherCityTitle");
  const sub = document.getElementById("weatherSubTitle");
  if(title) title.textContent = place ? place.name : "—";
  if(sub) sub.textContent = place ? [place.admin2, place.admin1].filter(Boolean).join(" • ") || "ایران" : "—";
};

const weatherRenderSearchResults = (items) => {
  const box = document.getElementById("weatherSearchResults");
  if(!box) return;
  box.innerHTML = "";
  if(!items || items.length===0){
    box.innerHTML = `<div class="muted tiny">نتیجه‌ای پیدا نشد.</div>`;
    return;
  }
  items.forEach(it=>{
    const btn = document.createElement("button");
    btn.type="button";
    btn.className="btn soft px-3 py-2 w-full text-right focusable";
    const meta = [it.admin2, it.admin1].filter(Boolean).join(" • ");
    btn.innerHTML = `<div class="font-semibold">${escapeHtml(it.name)}</div><div class="muted tiny mt-0.5">${escapeHtml(meta || "ایران")}</div>`;
    btn.addEventListener("click", async ()=>{
      await weatherSetPlace(it);
      await weatherFetchAndRender();
      showToast("شهر انتخاب شد ✅", "ok");
      box.innerHTML = "";
    });
    box.appendChild(btn);
  });
};

const weatherFmt = (n, unit) => {
  const cfg = elementSdk.getConfig();
  if(!Number.isFinite(n)) return "—";
  const s = `${Math.round(n)}${unit||""}`;
  return cfg.enable_persian_digits ? toPersianDigits(s) : s;
};

const weatherBuildNarrative = (hourly, tz) => {
  // خروجی: {title, sub, umbrellaEmoji}
  try{
    const times = hourly.time || [];
    const prob = hourly.precipitation_probability || [];
    const prec = hourly.precipitation || [];
    const code = hourly.weather_code || [];

    const now = new Date();
    // فقط 12 ساعت اول
    const N = Math.min(12, times.length, prob.length, prec.length);
    if(N <= 0) return { title:"—", sub:"—", umbrellaEmoji:"☂️" };

    let maxP = 0;
    let maxI = 0;
    for(let i=0;i<N;i++){
      const p = Number(prob[i]);
      if(Number.isFinite(p) && p>maxP){ maxP=p; maxI=i; }
    }

    const maxPrec = Math.max(...prec.slice(0,N).map(x=>Number(x)||0));
    const info = weatherCodeInfo(Number(code[maxI]));
    const umb = (maxP>=40 || maxPrec>0) ? "☂️" : "🌤️";

    // تلاش برای پیدا کردن زمان پایان بارش (وقتی احتمال برای 2 ساعت پشت سر هم پایین بیاد)
    let endAt = null;
    if(maxP >= 50 || maxPrec > 0){
      for(let i=maxI;i<N-2;i++){
        const p1 = Number(prob[i+1])||0;
        const p2 = Number(prob[i+2])||0;
        if(p1 < 30 && p2 < 30){
          endAt = times[i+1];
          break;
        }
      }
    }

    const fmtTime = (iso)=>{
      try{
        const d = new Date(iso);
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return fmtMaybeFaDigits(`${hh}:${mm}`);
      }catch{ return "—"; }
    };

    if(maxP >= 70 || maxPrec >= 1){
      const title = "بارش (احتمال زیاد)";
      const sub = endAt ? `احتمال بارش تا حدود ${fmtTime(endAt)} بالاست • وضعیت غالب: ${info.text}` : `احتمال بارش در ساعات آینده بالاست • وضعیت غالب: ${info.text}`;
      return { title, sub, umbrellaEmoji: umb };
    }
    if(maxP >= 40 || maxPrec > 0){
      const title = "بارش پراکنده";
      const sub = endAt ? `ممکن است بارش تا حدود ${fmtTime(endAt)} ادامه داشته باشد • وضعیت: ${info.text}` : `در برخی ساعات احتمال بارش وجود دارد • وضعیت: ${info.text}`;
      return { title, sub, umbrellaEmoji: umb };
    }
    return { title:"بارشی انتظار نمی‌رود", sub:`در ۱۲ ساعت آینده احتمال بارش کم است • وضعیت: ${info.text}`, umbrellaEmoji: umb };
  }catch{
    return { title:"—", sub:"—", umbrellaEmoji:"☂️" };
  }
};

const weatherRenderHourly = (data, mode) => {
  const box = document.getElementById("weatherHourly");
  const hint = document.getElementById("weatherHourlyHint");
  if(!box) return;
  box.innerHTML = "";

  const h = data && data.hourly ? data.hourly : null;
  if(!h || !h.time){ box.innerHTML = `<div class="muted tiny">داده‌ی ساعتی در دسترس نیست.</div>`; return; }

  const times = h.time;
  const temp = h.temperature_2m || [];
  const prob = h.precipitation_probability || [];
  const prec = h.precipitation || [];
  const hum  = h.relative_humidity_2m || [];
  const wind = h.wind_speed_10m || [];
  const code = h.weather_code || [];

  const N = Math.min(12, times.length);
  const label = (mode==="precip") ? "بارش" : (mode==="wind") ? "باد" : (mode==="humidity") ? "رطوبت" : "دما";
  if(hint) hint.textContent = label + " • ۱۲ ساعت آینده";

  const mkVal = (i)=>{
    if(mode==="precip"){
      const p = Number(prob[i]);
      const mm = Number(prec[i]);
      const a = Number.isFinite(p) ? `${Math.round(p)}%` : "—";
      const b = Number.isFinite(mm) ? `${(mm||0).toFixed(1)}mm` : "";
      return (b && b!=="0.0mm") ? `${a} • ${b}` : a;
    }
    if(mode==="wind"){
      const w = Number(wind[i]);
      return Number.isFinite(w) ? `${Math.round(w)} km/h` : "—";
    }
    if(mode==="humidity"){
      const r = Number(hum[i]);
      return Number.isFinite(r) ? `${Math.round(r)}%` : "—";
    }
    const t = Number(temp[i]);
    return Number.isFinite(t) ? `${Math.round(t)}°` : "—";
  };

  for(let i=0;i<N;i++){
    const d = new Date(times[i]);
    const hh = String(d.getHours()).padStart(2,"0");
    const tlabel = fmtMaybeFaDigits(`${hh}:00`);
    const info = weatherCodeInfo(Number(code[i]));

    const el = document.createElement("div");
    el.className = "soft px-3 py-2 rounded-2xl weatherHourCard snap-start text-center";
    el.innerHTML = `
      <div class="tiny muted">${tlabel}</div>
      <div class="text-2xl mt-1">${info.emoji}</div>
      <div class="tiny font-semibold mt-1">${escapeHtml(mkVal(i))}</div>
    `;
    box.appendChild(el);
  }
};

const weatherRenderDaily = (data) => {
  const box = document.getElementById("weatherDaily");
  if(!box) return;
  box.innerHTML = "";

  const d = data && data.daily ? data.daily : null;
  if(!d || !d.time){ box.innerHTML = `<div class="muted tiny">داده‌ی روزانه در دسترس نیست.</div>`; return; }

  const days = d.time;
  const tmax = d.temperature_2m_max || [];
  const tmin = d.temperature_2m_min || [];
  const code = d.weather_code || [];
  const pmax = d.precipitation_probability_max || [];
  const psum = d.precipitation_sum || [];

  const N = Math.min(6, days.length);
  const wdFa = ["یکشنبه","دوشنبه","سه‌شنبه","چهارشنبه","پنجشنبه","جمعه","شنبه"];

  const fmtDay = (iso)=>{
    try{
      const dt = new Date(iso);
      return wdFa[dt.getDay()] || "—";
    }catch{ return "—"; }
  };

  for(let i=0;i<N;i++){
    const info = weatherCodeInfo(Number(code[i]));
    const max = Number(tmax[i]);
    const min = Number(tmin[i]);
    const pr = Number(pmax[i]);
    const mm = Number(psum[i]);

    const card = document.createElement("div");
    card.className = "soft p-3 rounded-2xl text-center";
    const lineTemp = `${Math.round(max)}° / ${Math.round(min)}°`;
    const lineProb = Number.isFinite(pr) ? `${Math.round(pr)}%` : "—";
    const lineMm = Number.isFinite(mm) ? `${(mm||0).toFixed(1)}mm` : "";

    card.innerHTML = `
      <div class="tiny muted">${escapeHtml(fmtDay(days[i]))}</div>
      <div class="text-2xl mt-1">${info.emoji}</div>
      <div class="tiny font-semibold mt-1">${fmtMaybeFaDigits(lineTemp)}</div>
      <div class="tiny muted mt-1">${(lineMm && lineMm!=="0.0mm") ? (fmtMaybeFaDigits(lineProb)+" • "+lineMm) : fmtMaybeFaDigits(lineProb)}</div>
    `;
    box.appendChild(card);
  }
};

const weatherFetchAndRender = async () => {
  const p = weatherState.place;
  if(!p){ setWeatherStatus("warn","یک شهر انتخاب کنید."); return; }

  try{
    setWeatherStatus("warn","در حال دریافت…");

    const url =
      `${OM_FORECAST}?latitude=${encodeURIComponent(p.lat)}&longitude=${encodeURIComponent(p.lon)}`
      + `&current=temperature_2m,relative_humidity_2m,apparent_temperature,wind_speed_10m,weather_code`
      + `&hourly=temperature_2m,relative_humidity_2m,wind_speed_10m,precipitation_probability,precipitation,weather_code`
      + `&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max`
      + `&timezone=${encodeURIComponent(WEATHER_TZ)}`;

    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("bad_status");
    const data = await res.json();
    weatherState.lastData = data;
    const cur = data && data.current ? data.current : null;

    const t = cur ? Number(cur.temperature_2m) : NaN;
    const feels = cur ? Number(cur.apparent_temperature) : NaN;
    const hum = cur ? Number(cur.relative_humidity_2m) : NaN;
    const wind = cur ? Number(cur.wind_speed_10m) : NaN;
    const code = cur ? Number(cur.weather_code) : NaN;

    const info = weatherCodeInfo(code);
    const icon = document.getElementById("weatherIcon");
    if(icon) icon.textContent = info.emoji;

    const desc = document.getElementById("weatherDesc");
    if(desc) desc.textContent = info.text;

    document.getElementById("weatherTemp").textContent = weatherFmt(t, "°C");
    document.getElementById("weatherFeels").textContent = weatherFmt(feels, "°C");
    document.getElementById("weatherHumidity").textContent = weatherFmt(hum, "%");
    document.getElementById("weatherWind").textContent = weatherFmt(wind, " km/h");

    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");
    const up = `${hh}:${mm}:${ss}`;
    document.getElementById("weatherUpdatedAt").textContent = fmtMaybeFaDigits(up);

    // Narrative
    const nar = weatherBuildNarrative(data.hourly || {}, WEATHER_TZ);
    const nt = document.getElementById("weatherNarrativeTitle");
    const ns = document.getElementById("weatherNarrativeSub");
    const nb = document.getElementById("weatherNarrative");
    if(nb){
      const umb = nb.querySelector("span.text-xl");
      if(umb) umb.textContent = nar.umbrellaEmoji;
    }
    if(nt) nt.textContent = nar.title;
    if(ns) ns.textContent = nar.sub;

    // Hourly + Daily
    const tab = weatherState.tab || "overview";
    weatherRenderHourly(data, tab);
    weatherRenderDaily(data);

    // برای کپی
    weatherState.lastText = `${p.name}${p.admin1?(" - "+p.admin1):""}: ${Math.round(t)}°C، ${info.text}، دمای احساسی ${Math.round(feels)}°C، رطوبت ${Math.round(hum)}٪، باد ${Math.round(wind)} km/h. ${nar.title}: ${nar.sub}`;

    setWeatherStatus("ok","به‌روزرسانی شد ✅");
  }catch{
    setWeatherStatus("err","خطا در دریافت آب‌ و هوا. اینترنت یا سرویس را بررسی کنید.");
  }
};

const initWeather = () => {
  const capSel = document.getElementById("weatherCapitalSel");
  const searchIn = document.getElementById("weatherSearchInput");
  const copyBtn = document.getElementById("weatherCopyBtn");
  const refBtn = document.getElementById("weatherRefreshBtn");

  if(!capSel || !searchIn) return;

  // تب‌ها (نمای کلی / بارش / باد / رطوبت)
  weatherState.tab = weatherState.tab || "overview";
  const tabBtns = Array.from(document.querySelectorAll(".weatherTab"));
  const setTabUI = (key)=>{
    weatherState.tab = key;
    tabBtns.forEach(b=>{
      const isOn = b.dataset.wtab === key;
      b.classList.toggle("tabActive", isOn);
      b.classList.toggle("tabIdle", !isOn);
    });
    if(weatherState.lastData){
      weatherRenderHourly(weatherState.lastData, key);
    }
  };
  tabBtns.forEach(b=>{
    b.addEventListener("click", ()=> setTabUI(b.dataset.wtab || "overview"));
  });
  setTabUI(weatherState.tab);


  capSel.innerHTML = `<option value="">— انتخاب کنید —</option>` + IRAN_CAPITALS.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

  capSel.addEventListener("change", async ()=>{
    const val = capSel.value;
    if(!val) return;
    try{
      setWeatherStatus("warn","در حال پیدا کردن موقعیت…");
      const res = await weatherGeocode(val);
      if(!res.length){ setWeatherStatus("warn","موقعیت پیدا نشد."); return; }
      await weatherSetPlace(res[0]);
      await weatherFetchAndRender();
    }catch{
      setWeatherStatus("err","خطا در جستجو.");
    }
  });

  let tmr = null;
  searchIn.addEventListener("input", ()=>{
    const q = searchIn.value.trim();
    const box = document.getElementById("weatherSearchResults");
    if(tmr) clearTimeout(tmr);
    if(q.length < 2){
      if(box) box.innerHTML = "";
      return;
    }
    tmr = setTimeout(async ()=>{
      try{
        setWeatherStatus("warn","در حال جستجو…");
        const items = await weatherGeocode(q);
        weatherRenderSearchResults(items);
        setWeatherStatus("ok","نتایج آماده است.");
      }catch{
        setWeatherStatus("err","خطا در جستجو.");
      }
    }, 300);
  });

  searchIn.addEventListener("keydown", async (e)=>{
    if(e.key!=="Enter") return;
    const q = searchIn.value.trim();
    if(q.length<2) return;
    try{
      setWeatherStatus("warn","در حال جستجو…");
      const items = await weatherGeocode(q);
      weatherRenderSearchResults(items);
      setWeatherStatus("ok","نتایج آماده است.");
    }catch{
      setWeatherStatus("err","خطا در جستجو.");
    }
  });

  if(refBtn) refBtn.addEventListener("click", weatherFetchAndRender);

  if(copyBtn) copyBtn.addEventListener("click", ()=>{
    if(!weatherState.lastText){ showToast("چیزی برای کپی وجود ندارد.", "warn"); return; }
    copyText(maybePersianForCopy(weatherState.lastText), "کپی شد ✅");
  });

  const last = weatherRestore();
  if(last){
    weatherSetPlace(last).then(()=>weatherFetchAndRender());
  }
};


/* ========================= Crypto (Nobitex) =========================
   - دریافت قیمت لحظه‌ای از API عمومی نوبیتکس (Orderbook)
   - بازارهای *IRT معمولاً قیمت را به «ریال» برمی‌گردانند؛ اینجا برای نمایش «تومان» عدد را ÷10 می‌کنیم.
   - به‌روزرسانی هوشمند: هر 15 ثانیه + توقف وقتی تب مخفی است
   منابع: مستندات API نوبیتکس
*/
const NOBITEX_ORDERBOOK = (symbol)=>`https://apiv2.nobitex.ir/v3/orderbook/${encodeURIComponent(symbol)}`;

const CRYPTO_MARKETS = [
  { key:"BTC",  symbol:"BTCIRT",  name:"بیت‌کوین",          icon:"btc"  },
  { key:"ETH",  symbol:"ETHIRT",  name:"اتریوم",            icon:"eth"  },
  { key:"USDT", symbol:"USDTIRT", name:"تتر",               icon:"usdt" },
  { key:"TON",  symbol:"TONIRT",  name:"تون",               icon:"ton"  },
  { key:"TRX",  symbol:"TRXIRT",  name:"ترون",              icon:"trx"  },
  { key:"PAXG", symbol:"PAXGIRT", name:"طلای دیجیتال (PAXG)", icon:"paxg" },
];

const cryptoEl = {
  grid: () => document.getElementById("cryptoGrid"),
  status: () => document.getElementById("cryptoStatusText"),
  updated: () => document.getElementById("cryptoUpdatedAt"),
};

const cryptoSvg = (k) => {
  const common = 'width="28" height="28" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"';
  if(k==="btc") return `<svg ${common}><circle cx="32" cy="32" r="28" fill="#F7931A"/><path d="M37.6 19.6c2.2.6 3.6 2 3.9 4.5.4 3.1-1.3 5.2-4 6.2 3.3 1.1 5.3 3.4 4.7 7.2-.7 4.2-4 6-8.4 6.4v5h-3.1v-4.8h-2.5v4.8H25v-5c-.6 0-1.2 0-1.8-.1l-3.8-.2.6-3.7 2.2.1c.8.1 1.3-.2 1.5-.9V22.7c-.1-.5-.4-.9-1.1-.9l-2.2-.1.6-3.6 4 .2h1v-5h3.2v5h2.5v-5h3.1v5.2c1 .1 2 .3 2.8.5Zm-8.3 9.6 4.2.2c2.1 0 3.9-.6 4.2-2.8.3-2.1-1.2-3-3-3.2l-5.4-.3v6.1Zm0 14.1 5.2.3c2.6.1 4.7-.7 5.1-3.3.4-2.5-1.3-3.6-3.7-3.8l-6.6-.4v7.2Z" fill="#0B1220"/></svg>`;
  if(k==="eth") return `<svg ${common}><circle cx="32" cy="32" r="28" fill="#627EEA"/><path d="M32 10l12 20-12 7-12-7 12-20Zm0 29 12-7-12 17-12-17 12 7Z" fill="#0B1220" opacity=".95"/></svg>`;
  if(k==="usdt") return `<svg ${common}><circle cx="32" cy="32" r="28" fill="#26A17B"/><path d="M39 18H25v6c-5.4.7-9.5 2.3-9.5 4.2 0 1.9 4.1 3.5 9.5 4.2v13h14V36.6c5.4-.7 9.5-2.3 9.5-4.2 0-1.9-4.1-3.5-9.5-4.2V18Zm-7 18.2c-6.1 0-11-.9-11-2 0-1.1 4.9-2 11-2s11 .9 11 2c0 1.1-4.9 2-11 2Zm0-6.1c-3.9 0-7.1-.4-7.1-.9s3.2-.9 7.1-.9 7.1.4 7.1.9-3.2.9-7.1.9Z" fill="#0B1220" opacity=".95"/></svg>`;
  if(k==="ton") return `<svg ${common}><circle cx="32" cy="32" r="28" fill="#0098EA"/><path d="M32 16c-7 0-14 2.9-14 8.3 0 3.7 3 7.1 7.4 10.7l3.9 3.2c1.5 1.2 3.9 1.2 5.4 0l3.9-3.2c4.4-3.6 7.4-7 7.4-10.7C46 18.9 39 16 32 16Zm0 20.7-4.3-3.6c-3.6-3-5.7-5.3-5.7-7.8 0-2.6 4-4.7 10-4.7s10 2.1 10 4.7c0 2.5-2.1 4.8-5.7 7.8L32 36.7Z" fill="#0B1220" opacity=".95"/></svg>`;
  if(k==="trx") return `<svg ${common}><circle cx="32" cy="32" r="28" fill="#EF0027"/><path d="M18 18l28 5-10 28-18-33Zm8.8 7.6 9.2 7.5 6.2-8.7-15.4 1.2Zm7.1 10.9-7.8-6.4 8.9 16.5 5.8-16.2-6.9 6.1Z" fill="#0B1220" opacity=".95"/></svg>`;
  if(k==="paxg") return `<svg ${common}><circle cx="32" cy="32" r="28" fill="#D4AF37"/><path d="M32 15c6.2 0 11 3 11 8 0 5.6-4.4 11.6-11 26-6.6-14.4-11-20.4-11-26 0-5 4.8-8 11-8Zm0 5.5a4.6 4.6 0 1 0 0 9.2 4.6 4.6 0 0 0 0-9.2Z" fill="#0B1220" opacity=".95"/></svg>`;
  return `<div class="w-7 h-7 rounded-xl grad"></div>`;
};

let cryptoTimer = null;
let cryptoLastUpdated = null;
let cryptoInFlight = false;
let cryptoLastRows = [];

const toToman = (rial) => rial / 10;

const formatMoneyFa = (n) => {
  const cfg = elementSdk.getConfig();
  if(!Number.isFinite(n)) return "—";
  const s = Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  return cfg.enable_persian_digits ? toPersianDigits(s) : s;
};

const fetchMarket = async (symbol) => {
  const res = await fetch(NOBITEX_ORDERBOOK(symbol), { cache:"no-store" });
  if(!res.ok) throw new Error("bad_status");
  const data = await res.json();
    weatherState.lastData = data;
  if(!data || data.status !== "ok") throw new Error("bad_payload");
  const p = Number(data.lastTradePrice);
  const u = Number(data.lastUpdate);
  if(!Number.isFinite(p)) throw new Error("bad_price");
  return { price: p, lastUpdate: u };
};

const renderCrypto = (rows) => {
  cryptoLastRows = rows;
  const grid = cryptoEl.grid();
  if(!grid) return;
  grid.innerHTML = "";
  rows.forEach(r=>{
    const priceText = r.priceToman != null ? `${formatMoneyFa(r.priceToman)} تومان` : "—";
    const card = document.createElement("div");
    card.className = "cryptoCard soft p-3 rounded-2xl flex items-center justify-between gap-3";
    card.innerHTML = `
      <div class="flex items-center gap-3 min-w-0">
        <div class="shrink-0">${cryptoSvg(r.icon)}</div>
        <div class="min-w-0">
          <div class="font-bold truncate">${escapeHtml(r.name)}</div>
          <div class="muted tiny mt-0.5">${escapeHtml(r.key)} • ${escapeHtml(r.symbol)}</div>
        </div>
      </div>
      <div class="text-left">
        <div class="text-lg font-extrabold calcDisplay">${priceText}</div>
        <button type="button" class="btn px-3 py-1.5 mt-2 soft focusable tiny" data-ccopy="${escapeHtml(r.key)}">کپی</button>
      </div>
    `;
    grid.appendChild(card);
  });

  grid.querySelectorAll("[data-ccopy]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const k = btn.getAttribute("data-ccopy");
      const row = rows.find(x=>x.key===k);
      if(!row || row.priceToman==null){ showToast("چیزی برای کپی وجود ندارد.", "warn"); return; }
      const txt = `${row.key}: ${Math.round(row.priceToman)} تومان`;
      copyText(maybePersianForCopy(txt), "قیمت کپی شد ✅");
    });
  });
};

const setCryptoStatus = (msg, type="info") => {
  const el = cryptoEl.status();
  if(!el) return;
  el.className = "tiny " + (type==="ok" ? "text-emerald-200" : type==="err" ? "text-rose-200" : "text-amber-200");
  el.textContent = msg;
};

const updateCrypto = async (force=false) => {
  if(cryptoInFlight && !force) return;
  cryptoInFlight = true;

  try{
    setCryptoStatus("در حال دریافت قیمت‌ها…", "info");
    const tasks = CRYPTO_MARKETS.map(async m=>{
      try{
        const d = await fetchMarket(m.symbol);
        return { ...m, priceRaw: d.price, priceToman: toToman(d.price), lastUpdate: d.lastUpdate };
      }catch{
        return { ...m, priceRaw: null, priceToman: null, lastUpdate: null, _err:true };
      }
    });

    const rows = await Promise.all(tasks);
    renderCrypto(rows);

    const last = rows.map(r=>r.lastUpdate).filter(Boolean).sort((a,b)=>b-a)[0];
    cryptoLastUpdated = last ? new Date(last) : new Date();
    const cfg = elementSdk.getConfig();
    const ts = cryptoLastUpdated ? cryptoLastUpdated.toLocaleTimeString("fa-IR", {hour:"2-digit", minute:"2-digit", second:"2-digit"}) : "—";
    const shown = cfg.enable_persian_digits ? ts : toLatinDigits(ts);

    if(cryptoEl.updated()) cryptoEl.updated().textContent = shown;
    setCryptoStatus("قیمت‌ها به‌روزرسانی شد ✅", "ok");
  }catch{
    setCryptoStatus("خطا در دریافت قیمت‌ها. اینترنت/دسترسی API را بررسی کنید.", "err");
  }finally{
    cryptoInFlight = false;
  }
};

const startCryptoAuto = () => {
  if(cryptoTimer) clearInterval(cryptoTimer);
  cryptoTimer = setInterval(()=>{ if(!document.hidden) updateCrypto(); }, 15000);
};

document.addEventListener("visibilitychange", ()=>{
  if(!document.hidden) updateCrypto(true);
});

/* ========================= Settings helpers ========================= */
const bindColorPair = (colorInput, textInput, key) => {
  const syncFromColor = () => { textInput.value = colorInput.value; elementSdk.setConfig({[key]: colorInput.value}); };
  const syncFromText = () => {
    const v=textInput.value.trim();
    if(/^#([0-9a-fA-F]{6})$/.test(v)){ colorInput.value=v; elementSdk.setConfig({[key]: v}); }
    else showToast("کد رنگ نامعتبر است. مثل: #0b1220", "warn");
  };
  colorInput.addEventListener("input", syncFromColor);
  textInput.addEventListener("change", syncFromText);
};

const syncSettingsForm = (cfg) => {
  const setPair=(cId,tId,val)=>{
    const c=document.getElementById(cId), t=document.getElementById(tId);
    c.value = val; t.value = val;
  };
  setPair("bgColor","bgColorText", cfg.background_color);
  setPair("surfaceColor","surfaceColorText", cfg.surface_color);
  setPair("textColor","textColorText", cfg.text_color);
  setPair("primaryColor","primaryColorText", cfg.primary_action);
  setPair("secondaryColor","secondaryColorText", cfg.secondary_action);
  setPair("gradA","gradAText", cfg.accent_gradient_start);
  setPair("gradB","gradBText", cfg.accent_gradient_end);

  document.getElementById("fontFamily").value = cfg.font_family;
  document.getElementById("fontSize").value = cfg.font_size;
  document.getElementById("fontSizeLabel").textContent = displayNum(cfg.font_size);

  setToggleUI(document.getElementById("persianDigitsToggle"), document.getElementById("persianDigitsDot"), !!cfg.enable_persian_digits);
  setToggleUI(document.getElementById("copyPersianToggle"), document.getElementById("copyPersianDot"), !!cfg.copy_with_persian_digits);

  setToggleUI(document.getElementById("soundToggle"), document.getElementById("soundDot"), !!cfg.enable_click_sound);
  document.getElementById("soundVolume").value = clamp(Number(cfg.click_volume ?? 30),0,100);
  document.getElementById("soundVolumeLabel").textContent = displayNum(clamp(Number(cfg.click_volume ?? 30),0,100));

  document.getElementById("calcDisplayLang").value = (cfg.calculator_display_lang==="en" ? "en" : "fa");
  updateCalculatorDigitLabels(document.getElementById("calcDisplayLang").value);
};

/* ========================= INIT ========================= */
(function init(){
  const cfg=elementSdk.getConfig();
  applyConfig(cfg);
  bindNav();
  initWeather();

  const hash=(location.hash||"").replace("#","");
  showPage(pages.includes(hash)?hash:"converter");

  // categories
  const catSel=document.getElementById("categorySel");
  CATEGORIES.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.id; o.textContent=c.name;
    catSel.appendChild(o);
  });
  catSel.value = CATEGORIES[0].id;
  setUnitsForCategory(catSel.value);

  // converter events
  document.getElementById("valueInput").addEventListener("input", computeConverter);
  document.getElementById("fromUnitSel").addEventListener("change", ()=>{ state.fromLabel = document.getElementById("fromUnitSel").value; computeConverter(); });
  document.getElementById("toUnitSel").addEventListener("change", ()=>{ state.toLabel = document.getElementById("toUnitSel").value; computeConverter(); });
  document.getElementById("swapBtn").addEventListener("click", swapUnits);
  catSel.addEventListener("change", ()=>{
    state.categoryId=catSel.value;
    setUnitsForCategory(catSel.value);
    showToast("دسته‌بندی تغییر کرد.", "info");
  });

  document.getElementById("precisionRange").addEventListener("input", (e)=>{
    const v=clamp(Number(e.target.value),0,8);
    document.getElementById("precisionLabel").textContent = displayNum(v);
    elementSdk.setConfig({precision:v});
  });

  document.getElementById("copyResultBtn").addEventListener("click", ()=>{
    const cfg=elementSdk.getConfig();
    const cat=getCategory(catSel.value);
    const toUnit=findUnitByLabel(cat, document.getElementById("toUnitSel").value);
    const inputVal=safeNum(document.getElementById("valueInput").value);
    const fromUnit=findUnitByLabel(cat, document.getElementById("fromUnitSel").value);
    const toVal=convertValue(cat, inputVal, fromUnit, toUnit);
    if(!Number.isFinite(toVal)){ showToast("چیزی برای کپی وجود ندارد.", "warn"); return; }
    const txt = `${formatNumber(toVal, clamp(Number(cfg.precision??2),0,8))} ${toUnit.symbol}`;
    copyText(maybePersianForCopy(txt), "نتیجه کپی شد ✅");
  });

  document.getElementById("uiPersianDigitsToggle").addEventListener("change", (e)=>{
    elementSdk.setConfig({enable_persian_digits: e.target.checked});
    showToast(e.target.checked ? "نمایش اعداد فارسی فعال شد." : "نمایش اعداد فارسی غیرفعال شد.", "info");
  });

  // health live
  ["bmiWeight","bmiHeight","idealWeightToggle"].forEach(id=>document.getElementById(id).addEventListener("input", computeBMIUI));
  ["sexSel","ageInput","calHeight","calWeight","activitySel","goalSel"].forEach(id=>document.getElementById(id).addEventListener("input", computeCaloriesUI));

  // lab helper init
  const labTypeSel = document.getElementById("labType");
  if(labTypeSel){
    labTypeSel.innerHTML = "";
    LAB_TESTS.forEach(t=>{
      const o=document.createElement("option");
      o.value=t.id; o.textContent=t.name;
      labTypeSel.appendChild(o);
    });
    labTypeSel.value = LAB_TESTS[0].id;
    ["labType","labValue","labSex"].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.addEventListener("input", computeLabUI);
      if(el) el.addEventListener("change", computeLabUI);
    });
    const copyLabBtn = document.getElementById("copyLabBtn");
    if(copyLabBtn) copyLabBtn.addEventListener("click", ()=>{
      if(!labLastText){ showToast("چیزی برای کپی وجود ندارد.", "warn"); return; }
      copyText(maybePersianForCopy(labLastText), "نتیجه کپی شد ✅");
    });
    computeLabUI();
  }

  document.getElementById("copyBmiBtn").addEventListener("click", ()=>{
    const cfg=elementSdk.getConfig();
    const w=safeNum(document.getElementById("bmiWeight").value);
    const h=safeNum(document.getElementById("bmiHeight").value);
    const bmi=calculateBMI(w,h);
    if(!Number.isFinite(bmi)){ showToast("ابتدا وزن و قد معتبر وارد کنید.", "warn"); return; }
    const txt = `BMI: ${formatNumber(bmi, clamp(Number(cfg.precision??2),0,8))}`;
    copyText(maybePersianForCopy(txt), "BMI کپی شد ✅");
  });

  document.getElementById("copyGoalBtn").addEventListener("click", ()=>{
    const cfg=elementSdk.getConfig();
    const sex=document.getElementById("sexSel").value;
    const age=safeNum(document.getElementById("ageInput").value);
    const h=safeNum(document.getElementById("calHeight").value);
    const w=safeNum(document.getElementById("calWeight").value);
    const activity=safeNum(document.getElementById("activitySel").value);
    const goalAdj=safeNum(document.getElementById("goalSel").value);
    const bmr=calculateBMR(sex,w,h,age);
    const tdee=calculateTDEE(bmr,activity);
    const goal = Number.isFinite(tdee) ? tdee + (Number.isFinite(goalAdj)?goalAdj:0) : NaN;
    if(!Number.isFinite(goal)){ showToast("ابتدا اطلاعات معتبر وارد کنید.", "warn"); return; }
    const txt = `کالری هدف: ${formatNumber(goal, clamp(Number(cfg.precision??2),0,8))} کیلوکالری`;
    copyText(maybePersianForCopy(txt), "کالری هدف کپی شد ✅");
  });

  // datetime (TimeAPI.io)
  document.getElementById("timeRefreshBtn").addEventListener("click", ()=>{
    buildAnalogSvgOnce();
  fetchTimeApi();
  tickTime();
    showToast("درخواست به‌روزرسانی ارسال شد.", "info");
  });
  document.getElementById("timeCopyBtn").addEventListener("click", ()=>{
    const j = toLatinDigits(document.getElementById("todayJalali").textContent);
    const g = toLatinDigits(document.getElementById("todayGreg").textContent);
    const ir = toLatinDigits(document.getElementById("timeIR").textContent);
    const txt = `تاریخ شمسی: ${j}\nتاریخ میلادی: ${g}\nساعت ایران: ${ir}`;
    copyText(maybePersianForCopy(txt), "اطلاعات کپی شد ✅");
  });


  // calculator pads (basic + scientific)
  const bindCalcPad = (el) => {
    if(!el) return;
    el.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-k]");
      if(!btn) return;
      calcPush(btn.dataset.k);
    });
  };
  bindCalcPad(document.getElementById("calcPadBasic"));
  bindCalcPad(document.getElementById("calcPadSci"));

  document.getElementById("calcClearBtn").addEventListener("click", calcClear);
  document.getElementById("calcCopyBtn").addEventListener("click", ()=>{
    const out = document.getElementById("calcResult").textContent;
    const raw = toLatinDigits(out);
    if(raw==="—"){ showToast("چیزی برای کپی وجود ندارد.", "warn"); return; }
    copyText(maybePersianForCopy(raw), "نتیجه ماشین حساب کپی شد ✅");
  });
  document.getElementById("calcModeBtn").addEventListener("click", ()=>{
    setCalcMode(calcMode==="sci" ? "basic" : "sci");
    showToast(calcMode==="sci" ? "حالت مهندسی فعال شد." : "حالت ساده فعال شد.", "info");
  });

  window.addEventListener("keydown", (e)=>{
    const onCalc = !document.getElementById("page-calculator").classList.contains("hidden");
    if(!onCalc) return;
    const key=e.key;
    if(key==="Enter"){ e.preventDefault(); calcPush("="); return; }
    if(key==="Backspace"){ calcPush("DEL"); return; }
    const allowed = "0123456789+-*/().%^,";
    if(allowed.includes(key)){ calcPush(key); return; }
  });


  

  
  // crypto
  updateCrypto(true);
  startCryptoAuto();
  const refreshBtn=document.getElementById("cryptoRefreshBtn");
  if(refreshBtn) refreshBtn.addEventListener("click", ()=>updateCrypto(true));
  const copyAllBtn=document.getElementById("cryptoCopyAllBtn");
  if(copyAllBtn) copyAllBtn.addEventListener("click", ()=>{
    if(!cryptoLastRows || !cryptoLastRows.length){ showToast("چیزی برای کپی وجود ندارد.", "warn"); return; }
    const lines = cryptoLastRows.map(r=> r.priceToman==null ? `${r.key}: —` : `${r.key}: ${Math.round(r.priceToman)} تومان`);
    copyText(maybePersianForCopy(lines.join("\n")), "همه قیمت‌ها کپی شد ✅");
  });
// settings bindings
  bindColorPair(document.getElementById("bgColor"), document.getElementById("bgColorText"), "background_color");
  bindColorPair(document.getElementById("surfaceColor"), document.getElementById("surfaceColorText"), "surface_color");
  bindColorPair(document.getElementById("textColor"), document.getElementById("textColorText"), "text_color");
  bindColorPair(document.getElementById("primaryColor"), document.getElementById("primaryColorText"), "primary_action");
  bindColorPair(document.getElementById("secondaryColor"), document.getElementById("secondaryColorText"), "secondary_action");
  bindColorPair(document.getElementById("gradA"), document.getElementById("gradAText"), "accent_gradient_start");
  bindColorPair(document.getElementById("gradB"), document.getElementById("gradBText"), "accent_gradient_end");

  document.getElementById("fontFamily").addEventListener("change", (e)=>elementSdk.setConfig({font_family: e.target.value}));
  document.getElementById("fontSize").addEventListener("input", (e)=>{
    const v=clamp(Number(e.target.value),13,20);
    document.getElementById("fontSizeLabel").textContent = displayNum(v);
    elementSdk.setConfig({font_size:v});
  });

  document.getElementById("persianDigitsToggle").addEventListener("change", (e)=>{
    elementSdk.setConfig({enable_persian_digits: e.target.checked});
    showToast(e.target.checked ? "نمایش اعداد فارسی فعال شد." : "نمایش اعداد فارسی غیرفعال شد.", "info");
  });

  document.getElementById("copyPersianToggle").addEventListener("change", (e)=>{
    elementSdk.setConfig({copy_with_persian_digits: e.target.checked});
    showToast(e.target.checked ? "کپی با اعداد فارسی فعال شد." : "کپی با اعداد فارسی غیرفعال شد.", "info");
  });

  document.getElementById("soundToggle").addEventListener("change", (e)=>{
    elementSdk.setConfig({enable_click_sound: e.target.checked});
    showToast(e.target.checked ? "صدای کلیک فعال شد." : "صدای کلیک غیرفعال شد.", "info");
    if(e.target.checked){ ensureAudio(); playClick(); }
  });

  document.getElementById("soundVolume").addEventListener("input", (e)=>{
    const v=clamp(Number(e.target.value),0,100);
    document.getElementById("soundVolumeLabel").textContent = displayNum(v);
    elementSdk.setConfig({click_volume:v});
  });

  document.getElementById("calcDisplayLang").addEventListener("change", (e)=>{
    elementSdk.setConfig({calculator_display_lang: e.target.value});
    showToast(e.target.value==="en" ? "نمایشگر ماشین حساب: انگلیسی" : "نمایشگر ماشین حساب: فارسی", "info");
  });

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    localStorage.removeItem("proUnitConverter.config");
    elementSdk.setConfig({...defaultConfig});
    showToast("تنظیمات بازنشانی شد.", "ok");
  });

  document.getElementById("exportConfig").addEventListener("click", ()=>{
    const cfg = elementSdk.getConfig();
    copyText(JSON.stringify(cfg, null, 2), "پیکربندی کپی شد ✅");
  });

  document.getElementById("importConfig").addEventListener("click", ()=>{
    const raw = prompt("پیکربندی را وارد کنید (JSON):");
    if(!raw) return;
    try{
      const parsed = JSON.parse(raw);
      elementSdk.setConfig(parsed);
      showToast("پیکربندی اعمال شد ✅", "ok");
    }catch{
      showToast("فرمت JSON نامعتبر است.", "err");
    }
  });

  elementSdk.onConfigChange((newCfg)=>{
    applyConfig(newCfg);
    syncSettingsForm(newCfg);
    computeConverter();
    computeBMIUI();
    computeCaloriesUI();
    calcEvaluate();
    tickTime();
    renderCrypto(cryptoLastRows); // بروزرسانی نمایش (بدون درخواست جدید)
  });

  // initial renders
  syncSettingsForm(cfg);
  computeConverter();
  computeBMIUI();
  computeCaloriesUI();
  calcEvaluate();
  setCalcMode("basic");
  tickTime();
  updateCrypto(true);
  startCryptoAuto();

  // fetch time (TimeAPI.io)
  fetchTimeApi();
  setInterval(fetchTimeApi, 60 * 1000);

  setInterval(tickTime, 250);

  showToast("آماده‌ست! ✅", "ok");
})();
</script>
</body>
</html>
