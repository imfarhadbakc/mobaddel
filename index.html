<!doctype html>
<html lang="fa" dir="rtl" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codeisa</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; }
    * { font-family: 'Vazirmatn', sans-serif; }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
    .glass-dark { background: rgba(0,0,0,0.3); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }

    /* Unified input styles (banking + dropdowns) */
    .input{
      width:100%;
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.92);
      border-radius: 14px;
      padding: 12px 14px;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08);
      font-variant-numeric: tabular-nums;
    }
    .input::placeholder{ color: rgba(255,255,255,0.35); }
    .input:focus{
      border-color: rgba(129,140,248,0.65);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.20);
    }
    select.input{ -webkit-appearance:none; appearance:none; background-image: linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.7) 50%), linear-gradient(135deg, rgba(255,255,255,0.7) 50%, transparent 50%); background-position: calc(14px) 50%, calc(8px) 50%; background-size: 6px 6px, 6px 6px; background-repeat: no-repeat; padding-left: 34px; }
    select.input option{ background:#0b0b12; color:#fff; }
    input.input{ direction:ltr; text-align:right; }
    @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:.3} }
    .blink { animation: blink 1.5s infinite; }
    @keyframes float { 0%,100%{transform:translateY(0) translateX(0)} 25%{transform:translateY(-10px) translateX(5px)} 50%{transform:translateY(-5px) translateX(-5px)} 75%{transform:translateY(-15px) translateX(3px)} }
    .cloud { animation: float 8s ease-in-out infinite; }
    @keyframes rain-fall { 0%{transform:translateY(-100%);opacity:0} 10%{opacity:1} 90%{opacity:1} 100%{transform:translateY(400px);opacity:0} }
    .rain-drop { animation: rain-fall 1s linear infinite; }
    @keyframes snow-fall { 0%{transform:translateY(-100%) rotate(0deg);opacity:0} 10%{opacity:1} 90%{opacity:.8} 100%{transform:translateY(400px) rotate(360deg);opacity:0} }
    .snow-flake { animation: snow-fall 3s linear infinite; }
    @keyframes sun-pulse { 0%,100%{transform:scale(1);filter:drop-shadow(0 0 20px rgba(255,200,0,.5))} 50%{transform:scale(1.05);filter:drop-shadow(0 0 30px rgba(255,200,0,.7))} }
    .sun-glow { animation: sun-pulse 3s ease-in-out infinite; }
    @keyframes twinkle { 0%,100%{opacity:.3} 50%{opacity:1} }
    .star { animation: twinkle 2s ease-in-out infinite; }
    .nav-btn { transition: all .2s ease; }
    .nav-btn:active { transform: scale(.95); }
    .nav-btn.active { background: linear-gradient(135deg, rgba(99,102,241,.4), rgba(168,85,247,.4)); border-color: rgba(139,92,246,.5); }
    .banking-tab.active { background: linear-gradient(135deg, rgba(99,102,241,.4), rgba(168,85,247,.4)); border: 1px solid rgba(139,92,246,.5); }
    .calc-btn { transition: all .15s ease; }
    .calc-btn:active { transform: scale(.92); }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance:none; margin:0; }
    input[type="number"] { -moz-appearance:textfield; }
    .chart-container { position: relative; height: 120px; }
    .scrollbar-hide::-webkit-scrollbar { display:none; }
    .scrollbar-hide { -ms-overflow-style:none; scrollbar-width:none; }
    @keyframes gradient-shift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .animated-gradient { background-size: 200% 200%; animation: gradient-shift 15s ease infinite; }
    .pill { transition: all .2s ease; }
    .pill.active { background: linear-gradient(135deg, rgba(99,102,241,.5), rgba(168,85,247,.5)); border-color: rgba(139,92,246,.55); }
  
    /* Unit dropdown (better contrast) */
    .unit-menu{
      background: rgba(10, 5, 30, 0.98);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(16px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
    }
    .unit-menu::-webkit-scrollbar{ width: 8px; }
    .unit-menu::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.15); border-radius: 10px; }

    
    /* Forecast strip scroll (desktop-friendly) */
    .forecast-strip{
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.22) rgba(255,255,255,0.06);
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
      cursor: grab;
    }
    .forecast-strip:active{ cursor: grabbing; }
    .forecast-strip::-webkit-scrollbar{ height: 8px; }
    .forecast-strip::-webkit-scrollbar-track{ background: rgba(255,255,255,0.06); border-radius: 999px; }
    .forecast-strip::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.22); border-radius: 999px; }

    /* Telegram icon animation */
    @keyframes tgPulse { 0%,100%{ transform:translateY(0) scale(1); filter:drop-shadow(0 0 0 rgba(56,189,248,0)); } 50%{ transform:translateY(-2px) scale(1.05); filter:drop-shadow(0 8px 16px rgba(56,189,248,0.25)); } }
    .tg-anim{ animation: tgPulse 1.6s ease-in-out infinite; }

  
    /* --- Fix: dropdown menus should overlay other cards --- */
    #converter-section, #converter-section .glass { overflow: visible !important; }
    .unit-dropdown { position: relative; z-index: 2000; }
    .unit-dropdown .unit-menu, #conv-type-menu, #from-unit-menu, #to-unit-menu {
      z-index: 9999 !important;
    }
    /* make the dropdown list readable on all backgrounds */
    .unit-menu, #conv-type-menu{
      background: rgba(10, 5, 30, 0.98) !important;
      color: rgba(255,255,255,0.95) !important;
    }

    /* --- Responsive: keep mobile perfect, improve desktop width --- */
    @media (min-width: 1024px){
      #app { max-width: 1100px; margin-left: auto; margin-right: auto; }
      main { padding-left: 24px !important; padding-right: 24px !important; }
    }


    /* Responsive tweaks */
    .table-actions{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .btn-mini{background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.14); padding:8px 10px; border-radius:12px; font-size:12px}
    .btn-mini:hover{background:rgba(255,255,255,0.12)}
    .chart-wrap{min-height:220px}
    @media (max-width: 640px){
      .chart-wrap{min-height:200px}
      .glass{border-radius:18px}
    }

    /* Print/PDF export */
    @media print{
      body{background:#fff !important; color:#111 !important}
      nav, #top-nav, .nav-btn, .no-print{display:none !important}
      .glass, .glass-dark{background:transparent !important; border:0 !important; box-shadow:none !important}
      canvas{max-width:100% !important}
      table{width:100% !important}
      .print-card{padding:0 !important}
    }

    /* Weather: nicer clouds + depth */
    .cloud{filter: drop-shadow(0 6px 10px rgba(0,0,0,0.18)); opacity:0.95}
    .cloud svg{filter: blur(0.2px)}
    @keyframes cloudFloat { 0%{transform:translateX(120%)} 100%{transform:translateX(-140%)} }
    .cloud{animation: cloudFloat linear infinite; }
    .cloud.slow{animation-duration: 38s}
    .cloud.mid{animation-duration: 28s}
    .cloud.fast{animation-duration: 18s}
    .cloudLayer{position:absolute; inset:0; pointer-events:none}
    .mist{position:absolute; inset:-20px; background:radial-gradient(circle at 20% 30%, rgba(255,255,255,0.14), transparent 55%), radial-gradient(circle at 70% 60%, rgba(255,255,255,0.10), transparent 60%); filter: blur(6px); opacity:0.7}

/* DateTime: progress bars */
.progress-track{background:rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.10); border-radius:999px; overflow:hidden}
.progress-bar{height:10px; border-radius:999px; background:linear-gradient(90deg, rgba(99,102,241,0.9), rgba(168,85,247,0.9)); width:0%}
.mono{font-variant-numeric: tabular-nums}

/* Weather: richer animations */
@keyframes lightningFlash { 0%,92%,100%{opacity:0} 93%{opacity:0.65} 94%{opacity:0.15} 95%{opacity:0.85} 96%{opacity:0.2} 97%{opacity:0.7} }
.lightning-flash{position:absolute; inset:0; background:rgba(255,255,255,0.55); animation: lightningFlash 5.5s infinite; pointer-events:none; mix-blend-mode: overlay;}
@keyframes windDrift { 0%{transform:translateX(120%)} 100%{transform:translateX(-140%)} }
.wind-line{position:absolute; height:2px; width:80px; background:rgba(255,255,255,0.18); border-radius:999px; filter: blur(0.2px); animation: windDrift linear infinite}
@keyframes rainSlash { 0%{transform:translateY(-120%) translateX(0);opacity:0} 10%{opacity:1} 90%{opacity:1} 100%{transform:translateY(420px) translateX(80px);opacity:0} }
.rain-slash{animation: rainSlash 0.95s linear infinite;}

  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>

<body class="h-full bg-gradient-to-br from-slate-900 via-purple-950 to-slate-900 animated-gradient text-white overflow-auto text-[15px] md:text-[16px] lg:text-[17px]">
<div id="app" class="min-h-full w-full">

  <!-- Header -->
  <header class="glass-dark sticky top-0 z-50 px-4 py-3">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xl font-bold shadow-lg shadow-purple-500/30">âš¡</div>
        <h1 id="site-title" class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Codeisa</h1>
      </div>
      <!-- ØªØºÛŒÛŒØ±: Ø§ÙØ²ÙˆØ¯Ù† Ù…ØªÙ† Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ VPN -->
      <div id="online-status" class="flex items-center gap-2 text-xs">
        <span class="w-2 h-2 rounded-full bg-green-500 blink"></span>
        <span class="text-green-400">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
        
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="px-4 py-3 overflow-x-auto scrollbar-hide">
    <div class="max-w-5xl mx-auto flex gap-2 min-w-max">
      <button onclick="showSection('crypto')" class="nav-btn active glass px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap" data-section="crypto">ğŸ’° Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„</button>
      <button onclick="showSection('weather')" class="nav-btn glass px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap" data-section="weather">ğŸŒ¤ï¸ Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</button>
      <button onclick="showSection('datetime')" class="nav-btn glass px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap" data-section="datetime">ğŸ“… ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</button>
      <button onclick="showSection('converter')" class="nav-btn glass px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap" data-section="converter">ğŸ“ ØªØ¨Ø¯ÛŒÙ„ ÙˆØ§Ø­Ø¯</button>
      <button onclick="showSection('calculator')" class="nav-btn glass px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap" data-section="calculator">ğŸ§® Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</button>
      <button onclick="showSection('health')" class="nav-btn glass px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap" data-section="health">â¤ï¸ Ø³Ù„Ø§Ù…Øª</button>
      <button onclick="showSection('banking')" class="nav-btn glass px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap" data-section="banking">ğŸ¦ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¨Ø§Ù†Ú©ÛŒ</button>
      <button onclick="showSection('guide')" class="nav-btn glass px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap" data-section="guide">ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="px-4 pb-8">
    <div class="max-w-5xl mx-auto">

      <!-- Crypto Section -->
      <section id="crypto-section" class="space-y-4">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-lg font-bold">Ù‚ÛŒÙ…Øª Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</h2>
            <div class="text-[11px] text-gray-300 mt-1">Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ØŒ VPN Ø®Ø§Ù…ÙˆØ´ Ú©Ù†ÛŒØ¯.</div>
          </div>
          <div id="crypto-status" class="flex items-center gap-2 text-xs">
            <span class="status-dot w-2 h-2 rounded-full bg-yellow-500 blink"></span>
            <span class="status-text text-yellow-400">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
          </div>
        </div>
        <div id="crypto-cards" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        <div class="text-xs text-gray-400">Ù…Ù†Ø¨Ø¹ Ù‚ÛŒÙ…Øª: Ù†ÙˆØ¨ÛŒØªÚ©Ø³ (ØªÙ‚Ø±ÛŒØ¨ÛŒ/Ù†Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± Û²Û´ Ø³Ø§Ø¹ØªÙ‡)</div>
      </section>

      <!-- Weather Section -->
      <section id="weather-section" class="hidden space-y-4">
        <div class="flex flex-col gap-3 mb-4">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
            <div class="flex items-center gap-2"><h2 class="text-lg font-bold">Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</h2><span class="text-xs px-2 py-1 rounded-lg bg-white/10 border border-white/10 text-amber-200">Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ VPN</span></div>
            <!-- ØªØºÛŒÛŒØ±: Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ø³ØªØ¬Ùˆ Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ø§ÛŒØ±Ø§Ù† (Ø¨Ø§ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†) -->
            <div class="flex gap-2 w-full sm:w-auto">
              <div class="glass px-3 py-2 rounded-xl text-sm bg-transparent outline-none w-full sm:w-80 flex items-center gap-2">
                <span class="text-gray-300">ğŸ”</span>
                <input id="city-search" class="bg-transparent outline-none w-full" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯ (ØªÙ…Ø§Ù… Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†)..." oninput="searchIranCities()">
              </div>
            </div>
          </div>
          <div id="city-results" class="hidden glass rounded-2xl p-3 text-sm">
            <div class="text-gray-300 mb-2">Ù†ØªØ§ÛŒØ¬:</div>
            <div id="city-results-list" class="space-y-2"></div>
          </div>
        </div>

        <div id="weather-card" class="glass rounded-2xl p-6 relative overflow-hidden min-h-[320px]">
          <div id="weather-animation" class="absolute inset-0 pointer-events-none"></div>
          <div id="weather-content" class="relative z-10">
            <div class="text-center text-gray-400">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
          </div>
        </div>
      </section>

      <!-- DateTime Section -->
      <section id="datetime-section" class="hidden space-y-4">
        <h2 class="text-lg font-bold mb-4">ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</h2>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="glass rounded-2xl p-4 text-center">
            <div class="text-xs text-gray-400 mb-1">Ø³Ø§Ø¹Øª Ø§ÛŒØ±Ø§Ù†</div>
            <div id="iran-time" class="text-3xl font-bold tabular-nums">--:--:--</div>
            <div id="iran-date" class="text-sm text-gray-400 mt-1"></div>
          </div>
          <div class="glass rounded-2xl p-4 text-center">
            <div class="text-xs text-gray-400 mb-1">Ø³Ø§Ø¹Øª Ø¬Ù‡Ø§Ù†ÛŒ (UTC)</div>
            <div id="utc-time" class="text-3xl font-bold tabular-nums">--:--:--</div>
            <div id="utc-date" class="text-sm text-gray-400 mt-1"></div>
          </div>
          <div class="glass rounded-2xl p-4 flex flex-col items-center justify-center">
            <div class="text-xs text-gray-400 mb-2">Ø³Ø§Ø¹Øª Ø¢Ù†Ø§Ù„ÙˆÚ¯</div>
            <svg id="analog-clock" width="100" height="100" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2" />
              <circle cx="50" cy="50" r="3" fill="white" />
              <g stroke="rgba(255,255,255,0.5)" stroke-width="2">
                <line x1="50" y1="10" x2="50" y2="15" />
                <line x1="90" y1="50" x2="85" y2="50" />
                <line x1="50" y1="90" x2="50" y2="85" />
                <line x1="10" y1="50" x2="15" y2="50" />
              </g>
              <g id="clock-numbers" font-family="ui-sans-serif,system-ui" font-size="8" fill="rgba(255,255,255,0.75)" text-anchor="middle" dominant-baseline="middle">
                <text x="50" y="20">Û±Û²</text>
                <text x="65" y="23">Û±</text>
                <text x="76" y="34">Û²</text>
                <text x="82" y="50">Û³</text>
                <text x="76" y="66">Û´</text>
                <text x="65" y="77">Ûµ</text>
                <text x="50" y="82">Û¶</text>
                <text x="35" y="77">Û·</text>
                <text x="24" y="66">Û¸</text>
                <text x="18" y="50">Û¹</text>
                <text x="24" y="34">Û±Û°</text>
                <text x="35" y="23">Û±Û±</text>
              </g>
              <line id="hour-hand" x1="50" y1="50" x2="50" y2="28" stroke="white" stroke-width="3" stroke-linecap="round" />
              <line id="minute-hand" x1="50" y1="50" x2="50" y2="18" stroke="white" stroke-width="2" stroke-linecap="round" />
              <line id="second-hand" x1="50" y1="50" x2="50" y2="15" stroke="#a855f7" stroke-width="1" stroke-linecap="round" />
            </svg>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-4 text-center">
            <div class="text-xs text-gray-400 mb-1">ØªØ§Ø±ÛŒØ® Ù‡Ø¬Ø±ÛŒ Ù‚Ù…Ø±ÛŒ</div>
            <div id="hijri-date" class="text-xl font-bold">--</div>
          </div>
          <div class="glass rounded-2xl p-4 text-center">
            <div class="text-xs text-gray-400 mb-1">ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ</div>
            <div id="gregorian-date" class="text-xl font-bold">--</div>
          </div>
        

<!-- Advanced Date/Time -->
<div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
  <div class="glass rounded-2xl p-4 text-center">
    <div class="text-xs text-gray-400 mb-1">Ø§Ù…Ø±ÙˆØ²</div>
    <div id="today-name" class="text-xl font-bold">--</div>
    <div id="today-meta" class="text-xs text-gray-400 mt-1 mono">--</div>
  </div>
  <div class="glass rounded-2xl p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="text-xs text-gray-400">Ù¾ÛŒØ´Ø±ÙØª Ø§Ù…Ø±ÙˆØ²</div>
      <div id="day-progress-pct" class="text-xs text-gray-300 mono">--%</div>
    </div>
    <div class="progress-track">
      <div id="day-progress" class="progress-bar"></div>
    </div>
    <div id="day-remaining" class="text-[11px] text-gray-400 mt-2 mono">--</div>
  </div>
  <div class="glass rounded-2xl p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="text-xs text-gray-400">Ù¾ÛŒØ´Ø±ÙØª Ù…Ø§Ù‡</div>
      <div id="month-progress-pct" class="text-xs text-gray-300 mono">--%</div>
    </div>
    <div class="progress-track">
      <div id="month-progress" class="progress-bar"></div>
    </div>
    <div id="month-remaining" class="text-[11px] text-gray-400 mt-2 mono">--</div>
  </div>
  <div class="glass rounded-2xl p-4">
    <div class="flex items-center justify-between mb-2">
      <div class="text-xs text-gray-400">Ù¾ÛŒØ´Ø±ÙØª Ø³Ø§Ù„</div>
      <div id="year-progress-pct" class="text-xs text-gray-300 mono">--%</div>
    </div>
    <div class="progress-track">
      <div id="year-progress" class="progress-bar"></div>
    </div>
    <div id="year-remaining" class="text-[11px] text-gray-400 mt-2 mono">--</div>
  </div>
</div>

</div>

        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between mb-4">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-white/10 rounded-lg transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
            <div id="calendar-title" class="font-bold"></div>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-white/10 rounded-lg transition">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
          </div>
          <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2">
            <div class="text-gray-400 py-1">Ø´</div><div class="text-gray-400 py-1">ÛŒ</div><div class="text-gray-400 py-1">Ø¯</div>
            <div class="text-gray-400 py-1">Ø³</div><div class="text-gray-400 py-1">Ú†</div><div class="text-gray-400 py-1">Ù¾</div>
            <div class="text-red-400 py-1">Ø¬</div>
          </div>
          <div id="calendar-days" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-bold mb-2">Ù…Ù†Ø§Ø³Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</div>
          <div id="today-events" class="text-sm text-gray-300">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="text-sm font-bold mb-4">ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®</div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø´Ù…Ø³ÛŒ</label>
              <div class="flex gap-1">
                <input type="number" id="jalali-year" placeholder="Ø³Ø§Ù„" class="glass w-full px-2 py-2 rounded-lg text-sm bg-transparent outline-none text-center" min="1300" max="1500">
                <input type="number" id="jalali-month" placeholder="Ù…Ø§Ù‡" class="glass w-16 px-2 py-2 rounded-lg text-sm bg-transparent outline-none text-center" min="1" max="12">
                <input type="number" id="jalali-day" placeholder="Ø±ÙˆØ²" class="glass w-16 px-2 py-2 rounded-lg text-sm bg-transparent outline-none text-center" min="1" max="31">
              </div>
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ù…ÛŒÙ„Ø§Ø¯ÛŒ</label>
              <div class="flex gap-1">
                <input type="number" id="gregorian-year" placeholder="Ø³Ø§Ù„" class="glass w-full px-2 py-2 rounded-lg text-sm bg-transparent outline-none text-center" min="1900" max="2100">
                <input type="number" id="gregorian-month" placeholder="Ù…Ø§Ù‡" class="glass w-16 px-2 py-2 rounded-lg text-sm bg-transparent outline-none text-center" min="1" max="12">
                <input type="number" id="gregorian-day" placeholder="Ø±ÙˆØ²" class="glass w-16 px-2 py-2 rounded-lg text-sm bg-transparent outline-none text-center" min="1" max="31">
              </div>
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ù‡Ø¬Ø±ÛŒ Ù‚Ù…Ø±ÛŒ</label>
              <div class="flex gap-1">
                <input type="number" id="hijri-year" placeholder="Ø³Ø§Ù„" class="glass w-full px-2 py-2 rounded-lg text-sm bg-transparent outline-none text-center" min="1400" max="1600">
                <input type="number" id="hijri-month" placeholder="Ù…Ø§Ù‡" class="glass w-16 px-2 py-2 rounded-lg text-sm bg-transparent outline-none text-center" min="1" max="12">
                <input type="number" id="hijri-day" placeholder="Ø±ÙˆØ²" class="glass w-16 px-2 py-2 rounded-lg text-sm bg-transparent outline-none text-center" min="1" max="30">
              </div>
            </div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button onclick="convertFromJalali()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium">Ø§Ø² Ø´Ù…Ø³ÛŒ</button>
            <button onclick="convertFromGregorian()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium">Ø§Ø² Ù…ÛŒÙ„Ø§Ø¯ÛŒ</button>
            <button onclick="convertFromHijri()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium">Ø§Ø² Ù‚Ù…Ø±ÛŒ</button>
          </div>
        </div>
      </section>

      <!-- Unit Converter Section -->
      <section id="converter-section" class="hidden space-y-4">
        <h2 class="text-lg font-bold mb-4">ØªØ¨Ø¯ÛŒÙ„ ÙˆØ§Ø­Ø¯</h2>

        <!-- ØªØºÛŒÛŒØ±: Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ù‡ Û±Û² Ø¯Ø³ØªÙ‡ -->
        
<div class="glass rounded-2xl p-4">
  <label class="text-xs text-gray-400 block mb-2">Ø¯Ø³ØªÙ‡ ØªØ¨Ø¯ÛŒÙ„ <span class="text-[11px] text-gray-500">(Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ØŒ Ø±ÙˆÛŒ ÙÙ‡Ø±Ø³Øª Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</span></label>

  <div class="relative unit-dropdown" data-dd="conv-type">
    <button type="button" id="conv-type-btn" onclick="toggleUnitMenu('conv-type')"
            class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none cursor-pointer flex items-center justify-between">
      <span id="conv-type-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡</span>
      <span class="text-gray-300">â–¾</span>
    </button>
    <input type="hidden" id="conv-type-value" value="">
    <div id="conv-type-menu"
         class="hidden absolute z-50 mt-2 w-full max-h-64 overflow-auto rounded-2xl p-2 bg-black/70 border border-white/10 backdrop-blur-xl shadow-xl space-y-2">
      <!-- items injected -->
    </div>
  </div>
</div>


        <div class="glass rounded-2xl p-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø§Ø² <span class="text-[11px] text-gray-500">(Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ØŒ Ø±ÙˆÛŒ Ú©Ø§Ø¯Ø± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</span></label>
              
              <div class="relative unit-dropdown" data-dd="from-unit">
                <button type="button" id="from-unit-btn" onclick="toggleUnitMenu('from-unit')" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none cursor-pointer flex items-center justify-between">
                  <span id="from-unit-label">Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ§Ø­Ø¯</span>
                  <span class="text-gray-300">â–¾</span>
                </button>
                <div id="from-unit-menu" class="hidden unit-menu absolute z-50 mt-2 w-full max-h-60 overflow-auto scrollbar-hide rounded-xl p-2">
                  <!-- options injected -->
                </div>
                <input type="hidden" id="from-unit-value" value="">
              </div>
    
              <input type="number" id="from-value" oninput="convertUnit()" placeholder="Ù…Ù‚Ø¯Ø§Ø±" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø¨Ù‡ <span class="text-[11px] text-gray-500">(Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ØŒ Ø±ÙˆÛŒ Ú©Ø§Ø¯Ø± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</span></label>
              
              <div class="relative unit-dropdown" data-dd="to-unit">
                <button type="button" id="to-unit-btn" onclick="toggleUnitMenu('to-unit')" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none cursor-pointer flex items-center justify-between">
                  <span id="to-unit-label">Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ§Ø­Ø¯</span>
                  <span class="text-gray-300">â–¾</span>
                </button>
                <div id="to-unit-menu" class="hidden unit-menu absolute z-50 mt-2 w-full max-h-60 overflow-auto scrollbar-hide rounded-xl p-2">
                  <!-- options injected -->
                </div>
                <input type="hidden" id="to-unit-value" value="">
              </div>
    
              <div id="to-value" class="glass w-full px-3 py-2 rounded-xl text-sm bg-white/5 min-h-[40px] flex items-center">-</div>
            </div>
          </div>
          <div class="text-xs text-gray-400">Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ØŒ Ø§Ø² ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ù‡Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</div>
        </div>
      </section>

      <!-- Calculator Section -->
      <section id="calculator-section" class="hidden">
        <h2 class="text-lg font-bold mb-4">Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</h2>

        <!-- ØªØºÛŒÛŒØ±: Ø¯Ùˆ Ø­Ø§Ù„Øª Ø³Ø§Ø¯Ù‡ Ùˆ Ù…Ù‡Ù†Ø¯Ø³ÛŒ -->
        <div class="glass rounded-2xl p-4 max-w-md mx-auto">
          <div class="flex gap-2 mb-3">
            <button id="mode-simple" onclick="setCalcMode('simple')" class="pill active glass px-4 py-2 rounded-xl text-sm font-medium flex-1">Ø³Ø§Ø¯Ù‡</button>
            <button id="mode-sci" onclick="setCalcMode('sci')" class="pill glass px-4 py-2 rounded-xl text-sm font-medium flex-1">Ù…Ù‡Ù†Ø¯Ø³ÛŒ</button>
          </div>

          <div id="calc-display" class="glass-dark rounded-xl p-4 mb-4 text-left" dir="ltr">
            <div id="calc-expression" class="text-gray-400 text-sm h-5 overflow-hidden"></div>
            <div id="calc-result" class="text-3xl font-bold tabular-nums overflow-x-auto scrollbar-hide">0</div>
          </div>

          <!-- Scientific row -->
          <div id="sci-pad" class="hidden grid grid-cols-4 gap-2 mb-2">
            <button onclick="toggleTrigMode()" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold" id="trig-mode-btn">DEG</button>
            <button onclick="calcInsertFunc('sin')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">sin</button>
            <button onclick="calcInsertFunc('cos')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">cos</button>
            <button onclick="calcInsertFunc('tan')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">tan</button>

            <button onclick="calcInsertFunc('asin')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">asin</button>
            <button onclick="calcInsertFunc('acos')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">acos</button>
            <button onclick="calcInsertFunc('atan')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">atan</button>
            <button onclick="calcInsertConst('pi')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">Ï€</button>

            <button onclick="calcInsertFunc('sqrt')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">âˆš</button>
            <button onclick="calcInsertFunc('ln')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">ln</button>
            <button onclick="calcInsertFunc('log')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">log</button>
            <button onclick="calcInsertConst('e')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">e</button>

            <button onclick="calcInsert('(')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">(</button>
            <button onclick="calcInsert(')')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">)</button>
            <button onclick="calcInsertFunc('fact')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">x!</button>
            <button onclick="calcInsertOp('^')" class="calc-btn bg-purple-500/30 hover:bg-purple-500/50 p-3 rounded-xl text-sm font-bold">^</button>

            <button onclick="calcInsertFunc('abs')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">abs</button>
            <button onclick="calcInsertFunc('exp')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">exp</button>
            <button onclick="calcInsert('1/(')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">1/x</button>
            <button onclick="calcInsert('**2')" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">xÂ²</button>

            <button onclick="calcMemClear()" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">MC</button>
            <button onclick="calcMemRecall()" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">MR</button>
            <button onclick="calcMemAdd()" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">M+</button>
            <button onclick="calcMemSub()" class="calc-btn glass hover:bg-white/20 p-3 rounded-xl text-sm font-bold">M-</button>
          </div>

          <div class="grid grid-cols-4 gap-2">
            <button onclick="calcClear()" class="calc-btn bg-red-500/30 hover:bg-red-500/50 p-4 rounded-xl text-lg font-bold">C</button>
            <button onclick="calcBackspace()" class="calc-btn bg-orange-500/30 hover:bg-orange-500/50 p-4 rounded-xl text-lg font-bold">âŒ«</button>
            <button onclick="calcPercent()" class="calc-btn bg-purple-500/30 hover:bg-purple-500/50 p-4 rounded-xl text-lg font-bold">%</button>
            <button onclick="calcOp('/')" class="calc-btn bg-indigo-500/30 hover:bg-indigo-500/50 p-4 rounded-xl text-lg font-bold">Ã·</button>

            <button onclick="calcNum('7')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">Û·</button>
            <button onclick="calcNum('8')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">Û¸</button>
            <button onclick="calcNum('9')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">Û¹</button>
            <button onclick="calcOp('*')" class="calc-btn bg-indigo-500/30 hover:bg-indigo-500/50 p-4 rounded-xl text-lg font-bold">Ã—</button>

            <button onclick="calcNum('4')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">Û´</button>
            <button onclick="calcNum('5')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">Ûµ</button>
            <button onclick="calcNum('6')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">Û¶</button>
            <button onclick="calcOp('-')" class="calc-btn bg-indigo-500/30 hover:bg-indigo-500/50 p-4 rounded-xl text-lg font-bold">âˆ’</button>

            <button onclick="calcNum('1')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">Û±</button>
            <button onclick="calcNum('2')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">Û²</button>
            <button onclick="calcNum('3')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">Û³</button>
            <button onclick="calcOp('+')" class="calc-btn bg-indigo-500/30 hover:bg-indigo-500/50 p-4 rounded-xl text-lg font-bold">+</button>

            <button onclick="calcNum('0')" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold col-span-2">Û°</button>
            <button onclick="calcDot()" class="calc-btn glass hover:bg-white/20 p-4 rounded-xl text-lg font-bold">.</button>
            <button onclick="calcEquals()" class="calc-btn bg-gradient-to-r from-indigo-600 to-purple-600 p-4 rounded-xl text-lg font-bold">=</button>
          </div>
        </div>
      </section>

      <!-- Health Section -->
      <section id="health-section" class="hidden space-y-4">
        <h2 class="text-lg font-bold mb-4">Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø³Ù„Ø§Ù…Øª</h2>

        <!-- BMI -->
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-4"><span class="text-2xl">ğŸ“Š</span>
            <div>
              <div class="font-bold">Ø´Ø§Ø®Øµ ØªÙˆØ¯Ù‡ Ø¨Ø¯Ù†ÛŒ (BMI)</div>
              <div class="text-xs text-gray-400">Body Mass Index</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ù‚Ø¯ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
              <input type="number" id="bmi-height" placeholder="Û±Û·Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">ÙˆØ²Ù† (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…)</label>
              <input type="number" id="bmi-weight" placeholder="Û·Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
          </div>
          <button onclick="calculateBMI()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium mb-3">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
          <div id="bmi-result" class="text-center hidden">
            <div class="text-3xl font-bold" id="bmi-value">-</div>
            <div class="text-sm text-gray-400" id="bmi-status">-</div>
            <div class="mt-2 h-2 rounded-full bg-gradient-to-r from-blue-500 via-green-500 via-yellow-500 to-red-500 relative">
              <div id="bmi-marker" class="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow-lg transition-all -translate-x-1/2" style="left: 50%"></div>
            </div>
            <div class="flex justify-between text-xs text-gray-400 mt-1"><span>Ù„Ø§ØºØ±</span><span>Ù†Ø±Ù…Ø§Ù„</span><span>Ø§Ø¶Ø§ÙÙ‡</span><span>Ú†Ø§Ù‚</span></div>
          </div>
        </div>

        <!-- BMR -->
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-4"><span class="text-2xl">ğŸ”¥</span>
            <div>
              <div class="font-bold">Ù…ØªØ§Ø¨ÙˆÙ„ÛŒØ³Ù… Ù¾Ø§ÛŒÙ‡ (BMR)</div>
              <div class="text-xs text-gray-400">Basal Metabolic Rate</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø¬Ù†Ø³ÛŒØª</label>
              <select id="bmr-gender" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none cursor-pointer">
                <option value="male">Ù…Ø±Ø¯</option>
                <option value="female">Ø²Ù†</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø³Ù† (Ø³Ø§Ù„)</label>
              <input type="number" id="bmr-age" placeholder="Û³Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ù‚Ø¯ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
              <input type="number" id="bmr-height" placeholder="Û±Û·Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">ÙˆØ²Ù† (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…)</label>
              <input type="number" id="bmr-weight" placeholder="Û·Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
          </div>
          <button onclick="calculateBMR()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium mb-3">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
          <div id="bmr-result" class="text-center hidden">
            <div class="text-3xl font-bold" id="bmr-value">-</div>
            <div class="text-sm text-gray-400">Ú©Ø§Ù„Ø±ÛŒ Ø¯Ø± Ø±ÙˆØ² (Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ø³ØªØ±Ø§Ø­Øª)</div>
          </div>
        </div>

        <!-- Daily Calories -->
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-4"><span class="text-2xl">ğŸ</span>
            <div>
              <div class="font-bold">Ù†ÛŒØ§Ø² Ú©Ø§Ù„Ø±ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</div>
              <div class="text-xs text-gray-400">Total Daily Energy Expenditure</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø¬Ù†Ø³ÛŒØª</label>
              <select id="tdee-gender" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none cursor-pointer">
                <option value="male">Ù…Ø±Ø¯</option>
                <option value="female">Ø²Ù†</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø³Ù† (Ø³Ø§Ù„)</label>
              <input type="number" id="tdee-age" placeholder="Û³Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ù‚Ø¯ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
              <input type="number" id="tdee-height" placeholder="Û±Û·Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">ÙˆØ²Ù† (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…)</label>
              <input type="number" id="tdee-weight" placeholder="Û·Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
          </div>
          <div class="mb-4">
            <label class="text-xs text-gray-400 block mb-1">Ø³Ø·Ø­ ÙØ¹Ø§Ù„ÛŒØª</label>
            <select id="tdee-activity" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none cursor-pointer">
              <option value="1.2">Ú©Ù…â€ŒØªØ­Ø±Ú© (Ø¨Ø¯ÙˆÙ† ÙˆØ±Ø²Ø´)</option>
              <option value="1.375">Ú©Ù…ÛŒ ÙØ¹Ø§Ù„ (Û±-Û³ Ø±ÙˆØ² ÙˆØ±Ø²Ø´)</option>
              <option value="1.55">Ù…ØªÙˆØ³Ø· (Û³-Ûµ Ø±ÙˆØ² ÙˆØ±Ø²Ø´)</option>
              <option value="1.725">ÙØ¹Ø§Ù„ (Û¶-Û· Ø±ÙˆØ² ÙˆØ±Ø²Ø´)</option>
              <option value="1.9">Ø¨Ø³ÛŒØ§Ø± ÙØ¹Ø§Ù„ (ÙˆØ±Ø²Ø´Ú©Ø§Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ)</option>
            </select>
          </div>
          <button onclick="calculateTDEE()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium mb-3">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
          <div id="tdee-result" class="hidden">
            <div class="text-center mb-4">
              <div class="text-3xl font-bold" id="tdee-value">-</div>
              <div class="text-sm text-gray-400">Ú©Ø§Ù„Ø±ÛŒ Ø¯Ø± Ø±ÙˆØ² (Ø­ÙØ¸ ÙˆØ²Ù†)</div>
            </div>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="glass-dark rounded-xl p-3 text-center">
                <div class="text-green-400 font-bold" id="tdee-lose">-</div>
                <div class="text-xs text-gray-400">Ú©Ø§Ù‡Ø´ ÙˆØ²Ù†</div>
              </div>
              <div class="glass-dark rounded-xl p-3 text-center">
                <div class="text-blue-400 font-bold" id="tdee-gain">-</div>
                <div class="text-xs text-gray-400">Ø§ÙØ²Ø§ÛŒØ´ ÙˆØ²Ù†</div>
              </div>
            </div>
          </div>
        </div>


        <!-- Ø§Ù…Ú©Ø§Ù†Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø³Ù„Ø§Ù…Øª -->
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-4"><span class="text-2xl">ğŸ’§</span>
            <div>
              <div class="font-bold">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ø¨ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø±ÙˆØ²Ø§Ù†Ù‡</div>
              <div class="text-xs text-gray-400">Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ²Ù† Ùˆ Ø³Ø·Ø­ ÙØ¹Ø§Ù„ÛŒØª (ØªÙ‚Ø±ÛŒØ¨ÛŒ)</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400 block mb-1">ÙˆØ²Ù† (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…)</label>
              <input type="number" id="water-weight" placeholder="Û·Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">ÙØ¹Ø§Ù„ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡</label>
              <select id="water-activity" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none cursor-pointer">
                <option value="low">Ú©Ù…â€ŒØªØ­Ø±Ú©</option>
                <option value="mid">Ù…ØªÙˆØ³Ø·</option>
                <option value="high">Ø²ÛŒØ§Ø¯</option>
              </select>
            </div>
          </div>
          <button onclick="calculateWater()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium mb-3">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
          <div id="water-result" class="glass-dark rounded-xl p-3 text-sm text-gray-200 hidden"></div>
          <div class="text-xs text-gray-500 mt-2">âš ï¸ Ø¯Ø± Ø¨ÛŒÙ…Ø§Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒÙˆÛŒ/Ù‚Ù„Ø¨ÛŒ ÛŒØ§ Ø¨Ø§Ø±Ø¯Ø§Ø±ÛŒØŒ Ù…Ù‚Ø¯Ø§Ø± Ø¢Ø¨ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù†Ø¸Ø± Ù¾Ø²Ø´Ú© ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯.</div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-4"><span class="text-2xl">ğŸ“</span>
            <div>
              <div class="font-bold">Ù†Ø³Ø¨Øª Ø¯ÙˆØ± Ú©Ù…Ø± Ø¨Ù‡ Ù‚Ø¯ (WHtR)</div>
              <div class="text-xs text-gray-400">Ø´Ø§Ø®Øµ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±ÛŒØ³Ú© Ù…ØªØ§Ø¨ÙˆÙ„ÛŒÚ© (ØªÙ‚Ø±ÛŒØ¨ÛŒ)</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ù‚Ø¯ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
              <input type="number" id="whr-height" placeholder="Û±Û·Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø¯ÙˆØ± Ú©Ù…Ø± (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
              <input type="number" id="whr-waist" placeholder="Û¸Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
          </div>
          <button onclick="calculateWHtR()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium mb-3">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
          <div id="whr-result" class="glass-dark rounded-xl p-3 text-sm text-gray-200 hidden"></div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-4"><span class="text-2xl">ğŸ‹ï¸</span>
            <div>
              <div class="font-bold">Ø¯Ø±ØµØ¯ Ú†Ø±Ø¨ÛŒ Ø¨Ø¯Ù† (US Navy)</div>
              <div class="text-xs text-gray-400">Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø¯ÙˆØ± Ú¯Ø±Ø¯Ù†/Ú©Ù…Ø±/Ù‚Ø¯ (ØªÙ‚Ø±ÛŒØ¨ÛŒ)</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø¬Ù†Ø³ÛŒØª</label>
              <select id="bf-gender" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none cursor-pointer">
                <option value="male">Ù…Ø±Ø¯</option>
                <option value="female">Ø²Ù†</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ù‚Ø¯ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
              <input type="number" id="bf-height" placeholder="Û±Û·Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø¯ÙˆØ± Ú¯Ø±Ø¯Ù† (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
              <input type="number" id="bf-neck" placeholder="Û³Û¸" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø¯ÙˆØ± Ú©Ù…Ø± (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
              <input type="number" id="bf-waist" placeholder="Û¸Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div id="bf-hip-wrap" class="hidden col-span-2">
              <label class="text-xs text-gray-400 block mb-1">Ø¯ÙˆØ± Ø¨Ø§Ø³Ù† (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±) (Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§)</label>
              <input type="number" id="bf-hip" placeholder="Û¹Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
          </div>
          <button onclick="calculateBodyFat()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium mb-3">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
          <div id="bf-result" class="glass-dark rounded-xl p-3 text-sm text-gray-200 hidden"></div>
          <div class="text-xs text-gray-500 mt-2">Ø±Ø§Ù‡Ù†Ù…Ø§: Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ø­Ø§Ù„Øª Ø§ÛŒØ³ØªØ§Ø¯Ù‡ Ùˆ Ø¨Ø¯ÙˆÙ† ÙØ´Ø§Ø± Ø²ÛŒØ§Ø¯ Ù…ØªØ± Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-4"><span class="text-2xl">â¤ï¸â€ğŸ”¥</span>
            <div>
              <div class="font-bold">Ø²ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¶Ø±Ø¨Ø§Ù† Ù‚Ù„Ø¨ ØªÙ…Ø±ÛŒÙ†</div>
              <div class="text-xs text-gray-400">Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ù† (ØªÙ‚Ø±ÛŒØ¨ÛŒ)</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs text-gray-400 block mb-1">Ø³Ù† (Ø³Ø§Ù„)</label>
              <input type="number" id="hr-age" placeholder="Û³Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
            <div>
              <label class="text-xs text-gray-400 block mb-1">HR Rest (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
              <input type="number" id="hr-rest" placeholder="Û¶Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
            </div>
          </div>
          <button onclick="calculateHRZones()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium mb-3">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
          <div id="hr-result" class="glass-dark rounded-xl p-3 text-sm text-gray-200 hidden"></div>
        </div>

        
        <!-- ØªØºÛŒÛŒØ±: ØªÙØ³ÛŒØ± Ø¢Ø²Ù…Ø§ÛŒØ´ Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ (Ù…Ø±ØªØ¨ Ùˆ Ø²ÛŒØ¨Ø§ØªØ±) -->
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-4">
            <span class="text-2xl">ğŸ§ª</span>
            <div>
              <div class="font-bold">ØªÙØ³ÛŒØ± Ø¢Ø²Ù…Ø§ÛŒØ´ Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ</div>
              <div class="text-xs text-gray-400">Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ ØªÙØ³ÛŒØ± Ø¹Ù…ÙˆÙ…ÛŒ Ùˆ Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯</div>
            </div>
          </div>

          <!-- Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ø¸Ù… Ø¨Ù‡ØªØ± -->
          <div class="space-y-4 mb-4">
            <div class="glass-dark rounded-2xl p-3">
              <div class="text-sm font-bold text-gray-100 mb-3">Ù‚Ù†Ø¯ Ø®ÙˆÙ†</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-xs text-gray-400 block mb-1">Ù‚Ù†Ø¯ Ù†Ø§Ø´ØªØ§ (FBS) mg/dL</label>
                  <input type="number" id="lab-fbs" placeholder="Û¹Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
                <div>
                  <label class="text-xs text-gray-400 block mb-1">HbA1c (%)</label>
                  <input type="number" id="lab-a1c" placeholder="Ûµ.Û´" step="0.1" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
              </div>
            </div>

            <div class="glass-dark rounded-2xl p-3">
              <div class="text-sm font-bold text-gray-100 mb-3">Ú†Ø±Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆÙ†</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-xs text-gray-400 block mb-1">Ú©Ù„Ø³ØªØ±ÙˆÙ„ Ú©Ù„ (TC) mg/dL</label>
                  <input type="number" id="lab-tc" placeholder="Û±Û¸Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
                <div>
                  <label class="text-xs text-gray-400 block mb-1">ØªØ±ÛŒâ€ŒÚ¯Ù„ÛŒØ³Ø±ÛŒØ¯ (TG) mg/dL</label>
                  <input type="number" id="lab-tg" placeholder="Û±Û²Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
                <div>
                  <label class="text-xs text-gray-400 block mb-1">HDL mg/dL</label>
                  <input type="number" id="lab-hdl" placeholder="Û´Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
                <div>
                  <label class="text-xs text-gray-400 block mb-1">LDL mg/dL</label>
                  <input type="number" id="lab-ldl" placeholder="Û±Û°Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
              </div>
            </div>

            <div class="glass-dark rounded-2xl p-3">
              <div class="text-sm font-bold text-gray-100 mb-3">ÙØ´Ø§Ø± Ø®ÙˆÙ†</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-xs text-gray-400 block mb-1">Ø³ÛŒØ³ØªÙˆÙ„ (Sys)</label>
                  <input type="number" id="lab-sys" placeholder="Û±Û²Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none text-center">
                </div>
                <div>
                  <label class="text-xs text-gray-400 block mb-1">Ø¯ÛŒØ§Ø³ØªÙˆÙ„ (Dia)</label>
                  <input type="number" id="lab-dia" placeholder="Û¸Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none text-center">
                </div>
              </div>
            </div>

            <div class="glass-dark rounded-2xl p-3">
              <div class="text-sm font-bold text-gray-100 mb-3">Ú©Ø¨Ø¯ØŒ Ú©Ù„ÛŒÙ‡ Ùˆ Ù‡ÙˆØ±Ù…ÙˆÙ†</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="text-xs text-gray-400 block mb-1">Ú©Ø±Ø§ØªÛŒÙ†ÛŒÙ† (Cr) mg/dL</label>
                  <input type="number" id="lab-cr" placeholder="Û±.Û°" step="0.01" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
                <div>
                  <label class="text-xs text-gray-400 block mb-1">TSH (ÂµIU/mL)</label>
                  <input type="number" id="lab-tsh" placeholder="Û².Û°" step="0.01" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
                <div>
                  <label class="text-xs text-gray-400 block mb-1">ALT (IU/L)</label>
                  <input type="number" id="lab-alt" placeholder="Û²Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
                <div>
                  <label class="text-xs text-gray-400 block mb-1">AST (IU/L)</label>
                  <input type="number" id="lab-ast" placeholder="Û²Ûµ" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
                <div class="sm:col-span-2">
                  <label class="text-xs text-gray-400 block mb-1">ÙˆÛŒØªØ§Ù…ÛŒÙ† D (ng/mL)</label>
                  <input type="number" id="lab-vitd" placeholder="Û³Û°" class="glass w-full px-3 py-2 rounded-xl text-sm bg-transparent outline-none">
                </div>
              </div>
            </div>
          </div>

          <button onclick="interpretLabs()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium mb-3">ØªÙØ³ÛŒØ±</button>
          <div id="lab-result" class="glass-dark rounded-xl p-3 text-sm text-gray-200 hidden leading-relaxed"></div>
          <div class="text-xs text-gray-500 mt-2">âš ï¸ Ø§ÛŒÙ† ØªÙØ³ÛŒØ± Ø¹Ù…ÙˆÙ…ÛŒ Ø§Ø³Øª Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù†Ø¸Ø± Ù¾Ø²Ø´Ú© Ù†ÛŒØ³Øª.</div>
        </div>
      </section>

      <!-- Banking Section -->
      <section id="banking-section" class="hidden space-y-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-bold">Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¨Ø§Ù†Ú©ÛŒ</h2>
          <span class="text-xs text-gray-300">ÙˆØ§Ù…ØŒ Ø³Ù¾Ø±Ø¯Ù‡ØŒ Ú©Ø§Ø±Øª Ùˆ Ú†Ú©</span>
        </div>

        <div class="glass rounded-2xl p-3">
          <div class="flex gap-2 mb-3">
            <button id="banking-tab-loan" class="banking-tab flex-1 glass px-3 py-2 rounded-xl text-sm font-medium active">ÙˆØ§Ù…</button>
            <button id="banking-tab-deposit" class="banking-tab flex-1 glass px-3 py-2 rounded-xl text-sm font-medium">Ø³Ù¾Ø±Ø¯Ù‡</button>
            <button id="banking-tab-card" class="banking-tab flex-1 glass px-3 py-2 rounded-xl text-sm font-medium">Ú©Ø§Ø±Øª Ùˆ Ú†Ú©</button>
          </div>

          <!-- Loan -->
          <div id="loan-panel" class="space-y-3">
            <label class="block text-sm text-gray-200">Ù†ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡</label>
            <select id="loan-type" class="w-full input" onchange="renderLoanForm()">
              <option value="payment">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¨Ù„Øº Ù‚Ø³Ø· ÙˆØ§Ù… + Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ø³Ø§Ø·</option>
              <option value="compare">Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¯Ùˆ ÙˆØ§Ù…</option>
              <option value="penalty">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ø±ÛŒÙ…Ù‡ Ø¯ÛŒØ±Ú©Ø±Ø¯</option>
              <option value="grace">ÙˆØ§Ù… Ø¨Ø§ ØªÙ†ÙØ³ (Ú†Ù†Ø¯ Ù…Ø§Ù‡ Ø§ÙˆÙ„ ÙÙ‚Ø· Ø³ÙˆØ¯)</option>
              <option value="irregular">ÙˆØ§Ù… Ø¨Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…Ù†Ø¸Ù… (Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø¶Ø§ÙÙ‡/Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª)</option>
              <option value="rate">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ ÙˆØ§Ù…</option>
              <option value="early">Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ³ÙˆÛŒÙ‡ Ù¾ÛŒØ´ Ø§Ø² Ù…ÙˆØ¹Ø¯</option>
              <option value="qard">ÙˆØ§Ù… Ù‚Ø±Ø¶â€ŒØ§Ù„Ø­Ø³Ù†Ù‡</option>
              <option value="step">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù‚Ø³Ø§Ø· ÙˆØ§Ù… Ù¾Ù„Ú©Ø§Ù†ÛŒ</option>
            </select>

            <div id="loan-form" class="space-y-3"></div>

            <button onclick="calculateLoan()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
            <div id="loan-result" class="glass-dark rounded-xl p-3 text-sm text-gray-200 hidden leading-relaxed"></div>
          </div>

          <!-- Deposit -->
          <div id="deposit-panel" class="space-y-3 hidden">
            <label class="block text-sm text-gray-200">Ù†ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡</label>
            <select id="deposit-type" class="w-full input" onchange="renderDepositForm()">
              <option value="interest">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¨Ù„Øº Ø³ÙˆØ¯ Ø³Ù¾Ø±Ø¯Ù‡ (Ø³Ø§Ø¯Ù‡)</option>
              <option value="compound">Ø³ÙˆØ¯ Ù…Ø±Ú©Ø¨ ÙˆØ§Ù‚Ø¹ÛŒ (Ø±ÙˆØ²Ø§Ù†Ù‡/Ù…Ø§Ù‡Ø§Ù†Ù‡/Ø³Ø§Ù„Ø§Ù†Ù‡)</option>
              <option value="fv">Ø§Ø±Ø²Ø´ Ø¢ÛŒÙ†Ø¯Ù‡ Ù¾ÙˆÙ„ (Future Value)</option>
              <option value="pv">Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ Ù¾ÙˆÙ„ (Present Value)</option>
              <option value="inflation">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø«Ø± ØªÙˆØ±Ù…</option>
              <option value="rate">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ (Ø³Ø§Ø¯Ù‡)</option>
            </select>

            <div id="deposit-form" class="space-y-3"></div>

            <button onclick="calculateDeposit()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
            <div id="deposit-result" class="glass-dark rounded-xl p-3 text-sm text-gray-200 hidden leading-relaxed"></div>
            <div id="deposit-charts" class="hidden mt-3">
              <div class="table-actions no-print mb-2">
                <button class="btn-mini" onclick="exportDepositCSV()">â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ (CSV)</button>
                <button class="btn-mini" onclick="exportDepositPDF()">ğŸ§¾ Ø®Ø±ÙˆØ¬ÛŒ PDF / Ú†Ø§Ù¾</button>
              </div>
              <div class="glass rounded-xl p-2 chart-wrap">
                <div id="deposit-chart-title" class="text-xs text-gray-300 mb-2">Ù†Ù…ÙˆØ¯Ø§Ø±</div>
                <canvas id="deposit-chart" height="160"></canvas>
              </div>
            </div>

            <div class="text-[11px] text-gray-400 mt-2">
              Ù†Ú©ØªÙ‡: Ø¯Ø± Ø­Ø§Ù„Øª Â«Ø³Ø§Ø¯Ù‡Â»ØŒ Ø³ÙˆØ¯ Ø¨Ø± Ù…Ø¨Ù†Ø§ÛŒ Ø±ÙˆØ² (days/365) Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            </div>
          </div>

          <!-- Card & Cheque -->
          <div id="card-panel" class="space-y-3 hidden">
            <label class="block text-sm text-gray-200">Ù†ÙˆØ¹ Ù…Ø­Ø§Ø³Ø¨Ù‡</label>
            <select id="card-type" class="w-full input" onchange="renderCardForm()">
              <option value="installment">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù‚Ø³Ø§Ø· Ø®Ø±ÛŒØ¯ Ù‚Ø³Ø·ÛŒ</option>
              <option value="posfee">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†</option>
            </select>

            <div id="card-form" class="space-y-3"></div>

            <button onclick="calculateCard()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-2 rounded-xl text-sm font-medium">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
            <div id="card-result" class="glass-dark rounded-xl p-3 text-sm text-gray-200 hidden leading-relaxed"></div>
            <div id="card-charts" class="hidden mt-3">
              <div class="table-actions no-print mb-2">
                <button class="btn-mini" onclick="exportCardCSV()">â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ (CSV)</button>
                <button class="btn-mini" onclick="exportCardPDF()">ğŸ§¾ Ø®Ø±ÙˆØ¬ÛŒ PDF / Ú†Ø§Ù¾</button>
              </div>
              <div class="glass rounded-xl p-2 chart-wrap">
                <div id="card-chart-title" class="text-xs text-gray-300 mb-2">Ù†Ù…ÙˆØ¯Ø§Ø±</div>
                <canvas id="card-chart" height="160"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>
<!-- Guide Section (unchanged) -->
      <section id="guide-section" class="hidden space-y-4">
        <h2 class="text-lg font-bold mb-4">Ø±Ø§Ù‡Ù†Ù…Ø§</h2>
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-3"><span class="text-xl">ğŸ’°</span><div class="font-bold">Ø§Ø±Ø² Ø¯ÛŒØ¬ÛŒØªØ§Ù„</div></div>
          <p class="text-sm text-gray-300 leading-relaxed">Ù‚ÛŒÙ…Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø² Ù†ÙˆØ¨ÛŒØªÚ©Ø³ (BTC/ETH/USDT/TON/TRX/PAXG) Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†. Ù†Ù…Ø§ÛŒØ´ ØªØºÛŒÛŒØ±Ø§Øª Û²Û´Ø³Ø§Ø¹ØªÙ‡ Ùˆ Ø¬Ø²Ø¦ÛŒØ§Øª.</p>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-3"><span class="text-xl">ğŸŒ¤ï¸</span><div class="font-bold">Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</div></div>
          <p class="text-sm text-gray-300 leading-relaxed">Ø¨Ø§ Ø¬Ø³ØªØ¬Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‡Ø± Ø´Ù‡Ø± Ø§ÛŒØ±Ø§Ù† Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„â€ŒØªØ± (Ø¨Ø§Ø¯ØŒ Ø±Ø·ÙˆØ¨ØªØŒ ÙØ´Ø§Ø±ØŒ Ø¯ÛŒØ¯ØŒ Ø·Ù„ÙˆØ¹/ØºØ±ÙˆØ¨ØŒ Ø­Ø¯Ø§Ù‚Ù„/Ø­Ø¯Ø§Ú©Ø«Ø± Ø±ÙˆØ²) Ø¨Ø¨ÛŒÙ†ÛŒØ¯.</p>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-3"><span class="text-xl">ğŸ¦</span><div class="font-bold">Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¨Ø§Ù†Ú©ÛŒ (Ú©Ø§Ù…Ù„)</div></div>
          <div class="text-sm text-gray-300 leading-relaxed space-y-2">
            <div class="font-semibold text-gray-200">ÙˆØ§Ù…</div>
            <ul class="list-disc pr-5 space-y-1">
              <li><b>Ù‚Ø³Ø· + Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ø³Ø§Ø·:</b> Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ø­Ø§Ø³Ø¨Ù‡ØŒ Ø¬Ø¯ÙˆÙ„ Ù…Ø§Ù‡â€ŒØ¨Ù‡â€ŒÙ…Ø§Ù‡ Â«Ù…Ø¨Ù„Øº Ù‚Ø³Ø· / Ø³ÙˆØ¯ / Ø§ØµÙ„ / Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒÂ» Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (ÙˆØ§Ø­Ø¯: ØªÙˆÙ…Ø§Ù†).</li>
              <li><b>Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§:</b> Ù†Ù…ÙˆØ¯Ø§Ø± Â«Ú©Ø§Ù‡Ø´ Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒÂ» Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± Â«Ø³Ù‡Ù… Ø³ÙˆØ¯ vs Ø§ØµÙ„Â» Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ú© Ø³Ø±ÛŒØ¹â€ŒØªØ± Ù‡Ø²ÛŒÙ†Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ ÙˆØ§Ù….</li>
              <li><b>Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¯Ùˆ ÙˆØ§Ù…:</b> Ø¨Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù…Ø¨Ù„ØºØŒ Ù…Ø¯Øª Ùˆ Ù†Ø±Ø® Ø¯Ùˆ Ú¯Ø²ÛŒÙ†Ù‡ØŒ Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ Ø³ÙˆØ¯ Ú©Ù„ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ùˆ Ú¯Ø²ÛŒÙ†Ù‡ Ø¨Ù‡â€ŒØµØ±ÙÙ‡â€ŒØªØ± Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
              <li><b>Ø¬Ø±ÛŒÙ…Ù‡ Ø¯ÛŒØ±Ú©Ø±Ø¯:</b> Ø¨Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø±ÙˆØ²Ù‡Ø§ÛŒ ØªØ£Ø®ÛŒØ± Ùˆ Ø¯Ø±ØµØ¯ Ø¬Ø±ÛŒÙ…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡/Ù…Ø§Ù‡Ø§Ù†Ù‡ØŒ Ù…Ø¨Ù„Øº Ø§Ø¶Ø§ÙÙ‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
              <li><b>ÙˆØ§Ù… Ø¨Ø§ ØªÙ†ÙØ³:</b> Ú†Ù†Ø¯ Ù…Ø§Ù‡ Ø§ÙˆÙ„ ÙÙ‚Ø· Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø³Ù¾Ø³ Ø§Ù‚Ø³Ø§Ø· Ø¹Ø§Ø¯ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</li>
              <li><b>Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…Ù†Ø¸Ù…:</b> Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Â«Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®ØªÂ» ÛŒØ§ Â«Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø¶Ø§ÙÙ‡ Ø¯Ø± Ù…Ø§Ù‡ Ø¯Ù„Ø®ÙˆØ§Ù‡Â» ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø§Ø«Ø± Ø¢Ù† Ø±ÙˆÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ Ùˆ Ù…Ø¯Øª ÙˆØ§Ù… Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯.</li>
              <li><b>ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯:</b> Ø¯Ø±ØµØ¯ Ø³Ù‡Ù… Ø³ÙˆØ¯ Ø§Ø² Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.</li>
              <li><b>Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§:</b> Ø¨Ø±Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ø³Ø§Ø· Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø®Ø±ÙˆØ¬ÛŒ <b>Ø§Ú©Ø³Ù„ (CSV)</b> Ø¨Ú¯ÛŒØ±ÛŒØ¯ ÛŒØ§ <b>PDF/Ú†Ø§Ù¾</b> ØªÙ‡ÛŒÙ‡ Ú©Ù†ÛŒØ¯.</li>
            </ul>
            <div class="font-semibold text-gray-200 mt-2">Ø³Ù¾Ø±Ø¯Ù‡</div>
            <ul class="list-disc pr-5 space-y-1">
              <li><b>Ø³ÙˆØ¯ Ø³Ø§Ø¯Ù‡:</b> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯ Ø¨Ø± Ù…Ø¨Ù†Ø§ÛŒ Ø±ÙˆØ² (days/365).</li>
              <li><b>Ø³ÙˆØ¯ Ù…Ø±Ú©Ø¨ ÙˆØ§Ù‚Ø¹ÛŒ:</b> Ø±ÙˆØ²Ø§Ù†Ù‡/Ù…Ø§Ù‡Ø§Ù†Ù‡/Ø³Ø§Ù„Ø§Ù†Ù‡ + Ø§Ù…Ú©Ø§Ù† ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù‡Ø§Ù†Ù‡Ø› Ù†Ù…ÙˆØ¯Ø§Ø± Ø±Ø´Ø¯ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
              <li><b>FV Ùˆ PV:</b> Ø§Ø±Ø²Ø´ Ø¢ÛŒÙ†Ø¯Ù‡ Ùˆ Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ Ù¾ÙˆÙ„ Ø¨Ø§ Ù†Ù…ÙˆØ¯Ø§Ø± ØªØºÛŒÛŒØ±Ø§Øª Ø²Ù…Ø§Ù†ÛŒ (ÙˆØ§Ø­Ø¯: ØªÙˆÙ…Ø§Ù†).</li>
              <li><b>ØªÙˆØ±Ù…:</b> Ø§Ø±Ø²Ø´ ÙˆØ§Ù‚Ø¹ÛŒ Ù¾ÙˆÙ„ Ø¯Ø± Ø³Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡ Ø¨Ø§ Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ† Ù†Ø±Ø® ØªÙˆØ±Ù…Ø› Ù†Ù…ÙˆØ¯Ø§Ø± Ø§Ø±Ø²Ø´ ÙˆØ§Ù‚Ø¹ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
              <li><b>Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§:</b> Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±/Ø³Ø±ÛŒ Ø²Ù…Ø§Ù†ÛŒØŒ Ø®Ø±ÙˆØ¬ÛŒ <b>Ø§Ú©Ø³Ù„ (CSV)</b> Ùˆ <b>PDF/Ú†Ø§Ù¾</b> Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª.</li>
            </ul>
            <div class="font-semibold text-gray-200 mt-2">Ú©Ø§Ø±Øª Ùˆ Ú†Ú©</div>
            <ul class="list-disc pr-5 space-y-1">
              <li><b>Ø®Ø±ÛŒØ¯ Ù‚Ø³Ø·ÛŒ:</b> Ù‚ÛŒÙ…Øª Ú©Ø§Ù„Ø§ + Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª + ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø· (+ Ù†Ø±Ø® Ø§Ø®ØªÛŒØ§Ø±ÛŒ) Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù†Ù…ÙˆØ¯Ø§Ø± Ù…Ù‚Ø§ÛŒØ³Ù‡.</li>
              <li><b>Ú©Ø§Ø±Ù…Ø²Ø¯ Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†:</b> Ø­Ø¬Ù… ØªØ±Ø§Ú©Ù†Ø´ Ã— Ø¯Ø±ØµØ¯ Ú©Ø§Ø±Ù…Ø²Ø¯ Ùˆ Ù†Ù…Ø§ÛŒØ´ Â«Ú©Ø§Ø±Ù…Ø²Ø¯/Ø®Ø§Ù„Øµ Ø¯Ø±ÛŒØ§ÙØªÛŒÂ» + Ù†Ù…ÙˆØ¯Ø§Ø±.</li>
            </ul>
            <div class="text-[11px] text-gray-400 mt-2">Ù†Ú©ØªÙ‡: Â«ØªÙˆÙ…Ø§Ù†Â» Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ Ù…Ø´Ø®Øµ Ø§Ø³Øª Ùˆ Ù…ÙˆØ§Ø±Ø¯ Ø¯Ø±ØµØ¯ÛŒ Ø¨Ø§ Ø¹Ù„Ø§Ù…Øª % Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
          </div>
        </div>

        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-3"><span class="text-xl">ğŸ“…</span><div class="font-bold">ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</div></div>
          <p class="text-sm text-gray-300 leading-relaxed">Ø³Ø§Ø¹Øª Ø¯Ù‚ÛŒÙ‚ Ø§ÛŒØ±Ø§Ù† Ùˆ Ø¬Ù‡Ø§Ù†ÛŒØŒ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒØŒ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ùˆ Ù‡Ø¬Ø±ÛŒ Ù‚Ù…Ø±ÛŒ (Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) Ùˆ Ù…Ù†Ø§Ø³Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ². ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø¨ÛŒÙ† Ø³Ù‡ ØªÙ‚ÙˆÛŒÙ….</p>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-3"><span class="text-xl">ğŸ“</span><div class="font-bold">ØªØ¨Ø¯ÛŒÙ„ ÙˆØ§Ø­Ø¯</div></div>
          <p class="text-sm text-gray-300 leading-relaxed">Û±Û² Ø¯Ø³ØªÙ‡ ØªØ¨Ø¯ÛŒÙ„: Ø·ÙˆÙ„ØŒ ÙˆØ²Ù†ØŒ Ø¯Ù…Ø§ØŒ Ø­Ø¬Ù…ØŒ Ø³Ø±Ø¹ØªØŒ Ø²Ù…Ø§Ù†ØŒ ÙØ´Ø§Ø±ØŒ Ø§Ù†Ø±Ú˜ÛŒØŒ ØªÙˆØ§Ù†ØŒ Ù…Ø³Ø§Ø­ØªØŒ Ø¯Ø§Ø¯Ù‡ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ØŒ Ø²Ø§ÙˆÛŒÙ‡.</p>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-3"><span class="text-xl">ğŸ§®</span><div class="font-bold">Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨</div></div>
          <p class="text-sm text-gray-300 leading-relaxed">Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ Ø³Ø§Ø¯Ù‡ Ùˆ Ù…Ù‡Ù†Ø¯Ø³ÛŒ (sin/cos/tan/log/ln/âˆš/^/Ï€).</p>
        </div>
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center gap-2 mb-3"><span class="text-xl">â¤ï¸</span><div class="font-bold">Ø³Ù„Ø§Ù…Øª</div></div>
          <div class="text-sm text-gray-300 leading-relaxed space-y-2">
            <div>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø®Ø´ Ø³Ù„Ø§Ù…Øª:</div>
            <ul class="list-disc pr-5 space-y-1 text-gray-300">
              <li><span class="font-bold text-gray-100">BMI</span> (Ø´Ø§Ø®Øµ ØªÙˆØ¯Ù‡ Ø¨Ø¯Ù†ÛŒ): Ø§Ø² ÙØ±Ù…ÙˆÙ„ <span class="text-gray-200">ÙˆØ²Ù†(Ú©ÛŒÙ„Ùˆ) Ã· Ù‚Ø¯Â²(Ù…ØªØ±)</span> Ø¨Ù‡â€ŒØ¯Ø³Øª Ù…ÛŒâ€ŒØ¢ÛŒØ¯ Ùˆ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ú©Ù„ÛŒ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ ÙˆØ²Ù† Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù‚Ø¯ Ø¯Ø± Ú†Ù‡ Ù…Ø­Ø¯ÙˆØ¯Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª. ØªÙØ³ÛŒØ± Ø±Ø§ÛŒØ¬: Ú©Ù…ØªØ± Ø§Ø² Û±Û¸.Ûµ Ú©Ù…â€ŒÙˆØ²Ù†ØŒ Û±Û¸.Ûµ ØªØ§ Û²Û´.Û¹ Ù†Ø±Ù…Ø§Ù„ØŒ Û²Ûµ ØªØ§ Û²Û¹.Û¹ Ø§Ø¶Ø§ÙÙ‡â€ŒÙˆØ²Ù†ØŒ Û³Û° Ø¨Ù‡ Ø¨Ø§Ù„Ø§ Ú†Ø§Ù‚ÛŒ. (Ø§ÛŒÙ† Ø´Ø§Ø®Øµ Ø¨ÛŒÙ† Ø¹Ø¶Ù„Ù‡ Ùˆ Ú†Ø±Ø¨ÛŒ ØªÙÚ©ÛŒÚ© Ø¯Ù‚ÛŒÙ‚ Ù†Ø¯Ø§Ø±Ø¯.)</li>
              <li><span class="font-bold text-gray-100">BMR</span> (Ø³ÙˆØ®Øªâ€ŒÙˆØ³Ø§Ø² Ù¾Ø§ÛŒÙ‡): Ù…Ù‚Ø¯Ø§Ø± Ú©Ø§Ù„Ø±ÛŒâ€ŒØ§ÛŒ Ú©Ù‡ Ø¨Ø¯Ù† Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ø³ØªØ±Ø§Ø­Øª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯Ù‡Ø§ÛŒ Ø­ÛŒØ§ØªÛŒ (ØªÙ†ÙØ³ØŒ Ø¶Ø±Ø¨Ø§Ù† Ù‚Ù„Ø¨ØŒ ØªÙ†Ø¸ÛŒÙ… Ø¯Ù…Ø§ Ùˆâ€¦) Ù…ØµØ±Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ù¾Ø§ÛŒÙ‡â€ŒÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÛŒ Ú©Ø§Ù„Ø±ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø§Ø³Øª.</li>
              <li><span class="font-bold text-gray-100">Ù†ÛŒØ§Ø² Ú©Ø§Ù„Ø±ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</span>: Ø¨Ø±Ø¢ÙˆØ±Ø¯ Ú©Ø§Ù„Ø±ÛŒ Ú©Ù„ Ø±ÙˆØ² (TDEE) Ø¨Ø§ Ø¯Ø±Ù†Ø¸Ø±Ú¯Ø±ÙØªÙ† Ø³Ø·Ø­ ÙØ¹Ø§Ù„ÛŒØª. Ø§Ú¯Ø± Ù‡Ø¯Ù Ú©Ø§Ù‡Ø´ ÙˆØ²Ù† Ø§Ø³Øª Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ú©Ø³Ø±ÛŒ Ù…Ù„Ø§ÛŒÙ… (Ù…Ø«Ù„Ø§Ù‹ Û³Û°Û°â€“ÛµÛ°Û° Ú©Ø§Ù„Ø±ÛŒ) Ùˆ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ ÙˆØ²Ù† Ù…Ø§Ø²Ø§Ø¯ Ù…Ù„Ø§ÛŒÙ… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
              <li><span class="font-bold text-gray-100">Ø¢Ø¨ Ù…ÙˆØ±Ø¯Ù†ÛŒØ§Ø²</span>: ØªØ®Ù…ÛŒÙ† Ù…ØµØ±Ù Ø¢Ø¨ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ²Ù† Ùˆ Ø´Ø±Ø§ÛŒØ· Ø¹Ù…ÙˆÙ…ÛŒ. Ù…Ù‚Ø¯Ø§Ø± Ø¯Ù‚ÛŒÙ‚ Ø¨Ù‡ Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§ØŒ ÙØ¹Ø§Ù„ÛŒØªØŒ ØªØ¹Ø±ÛŒÙ‚ØŒ Ø±Ú˜ÛŒÙ… ØºØ°Ø§ÛŒÛŒ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø²Ø´Ú©ÛŒ ÙˆØ§Ø¨Ø³ØªÙ‡ Ø§Ø³Øª.</li>
              <li><span class="font-bold text-gray-100">WHtR</span> (Ù†Ø³Ø¨Øª Ø¯ÙˆØ± Ú©Ù…Ø± Ø¨Ù‡ Ù‚Ø¯): <span class="text-gray-200">Ø¯ÙˆØ± Ú©Ù…Ø± Ã· Ù‚Ø¯</span>. Ø´Ø§Ø®Øµ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú†Ø±Ø¨ÛŒ Ø´Ú©Ù…ÛŒ. Ø¨Ù‡â€ŒØ·ÙˆØ± Ú©Ù„ÛŒ Ú©Ù…ØªØ± Ø§Ø² Û°.Ûµ Ø¨Ù‡ØªØ± Ø§Ø³Øª (Ù‡Ø±Ú†Ù‡ Ø¨Ø§Ù„Ø§ØªØ±ØŒ Ø±ÛŒØ³Ú© Ù…ØªØ§Ø¨ÙˆÙ„ÛŒÚ©/Ù‚Ù„Ø¨ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ø¯).</li>
              <li><span class="font-bold text-gray-100">Ø¯Ø±ØµØ¯ Ú†Ø±Ø¨ÛŒ Ø¨Ø¯Ù†</span> (US Navy): ØªØ®Ù…ÛŒÙ† ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø¨Ø§ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø¯ÙˆØ± Ú¯Ø±Ø¯Ù†/Ú©Ù…Ø± (Ùˆ Ø¯Ø± Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§ Ø¯ÙˆØ± Ø¨Ø§Ø³Ù†). Ø¹Ø¯Ø¯ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø§Ø³Øª Ùˆ Ø¨Ø§ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± (DEXA/BIA) Ù…Ù…Ú©Ù† Ø§Ø³Øª ØªÙØ§ÙˆØª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.</li>
              <li><span class="font-bold text-gray-100">Ø²ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¶Ø±Ø¨Ø§Ù† Ù‚Ù„Ø¨</span>: Ù…Ø­Ø¯ÙˆØ¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø±ÛŒÙ†ÛŒ (Ø§Ø² Ø±ÛŒÚ©Ø§ÙˆØ±ÛŒ ØªØ§ Ø´Ø¯ÛŒØ¯) Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ù† Ùˆ Ø­Ø¯Ø§Ú©Ø«Ø± Ø¶Ø±Ø¨Ø§Ù† ØªØ®Ù…ÛŒÙ†ÛŒ. Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ ØªÙ…Ø±ÛŒÙ† Ù‡ÙˆØ§Ø²ÛŒ/Ú†Ø±Ø¨ÛŒâ€ŒØ³ÙˆØ²ÛŒØŒ ÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÙØ±Ø§Ø¯ Ø¨Ø§ Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ù‚Ù„Ø¨ÛŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù†Ø¸Ø± Ù¾Ø²Ø´Ú© Ø¨Ø§Ø´Ø¯.</li>
              <li><span class="font-bold text-gray-100">ØªÙØ³ÛŒØ± Ø¢Ø²Ù…Ø§ÛŒØ´</span>: ÛŒÚ© ØªÙØ³ÛŒØ± Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ±ÙˆØ¯ÛŒ + Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…Ø«Ù„ <span class="text-gray-200">Nonâ€‘HDL</span> Ùˆ Ù†Ø³Ø¨Øª <span class="text-gray-200">TG/HDL</span>. (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù†Ø¸Ø± Ù¾Ø²Ø´Ú© Ù†ÛŒØ³ØªØ› Ù…Ø­Ø¯ÙˆØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¬Ø¹ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨ÛŒÙ† Ø¢Ø²Ù…Ø§ÛŒØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ ÙØ±Ù‚ Ú©Ù†Ø¯.)</li>
</ul>
          </div>
        </div>
        <div class="glass rounded-2xl p-4 border-indigo-500/30">
          <div class="text-center text-sm text-gray-400">
            <div class="text-2xl mb-2">âš¡</div>
            <div>Codeisa - Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ ÙØ§Ø±Ø³ÛŒ</div>
            <div class="text-xs mt-1">Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸</div>
            <div class="mt-3 flex items-center justify-center gap-2 text-xs">
              <a href="https://t.me/ShadowPsychologist" onclick="return openTelegram('ShadowPsychologist');"
                 class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-sky-400/10 border border-sky-300/20 hover:bg-sky-400/15 transition">
                <span class="tg-anim inline-flex items-center justify-center w-6 h-6 rounded-lg bg-sky-500/20 border border-sky-300/20">
                  <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="text-sky-200">
                    <path d="M9.993 15.674 9.65 20.5c.49 0 .702-.21.956-.463l2.294-2.188 4.758 3.481c.872.481 1.491.228 1.726-.806l3.127-14.665v-.001c.274-1.28-.463-1.78-1.312-1.46L1.34 9.444c-1.242.484-1.223 1.17-.212 1.483l5.356 1.672L19.07 6.02c.592-.392 1.131-.175.687.217l-9.764 9.437Z"/>
                  </svg>
                </span>
                <span>Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø§Ø²Ù†Ø¯Ù‡: <span dir="ltr" class="font-semibold">@ShadowPsychologist</span></span>
              </a>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<script>
  // Persian number converter
  function toPersianNum(num) {
    const persianDigits = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
    return String(num).replace(/[0-9]/g, d => persianDigits[parseInt(d)]);
  }
  function toEnglishNum(str) {
    const persianDigits = ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'];
    return String(str).replace(/[Û°-Û¹]/g, d => persianDigits.indexOf(d));
  }
  function formatNumber(num, decimals = 0) {
    if (num === null || num === undefined || isNaN(num)) return '-';
    return toPersianNum(Number(num).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }));
  }

  // Open Telegram (try app scheme, fallback to web)
  function openTelegram(username){
    try{
      const tgs = `tg://resolve?domain=${username}`;
      window.location.href = tgs;
      setTimeout(()=>{ window.open(`https://t.me/${username}`, '_blank'); }, 400);
      return false;
    }catch{
      window.open(`https://t.me/${username}`, '_blank');
      return false;
    }
  }


  // Section navigation
  function showSection(section) {
    document.querySelectorAll('main > div > section').forEach(s => s.classList.add('hidden'));
    document.getElementById(`${section}-section`).classList.remove('hidden');

    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.section === section) btn.classList.add('active');
    });

    if (section === 'weather') {
      if (!selectedCity) {
        // default: Tehran
        setSelectedCity({ name: 'ØªÙ‡Ø±Ø§Ù†', province: 'ØªÙ‡Ø±Ø§Ù†', lat: 35.6892, lon: 51.3890 });
      } else {
        loadWeather();
      }
    }
    if (section === 'datetime') {
      updateDateTime();
      renderCalendar();
      fetchEvents();
    }
    if (section === 'converter') {
      initConverterTypes();
      setConverterType('length');
    }
    if (section === 'banking') {
      initBanking();
    }
  }

  // ===================== CRYPTO (Nobitex - robust) =====================
  // Ù†Ú©ØªÙ‡: Ù†ÙˆØ¨ÛŒØªÚ©Ø³ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ù‚ÛŒÙ…Øª Ø±Ø§ Ø¨Ù‡ Ø±ÛŒØ§Ù„ (RLS) Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯. Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªÙˆÙ…Ø§Ù†ØŒ ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± Û±Û° Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
  // Ù…Ø´Ú©Ù„ Ø±Ø§ÛŒØ¬Ù Â«Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯Â» Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¨Ù‡ Ø®Ø§Ø·Ø± ØªØºÛŒÛŒØ± Ø¯Ø§Ù…Ù†Ù‡ API (apiv2) ÛŒØ§ ØªÙØ§ÙˆØª ÙÛŒÙ„Ø¯Ù‡Ø§Ø³Øª.
  const NOBITEX_STATS_URLS = [
    'https://apiv2.nobitex.ir/market/stats',   // Ø¬Ø¯ÛŒØ¯ØªØ±/Ù¾Ø§ÛŒØ¯Ø§Ø±ØªØ±
    'https://api.nobitex.ir/market/stats'      // Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ± (fallback)
  ];

  const cryptoList = [
    // Top coins + requested extras (may vary by exchange availability)
    { key:'btc',  symbol:'BTC',  name:'Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†' },
    { key:'eth',  symbol:'ETH',  name:'Ø§ØªØ±ÛŒÙˆÙ…' },
    { key:'usdt', symbol:'USDT', name:'ØªØªØ±' },
    { key:'bnb',  symbol:'BNB',  name:'Ø¨Ø§ÛŒÙ†Ù†Ø³â€ŒÚ©ÙˆÛŒÙ†' },
    { key:'sol',  symbol:'SOL',  name:'Ø³ÙˆÙ„Ø§Ù†Ø§' },
    { key:'xrp',  symbol:'XRP',  name:'Ø±ÛŒÙ¾Ù„' },
    { key:'usdc', symbol:'USDC', name:'ÛŒÙˆâ€ŒØ§Ø³â€ŒØ¯ÛŒâ€ŒØ³ÛŒ' },
    { key:'doge', symbol:'DOGE', name:'Ø¯ÙˆØ¬â€ŒÚ©ÙˆÛŒÙ†' },
    { key:'ton',  symbol:'TON',  name:'ØªÙˆÙ†â€ŒÚ©ÙˆÛŒÙ†' },
    { key:'ada',  symbol:'ADA',  name:'Ú©Ø§Ø±Ø¯Ø§Ù†Ùˆ' },

    // Additional popular coins
    { key:'trx',  symbol:'TRX',  name:'ØªØ±ÙˆÙ†' },
    { key:'paxg', symbol:'PAXG', name:'Ø·Ù„Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„' }
  ];

  function synthChartFromStats(last, low, high) {
    // 24 points: smooth curve between low->high->last (Ù†Ù…Ø§ÛŒØ´ÛŒ)
    const points = [];
    const a = low, b = high, c = last;
    for (let i=0;i<24;i++){
      const t = i/23;
      const wave = Math.sin(t*Math.PI)*0.15;
      const base = a + (b-a)*t;
      const towardLast = base*(1-t) + c*t;
      points.push(towardLast*(1+wave*(Math.random()*0.5+0.5)));
    }
    return points;
  }

  async function fetchNobitexStats() {
    for (const url of NOBITEX_STATS_URLS) {
      try {
        const res = await fetch(url);
        if (!res.ok) continue;
        const j = await res.json();

        // apiv2: {status:"ok", stats:{...}}
        if (j && j.stats) return j.stats;

        // Ø¨Ø¹Ø¶ÛŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§: {data:{stats:{...}}}
        if (j && j.data && j.data.stats) return j.data.stats;

        // Ù†Ø³Ø®Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±ÛŒ (Ø§Ú¯Ø± ÙÙ‚Ø· Ù‡Ù…ÛŒÙ† Ú©Ø§Ø± Ú©Ø±Ø¯)
        // Ø¯Ø± Ø§ÛŒÙ† Ø­Ø§Ù„ØªØŒ loadCrypto Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø± Ú©ÙˆÛŒÙ† Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
      } catch (_) {}
    }
    return null;
  }

  function pickPair(stats, key) {
    // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¬ÙØª Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø±Ø§ÛŒØ¬
    const candidates = [
      `${key}-rls`,
      `${key}-irt`,
      `${key.toUpperCase()}-rls`,
      `${key.toUpperCase()}-irt`
    ];
    for (const c of candidates) {
      if (stats && stats[c]) return stats[c];
    }
    return null;
  }

  function parseNum(x) {
    const n = typeof x === 'string' ? parseFloat(x) : (typeof x === 'number' ? x : NaN);
    return Number.isFinite(n) ? n : NaN;
  }

  function computeChangePercent(s) {
    // Ø§ÙˆÙ„ÙˆÛŒØª: dayChange (Ø§Ú¯Ø± Ø¯Ø±ØµØ¯ Ø¨ÙˆØ¯)
    const dc = parseNum(s?.dayChange);
    if (Number.isFinite(dc)) {
      // Ø§Ú¯Ø± Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ù…Ù†Ø·Ù‚ÛŒ Ø¯Ø±ØµØ¯ Ø¨ÙˆØ¯ØŒ Ù‡Ù…ÙˆÙ† Ø±Ùˆ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ….
      if (Math.abs(dc) <= 100) return dc;
    }

    // fallback: (latest - dayOpen)/dayOpen * 100
    const latest = parseNum(s?.latest);
    const dayOpen = parseNum(s?.dayOpen);
    if (Number.isFinite(latest) && Number.isFinite(dayOpen) && dayOpen !== 0) {
      return ((latest - dayOpen) / dayOpen) * 100;
    }
    return 0;
  }

  function getHighLow(s) {
    // apiv2: dayHigh/dayLow | Ù‚Ø¯ÛŒÙ…ÛŒ: max/min
    const high = parseNum(s?.dayHigh);
    const low  = parseNum(s?.dayLow);

    const max = parseNum(s?.max);
    const min = parseNum(s?.min);

    const outHigh = Number.isFinite(high) ? high : (Number.isFinite(max) ? max : NaN);
    const outLow  = Number.isFinite(low)  ? low  : (Number.isFinite(min) ? min : NaN);
    return { high: outHigh, low: outLow };
  }

  function getVolumeSrc(s) {
    // apiv2: volumeSrc | Ù‚Ø¯ÛŒÙ…ÛŒ: volume
    const v1 = parseNum(s?.volumeSrc);
    const v2 = parseNum(s?.volume);
    return Number.isFinite(v1) ? v1 : (Number.isFinite(v2) ? v2 : NaN);
  }

  async function loadCrypto() {
    const statusEl = document.getElementById('crypto-status');
    const cardsEl = document.getElementById('crypto-cards');

    try {
      statusEl.innerHTML = '<span class="status-dot w-2 h-2 rounded-full bg-yellow-500 blink"></span><span class="status-text text-yellow-400">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>';

      // 1) ØªÙ„Ø§Ø´: ÛŒÚ© Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø§ÛŒ Ú©Ù„ Ø¨Ø§Ø²Ø§Ø± (Ø³Ø±ÛŒØ¹â€ŒØªØ± Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø±ØªØ±)
      const allStats = await fetchNobitexStats();

      cardsEl.innerHTML = '';

      // 2) Ø§Ú¯Ø± Ú©Ù„ Ø¨Ø§Ø²Ø§Ø± Ù†ÛŒØ§Ù…Ø¯ØŒ fallback: Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÚ©â€ŒØ¨Ù‡â€ŒØªÚ©
      const perCoinFallback = async (coinKey) => {
        // Ø¨Ø±Ø®ÛŒ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ±ÛŒ Ù‡Ø³ØªÙ†Ø¯
        const url = `https://api.nobitex.ir/market/stats?srcCurrency=${coinKey}&dstCurrency=rls`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('coin stats failed');
        const j = await res.json();
        return j?.stats?.[`${coinKey}-rls`] || j?.stats?.[`${coinKey}-irt`] || null;
      };

      for (const meta of cryptoList) {
        let s = allStats ? pickPair(allStats, meta.key) : null;

        if (!s && !allStats) {
          try { s = await perCoinFallback(meta.key); } catch (_) {}
        }

        if (!s) {
          const card = document.createElement('div');
          card.className = 'glass rounded-2xl p-4';
          card.innerHTML = `<div class="font-bold mb-2">${meta.name}</div><div class="text-sm text-gray-400">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>`;
          cardsEl.appendChild(card);
          continue;
        }

        // values are strings in rials; convert to number (toman)
        const latestRls = parseNum(s?.latest);
        const last = Number.isFinite(latestRls) ? (latestRls / 10) : NaN;

        const { high: highRls, low: lowRls } = getHighLow(s);
        const high = Number.isFinite(highRls) ? (highRls / 10) : NaN;
        const low  = Number.isFinite(lowRls)  ? (lowRls / 10)  : NaN;

        const vol  = getVolumeSrc(s);
        const change = computeChangePercent(s);
        const isUp = change >= 0;

        const safeLast = Number.isFinite(last) ? last : 0;
        const safeLow = Number.isFinite(low) ? low : safeLast*0.98;
        const safeHigh = Number.isFinite(high) ? high : safeLast*1.02;

        const chartData = synthChartFromStats(safeLast, safeLow, safeHigh);

        const card = document.createElement('div');
        card.className = 'glass rounded-2xl p-4';
        card.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold">${meta.symbol[0]}</div>
              <div>
                <div class="font-bold">${meta.name}</div>
                <div class="text-xs text-gray-400">${meta.symbol}/IRT</div>
              </div>
            </div>
            <div class="text-left" dir="ltr">
              <div class="flex items-center gap-1 ${isUp ? 'text-green-400' : 'text-red-400'}">
                <span>${isUp ? 'â–²' : 'â–¼'}</span>
                <span>${toPersianNum(Math.abs(change).toFixed(2))}%</span>
              </div>
            </div>
          </div>

          <div class="text-2xl font-bold mb-3">${formatNumber(last, 0)} <span class="text-sm text-gray-300">ØªÙˆÙ…Ø§Ù†</span></div>

          <div class="chart-container mb-3">${createMiniChart(chartData, isUp)}</div>

          <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="glass-dark rounded-lg p-2">
              <div class="text-gray-300">Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Û²Û´Ø³</div>
              <div class="text-green-300">${formatNumber(high, 0)}</div>
            </div>
            <div class="glass-dark rounded-lg p-2">
              <div class="text-gray-300">Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±ÛŒÙ† Û²Û´Ø³</div>
              <div class="text-red-300">${formatNumber(low, 0)}</div>
            </div>
            <div class="glass-dark rounded-lg p-2">
              <div class="text-gray-300">Ø­Ø¬Ù… (Coin)</div>
              <div>${Number.isFinite(vol) ? formatNumber(vol, 4) : '-'}</div>
            </div>
            <div class="glass-dark rounded-lg p-2">
              <div class="text-gray-300">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</div>
              <div>${toPersianNum(new Date().toTimeString().slice(0,5))}</div>
            </div>
          </div>
        `;
        cardsEl.appendChild(card);
      }

      statusEl.innerHTML = '<span class="status-dot w-2 h-2 rounded-full bg-green-500 blink"></span><span class="status-text text-green-400">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>';
    } catch (e) {
      console.error(e);
      document.getElementById('crypto-status').innerHTML = '<span class="status-dot w-2 h-2 rounded-full bg-red-500 blink"></span><span class="status-text text-red-400">Ø¢ÙÙ„Ø§ÛŒÙ†</span>';
      document.getElementById('crypto-cards').innerHTML = '<div class="col-span-full text-center text-gray-300 py-8">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§. Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª/ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</div>';
    }
  }

  function createMiniChart(data, isUp) {
    if (!data || data.length === 0) return '<div class="h-full flex items-center justify-center text-gray-500 text-xs">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</div>';

    const min = Math.min(...data);
    const max = Math.max(...data);
    const range = max - min || 1;
    const height = 100, width = 280, padding = 10;

    const points = data.map((val, i) => {
      const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
      const y = height - padding - ((val - min) / range) * (height - 2 * padding);
      return `${x},${y}`;
    }).join(' ');

    const lastPoint = points.split(' ').pop();
    const color = isUp ? '#22c55e' : '#ef4444';

    return `
      <svg viewBox="0 0 ${width} ${height}" class="w-full h-full">
        <defs>
          <linearGradient id="grad-${isUp ? 'up' : 'down'}" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
            <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
          </linearGradient>
        </defs>
        <polyline fill="none" stroke="${color}" stroke-width="2" points="${points}"/>
        <polygon fill="url(#grad-${isUp ? 'up' : 'down'})" points="${padding},${height - padding} ${points} ${width - padding},${height - padding}"/>
        <circle cx="${lastPoint.split(',')[0]}" cy="${lastPoint.split(',')[1]}" r="4" fill="${color}"/>
        <circle cx="${lastPoint.split(',')[0]}" cy="${lastPoint.split(',')[1]}" r="6" fill="${color}" opacity="0.3"/>
      </svg>
    `;
  }

  // ===================== WEATHER (Search all Iran cities via Nominatim) =====================
  const weatherConditions = {
    0: { fa:'Ø¢Ø³Ù…Ø§Ù† ØµØ§Ù', icon:'sunny', night:'clear-night' },
    1: { fa:'Ø¹Ù…Ø¯ØªØ§Ù‹ ØµØ§Ù', icon:'sunny', night:'clear-night' },
    2: { fa:'Ù†ÛŒÙ…Ù‡ Ø§Ø¨Ø±ÛŒ', icon:'cloudy', night:'cloudy' },
    3: { fa:'Ø§Ø¨Ø±ÛŒ', icon:'cloudy', night:'cloudy' },
    45:{ fa:'Ù…Ù‡', icon:'cloudy', night:'cloudy' },
    48:{ fa:'Ù…Ù‡ ÛŒØ®â€ŒØ²Ø¯Ù‡', icon:'cloudy', night:'cloudy' },
    51:{ fa:'Ù†Ù…â€ŒÙ†Ù… Ø¨Ø§Ø±Ø§Ù†', icon:'rain', night:'rain' },
    53:{ fa:'Ø¨Ø§Ø±Ø§Ù† Ù…ØªÙˆØ³Ø·', icon:'rain', night:'rain' },
    55:{ fa:'Ø¨Ø§Ø±Ø§Ù† Ø´Ø¯ÛŒØ¯', icon:'rain', night:'rain' },
    61:{ fa:'Ø¨Ø§Ø±Ø§Ù† Ø®ÙÛŒÙ', icon:'rain', night:'rain' },
    63:{ fa:'Ø¨Ø§Ø±Ø§Ù† Ù…ØªÙˆØ³Ø·', icon:'rain', night:'rain' },
    65:{ fa:'Ø¨Ø§Ø±Ø§Ù† Ø´Ø¯ÛŒØ¯', icon:'rain', night:'rain' },
    71:{ fa:'Ø¨Ø±Ù Ø®ÙÛŒÙ', icon:'snow', night:'snow' },
    73:{ fa:'Ø¨Ø±Ù Ù…ØªÙˆØ³Ø·', icon:'snow', night:'snow' },
    75:{ fa:'Ø¨Ø±Ù Ø´Ø¯ÛŒØ¯', icon:'snow', night:'snow' },
    77:{ fa:'Ø¯Ø§Ù†Ù‡ Ø¨Ø±Ù', icon:'snow', night:'snow' },
    80:{ fa:'Ø±Ú¯Ø¨Ø§Ø± Ø®ÙÛŒÙ', icon:'rain', night:'rain' },
    81:{ fa:'Ø±Ú¯Ø¨Ø§Ø± Ù…ØªÙˆØ³Ø·', icon:'rain', night:'rain' },
    82:{ fa:'Ø±Ú¯Ø¨Ø§Ø± Ø´Ø¯ÛŒØ¯', icon:'rain', night:'rain' },
    85:{ fa:'Ø¨Ø§Ø±Ø´ Ø¨Ø±Ù', icon:'snow', night:'snow' },
    86:{ fa:'Ø¨Ø±Ù Ø³Ù†Ú¯ÛŒÙ†', icon:'snow', night:'snow' },
    95:{ fa:'Ø±Ø¹Ø¯ Ùˆ Ø¨Ø±Ù‚', icon:'rain', night:'rain' },
    96:{ fa:'ØªÚ¯Ø±Ú¯ Ø®ÙÛŒÙ', icon:'rain-snow', night:'rain-snow' },
    99:{ fa:'ØªÚ¯Ø±Ú¯ Ø³Ù†Ú¯ÛŒÙ†', icon:'rain-snow', night:'rain-snow' }
  };

  let selectedCity = null;
  let citySearchTimer = null;

  async function searchIranCities() {
    const q = document.getElementById('city-search').value.trim();
    const box = document.getElementById('city-results');
    const list = document.getElementById('city-results-list');

    if (citySearchTimer) clearTimeout(citySearchTimer);

    if (q.length < 2) {
      box.classList.add('hidden');
      return;
    }

    citySearchTimer = setTimeout(async () => {
      list.innerHTML = '<div class="text-gray-400">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</div>';
      box.classList.remove('hidden');

      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=8&countrycodes=ir&q=${encodeURIComponent(q)}`;
        const res = await fetch(url, { headers: { 'Accept-Language': 'fa' } });
        const data = await res.json();

        if (!data || data.length === 0) {
          list.innerHTML = '<div class="text-gray-400">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
          return;
        }

        list.innerHTML = data.map((it) => {
          const name = (it.display_name || '').split(',')[0] || q;
          const province = (it.display_name || '').split(',')[1]?.trim() || 'Ø§ÛŒØ±Ø§Ù†';
          const lat = parseFloat(it.lat);
          const lon = parseFloat(it.lon);
          const safeName = String(name).replace(/</g,'&lt;').replace(/>/g,'&gt;');
          const safeProv = String(province).replace(/</g,'&lt;').replace(/>/g,'&gt;');

          return `
            <button class="w-full text-right glass-dark rounded-xl p-3 hover:bg-white/10 transition"
              onclick="setSelectedCity({name:'${safeName}', province:'${safeProv}', lat:${lat}, lon:${lon}})">
              <div class="font-bold">${safeName}</div>
              <div class="text-xs text-gray-400">${safeProv}</div>
            </button>
          `;
        }).join('');
      } catch (e) {
        console.error(e);
        list.innerHTML = '<div class="text-red-400">Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ (Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ VPN).</div>';
      }
    }, 350);
  }

  function setSelectedCity(city) {
    selectedCity = city;
    document.getElementById('city-search').value = city.name;
    document.getElementById('city-results').classList.add('hidden');
    loadWeather();
  }

  async function loadWeather() {
    const contentEl = document.getElementById('weather-content');
    const animEl = document.getElementById('weather-animation');
    const cardEl = document.getElementById('weather-card');

    if (!selectedCity) return;

    contentEl.innerHTML = '<div class="text-center text-gray-400 py-8">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';
    animEl.innerHTML = '';

    try {
      const lat = selectedCity.lat;
      const lon = selectedCity.lon;

      // ØªØºÛŒÛŒØ±: Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ± (pressure, visibility, daily max/min, sunrise/sunset)
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m,pressure_msl,visibility&hourly=temperature_2m,precipitation_probability,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset&forecast_days=7&timezone=Asia/Tehran`;
      const res = await fetch(url);

      if (!res.ok) throw new Error('Weather API Error');

      const data = await res.json();
      const current = data.current;

      const weatherInfo = weatherConditions[current.weather_code] || { fa:'Ù†Ø§Ù…Ø´Ø®Øµ', icon:'cloudy', night:'cloudy' };
      const isDay = current.is_day === 1;
      const iconType = isDay ? weatherInfo.icon : weatherInfo.night;

      // Update background (same logic)
      if (isDay) {
        if (iconType === 'sunny') cardEl.style.background = 'linear-gradient(135deg, #87CEEB 0%, #FFE4B5 100%)';
        else if (iconType === 'rain' || iconType === 'rain-snow') cardEl.style.background = 'linear-gradient(135deg, #4A5568 0%, #2D3748 100%)';
        else if (iconType === 'snow') cardEl.style.background = 'linear-gradient(135deg, #CBD5E0 0%, #E2E8F0 100%)';
        else cardEl.style.background = 'linear-gradient(135deg, #718096 0%, #A0AEC0 100%)';
      } else {
        cardEl.style.background = 'linear-gradient(135deg, #1A202C 0%, #2D3748 100%)';
      }

      const code = current.weather_code;
      const wind = current.wind_speed_10m ?? 0;
      let animType = iconType;
      if ([95,96,99].includes(code)) animType = 'thunder';
      animEl.innerHTML = createWeatherAnimation(animType, isDay, wind);


      const dailyMax = data.daily?.temperature_2m_max?.[0];
      const dailyMin = data.daily?.temperature_2m_min?.[0];
      const sunrise = data.daily?.sunrise?.[0];
      const sunset  = data.daily?.sunset?.[0];

      const pressure = current.pressure_msl;
      const visibility = current.visibility; // meters
      const visKm = visibility ? (visibility/1000) : null;

      const weeklyHtml = renderWeeklyForecast(data.daily);
      const hourlyHtml = renderHourlyForecast(data);


      contentEl.innerHTML = `
        <div class="text-center">
          <div class="text-sm text-gray-200 mb-1">${selectedCity.name}ØŒ ${selectedCity.province}</div>
          <div class="text-6xl font-bold mb-2">${toPersianNum(Math.round(current.temperature_2m))}Â°</div>
          <div class="text-lg mb-4">${weatherInfo.fa}</div>

          <div class="grid grid-cols-3 gap-4 text-sm mb-4">
            <div class="glass-dark rounded-xl p-3">
              <div class="text-gray-200 text-xs mb-1">Ø§Ø­Ø³Ø§Ø³ Ø¯Ù…Ø§</div>
              <div class="font-bold">${toPersianNum(Math.round(current.apparent_temperature))}Â°</div>
            </div>
            <div class="glass-dark rounded-xl p-3">
              <div class="text-gray-200 text-xs mb-1">Ø±Ø·ÙˆØ¨Øª</div>
              <div class="font-bold">${toPersianNum(current.relative_humidity_2m)}%</div>
            </div>
            <div class="glass-dark rounded-xl p-3">
              <div class="text-gray-200 text-xs mb-1">Ø¨Ø§Ø¯</div>
              <div class="font-bold">${toPersianNum(Math.round(current.wind_speed_10m))} km/h</div>
            </div>
          </div>

          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-xs">
            <div class="glass-dark rounded-xl p-3">
              <div class="text-gray-200 mb-1">ÙØ´Ø§Ø± Ù‡ÙˆØ§</div>
              <div class="font-bold">${pressure ? toPersianNum(Math.round(pressure)) : '-'} hPa</div>
            </div>
            <div class="glass-dark rounded-xl p-3">
              <div class="text-gray-200 mb-1">Ø¯ÛŒØ¯ Ø§ÙÙ‚ÛŒ</div>
              <div class="font-bold">${visKm ? toPersianNum(visKm.toFixed(1)) : '-'} km</div>
            </div>
            <div class="glass-dark rounded-xl p-3">
              <div class="text-gray-200 mb-1">Ú©Ù…ÛŒÙ†Ù‡/Ø¨ÛŒØ´ÛŒÙ†Ù‡</div>
              <div class="font-bold">${dailyMin!=null ? toPersianNum(Math.round(dailyMin)) : '-'}Â° / ${dailyMax!=null ? toPersianNum(Math.round(dailyMax)) : '-'}Â°</div>
            </div>
            <div class="glass-dark rounded-xl p-3">
              <div class="text-gray-200 mb-1">Ø·Ù„ÙˆØ¹/ØºØ±ÙˆØ¨</div>
              <div class="font-bold">${sunrise ? toPersianNum(new Date(sunrise).toTimeString().slice(0,5)) : '--'} / ${sunset ? toPersianNum(new Date(sunset).toTimeString().slice(0,5)) : '--'}</div>
            </div>
          </div>
        </div>

        ${hourlyHtml}
        ${weeklyHtml}
      `;
      enhanceAllHorizontalScroll();
    } catch (e) {
      console.error(e);
      contentEl.innerHTML = '<div class="text-center text-red-200 py-8">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ (Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ VPN)</div>';
    }
  }

  function createWeatherAnimation(type, isDay, wind=0) {
    let html = '';
    const windLines = (wind>28) ? `${[...Array(6)].map((_,i)=>`<div class="wind-line" style="top:${18+i*10}%; right:${-10 - i*18}%; animation-duration:${10+Math.random()*8}s; opacity:${0.10+Math.random()*0.15}"></div>`).join('')}` : '';
    if (type === 'sunny' && isDay) {
      html = `
        <div class="absolute top-4 left-4 sun-glow">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <circle cx="40" cy="40" r="20" fill="#FFD700"/>
            ${[...Array(8)].map((_, i) => `<line x1="40" y1="8" x2="40" y2="16" stroke="#FFD700" stroke-width="3" stroke-linecap="round" transform="rotate(${i*45} 40 40)"/>`).join('')}
          </svg>
        </div>
      `;
    } else if (type === 'clear-night') {
      html = `
        <svg class="absolute top-4 left-4" width="60" height="60" viewBox="0 0 60 60">
          <path d="M35 10 C20 10 10 25 15 40 C20 55 40 55 50 45 C35 50 25 35 35 20 C40 15 35 10 35 10" fill="#F0E68C"/>
        </svg>
        ${[...Array(20)].map(() => `<div class="star absolute w-1 h-1 bg-white rounded-full" style="top:${Math.random()*100}%; left:${Math.random()*100}%; animation-delay:${Math.random()*2}s;"></div>`).join('')}
      `;
    } else if (type === 'cloudy') {
      const speeds = ['slow','mid','fast','mid','slow'];
      html = `
        <div class="cloudLayer">
          <div class="mist"></div>
          ${[...Array(5)].map((_,i)=>`
            <div class="cloud ${speeds[i] || 'mid'} absolute" style="top:${8+i*14}%; right:${-20 - i*18}%; animation-delay:${i*1.6}s;">
              <svg width="${110-i*8}" height="${68-i*4}" viewBox="0 0 120 70">
                <ellipse cx="38" cy="48" rx="32" ry="18" fill="rgba(255,255,255,${0.55-i*0.06})"/>
                <ellipse cx="68" cy="42" rx="38" ry="24" fill="rgba(255,255,255,${0.55-i*0.06})"/>
                <ellipse cx="96" cy="48" rx="26" ry="16" fill="rgba(255,255,255,${0.55-i*0.06})"/>
              </svg>
            </div>`).join('')}
        </div>
      `;
    } else if (type === 'rain') {
      html = `
        ${windLines}
        ${[...Array(20)].map(()=>`<div class="${wind>22?'rain-slash':'rain-drop'} absolute w-0.5 h-4 bg-blue-300 rounded-full opacity-60 style="right:${Math.random()*100}%; animation-delay:${Math.random()*1}s; animation-duration:${0.8+Math.random()*0.4}s;"></div>`).join('')}
        <div class="cloud absolute top-2 right-4">
          <svg width="100" height="60" viewBox="0 0 100 60">
            <ellipse cx="30" cy="40" rx="25" ry="15" fill="rgba(100,100,100,0.8)"/>
            <ellipse cx="55" cy="35" rx="30" ry="20" fill="rgba(100,100,100,0.8)"/>
            <ellipse cx="80" cy="40" rx="20" ry="12" fill="rgba(100,100,100,0.8)"/>
          </svg>
        </div>
      `;
} else if (type === 'thunder') {
  html = `
    <div class="lightning-flash"></div>
    ${windLines}
    ${[...Array(18)].map(()=>`<div class="${wind>22?'rain-slash':'rain-drop'} absolute w-0.5 h-4 bg-blue-200 rounded-full opacity-55" style="right:${Math.random()*100}%; animation-delay:${Math.random()*1}s; animation-duration:${0.75+Math.random()*0.45}s;"></div>`).join('')}
    <div class="cloudLayer">
      <div class="mist" style="opacity:0.85"></div>
      ${[...Array(4)].map((_,i)=>`
        <div class="cloud mid absolute" style="top:${6+i*16}%; right:${-30 - i*22}%; animation-duration:${22+i*5}s; opacity:${0.75-i*0.08}">
          <svg width="${120-i*10}" height="${72-i*4}" viewBox="0 0 120 70">
            <ellipse cx="38" cy="48" rx="32" ry="18" fill="rgba(70,70,80,0.78)"/>
            <ellipse cx="68" cy="42" rx="38" ry="24" fill="rgba(70,70,80,0.78)"/>
            <ellipse cx="96" cy="48" rx="26" ry="16" fill="rgba(70,70,80,0.78)"/>
          </svg>
        </div>`).join('')}
    </div>
    <svg class="absolute left-6 top-24 opacity-80" width="70" height="120" viewBox="0 0 70 120">
      <path d="M40 0 L10 55 H32 L18 120 L60 55 H38 Z" fill="rgba(255,255,255,0.85)"/>
    </svg>
  `;
    } else if (type === 'snow') {
      html = `${[...Array(15)].map(()=>`<div class="snow-flake absolute text-white opacity-80" style="right:${Math.random()*100}%; animation-delay:${Math.random()*3}s; animation-duration:${2+Math.random()*2}s;">â„</div>`).join('')}`;
    } else if (type === 'rain-snow') {
      html = `
        ${[...Array(10)].map(()=>`<div class="rain-drop absolute w-0.5 h-3 bg-blue-300 rounded-full opacity-60" style="right:${Math.random()*50}%; animation-delay:${Math.random()*1}s;"></div>`).join('')}
        ${[...Array(8)].map(()=>`<div class="snow-flake absolute text-white opacity-80 text-xs" style="right:${50+Math.random()*50}%; animation-delay:${Math.random()*3}s;">â„</div>`).join('')}
      `;
    }
    return html;
  }


function renderHourlyForecast(data){
  try{
    const hourly = data?.hourly;
    if (!hourly || !hourly.time || hourly.time.length===0) return '';
    const nowIso = data?.current?.time || null;

    // find starting index (nearest >= now)
    let startIdx = 0;
    if (nowIso){
      const nowT = new Date(nowIso).getTime();
      startIdx = hourly.time.findIndex(t => new Date(t).getTime() >= nowT);
      if (startIdx < 0) startIdx = 0;
    }

    const endIdx = Math.min(startIdx + 24, hourly.time.length);
    const items = [];
    for (let i=startIdx;i<endIdx;i++){
      const t = new Date(hourly.time[i]);
      const hh = String(t.getHours()).padStart(2,'0');
      const temp = hourly.temperature_2m?.[i];
      const pop  = hourly.precipitation_probability?.[i];
      const wind = hourly.wind_speed_10m?.[i];
      const code = hourly.weather_code?.[i];
      const info = weatherConditions[code] || { fa:'-', icon:'cloudy', night:'cloudy' };

      items.push(`
        <div class="glass-dark rounded-xl p-3 min-w-[120px]">
          <div class="text-xs text-gray-200 mb-1 mono">${toPersianNum(hh)}:Û°Û°</div>
          <div class="text-lg font-bold mono mb-1">${temp!=null ? toPersianNum(Math.round(temp)) : '-'}Â°</div>
          <div class="text-[11px] text-gray-300 mb-2">${info.fa}</div>
          <div class="text-[11px] text-gray-300 mono">Ø¨Ø§Ø±Ø´: ${pop!=null ? toPersianNum(pop) : '-'}%</div>
          <div class="text-[11px] text-gray-300 mono">Ø¨Ø§Ø¯: ${wind!=null ? toPersianNum(Math.round(wind)) : '-'} km/h</div>
        </div>
      `);
    }

    return `
      <div class="mt-5">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-bold text-gray-100">Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ (Û²Û´ Ø³Ø§Ø¹Øª Ø¢ÛŒÙ†Ø¯Ù‡)</div>
          <div class="text-[11px] text-gray-300">Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙÙ‚ÛŒ âŸµâŸ¶</div>
        </div>
        <div class="forecast-strip flex gap-3 overflow-x-auto pb-2 select-none cursor-grab" data-hscroll="1">
          ${items.join('')}
        </div>
      </div>
    `;
  }catch{
    return '';
  }
}

  function renderWeeklyForecast(daily) {
    try {
      if (!daily || !daily.time || daily.time.length === 0) return '';
      const dayNames = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡','Ø´Ù†Ø¨Ù‡'];
      const items = daily.time.map((t, i) => {
        const d = new Date(t);
        const name = dayNames[d.getDay()];
        const code = daily.weather_code?.[i];
        const info = weatherConditions[code] || { fa:'-', icon:'cloudy', night:'cloudy' };
        const max = daily.temperature_2m_max?.[i];
        const min = daily.temperature_2m_min?.[i];
        const pop = daily.precipitation_probability_max?.[i]; // %
        return `
          <div class="glass-dark rounded-xl p-3 min-w-[140px]">
            <div class="text-xs text-gray-200 mb-1">${name}</div>
            <div class="text-[11px] text-gray-300 mb-2">${toPersianNum(d.getDate())}/${toPersianNum(d.getMonth()+1)}</div>
            <div class="text-sm font-bold mb-1">${info.fa}</div>
            <div class="text-xs text-gray-300 mb-2">Ú©Ù…ÛŒÙ†Ù‡/Ø¨ÛŒØ´ÛŒÙ†Ù‡: ${min!=null ? toPersianNum(Math.round(min)) : '-'}Â° / ${max!=null ? toPersianNum(Math.round(max)) : '-'}Â°</div>
            <div class="text-xs text-gray-300">Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø§Ø±Ø´: ${pop!=null ? toPersianNum(pop) : '-'}%</div>
          </div>
        `;
      }).join('');

      return `
        <div class="mt-5">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-bold text-gray-100">Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Û· Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡</div>
            <div class="text-[11px] text-gray-300">Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„: Ø¨Ú©Ø´ÛŒØ¯ âŸµâŸ¶ ÛŒØ§ Ø¨Ø§ Ù…ÙˆØ³ Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="forecast-strip flex gap-3 overflow-x-auto pb-2 select-none cursor-grab" data-hscroll="1">
            ${items}
          </div>
        </div>
      `;
    } catch {
      return '';
    }
  }

  // Enable horizontal scroll with mouse wheel + drag (for desktop)
  function enhanceHorizontalScroll(el){
    if (!el || el.dataset.hscrollEnhanced === '1') return;
    el.dataset.hscrollEnhanced = '1';

    // Prevent text selection/copy while interacting
    el.style.userSelect = 'none';
    el.style.webkitUserSelect = 'none';
    el.style.msUserSelect = 'none';
    el.style.cursor = 'grab';

    // Wheel -> horizontal
    el.addEventListener('wheel', (e) => {
      const dy = e.deltaY;
      const dx = e.deltaX;
      if (Math.abs(dy) > Math.abs(dx)) {
        el.scrollLeft += dy;
        e.preventDefault();
      }
    }, { passive: false });

    // Drag to scroll (desktop)
    let isDown = false, startX = 0, startLeft = 0, moved = false;

    const onDown = (e) => {
      // only left click / primary
      if (e.button !== undefined && e.button !== 0) return;
      isDown = true;
      moved = false;
      el.style.cursor = 'grabbing';
      startX = (e.pageX ?? e.touches?.[0]?.pageX ?? 0);
      startLeft = el.scrollLeft;
      // prevent text selection
      e.preventDefault();
    };

    const onMove = (e) => {
      if (!isDown) return;
      const x = (e.pageX ?? e.touches?.[0]?.pageX ?? 0);
      const walk = (x - startX);
      if (Math.abs(walk) > 3) moved = true;
      el.scrollLeft = startLeft - walk;
      e.preventDefault();
    };

    const onUp = () => {
      if (!isDown) return;
      isDown = false;
      el.style.cursor = 'grab';
      // if user dragged, block the next click (prevents selection/copy)
      if (moved) {
        el.dataset.justDragged = '1';
        setTimeout(() => { el.dataset.justDragged = '0'; }, 150);
      }
    };

    el.addEventListener('mousedown', onDown);
    el.addEventListener('touchstart', onDown, { passive: false });

    window.addEventListener('mousemove', onMove, { passive: false });
    window.addEventListener('touchmove', onMove, { passive: false });

    window.addEventListener('mouseup', onUp);
    window.addEventListener('touchend', onUp);

    // Prevent click selection after dragging
    el.addEventListener('click', (e) => {
      if (el.dataset.justDragged === '1') {
        e.preventDefault();
        e.stopPropagation();
      }
    });
  }

  function enhanceAllHorizontalScroll(){
    document.querySelectorAll('[data-hscroll="1"]').forEach(enhanceHorizontalScroll);
  }


  // ===================== DATE & TIME (Hijri fixed -1 day) =====================
  let currentCalendarMonth = 0;
  let currentCalendarYear = 0;

  function updateDateTime() {
    const now = new Date();

    const iranTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tehran' }));
    document.getElementById('iran-time').textContent = toPersianNum(iranTime.toTimeString().slice(0,8));

    const utcTime = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
    document.getElementById('utc-time').textContent = toPersianNum(utcTime.toTimeString().slice(0,8));

    const jalali = gregorianToJalali(now.getFullYear(), now.getMonth()+1, now.getDate());
    const jalaliMonths = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
    document.getElementById('iran-date').textContent = `${toPersianNum(jalali.day)} ${jalaliMonths[jalali.month-1]} ${toPersianNum(jalali.year)}`;

    document.getElementById('utc-date').textContent = utcTime.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });

    const gregorianMonths = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    document.getElementById('gregorian-date').textContent = `${now.getDate()} ${gregorianMonths[now.getMonth()]} ${now.getFullYear()}`;

    // ØªØ§Ø±ÛŒØ® Ù‚Ù…Ø±ÛŒ (Ù‡Ø¬Ø±ÛŒ Ù‚Ù…Ø±ÛŒ) â€” Ø§ØµÙ„Ø§Ø­ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø§ Intl (Ù…Ù†Ø·Ø¨Ù‚ Ø¨Ø§ Asia/Tehran)
    try {
      const fmtHijri = new Intl.DateTimeFormat('fa-IR-u-ca-islamic', {
        day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Tehran'
      });
      const hijriDate = new Date(iranTime);
      hijriDate.setDate(hijriDate.getDate() - 2);
      document.getElementById('hijri-date').textContent = fmtHijri.format(hijriDate);
    } catch {
      // fallback (Ø§Ú¯Ø± Intl ØªÙ‚ÙˆÛŒÙ… Ù‚Ù…Ø±ÛŒ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ø´ÙˆØ¯)
      const hijriBase = new Date(iranTime);
      hijriBase.setDate(hijriBase.getDate() - 2); // Ø¬Ø¨Ø±Ø§Ù† Ø®Ø·Ø§ÛŒ Ø±Ø§ÛŒØ¬ Ø¨Ø¹Ø¶ÛŒ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…â€ŒÙ‡Ø§
      const hijri = gregorianToHijri(hijriBase.getFullYear(), hijriBase.getMonth()+1, hijriBase.getDate());
      const hijriMonths = ['Ù…Ø­Ø±Ù…','ØµÙØ±','Ø±Ø¨ÛŒØ¹â€ŒØ§Ù„Ø§ÙˆÙ„','Ø±Ø¨ÛŒØ¹â€ŒØ§Ù„Ø«Ø§Ù†ÛŒ','Ø¬Ù…Ø§Ø¯ÛŒâ€ŒØ§Ù„Ø§ÙˆÙ„','Ø¬Ù…Ø§Ø¯ÛŒâ€ŒØ§Ù„Ø«Ø§Ù†ÛŒ','Ø±Ø¬Ø¨','Ø´Ø¹Ø¨Ø§Ù†','Ø±Ù…Ø¶Ø§Ù†','Ø´ÙˆØ§Ù„','Ø°ÛŒâ€ŒØ§Ù„Ù‚Ø¹Ø¯Ù‡','Ø°ÛŒâ€ŒØ§Ù„Ø­Ø¬Ù‡'];
      document.getElementById('hijri-date').textContent = `${toPersianNum(hijri.day)} ${hijriMonths[hijri.month-1]} ${toPersianNum(hijri.year)}`;
    }

// --- Advanced details (weekday, week number, timezone, progress bars) ---
try{
  const faDays = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡','Ø´Ù†Ø¨Ù‡'];
  const todayName = faDays[iranTime.getDay()];
  const isoWeek = getISOWeekNumber(iranTime);

  // timezone offset like GMT+3:30
  let tzOff = 'GMT+3:30';
  try{
    const parts = new Intl.DateTimeFormat('en-US', { timeZone:'Asia/Tehran', timeZoneName:'shortOffset' }).formatToParts(now);
    const p = parts.find(x=>x.type==='timeZoneName')?.value;
    if (p) tzOff = p.replace('UTC','GMT');
  }catch{}

  document.getElementById('today-name').textContent = todayName;
  document.getElementById('today-meta').textContent = `Ù‡ÙØªÙ‡ ${toPersianNum(isoWeek)} â€¢ ${tzOff}`;

  // Day progress
  const daySeconds = iranTime.getHours()*3600 + iranTime.getMinutes()*60 + iranTime.getSeconds();
  const dayPct = (daySeconds/86400)*100;
  setProgress('day', dayPct, 86400-daySeconds);

  // Jalali month/year progress
  const jmDays = jalali.month <= 6 ? 31 : (jalali.month <= 11 ? 30 : (isJalaliLeapYear(jalali.year) ? 30 : 29));
  const jMonthSeconds = (jalali.day-1)*86400 + daySeconds;
  const jMonthTotal = jmDays*86400;
  setProgress('month', (jMonthSeconds/jMonthTotal)*100, jMonthTotal-jMonthSeconds);

  const jDayOfYear = jalaliDayOfYear(jalali.year, jalali.month, jalali.day);
  const jyDays = isJalaliLeapYear(jalali.year) ? 366 : 365;
  const jYearSeconds = (jDayOfYear-1)*86400 + daySeconds;
  const jYearTotal = jyDays*86400;
  setProgress('year', (jYearSeconds/jYearTotal)*100, jYearTotal-jYearSeconds);
}catch(e){ /* ignore */ }

    const hours = iranTime.getHours()%12;
    const minutes = iranTime.getMinutes();
    const seconds = iranTime.getSeconds();

    const hourAngle = (hours*30)+(minutes*0.5);
    const minuteAngle = minutes*6;
    const secondAngle = seconds*6;

    document.getElementById('hour-hand').setAttribute('transform', `rotate(${hourAngle} 50 50)`);
    document.getElementById('minute-hand').setAttribute('transform', `rotate(${minuteAngle} 50 50)`);
    document.getElementById('second-hand').setAttribute('transform', `rotate(${secondAngle} 50 50)`);

    if (currentCalendarYear === 0) {
      currentCalendarYear = jalali.year;
      currentCalendarMonth = jalali.month;
    }
  }

function getISOWeekNumber(date){
  // ISO week number (Monday as first day)
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function formatHMS(totalSeconds){
  const s = Math.max(0, Math.floor(totalSeconds));
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  const pad = (n)=>String(n).padStart(2,'0');
  return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
}

function setProgress(prefix, pct, remainingSeconds){
  const bar = document.getElementById(`${prefix}-progress`);
  const pctEl = document.getElementById(`${prefix}-progress-pct`);
  const remEl = document.getElementById(`${prefix}-remaining`);
  if (!bar || !pctEl || !remEl) return;
  const p = Math.max(0, Math.min(100, pct));
  bar.style.width = `${p.toFixed(2)}%`;
  pctEl.textContent = `${toPersianNum(p.toFixed(1))}%`;
  const txt = `Ù…Ø§Ù†Ø¯Ù‡: ${toPersianNum(formatHMS(remainingSeconds))}`;
  remEl.textContent = txt;
}

function jalaliDayOfYear(jy, jm, jd){
  const monthDays = (m)=> (m<=6?31:(m<=11?30:(isJalaliLeapYear(jy)?30:29)));
  let sum = 0;
  for (let m=1;m<jm;m++) sum += monthDays(m);
  return sum + jd;
}

  function adjustHijriByDays(hijriObj, deltaDays) {
    // Convert hijri -> gregorian date, shift, back to hijri
    const g = hijriToGregorian(hijriObj.year, hijriObj.month, hijriObj.day);
    const d = new Date(g.year, g.month-1, g.day);
    d.setDate(d.getDate() + deltaDays);
    return gregorianToHijri(d.getFullYear(), d.getMonth()+1, d.getDate());
  }

  function renderCalendar() {
    const jalaliMonths = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
    document.getElementById('calendar-title').textContent = `${jalaliMonths[currentCalendarMonth-1]} ${toPersianNum(currentCalendarYear)}`;

    const daysInMonth = currentCalendarMonth <= 6 ? 31 : (currentCalendarMonth <= 11 ? 30 : (isJalaliLeapYear(currentCalendarYear) ? 30 : 29));

    const firstDayGregorian = jalaliToGregorian(currentCalendarYear, currentCalendarMonth, 1);
    const firstDate = new Date(firstDayGregorian.year, firstDayGregorian.month-1, firstDayGregorian.day);
    let firstDayOfWeek = firstDate.getDay();
    firstDayOfWeek = (firstDayOfWeek + 1) % 7;

    const today = new Date();
    const todayJalali = gregorianToJalali(today.getFullYear(), today.getMonth()+1, today.getDate());

    const daysEl = document.getElementById('calendar-days');
    daysEl.innerHTML = '';

    for (let i=0;i<firstDayOfWeek;i++) daysEl.innerHTML += '<div class="py-2"></div>';

    for (let day=1; day<=daysInMonth; day++) {
      const isToday = currentCalendarYear===todayJalali.year && currentCalendarMonth===todayJalali.month && day===todayJalali.day;
      const isFriday = (firstDayOfWeek + day - 1) % 7 === 6;
      const isHoliday = getStaticEvents(currentCalendarMonth, day).some(e => e.holiday);

      daysEl.innerHTML += `
        <div class="py-2 rounded-lg cursor-pointer transition hover:bg-white/10 ${isToday ? 'bg-gradient-to-r from-indigo-600 to-purple-600 font-bold' : ''} ${((isFriday || isHoliday) && !isToday) ? 'text-red-400' : ''} ${(isToday && (isFriday || isHoliday)) ? 'ring-2 ring-red-400/60' : ''}">
          ${toPersianNum(day)}
        </div>
      `;
    }
  }

  function changeMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth > 12) { currentCalendarMonth = 1; currentCalendarYear++; }
    else if (currentCalendarMonth < 1) { currentCalendarMonth = 12; currentCalendarYear--; }
    renderCalendar();
  }

  async function fetchEvents() {
    const eventsEl = document.getElementById('today-events');
    try {
      const today = new Date();
      const jalali = gregorianToJalali(today.getFullYear(), today.getMonth()+1, today.getDate());
      const events = getStaticEvents(jalali.month, jalali.day);

      if (!events.length) {
        eventsEl.innerHTML = '<div class="text-gray-500">Ù…Ù†Ø§Ø³Ø¨ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
        return;
      }

      eventsEl.innerHTML = events.map(e => `
        <div class="py-1 flex items-center gap-2">
          <span>â€¢ ${e.title}</span>
          ${e.holiday ? '<span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-300">ØªØ¹Ø·ÛŒÙ„</span>' : ''}
        </div>
      `).join('');
    } catch {
      eventsEl.innerHTML = '<div class="text-gray-500">Ù…Ù†Ø§Ø³Ø¨ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
    }
  }

  function getStaticEvents(month, day) {
    // Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡: Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§ÛŒÙ† Ù„ÛŒØ³Øª Ø±Ùˆ Ú©Ø§Ù…Ù„â€ŒØªØ± Ú©Ù†ÛŒ (Ù…Ø°Ù‡Ø¨ÛŒ/Ù…Ù„ÛŒ/Ø¬Ù‡Ø§Ù†ÛŒ)
    // Ø³Ø§Ø®ØªØ§Ø± Ø®Ø±ÙˆØ¬ÛŒ: [{ title: '...', holiday: true/false }]
    const events = {
      '1-1':[ {title:'Ø¹ÛŒØ¯ Ù†ÙˆØ±ÙˆØ²', holiday:true} ],
      '1-2':[ {title:'Ø¹ÛŒØ¯ Ù†ÙˆØ±ÙˆØ²', holiday:true} ],
      '1-3':[ {title:'Ø¹ÛŒØ¯ Ù†ÙˆØ±ÙˆØ²', holiday:true} ],
      '1-4':[ {title:'Ø¹ÛŒØ¯ Ù†ÙˆØ±ÙˆØ²', holiday:true} ],
      '1-12':[ {title:'Ø±ÙˆØ² Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ø§Ø³Ù„Ø§Ù…ÛŒ Ø§ÛŒØ±Ø§Ù†', holiday:true} ],
      '1-13':[ {title:'Ø±ÙˆØ² Ø·Ø¨ÛŒØ¹Øª (Ø³ÛŒØ²Ø¯Ù‡â€ŒØ¨Ø¯Ø±)', holiday:true} ],
      '3-14':[ {title:'Ø±Ø­Ù„Øª Ø§Ù…Ø§Ù… Ø®Ù…ÛŒÙ†ÛŒ (Ø±Ù‡)', holiday:true} ],
      '3-15':[ {title:'Ù‚ÛŒØ§Ù… Û±Ûµ Ø®Ø±Ø¯Ø§Ø¯', holiday:true} ],
      '11-22':[ {title:'Ù¾ÛŒØ±ÙˆØ²ÛŒ Ø§Ù†Ù‚Ù„Ø§Ø¨ Ø§Ø³Ù„Ø§Ù…ÛŒ', holiday:true} ],
      '12-29':[ {title:'Ø±ÙˆØ² Ù…Ù„ÛŒ Ø´Ø¯Ù† ØµÙ†Ø¹Øª Ù†ÙØª', holiday:true} ],
    };
    return events[`${month}-${day}`] || [];
  }

  // Date conversion functions (original)
  function gregorianToJalali(gy, gm, gd) {
    const g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
    let jy = (gy <= 1600) ? 0 : 979;
    gy -= (gy <= 1600) ? 621 : 1600;
    const gy2 = (gm > 2) ? (gy + 1) : gy;
    let days = (365 * gy) + (parseInt((gy2 + 3) / 4)) - (parseInt((gy2 + 99) / 100)) + (parseInt((gy2 + 399) / 400)) - 80 + gd + g_d_m[gm - 1];
    jy += 33 * (parseInt(days / 12053));
    days %= 12053;
    jy += 4 * (parseInt(days / 1461));
    days %= 1461;
    jy += parseInt((days - 1) / 365);
    if (days > 365) days = (days - 1) % 365;
    const jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
    const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
    return { year: jy, month: jm, day: jd };
  }

  function jalaliToGregorian(jy, jm, jd) {
    let gy = (jy <= 979) ? 621 : 1600;
    jy -= (jy <= 979) ? 0 : 979;
    let days = (365 * jy) + ((parseInt(jy / 33)) * 8) + (parseInt(((jy % 33) + 3) / 4)) + 78 + jd + ((jm < 7) ? (jm - 1) * 31 : ((jm - 7) * 30) + 186);
    gy += 400 * (parseInt(days / 146097));
    days %= 146097;
    if (days > 36524) {
      gy += 100 * (parseInt(--days / 36524));
      days %= 36524;
      if (days >= 365) days++;
    }
    gy += 4 * (parseInt(days / 1461));
    days %= 1461;
    gy += parseInt((days - 1) / 365);
    if (days > 365) days = (days - 1) % 365;
    const gd = days + 1;
    const sal_a = [0,31,((gy%4===0 && gy%100!==0) || (gy%400===0)) ? 29 : 28,31,30,31,30,31,31,30,31,30,31];
    let gm = 0;
    let v = gd;
    for (gm = 0; gm < 13 && v > sal_a[gm]; gm++) v -= sal_a[gm];
    return { year: gy, month: gm, day: v };
  }

  function gregorianToHijri(gy, gm, gd) {
    const d = new Date(gy, gm - 1, gd);
    const jd = Math.floor((d.getTime() / 86400000) + 2440587.5);
    const l = jd - 1948439 + 10632;
    const n = Math.floor((l - 1) / 10631);
    const l2 = l - 10631 * n + 354;
    const j = Math.floor((10985 - l2) / 5316) * Math.floor((50 * l2) / 17719) + Math.floor(l2 / 5670) * Math.floor((43 * l2) / 15238);
    const l3 = l2 - Math.floor((30 - j) / 15) * Math.floor((17719 * j) / 50) - Math.floor(j / 16) * Math.floor((15238 * j) / 43) + 29;
    const hm = Math.floor((24 * l3) / 709);
    const hd = l3 - Math.floor((709 * hm) / 24);
    const hy = 30 * n + j - 30;
    return { year: hy, month: hm, day: hd };
  }

  function hijriToGregorian(hy, hm, hd) {
    const jd = Math.floor((11 * hy + 3) / 30) + 354 * hy + 30 * hm - Math.floor((hm - 1) / 2) + hd + 1948439 - 385;
    const l = jd + 68569;
    const n = Math.floor(4 * l / 146097);
    const l2 = l - Math.floor((146097 * n + 3) / 4);
    const i = Math.floor(4000 * (l2 + 1) / 1461001);
    const l3 = l2 - Math.floor(1461 * i / 4) + 31;
    const j = Math.floor(80 * l3 / 2447);
    const gd = l3 - Math.floor(2447 * j / 80);
    const l4 = Math.floor(j / 11);
    const gm = j + 2 - 12 * l4;
    const gy = 100 * (n - 49) + i + l4;
    return { year: gy, month: gm, day: gd };
  }

  function isJalaliLeapYear(jy) {
    return [1,5,9,13,17,22,26,30].indexOf(jy % 33) !== -1;
  }

  function convertFromJalali() {
    const y = parseInt(document.getElementById('jalali-year').value);
    const m = parseInt(document.getElementById('jalali-month').value);
    const d = parseInt(document.getElementById('jalali-day').value);
    if (!y || !m || !d) return;

    const gregorian = jalaliToGregorian(y, m, d);
    document.getElementById('gregorian-year').value = gregorian.year;
    document.getElementById('gregorian-month').value = gregorian.month;
    document.getElementById('gregorian-day').value = gregorian.day;

    const hijri = gregorianToHijri(gregorian.year, gregorian.month, gregorian.day);
    document.getElementById('hijri-year').value = hijri.year;
    document.getElementById('hijri-month').value = hijri.month;
    document.getElementById('hijri-day').value = hijri.day;
  }

  function convertFromGregorian() {
    const y = parseInt(document.getElementById('gregorian-year').value);
    const m = parseInt(document.getElementById('gregorian-month').value);
    const d = parseInt(document.getElementById('gregorian-day').value);
    if (!y || !m || !d) return;

    const jalali = gregorianToJalali(y, m, d);
    document.getElementById('jalali-year').value = jalali.year;
    document.getElementById('jalali-month').value = jalali.month;
    document.getElementById('jalali-day').value = jalali.day;

    const hijri = gregorianToHijri(y, m, d);
    document.getElementById('hijri-year').value = hijri.year;
    document.getElementById('hijri-month').value = hijri.month;
    document.getElementById('hijri-day').value = hijri.day;
  }

  function convertFromHijri() {
    const y = parseInt(document.getElementById('hijri-year').value);
    const m = parseInt(document.getElementById('hijri-month').value);
    const d = parseInt(document.getElementById('hijri-day').value);
    if (!y || !m || !d) return;

    const gregorian = hijriToGregorian(y, m, d);
    document.getElementById('gregorian-year').value = gregorian.year;
    document.getElementById('gregorian-month').value = gregorian.month;
    document.getElementById('gregorian-day').value = gregorian.day;

    const jalali = gregorianToJalali(gregorian.year, gregorian.month, gregorian.day);
    document.getElementById('jalali-year').value = jalali.year;
    document.getElementById('jalali-month').value = jalali.month;
    document.getElementById('jalali-day').value = jalali.day;
  }

  // ===================== UNIT CONVERTER (12 types) =====================
  const unitData = {
    length: { label:'ğŸ“ Ø·ÙˆÙ„', units:[
      { id:'meter', name:'Ù…ØªØ±', factor:1 },
      { id:'kilometer', name:'Ú©ÛŒÙ„ÙˆÙ…ØªØ±', factor:1000 },
      { id:'centimeter', name:'Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±', factor:0.01 },
      { id:'millimeter', name:'Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ±', factor:0.001 },
      { id:'micrometer', name:'Ù…ÛŒÚ©Ø±ÙˆÙ…ØªØ±', factor:1e-6 },
      { id:'nanometer', name:'Ù†Ø§Ù†ÙˆÙ…ØªØ±', factor:1e-9 },
      { id:'mile', name:'Ù…Ø§ÛŒÙ„', factor:1609.344 },
      { id:'yard', name:'ÛŒØ§Ø±Ø¯', factor:0.9144 },
      { id:'foot', name:'ÙÙˆØª', factor:0.3048 },
      { id:'inch', name:'Ø§ÛŒÙ†Ú†', factor:0.0254 },
      { id:'nautical_mile', name:'Ù…Ø§ÛŒÙ„ Ø¯Ø±ÛŒØ§ÛŒÛŒ', factor:1852 },
      { id:'angstrom', name:'Ø¢Ù†Ú¯Ø³ØªØ±ÙˆÙ…', factor:1e-10 }
    ]},
    weight: { label:'âš–ï¸ ÙˆØ²Ù†', units:[
      { id:'kilogram', name:'Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…', factor:1 },
      { id:'gram', name:'Ú¯Ø±Ù…', factor:0.001 },
      { id:'milligram', name:'Ù…ÛŒÙ„ÛŒâ€ŒÚ¯Ø±Ù…', factor:1e-6 },
      { id:'microgram', name:'Ù…ÛŒÚ©Ø±ÙˆÚ¯Ø±Ù…', factor:1e-9 },
      { id:'ton', name:'ØªÙ†', factor:1000 },
      { id:'pound', name:'Ù¾ÙˆÙ†Ø¯', factor:0.45359237 },
      { id:'ounce', name:'Ø§ÙˆÙ†Ø³', factor:0.028349523125 },
      { id:'stone', name:'Ø§Ø³ØªÙˆÙ†', factor:6.35029318 },
      { id:'carat', name:'Ù‚ÛŒØ±Ø§Ø·', factor:0.0002 },
      { id:'grain', name:'Ú¯Ø±ÛŒÙ†', factor:0.00006479891 },
      { id:'slug', name:'Ø§Ø³Ù„Ø§Ú¯', factor:14.59390294 },
      { id:'atomic_mass', name:'Ø¬Ø±Ù… Ø§ØªÙ…ÛŒ (u)', factor:1.66053906660e-27 } // symbolic: won't be practical
    ]},
    temperature: { label:'ğŸŒ¡ï¸ Ø¯Ù…Ø§', units:[
      { id:'celsius', name:'Ø³Ù„Ø³ÛŒÙˆØ³ (Â°C)' },
      { id:'fahrenheit', name:'ÙØ§Ø±Ù†Ù‡Ø§ÛŒØª (Â°F)' },
      { id:'kelvin', name:'Ú©Ù„ÙˆÛŒÙ† (K)' },
      { id:'rankine', name:'Ø±Ø§Ù†Ú©ÛŒÙ† (Â°R)' }
    ]},
    volume: { label:'ğŸ§ª Ø­Ø¬Ù…', units:[
      { id:'liter', name:'Ù„ÛŒØªØ±', factor:1 },
      { id:'milliliter', name:'Ù…ÛŒÙ„ÛŒâ€ŒÙ„ÛŒØªØ±', factor:0.001 },
      { id:'cubic_meter', name:'Ù…ØªØ± Ù…Ú©Ø¹Ø¨', factor:1000 },
      { id:'cubic_centimeter', name:'Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ± Ù…Ú©Ø¹Ø¨', factor:0.001 },
      { id:'gallon_us', name:'Ú¯Ø§Ù„Ù† (US)', factor:3.78541 },
      { id:'gallon_uk', name:'Ú¯Ø§Ù„Ù† (UK)', factor:4.54609 },
      { id:'quart', name:'Ú©ÙˆØ§Ø±Øª', factor:0.946353 },
      { id:'pint', name:'Ù¾Ø§ÛŒÙ†Øª', factor:0.473176 },
      { id:'cup', name:'ÙÙ†Ø¬Ø§Ù†', factor:0.236588 },
      { id:'tablespoon', name:'Ù‚Ø§Ø´Ù‚ ØºØ°Ø§Ø®ÙˆØ±ÛŒ', factor:0.0147868 },
      { id:'teaspoon', name:'Ù‚Ø§Ø´Ù‚ Ú†Ø§ÛŒØ®ÙˆØ±ÛŒ', factor:0.00492892 },
      { id:'barrel', name:'Ø¨Ø´Ú©Ù‡ Ù†ÙØª', factor:158.987 }
    ]},
    speed: { label:'ğŸš— Ø³Ø±Ø¹Øª', units:[
      { id:'mps', name:'Ù…ØªØ± Ø¨Ø± Ø«Ø§Ù†ÛŒÙ‡', factor:1 },
      { id:'kmph', name:'Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ø¨Ø± Ø³Ø§Ø¹Øª', factor:0.2777777778 },
      { id:'mph', name:'Ù…Ø§ÛŒÙ„ Ø¨Ø± Ø³Ø§Ø¹Øª', factor:0.44704 },
      { id:'knot', name:'Ù†Ø§Øª (Ø¯Ø±ÛŒØ§ÛŒÛŒ)', factor:0.514444 },
      { id:'fps', name:'ÙÙˆØª Ø¨Ø± Ø«Ø§Ù†ÛŒÙ‡', factor:0.3048 },
      { id:'mach', name:'Ù…Ø§Ø® (ØªÙ‚Ø±ÛŒØ¨ÛŒ)', factor:340.29 }
    ]},
    time: { label:'â±ï¸ Ø²Ù…Ø§Ù†', units:[
      { id:'second', name:'Ø«Ø§Ù†ÛŒÙ‡', factor:1 },
      { id:'minute', name:'Ø¯Ù‚ÛŒÙ‚Ù‡', factor:60 },
      { id:'hour', name:'Ø³Ø§Ø¹Øª', factor:3600 },
      { id:'day', name:'Ø±ÙˆØ²', factor:86400 },
      { id:'week', name:'Ù‡ÙØªÙ‡', factor:604800 },
      { id:'month', name:'Ù…Ø§Ù‡ (Û³Û° Ø±ÙˆØ²)', factor:2592000 },
      { id:'year', name:'Ø³Ø§Ù„ (Û³Û¶Ûµ Ø±ÙˆØ²)', factor:31536000 }
    ]},
    pressure: { label:'ğŸ§¯ ÙØ´Ø§Ø±', units:[
      { id:'pascal', name:'Ù¾Ø§Ø³Ú©Ø§Ù„ (Pa)', factor:1 },
      { id:'kpa', name:'Ú©ÛŒÙ„ÙˆÙ¾Ø§Ø³Ú©Ø§Ù„ (kPa)', factor:1000 },
      { id:'bar', name:'Ø¨Ø§Ø± (bar)', factor:100000 },
      { id:'atm', name:'Ø§ØªÙ…Ø³ÙØ± (atm)', factor:101325 },
      { id:'mmhg', name:'Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ± Ø¬ÛŒÙˆÙ‡ (mmHg)', factor:133.322 },
      { id:'psi', name:'PSI', factor:6894.757 }
    ]},
    energy: { label:'âš¡ Ø§Ù†Ø±Ú˜ÛŒ', units:[
      { id:'joule', name:'Ú˜ÙˆÙ„ (J)', factor:1 },
      { id:'kj', name:'Ú©ÛŒÙ„ÙˆÚ˜ÙˆÙ„', factor:1000 },
      { id:'cal', name:'Ú©Ø§Ù„Ø±ÛŒ', factor:4.184 },
      { id:'kcal', name:'Ú©ÛŒÙ„ÙˆÚ©Ø§Ù„Ø±ÛŒ', factor:4184 },
      { id:'wh', name:'ÙˆØ§Øªâ€ŒØ³Ø§Ø¹Øª', factor:3600 },
      { id:'kwh', name:'Ú©ÛŒÙ„ÙˆÙˆØ§Øªâ€ŒØ³Ø§Ø¹Øª', factor:3.6e6 },
      { id:'btu', name:'BTU', factor:1055.06 }
    ]},
    power: { label:'ğŸ”Œ ØªÙˆØ§Ù†', units:[
      { id:'watt', name:'ÙˆØ§Øª (W)', factor:1 },
      { id:'kw', name:'Ú©ÛŒÙ„ÙˆÙˆØ§Øª', factor:1000 },
      { id:'mw', name:'Ù…Ú¯Ø§ÙˆØ§Øª', factor:1e6 },
      { id:'hp', name:'Ø§Ø³Ø¨â€ŒØ¨Ø®Ø§Ø±', factor:745.699872 }
    ]},
    area: { label:'ğŸ—ºï¸ Ù…Ø³Ø§Ø­Øª', units:[
      { id:'sqm', name:'Ù…ØªØ± Ù…Ø±Ø¨Ø¹', factor:1 },
      { id:'sqkm', name:'Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ù…Ø±Ø¨Ø¹', factor:1e6 },
      { id:'sqcm', name:'Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ± Ù…Ø±Ø¨Ø¹', factor:0.0001 },
      { id:'hectare', name:'Ù‡Ú©ØªØ§Ø±', factor:10000 },
      { id:'acre', name:'Ø§ÛŒÚ©Ø±', factor:4046.8564224 },
      { id:'sqft', name:'ÙÙˆØª Ù…Ø±Ø¨Ø¹', factor:0.09290304 }
    ]},
    data: { label:'ğŸ’¾ Ø¯Ø§Ø¯Ù‡', units:[
      { id:'byte', name:'Ø¨Ø§ÛŒØª', factor:1 },
      { id:'kb', name:'Ú©ÛŒÙ„ÙˆØ¨Ø§ÛŒØª', factor:1024 },
      { id:'mb', name:'Ù…Ú¯Ø§Ø¨Ø§ÛŒØª', factor:1024**2 },
      { id:'gb', name:'Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª', factor:1024**3 },
      { id:'tb', name:'ØªØ±Ø§Ø¨Ø§ÛŒØª', factor:1024**4 },
      { id:'bit', name:'Ø¨ÛŒØª', factor:1/8 }
    ]},
    angle: { label:'ğŸ“ Ø²Ø§ÙˆÛŒÙ‡', units:[
      { id:'degree', name:'Ø¯Ø±Ø¬Ù‡', factor:1 },
      { id:'radian', name:'Ø±Ø§Ø¯ÛŒØ§Ù†', factor:57.2957795131 },
      { id:'grad', name:'Ú¯Ø±Ø§Ø¯', factor:0.9 },
      { id:'minute', name:'Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚ÙˆØ³ÛŒ', factor:1/60 },
      { id:'second', name:'Ø«Ø§Ù†ÛŒÙ‡ Ù‚ÙˆØ³ÛŒ', factor:1/3600 }
    ]}
  };


  // ---- Unit dropdown helpers (portal to body for perfect overlay) ----
  const __ddState = {}; // {menuId:{homeParent,homeNext,anchorId,open}}

  function __ddMoveToBody(menuId, anchorId){
    const menu = document.getElementById(menuId);
    const anchor = document.getElementById(anchorId);
    if (!menu || !anchor) return;

    // remember original place once
    if (!__ddState[menuId]) {
      __ddState[menuId] = {
        homeParent: menu.parentElement,
        homeNext: menu.nextSibling,
        anchorId,
        open: false
      };
    }

    // already in body
    if (menu.parentElement !== document.body) {
      document.body.appendChild(menu);
    }

    const r = anchor.getBoundingClientRect();
    const top = Math.min(window.innerHeight - 12, r.bottom + 8);
    let left = r.left;
    let width = r.width;

    // keep inside viewport
    const maxLeft = window.innerWidth - width - 12;
    left = Math.max(12, Math.min(left, maxLeft));

    menu.style.position = 'fixed';
    menu.style.top = top + 'px';
    menu.style.left = left + 'px';
    menu.style.width = width + 'px';
    menu.style.zIndex = '100000';
    menu.classList.remove('hidden');
    __ddState[menuId].open = true;
  }

  function __ddReturnHome(menuId){
    const st = __ddState[menuId];
    const menu = document.getElementById(menuId);
    if (!st || !menu) return;
    menu.classList.add('hidden');
    menu.style.position = '';
    menu.style.top = '';
    menu.style.left = '';
    menu.style.width = '';
    menu.style.zIndex = '';
    // restore to original parent
    if (st.homeParent && menu.parentElement !== st.homeParent) {
      if (st.homeNext && st.homeNext.parentElement === st.homeParent) st.homeParent.insertBefore(menu, st.homeNext);
      else st.homeParent.appendChild(menu);
    }
    st.open = false;
  }

  function closeAllUnitMenus(){
    ['conv-type-menu','from-unit-menu','to-unit-menu'].forEach(mid => __ddReturnHome(mid));
  }

  function toggleUnitMenu(id){
    const menuId = id + '-menu';
    const btnId = id + '-btn';
    const st = __ddState[menuId];
    const isOpen = st?.open && !document.getElementById(menuId)?.classList.contains('hidden');
    closeAllUnitMenus();
    if (!isOpen) __ddMoveToBody(menuId, btnId);
  }

  function openUnitMenu(id){
    closeAllUnitMenus();
    __ddMoveToBody(id+'-menu', id+'-btn');
  }

  function closeUnitMenu(id){
    __ddReturnHome(id+'-menu');
  }

  // close on outside click
  document.addEventListener('click', (e) => {
    const inside = e.target.closest('#conv-type-btn, #conv-type-menu, #from-unit-btn, #from-unit-menu, #to-unit-btn, #to-unit-menu');
    if (!inside) closeAllUnitMenus();
  });

  // keep menus aligned on scroll/resize
  window.addEventListener('resize', () => {
    Object.keys(__ddState).forEach(menuId => {
      const st = __ddState[menuId];
      if (!st?.open) return;
      __ddMoveToBody(menuId, st.anchorId || (menuId.replace('-menu','-btn')));
    });
  });
  window.addEventListener('scroll', () => {
    Object.keys(__ddState).forEach(menuId => {
      const st = __ddState[menuId];
      if (!st?.open) return;
      __ddMoveToBody(menuId, st.anchorId || (menuId.replace('-menu','-btn')));
    });
  }, {passive:true});

  function initUnitDropdownHover(){
    // Only open on hover for desktop pointers, but NEVER auto-close.
    // Menus will close only when user selects an option or clicks/taps outside.
    if (!window.matchMedia || !window.matchMedia('(hover:hover) and (pointer:fine)').matches) return;
    document.querySelectorAll('.unit-dropdown').forEach(wrap => {
      const dd = wrap.getAttribute('data-dd') || (wrap.querySelector('#conv-type-btn') ? 'conv-type' : null);
      if (!dd) return;
      if(dd !== 'conv-type') wrap.addEventListener('mouseenter', () => { openUnitMenu(dd); });
    });
  }

function setUnitDropdownOptions(id, units) {
    const menu = document.getElementById(id+'-menu');
    if (!menu) return;
    menu.innerHTML = units.map(u => `
      <button type="button" class="w-full text-right px-3 py-2 rounded-lg bg-white/10 text-white hover:bg-white/20 transition text-sm border border-white/10"
        onclick="selectUnit('${id}','${u.id}','${u.name.replace(/'/g, '&#39;')}')">
        ${u.name}
      </button>
    `).join('');
  }

  function selectUnit(id, value, label) {
    document.getElementById(id+'-value').value = value;
    document.getElementById(id+'-label').innerHTML = label;
    // Close menu ONLY after user selects an option (no auto-close on hover)
    closeUnitMenu(id);
    convertUnit();
  }

  function getSelectedUnit(id) {
    return document.getElementById(id+'-value')?.value || '';
  }

  let currentConverterType = 'length';

  function initConverterTypes() {
    const menu = document.getElementById('conv-type-menu');
    const btnLabel = document.getElementById('conv-type-label');
    const hidden = document.getElementById('conv-type-value');
    if (!menu || menu.dataset.inited === '1') return;
    menu.dataset.inited = '1';

    const keys = Object.keys(unitData);
    menu.innerHTML = keys.map(k => `
      <button type="button"
        class="w-full text-right px-3 py-2 rounded-xl bg-white/10 text-white hover:bg-white/20 transition text-sm border border-white/10"
        onclick="selectConverterType('${k}')">
        ${unitData[k].label}
      </button>
    `).join('');

    // default label
    if (btnLabel && (!hidden || !hidden.value)) {
      btnLabel.textContent = unitData[currentConverterType]?.label || 'Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡';
    }
  }

  function selectConverterType(type){
    const hidden = document.getElementById('conv-type-value');
    if (hidden) hidden.value = type;
    const lbl = document.getElementById('conv-type-label');
    if (lbl) lbl.textContent = unitData[type]?.label || 'Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡';
    // Properly close and return menu to its original place
    closeUnitMenu('conv-type');
    setConverterType(type);
  }


  
  function setConverterType(type) {
    currentConverterType = type;

    // sync dropdown label (in case called programmatically)
    const lbl = document.getElementById('conv-type-label');
    const hidden = document.getElementById('conv-type-value');
    if (hidden) hidden.value = type;
    if (lbl) lbl.textContent = unitData[type]?.label || 'Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡';

    const units = unitData[type].units;

    // populate compact dropdowns
    setUnitDropdownOptions('from-unit', units);
    setUnitDropdownOptions('to-unit', units);

    // default selections
    const fromDefault = units[0]?.id || '';
    const toDefault = units[1]?.id || units[0]?.id || '';

    selectUnit('from-unit', fromDefault, units.find(u=>u.id===fromDefault)?.name || 'Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ§Ø­Ø¯');
    selectUnit('to-unit', toDefault, units.find(u=>u.id===toDefault)?.name || 'Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ§Ø­Ø¯');

    document.getElementById('from-value').value = '';
    document.getElementById('to-value').textContent = '-';
  }


  
  function convertUnit() {
    const fromValue = parseFloat(document.getElementById('from-value').value);
    const fromUnit = getSelectedUnit('from-unit');
    const toUnit = getSelectedUnit('to-unit');

    if (isNaN(fromValue)) { document.getElementById('to-value').textContent = '-'; return; }
    if (!fromUnit || !toUnit) { document.getElementById('to-value').textContent = '-'; return; }

    let result;

    if (currentConverterType === 'temperature') {
      result = convertTemperature(fromValue, fromUnit, toUnit);
    } else {
      const units = unitData[currentConverterType].units;
      const fromFactor = units.find(u => u.id === fromUnit)?.factor;
      const toFactor = units.find(u => u.id === toUnit)?.factor;

      if (!fromFactor || !toFactor) { document.getElementById('to-value').textContent='-'; return; }
      result = (fromValue * fromFactor) / toFactor;
    }

    const pretty = Number.isFinite(result) ? result.toFixed(8).replace(/\.0+$/,'').replace(/(\.\d*?)0+$/,'$1') : '-';
    document.getElementById('to-value').textContent = toPersianNum(pretty);
  }


  function convertTemperature(value, from, to) {
    let c;
    switch(from){
      case 'celsius': c=value; break;
      case 'fahrenheit': c=(value-32)*5/9; break;
      case 'kelvin': c=value-273.15; break;
      case 'rankine': c=(value-491.67)*5/9; break;
      default: c=value;
    }
    switch(to){
      case 'celsius': return c;
      case 'fahrenheit': return (c*9/5)+32;
      case 'kelvin': return c+273.15;
      case 'rankine': return (c+273.15)*9/5;
      default: return c;
    }
  }

  // ===================== CALCULATOR (simple + engineering) =====================
  // Ø¨Ù‡ÛŒÙ†Ù‡ Ùˆ Ù‚ÙˆÛŒâ€ŒØªØ±: Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø¹Ø¨Ø§Ø±Øª Ú©Ø§Ù…Ù„ØŒ Ù¾Ø±Ø§Ù†ØªØ²ØŒ ØªÙˆØ§Ø¨Ø¹ Ù…Ù‡Ù†Ø¯Ø³ÛŒØŒ Ùˆ Ø­Ø§ÙØ¸Ù‡
  let calcExpression = '';        // expression buffer (JS-like tokens)
  let calcCurrentValue = '0';     // current number token being typed
  let calcNewNumber = true;       // whether next digit starts a new number
  let calcMode = 'simple';
  let trigMode = 'DEG';           // DEG / RAD
  let calcMem = 0;                // memory register

  function setCalcMode(mode) {
    calcMode = mode;
    document.getElementById('mode-simple').classList.toggle('active', mode==='simple');
    document.getElementById('mode-sci').classList.toggle('active', mode==='sci');
    document.getElementById('sci-pad').classList.toggle('hidden', mode!=='sci');
  }

  function toggleTrigMode(){
    trigMode = (trigMode === 'DEG') ? 'RAD' : 'DEG';
    const btn = document.getElementById('trig-mode-btn');
    if(btn) btn.textContent = trigMode;
  }

  function _exprPreviewString(){
    const tail = calcNewNumber ? '' : calcCurrentValue;
    return (calcExpression + tail).trim();
  }

  function updateCalcDisplay() {
    const expr = _exprPreviewString();
    document.getElementById('calc-expression').textContent = expr ? expr : '';
    document.getElementById('calc-result').textContent = toPersianNum(calcCurrentValue);
  }

  function _startNewIfNeeded(){
    if(calcNewNumber){
      calcCurrentValue = '0';
      calcNewNumber = false;
    }
  }

  function calcNum(num) {
    _startNewIfNeeded();
    calcCurrentValue = (calcCurrentValue === '0') ? num : (calcCurrentValue + num);
    updateCalcDisplay();
  }

  function calcDot() {
    _startNewIfNeeded();
    if (!calcCurrentValue.includes('.')) calcCurrentValue += '.';
    updateCalcDisplay();
  }

  function calcInsert(text){
    // inserts raw token into expression (used in sci mode)
    // if user is typing a number, commit it first when appropriate
    if(!calcNewNumber && calcCurrentValue !== '0'){
      calcExpression += calcCurrentValue;
      calcCurrentValue = '0';
      calcNewNumber = true;
    }
    calcExpression += String(text);
    updateCalcDisplay();
  }

  function calcInsertOp(op){
    // commit current value, then append operator (replace last operator if needed)
    if(!calcNewNumber){
      calcExpression += calcCurrentValue;
      calcNewNumber = true;
      calcCurrentValue = '0';
    }
    // normalize: replace trailing operator
    calcExpression = calcExpression.trimEnd();
    if (/[\+\-\*\/\^]$/.test(calcExpression)) {
      calcExpression = calcExpression.slice(0, -1) + op;
    } else {
      calcExpression += (calcExpression ? ' ' : '') + op + ' ';
    }
    updateCalcDisplay();
  }

  function calcOp(op) { calcInsertOp(op); }

  function calcInsertConst(name){
    if(name === 'pi') calcInsert('pi');
    if(name === 'e') calcInsert('e');
  }

  function calcInsertFunc(fn){
    // inserts function call, like sin(
    const map = { sin:'sin', cos:'cos', tan:'tan', asin:'asin', acos:'acos', atan:'atan', sqrt:'sqrt', ln:'ln', log:'log', abs:'abs', exp:'exp', fact:'fact' };
    const f = map[fn] || fn;
    calcInsert(f + '(');
  }

  function calcPow() { calcInsertOp('^'); }

  function calcBackspace() {
    if(!calcNewNumber){
      if (calcCurrentValue.length > 1) calcCurrentValue = calcCurrentValue.slice(0, -1);
      else { calcCurrentValue = '0'; calcNewNumber = true; }
      updateCalcDisplay();
      return;
    }
    // backspace in expression buffer
    if(calcExpression.length){
      calcExpression = calcExpression.slice(0, -1);
      updateCalcDisplay();
    }
  }

  function calcClear() {
    calcExpression = '';
    calcCurrentValue = '0';
    calcNewNumber = true;
    updateCalcDisplay();
  }

  function calcPercent() {
    // percent on current token
    if(calcNewNumber) return;
    const x = parseFloat(calcCurrentValue);
    if(isNaN(x)) return;
    calcCurrentValue = String(x / 100);
    updateCalcDisplay();
  }

  function _safeEval(expr){
    // allow only safe characters/tokens
    // (digits, ops, parentheses, dot, spaces, commas, letters for function names)
    const safe = /^[0-9+\-*/^().,\sA-Za-z]*$/;
    if(!safe.test(expr)) return { ok:false, value:'Error' };

    // normalize
    let jsExpr = expr
      .replace(/\^/g, '**')
      .replace(/\bpi\b/gi, 'PI')
      .replace(/\be\b/g, 'E')
      .replace(/\bln\s*\(/gi, 'LN(')
      .replace(/\blog\s*\(/gi, 'LOG10(');

    // context functions (DEG/RAD aware trig)
    const ctx = {
      PI: Math.PI,
      E: Math.E,
      abs: Math.abs,
      sqrt: Math.sqrt,
      exp: Math.exp,
      LN: (x)=>Math.log(x),
      LOG10: (x)=>Math.log10(x),
      fact: (n)=>{
        const x = Number(n);
        if(!Number.isFinite(x) || x < 0) return NaN;
        if(Math.floor(x) !== x) return NaN;
        let r = 1;
        for(let i=2;i<=x;i++) r*=i;
        return r;
      },
      sin: (x)=> trigMode==='DEG' ? Math.sin(Number(x)*Math.PI/180) : Math.sin(Number(x)),
      cos: (x)=> trigMode==='DEG' ? Math.cos(Number(x)*Math.PI/180) : Math.cos(Number(x)),
      tan: (x)=> trigMode==='DEG' ? Math.tan(Number(x)*Math.PI/180) : Math.tan(Number(x)),
      asin: (x)=> trigMode==='DEG' ? (Math.asin(Number(x))*180/Math.PI) : Math.asin(Number(x)),
      acos: (x)=> trigMode==='DEG' ? (Math.acos(Number(x))*180/Math.PI) : Math.acos(Number(x)),
      atan: (x)=> trigMode==='DEG' ? (Math.atan(Number(x))*180/Math.PI) : Math.atan(Number(x))
    };

    try{
      const fn = new Function('ctx', 'with(ctx){ return (' + jsExpr + '); }');
      const val = fn(ctx);
      if(typeof val === 'number' && Number.isFinite(val)) return { ok:true, value: val };
      return { ok:false, value:'Error' };
    } catch {
      return { ok:false, value:'Error' };
    }
  }

  function calcEquals() {
    const expr = _exprPreviewString();
    if(!expr) return;
    const out = _safeEval(expr);
    calcExpression = '';
    if(out.ok){
      // limit noise
      const v = out.value;
      calcCurrentValue = String(Math.abs(v) >= 1e12 || (Math.abs(v) > 0 && Math.abs(v) < 1e-9) ? v.toExponential(10) : +v.toFixed(10));
      // remove trailing zeros
      calcCurrentValue = calcCurrentValue.replace(/\.?0+($|e)/, (m)=> m.startsWith('e') ? m : '');
    } else {
      calcCurrentValue = 'Error';
    }
    calcNewNumber = true;
    updateCalcDisplay();
  }

  // Memory functions
  function _currentNumber(){
    const x = parseFloat(calcCurrentValue);
    return Number.isFinite(x) ? x : 0;
  }
  function calcMemClear(){ calcMem = 0; }
  function calcMemRecall(){
    calcCurrentValue = String(calcMem);
    calcNewNumber = true;
    updateCalcDisplay();
  }
  function calcMemAdd(){ calcMem += _currentNumber(); }
  function calcMemSub(){ calcMem -= _currentNumber(); }

  // Initialize display
  updateCalcDisplay();

  // ===================== HEALTH: BMI / BMR / TDEE =====================: BMI / BMR / TDEE =====================
function _getNum(id){
  const el = document.getElementById(id);
  if(!el) return NaN;
  const v = (el.value ?? '').toString().trim();
  if(!v) return NaN;
  return parseFloat(toEnglishNum(v));
}

function calculateBMI(){
  const hCm = _getNum('bmi-height');
  const wKg = _getNum('bmi-weight');
  const box = document.getElementById('bmi-result');
  const valueEl = document.getElementById('bmi-value');
  const statusEl = document.getElementById('bmi-status');
  const markerEl = document.getElementById('bmi-marker');

  if(!Number.isFinite(hCm) || !Number.isFinite(wKg) || hCm<=0 || wKg<=0){
    if(valueEl) valueEl.textContent = 'â€”';
    if(statusEl) statusEl.textContent = 'Ù„Ø·ÙØ§Ù‹ Ù‚Ø¯ Ùˆ ÙˆØ²Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
    if(box) box.classList.remove('hidden');
    return;
  }

  const hM = hCm/100;
  const bmi = wKg/(hM*hM);

  let status='Ù†Ø±Ù…Ø§Ù„';
  if(bmi < 18.5) status='Ú©Ù…â€ŒÙˆØ²Ù†';
  else if(bmi < 25) status='Ù†Ø±Ù…Ø§Ù„';
  else if(bmi < 30) status='Ø§Ø¶Ø§ÙÙ‡â€ŒÙˆØ²Ù†';
  else status='Ú†Ø§Ù‚ÛŒ';

  if(valueEl) valueEl.textContent = toPersianNum(bmi.toFixed(1));
  if(statusEl) statusEl.textContent = status;

  // marker position on bar (12..40 mapped, clamp)
// NOTE: for RTL/LTR consistency we always place marker using 'left' (0..100)
const clamped = Math.max(12, Math.min(40, bmi));
const pct = (clamped - 12) / (40 - 12); // 0..1
const leftPct = pct * 100;
if(markerEl){
  markerEl.style.left = leftPct.toFixed(1) + '%';
  markerEl.style.right = 'auto';
}

  if(box) box.classList.remove('hidden');
}

function _calcBMR(gender, age, hCm, wKg){
  // Mifflin-St Jeor
  const base = 10*wKg + 6.25*hCm - 5*age;
  return gender === 'female' ? (base - 161) : (base + 5);
}

function calculateBMR(){
  const gender = document.getElementById('bmr-gender')?.value || 'male';
  const age = _getNum('bmr-age');
  const hCm = _getNum('bmr-height');
  const wKg = _getNum('bmr-weight');

  const box = document.getElementById('bmr-result');
  const valueEl = document.getElementById('bmr-value');

  if(!Number.isFinite(age) || !Number.isFinite(hCm) || !Number.isFinite(wKg) || age<=0 || hCm<=0 || wKg<=0){
    if(valueEl) valueEl.textContent = 'â€”';
    if(box){
      box.classList.remove('hidden');
      box.querySelector('.text-sm')?.classList.remove('hidden');
    }
    // add a small hint under the number (non-breaking for layout)
    const hint = box?.querySelector('.bmr-hint') || null;
    if(hint) hint.remove();
    if(box){
      const p = document.createElement('div');
      p.className = 'bmr-hint text-xs text-gray-300 mt-2';
      p.textContent = 'Ù„Ø·ÙØ§Ù‹ Ø³Ù†ØŒ Ù‚Ø¯ Ùˆ ÙˆØ²Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
      box.appendChild(p);
    }
    return;
  }

  const bmr = _calcBMR(gender, age, hCm, wKg);
  if(valueEl) valueEl.textContent = toPersianNum(Math.round(bmr));

  // remove hint if exists
  const hint = box?.querySelector('.bmr-hint');
  if(hint) hint.remove();

  if(box) box.classList.remove('hidden');
}

function calculateTDEE(){
  const gender = document.getElementById('tdee-gender')?.value || 'male';
  const age = _getNum('tdee-age');
  const hCm = _getNum('tdee-height');
  const wKg = _getNum('tdee-weight');
  const activity = parseFloat(document.getElementById('tdee-activity')?.value || '1.2');

  const box = document.getElementById('tdee-result');
  const valueEl = document.getElementById('tdee-value');
  const loseEl = document.getElementById('tdee-lose');
  const gainEl = document.getElementById('tdee-gain');

  if(!Number.isFinite(age) || !Number.isFinite(hCm) || !Number.isFinite(wKg) || age<=0 || hCm<=0 || wKg<=0 || !Number.isFinite(activity)){
    if(valueEl) valueEl.textContent = 'â€”';
    if(loseEl) loseEl.textContent = 'â€”';
    if(gainEl) gainEl.textContent = 'â€”';
    if(box){
      box.classList.remove('hidden');
      // add/update hint
      const old = box.querySelector('.tdee-hint');
      if(old) old.remove();
      const p = document.createElement('div');
      p.className = 'tdee-hint text-xs text-gray-300 mt-3 text-center';
      p.textContent = 'Ù„Ø·ÙØ§Ù‹ Ø³Ù†ØŒ Ù‚Ø¯ Ùˆ ÙˆØ²Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
      box.appendChild(p);
    }
    return;
  }

  const bmr = _calcBMR(gender, age, hCm, wKg);
  const tdee = bmr * activity;

  // suggestions
  const lose = Math.max(1200, tdee - 500); // safe-ish floor for adults
  const gain = tdee + 300;

  if(valueEl) valueEl.textContent = toPersianNum(Math.round(tdee));
  if(loseEl) loseEl.textContent = toPersianNum(Math.round(lose));
  if(gainEl) gainEl.textContent = toPersianNum(Math.round(gain));

  // remove hint if exists
  const old = box?.querySelector('.tdee-hint');
  if(old) old.remove();

  if(box) box.classList.remove('hidden');
}

  // ===================== HEALTH: Extra tools =====================
  function calculateWater() {
    const w = parseFloat(document.getElementById('water-weight').value);
    const activity = document.getElementById('water-activity').value;
    const out = document.getElementById('water-result');

    if (!Number.isFinite(w) || w <= 0) {
      out.innerHTML = 'Ù„Ø·ÙØ§Ù‹ ÙˆØ²Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
      out.classList.remove('hidden');
      return;
    }

    // baseline: 30-35 ml/kg
    let mlPerKg = 32;
    if (activity === 'mid') mlPerKg = 35;
    if (activity === 'high') mlPerKg = 40;

    const liters = (w * mlPerKg) / 1000;

    const msg = `
      <div class="mb-1"><span class="font-bold">Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:</span> Ø­Ø¯ÙˆØ¯ <span class="font-bold">${toPersianNum(liters.toFixed(1))}</span> Ù„ÛŒØªØ± Ø¯Ø± Ø±ÙˆØ²</div>
      <div class="text-xs text-gray-300">Ù†Ú©ØªÙ‡: Ø¯Ø± Ù‡ÙˆØ§ÛŒ Ú¯Ø±Ù…/ÙˆØ±Ø²Ø´ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø¨ÛŒØ´ØªØ±ÛŒ Ù„Ø§Ø²Ù… Ø§Ø³Øª. Ø±Ù†Ú¯ Ø§Ø¯Ø±Ø§Ø± Ø®ÛŒÙ„ÛŒ ØªÛŒØ±Ù‡ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ù†Ø´Ø§Ù†Ù‡ Ú©Ù…â€ŒØ¢Ø¨ÛŒ Ø§Ø³Øª.</div>
    `;
    out.innerHTML = msg;
    out.classList.remove('hidden');
  }

  function calculateWHtR() {
    const h = parseFloat(document.getElementById('whr-height').value);
    const w = parseFloat(document.getElementById('whr-waist').value);
    const out = document.getElementById('whr-result');

    if (!Number.isFinite(h) || !Number.isFinite(w) || h<=0 || w<=0) {
      out.innerHTML = 'Ù„Ø·ÙØ§Ù‹ Ù‚Ø¯ Ùˆ Ø¯ÙˆØ± Ú©Ù…Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
      out.classList.remove('hidden');
      return;
    }

    const ratio = w / h; // both cm
    let label = 'Ú©Ù…â€ŒØ®Ø·Ø±';
    let tip = 'ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø®ÙˆØ¨ Ø§Ø³ØªØ› ÙØ¹Ø§Ù„ÛŒØª Ø¨Ø¯Ù†ÛŒ Ùˆ ØªØºØ°ÛŒÙ‡ Ù…ØªØ¹Ø§Ø¯Ù„ Ø±Ø§ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯.';

    if (ratio >= 0.5 && ratio < 0.6) { label = 'Ù…Ø±Ø²ÛŒ'; tip = 'Ø¨Ù‡ØªØ± Ø§Ø³Øª ÙˆØ²Ù†/Ø¯ÙˆØ± Ú©Ù…Ø± Ø±Ø§ Ú©Ù†ØªØ±Ù„ Ú©Ù†ÛŒØ¯ Ùˆ ÙØ¹Ø§Ù„ÛŒØª Ø¨Ø¯Ù†ÛŒ Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯.'; }
    if (ratio >= 0.6) { label = 'Ù¾Ø±Ø®Ø·Ø±'; tip = 'Ø±ÛŒØ³Ú© Ù…ØªØ§Ø¨ÙˆÙ„ÛŒÚ© Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø³ØªØ› Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù¾Ø²Ø´Ú©ÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.'; }

    out.innerHTML = `
      <div class="mb-1"><span class="font-bold">WHtR:</span> ${toPersianNum(ratio.toFixed(2))} (${label})</div>
      <div class="text-xs text-gray-300">${tip}</div>
    `;
    out.classList.remove('hidden');
  }

  function calculateBodyFat() {
    const gender = document.getElementById('bf-gender').value;
    const height = parseFloat(document.getElementById('bf-height').value);
    const neck = parseFloat(document.getElementById('bf-neck').value);
    const waist = parseFloat(document.getElementById('bf-waist').value);
    const hip = parseFloat(document.getElementById('bf-hip')?.value);
    const out = document.getElementById('bf-result');

    if (!Number.isFinite(height) || !Number.isFinite(neck) || !Number.isFinite(waist) || height<=0 || neck<=0 || waist<=0) {
      out.innerHTML = 'Ù„Ø·ÙØ§Ù‹ Ù‚Ø¯ØŒ Ø¯ÙˆØ± Ú¯Ø±Ø¯Ù† Ùˆ Ø¯ÙˆØ± Ú©Ù…Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
      out.classList.remove('hidden');
      return;
    }

    // US Navy (cm): convert to inches? we'll use log10 with cm formula variants:
    // Male: %BF = 495/(1.0324 - 0.19077*log10(waist-neck) + 0.15456*log10(height)) - 450
    // Female: %BF = 495/(1.29579 - 0.35004*log10(waist+hip-neck) + 0.22100*log10(height)) - 450
    const log10 = (x) => Math.log(x) / Math.LN10;

    let bf;
    if (gender === 'male') {
      const x = waist - neck;
      if (x <= 0) {
        out.innerHTML = 'Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ù†Ø·Ù‚ÛŒ Ù†ÛŒØ³Øª (Ø¯ÙˆØ± Ú©Ù…Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² Ø¯ÙˆØ± Ú¯Ø±Ø¯Ù† Ø¨Ø§Ø´Ø¯).';
        out.classList.remove('hidden');
        return;
      }
      bf = 495 / (1.0324 - 0.19077 * log10(x) + 0.15456 * log10(height)) - 450;
    } else {
      if (!Number.isFinite(hip) || hip<=0) {
        out.innerHTML = 'Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù†Ù…â€ŒÙ‡Ø§ØŒ Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ± Ø¨Ø§Ø³Ù† Ø±Ø§ Ù‡Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
        out.classList.remove('hidden');
        return;
      }
      const x = waist + hip - neck;
      if (x <= 0) {
        out.innerHTML = 'Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ù†Ø·Ù‚ÛŒ Ù†ÛŒØ³Øª (waist+hip Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø§Ø² neck Ø¨Ø§Ø´Ø¯).';
        out.classList.remove('hidden');
        return;
      }
      bf = 495 / (1.29579 - 0.35004 * log10(x) + 0.22100 * log10(height)) - 450;
    }

    if (!Number.isFinite(bf)) {
      out.innerHTML = 'Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡. ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.';
      out.classList.remove('hidden');
      return;
    }

    const bfRounded = Math.max(0, Math.min(70, bf));
    out.innerHTML = `<div><span class="font-bold">Ø¯Ø±ØµØ¯ Ú†Ø±Ø¨ÛŒ Ø¨Ø¯Ù†:</span> ${toPersianNum(bfRounded.toFixed(1))}%</div>
      <div class="text-xs text-gray-300 mt-1">Ø§ÛŒÙ† Ø¹Ø¯Ø¯ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø§Ø³Øª Ùˆ Ø¨Ø§ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ (DEXA/Ú©Ø§Ù„ÛŒÙ¾Ø±) Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ø¯.</div>`;
    out.classList.remove('hidden');
  }

  function calculateHRZones() {
    const age = parseFloat(document.getElementById('hr-age').value);
    const rest = parseFloat(document.getElementById('hr-rest').value);
    const out = document.getElementById('hr-result');

    if (!Number.isFinite(age) || age<=0) {
      out.innerHTML = 'Ù„Ø·ÙØ§Ù‹ Ø³Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
      out.classList.remove('hidden');
      return;
    }

    // Max HR approximations: 220 - age
    const max = 220 - age;

    // If rest given, also show Karvonen (heart rate reserve)
    const hasRest = Number.isFinite(rest) && rest > 0 && rest < max;

    const zones = [
      { n:'Ø²ÙˆÙ† Û± (Ø±ÛŒÚ©Ø§ÙˆØ±ÛŒ)', a:0.50, b:0.60 },
      { n:'Ø²ÙˆÙ† Û² (Ú†Ø±Ø¨ÛŒâ€ŒØ³ÙˆØ²ÛŒ)', a:0.60, b:0.70 },
      { n:'Ø²ÙˆÙ† Û³ (Ù‡ÙˆØ§Ø²ÛŒ)', a:0.70, b:0.80 },
      { n:'Ø²ÙˆÙ† Û´ (Ø¢Ø³ØªØ§Ù†Ù‡)', a:0.80, b:0.90 },
      { n:'Ø²ÙˆÙ† Ûµ (Ø´Ø¯Øª Ø¨Ø§Ù„Ø§)', a:0.90, b:1.00 }
    ];

    const fmt = (x) => toPersianNum(Math.round(x));

    const simple = zones.map(z => {
      const lo = max * z.a;
      const hi = max * z.b;
      return `<div class="flex justify-between"><span>${z.n}</span><span dir="ltr">${fmt(lo)}-${fmt(hi)} bpm</span></div>`;
    }).join('');

    let karvonen = '';
    if (hasRest) {
      const hrr = max - rest;
      karvonen = `
        <div class="mt-3 text-xs text-gray-300">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ø§ HR Rest (Ú©Ø§Ø±ÙˆÙˆÙ†Ù†):</div>
        ${zones.map(z=>{
          const lo = rest + hrr*z.a;
          const hi = rest + hrr*z.b;
          return `<div class="flex justify-between"><span>${z.n}</span><span dir="ltr">${fmt(lo)}-${fmt(hi)} bpm</span></div>`;
        }).join('')}
      `;
    }

    out.innerHTML = `
      <div class="mb-2"><span class="font-bold">Ø­Ø¯Ø§Ú©Ø«Ø± Ø¶Ø±Ø¨Ø§Ù† ØªÙ‚Ø±ÛŒØ¨ÛŒ:</span> ${fmt(max)} bpm</div>
      <div class="space-y-1 text-sm">${simple}</div>
      ${karvonen}
    `;
    out.classList.remove('hidden');
  }

  // show/hide hip for female
  (function initBodyFatUI(){
    const g = document.getElementById('bf-gender');
    const wrap = document.getElementById('bf-hip-wrap');
    if (!g || !wrap) return;
    const refresh = () => wrap.classList.toggle('hidden', g.value !== 'female');
    g.addEventListener('change', refresh);
    refresh();
  })();

// ===================== HEALTH: Lab interpretation =====================
  
  // ===================== HEALTH: Lab interpretation (advanced) =====================
  function interpretLabs() {
    const fbs = parseFloat(document.getElementById('lab-fbs').value);
    const a1c = parseFloat(document.getElementById('lab-a1c').value);
    const tc  = parseFloat(document.getElementById('lab-tc').value);
    const tg  = parseFloat(document.getElementById('lab-tg').value);
    const hdl = parseFloat(document.getElementById('lab-hdl').value);
    const ldl = parseFloat(document.getElementById('lab-ldl').value);
    const cr  = parseFloat(document.getElementById('lab-cr').value);
    const alt = parseFloat(document.getElementById('lab-alt').value);
    const ast = parseFloat(document.getElementById('lab-ast').value);
    const tsh = parseFloat(document.getElementById('lab-tsh').value);
    const vitd= parseFloat(document.getElementById('lab-vitd').value);
    const sys = parseFloat(document.getElementById('lab-sys').value);
    const dia = parseFloat(document.getElementById('lab-dia').value);

    const out = document.getElementById('lab-result');
    const sections = [];

    const badge = (txt, tone) => {
      const cls = tone === 'good' ? 'bg-green-500/15 text-green-200 border-green-500/20'
                : tone === 'warn' ? 'bg-amber-500/15 text-amber-200 border-amber-500/20'
                : tone === 'bad'  ? 'bg-red-500/15 text-red-200 border-red-500/20'
                : 'bg-white/10 text-gray-200 border-white/10';
      return `<span class="inline-flex items-center px-2 py-0.5 rounded-lg border ${cls} text-xs mr-1">${txt}</span>`;
    };

    const row = (title, msg, tone) =>
      `<div class="mb-2"><div class="flex items-center justify-between gap-2">
        <div class="font-bold">${title}</div>
        <div>${badge(tone==='good'?'Ø®ÙˆØ¨':tone==='warn'?'Ù…Ø±Ø²ÛŒ':tone==='bad'?'Ø¨Ø§Ù„Ø§/ØºÛŒØ±Ø·Ø¨ÛŒØ¹ÛŒ':'-', tone)}</div>
      </div><div class="text-gray-200">${msg}</div></div>`;

    // ---- Glucose / Diabetes ----
    if (Number.isFinite(fbs) || Number.isFinite(a1c)) {
      let msgs = '';

      if (Number.isFinite(fbs)) {
        if (fbs < 70) msgs += `â€¢ Ù‚Ù†Ø¯ Ù†Ø§Ø´ØªØ§ ${toPersianNum(fbs)}: Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¹Ù…ÙˆÙ„. <span class="text-gray-300">(Ø§Ú¯Ø± Ø¹Ù„Ø§Ø¦Ù… Ø¯Ø§Ø±ÛŒØ¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ú©Ù†ÛŒØ¯)</span><br>`;
        else if (fbs <= 99) msgs += `â€¢ Ù‚Ù†Ø¯ Ù†Ø§Ø´ØªØ§ ${toPersianNum(fbs)}: Ø·Ø¨ÛŒØ¹ÛŒ.<br>`;
        else if (fbs <= 125) msgs += `â€¢ Ù‚Ù†Ø¯ Ù†Ø§Ø´ØªØ§ ${toPersianNum(fbs)}: Ù¾ÛŒØ´â€ŒØ¯ÛŒØ§Ø¨Øª.<br>`;
        else msgs += `â€¢ Ù‚Ù†Ø¯ Ù†Ø§Ø´ØªØ§ ${toPersianNum(fbs)}: Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø¯ÛŒØ§Ø¨Øª (Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø²Ø´Ú©ÛŒ).<br>`;
      }

      if (Number.isFinite(a1c)) {
        if (a1c < 5.7) msgs += `â€¢ HbA1c ${toPersianNum(a1c.toFixed(1))}%: Ø·Ø¨ÛŒØ¹ÛŒ.<br>`;
        else if (a1c < 6.5) msgs += `â€¢ HbA1c ${toPersianNum(a1c.toFixed(1))}%: Ù¾ÛŒØ´â€ŒØ¯ÛŒØ§Ø¨Øª.<br>`;
        else msgs += `â€¢ HbA1c ${toPersianNum(a1c.toFixed(1))}%: Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø¯ÛŒØ§Ø¨Øª (Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ).<br>`;
      }

      let tone = 'info';
      if ((Number.isFinite(fbs) && fbs >= 126) || (Number.isFinite(a1c) && a1c >= 6.5)) tone = 'bad';
      else if ((Number.isFinite(fbs) && fbs >= 100) || (Number.isFinite(a1c) && a1c >= 5.7)) tone = 'warn';
      else tone = 'good';

      sections.push(row('Ù‚Ù†Ø¯ Ùˆ Ú©Ù†ØªØ±Ù„ Ø¯ÛŒØ§Ø¨Øª', msgs || 'â€”', tone));
    }

    // ---- Lipids ----
    if (Number.isFinite(tc) || Number.isFinite(tg) || Number.isFinite(hdl) || Number.isFinite(ldl)) {
      let msgs = '';

      if (Number.isFinite(tc)) {
        if (tc < 200) msgs += `â€¢ Ú©Ù„Ø³ØªØ±ÙˆÙ„ Ú©Ù„ ${toPersianNum(tc)}: Ù…Ø·Ù„ÙˆØ¨.<br>`;
        else if (tc <= 239) msgs += `â€¢ Ú©Ù„Ø³ØªØ±ÙˆÙ„ Ú©Ù„ ${toPersianNum(tc)}: Ù…Ø±Ø²ÛŒ.<br>`;
        else msgs += `â€¢ Ú©Ù„Ø³ØªØ±ÙˆÙ„ Ú©Ù„ ${toPersianNum(tc)}: Ø¨Ø§Ù„Ø§.<br>`;
      }

      if (Number.isFinite(ldl)) {
        let cat = 'Ø¨Ù‡ÛŒÙ†Ù‡';
        if (ldl < 100) cat = 'Ø¨Ù‡ÛŒÙ†Ù‡';
        else if (ldl <= 129) cat = 'Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ø¨Ù‡ÛŒÙ†Ù‡';
        else if (ldl <= 159) cat = 'Ù…Ø±Ø²ÛŒ Ø¨Ø§Ù„Ø§';
        else if (ldl <= 189) cat = 'Ø¨Ø§Ù„Ø§';
        else cat = 'Ø®ÛŒÙ„ÛŒ Ø¨Ø§Ù„Ø§';
        msgs += `â€¢ LDL ${toPersianNum(ldl)}: ${cat}.<br>`;
      }

      if (Number.isFinite(hdl)) {
        if (hdl < 40) msgs += `â€¢ HDL ${toPersianNum(hdl)}: Ù¾Ø§ÛŒÛŒÙ† (Ø±ÛŒØ³Ú© Ù‚Ù„Ø¨ÛŒ Ø¨ÛŒØ´ØªØ±).<br>`;
        else if (hdl < 60) msgs += `â€¢ HDL ${toPersianNum(hdl)}: Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„.<br>`;
        else msgs += `â€¢ HDL ${toPersianNum(hdl)}: Ø¹Ø§Ù„ÛŒ/Ù…Ø­Ø§ÙØ¸ØªÛŒ.<br>`;
      }

      if (Number.isFinite(tg)) {
        if (tg < 150) msgs += `â€¢ TG ${toPersianNum(tg)}: Ø·Ø¨ÛŒØ¹ÛŒ.<br>`;
        else if (tg <= 199) msgs += `â€¢ TG ${toPersianNum(tg)}: Ù…Ø±Ø²ÛŒ.<br>`;
        else if (tg <= 499) msgs += `â€¢ TG ${toPersianNum(tg)}: Ø¨Ø§Ù„Ø§.<br>`;
        else msgs += `â€¢ TG ${toPersianNum(tg)}: Ø®ÛŒÙ„ÛŒ Ø¨Ø§Ù„Ø§ (Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ÙÙˆØ±ÛŒ).<br>`;
      }

      // Derived metrics
      if (Number.isFinite(tc) && Number.isFinite(hdl) && hdl > 0) {
        const nonHdl = tc - hdl;
        msgs += `â€¢ Nonâ€‘HDL: ${toPersianNum(nonHdl.toFixed(0))} mg/dL.<br>`;
      }
      if (Number.isFinite(tg) && Number.isFinite(hdl) && hdl > 0) {
        const ratio = tg / hdl;
        const rTone = ratio < 2 ? 'Ø®ÙˆØ¨' : ratio < 3.5 ? 'Ù…Ø±Ø²ÛŒ' : 'Ø¨Ø§Ù„Ø§';
        msgs += `â€¢ Ù†Ø³Ø¨Øª TG/HDL: ${toPersianNum(ratio.toFixed(2))} (${rTone}).<br>`;
      }

      let tone = 'info';
      if ((Number.isFinite(ldl) && ldl >= 160) || (Number.isFinite(tg) && tg >= 200) || (Number.isFinite(tc) && tc >= 240)) tone = 'bad';
      else if ((Number.isFinite(ldl) && ldl >= 130) || (Number.isFinite(tg) && tg >= 150) || (Number.isFinite(tc) && tc >= 200) || (Number.isFinite(hdl) && hdl < 40)) tone = 'warn';
      else tone = 'good';

      sections.push(row('Ú†Ø±Ø¨ÛŒ Ø®ÙˆÙ†', msgs || 'â€”', tone));
    }

    // ---- Blood Pressure ----
    if (Number.isFinite(sys) && Number.isFinite(dia)) {
      const bp = `${toPersianNum(sys)}/${toPersianNum(dia)}`;
      let tone = 'good';
      let msg = `${bp} Ø·Ø¨ÛŒØ¹ÛŒ Ø§Ø³Øª.`;
      if (sys < 120 && dia < 80) { tone='good'; msg = `${bp} Ø·Ø¨ÛŒØ¹ÛŒ Ø§Ø³Øª.`; }
      else if (sys < 130 && dia < 80) { tone='warn'; msg = `${bp} Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø­Ø§Ù„Øª Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ (Elevated).`; }
      else if (sys < 140 || dia < 90) { tone='warn'; msg = `${bp} Ù…Ø±Ø­Ù„Ù‡ Û±. Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`; }
      else { tone='bad'; msg = `${bp} Ù…Ø±Ø­Ù„Ù‡ Û². Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø¨Ø§ Ù¾Ø²Ø´Ú© Ù…Ø´ÙˆØ±Øª Ú©Ù†ÛŒØ¯.`; }
      sections.push(row('ÙØ´Ø§Ø± Ø®ÙˆÙ†', msg, tone));
    }

    // ---- Kidney (Creatinine) ----
    if (Number.isFinite(cr)) {
      // Ù…Ø­Ø¯ÙˆØ¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø¬Ù†Ø³/Ø¹Ø¶Ù„Ù‡ ÙˆØ§Ø¨Ø³ØªÙ‡ Ø§Ø³ØªØ› Ø§ÛŒÙ†Ø¬Ø§ ÙÙ‚Ø· Ù‡Ø´Ø¯Ø§Ø± Ø¹Ù…ÙˆÙ…ÛŒ
      let tone='good', msg=`Ú©Ø±Ø§ØªÛŒÙ†ÛŒÙ† ${toPersianNum(cr.toFixed(2))} mg/dL.`;
      if (cr < 0.6) { tone='warn'; msg += ' Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¹Ù…ÙˆÙ„ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø§ ØªÙˆØ¯Ù‡ Ø¹Ø¶Ù„Ø§Ù†ÛŒ Ú©Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ø´Ø¯).'; }
      else if (cr > 1.3) { tone='warn'; msg += ' Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¹Ù…ÙˆÙ„ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ù„ÛŒÙ‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯).'; }
      sections.push(row('Ú©Ù„ÛŒÙ‡ (Ú©Ø±Ø§ØªÛŒÙ†ÛŒÙ†)', msg, tone));
    }

    // ---- Liver enzymes ----
    if (Number.isFinite(alt) || Number.isFinite(ast)) {
      let msg = '';
      const hiALT = Number.isFinite(alt) && alt > 40;
      const hiAST = Number.isFinite(ast) && ast > 40;
      if (Number.isFinite(alt)) msg += `â€¢ ALT ${toPersianNum(alt)} IU/L ${hiALT ? '(Ø¨Ø§Ù„Ø§)' : '(Ø·Ø¨ÛŒØ¹ÛŒ)'}<br>`;
      if (Number.isFinite(ast)) msg += `â€¢ AST ${toPersianNum(ast)} IU/L ${hiAST ? '(Ø¨Ø§Ù„Ø§)' : '(Ø·Ø¨ÛŒØ¹ÛŒ)'}<br>`;
      const tone = (hiALT || hiAST) ? 'warn' : 'good';
      sections.push(row('Ú©Ø¨Ø¯ (ALT/AST)', msg || 'â€”', tone));
    }

    // ---- Thyroid ----
    if (Number.isFinite(tsh)) {
      let tone='good', msg=`TSH ${toPersianNum(tsh.toFixed(2))} ÂµIU/mL.`;
      if (tsh < 0.4) { tone='warn'; msg += ' Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¹Ù…ÙˆÙ„ (Ø§Ø­ØªÙ…Ø§Ù„ Ù¾Ø±Ú©Ø§Ø±ÛŒ).'; }
      else if (tsh > 4.5) { tone='warn'; msg += ' Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¹Ù…ÙˆÙ„ (Ø§Ø­ØªÙ…Ø§Ù„ Ú©Ù…â€ŒÚ©Ø§Ø±ÛŒ).'; }
      sections.push(row('ØªÛŒØ±ÙˆØ¦ÛŒØ¯ (TSH)', msg, tone));
    }

    // ---- Vitamin D ----
    if (Number.isFinite(vitd)) {
      let tone='good', msg=`ÙˆÛŒØªØ§Ù…ÛŒÙ† D ${toPersianNum(vitd)} ng/mL.`;
      if (vitd < 20) { tone='bad'; msg += ' Ú©Ù…Ø¨ÙˆØ¯.'; }
      else if (vitd < 30) { tone='warn'; msg += ' Ù†Ø§Ú©Ø§ÙÛŒ.'; }
      else msg += ' Ù…Ù†Ø§Ø³Ø¨.';
      sections.push(row('ÙˆÛŒØªØ§Ù…ÛŒÙ† D', msg, tone));
    }

    if (sections.length === 0) {
      out.innerHTML = '<div class="text-gray-300">Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>';
      out.classList.remove('hidden');
      return;
    }

    // ---- General recommendations (context-free) ----
    const advice = `
      <div class="mt-3 pt-3 border-t border-white/10 text-xs text-gray-300 leading-relaxed">
        <div class="font-bold mb-1">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ (ØºÛŒØ±ØªØ¬ÙˆÛŒØ²ÛŒ):</div>
        <div>â€¢ Û±ÛµÛ° Ø¯Ù‚ÛŒÙ‚Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ù‡ÙˆØ§Ø²ÛŒ Ø¯Ø± Ù‡ÙØªÙ‡ + Û² Ø¬Ù„Ø³Ù‡ ØªÙ…Ø±ÛŒÙ† Ù‚Ø¯Ø±ØªÛŒ</div>
        <div>â€¢ Ú©Ø§Ù‡Ø´ Ù‚Ù†Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡ØŒ Ù†ÙˆØ´ÛŒØ¯Ù†ÛŒ Ø´ÛŒØ±ÛŒÙ†ØŒ Ú†Ø±Ø¨ÛŒ ØªØ±Ø§Ù†Ø³Ø› Ø§ÙØ²Ø§ÛŒØ´ ÙÛŒØ¨Ø± (Ø³Ø¨Ø²ÛŒ/Ø­Ø¨ÙˆØ¨Ø§Øª)</div>
        <div>â€¢ Ø®ÙˆØ§Ø¨ Û·-Û¸ Ø³Ø§Ø¹Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ±Ø³</div>
        <div>â€¢ Ø§Ú¯Ø± Ø¹Ø¯Ø¯Ù‡Ø§ Ø®ÛŒÙ„ÛŒ Ø¨Ø§Ù„Ø§/ØºÛŒØ±Ø·Ø¨ÛŒØ¹ÛŒ Ù‡Ø³ØªÙ†Ø¯ ÛŒØ§ Ø¹Ù„Ø§Ø¦Ù… Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø²Ø´Ú©ÛŒ Ù„Ø§Ø²Ù… Ø§Ø³Øª</div>
      </div>
    `;

    out.innerHTML = sections.join('') + advice;
    out.classList.remove('hidden');
  }


  // ===================== ELEMENT SDK (unchanged) =====================
  const defaultConfig = { site_title: 'Codeisa' };
  let config = { ...defaultConfig };

  async function onConfigChange(newConfig) {
    config = { ...config, ...newConfig };
    const titleEl = document.getElementById('site-title');
    if (titleEl) titleEl.textContent = config.site_title || defaultConfig.site_title;
    document.title = config.site_title || defaultConfig.site_title;
  }

  function mapToCapabilities(config) {
    return { recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined };
  }

  function mapToEditPanelValues(config) {
    return new Map([['site_title', config.site_title || defaultConfig.site_title]]);
  }

  if (window.elementSdk) {
    window.elementSdk.init({ defaultConfig, onConfigChange, mapToCapabilities, mapToEditPanelValues });
  }


  // =========================
  // =========================
// Banking (Loan / Deposit / Card)
// =========================
let bankingInited = false;

function initBanking() {
  if (bankingInited) return;
  bankingInited = true;

  const tabLoan = document.getElementById('banking-tab-loan');
  const tabDeposit = document.getElementById('banking-tab-deposit');
  const tabCard = document.getElementById('banking-tab-card');

  const loanPanel = document.getElementById('loan-panel');
  const depositPanel = document.getElementById('deposit-panel');
  const cardPanel = document.getElementById('card-panel');

  function activate(which) {
    const on = (btn, yes) => btn && btn.classList.toggle('active', !!yes);
    on(tabLoan, which === 'loan');
    on(tabDeposit, which === 'deposit');
    on(tabCard, which === 'card');

    loanPanel.classList.toggle('hidden', which !== 'loan');
    depositPanel.classList.toggle('hidden', which !== 'deposit');
    cardPanel.classList.toggle('hidden', which !== 'card');
  }

  tabLoan?.addEventListener('click', () => activate('loan'));
  tabDeposit?.addEventListener('click', () => activate('deposit'));
  tabCard?.addEventListener('click', () => activate('card'));

  renderLoanForm();
  renderDepositForm();
  renderCardForm();
  activate('loan');
}

// --- helpers (digits + parsing + UI boxes) ---
function toEnglishDigits(str){
  str = String(str ?? '');
  return str
    .replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d))
    .replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d))
    .replace(/[Ù¬ØŒ]/g, ',');
}

function nval(id){
  const el = document.getElementById(id);
  if(!el) return NaN;
  const raw = toEnglishDigits(el.value ?? '').replace(/,/g,'').trim();
  const n = parseFloat(raw);
  return Number.isFinite(n) ? n : NaN;
}

function showBox(id, htmlStr){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = htmlStr;
  el.classList.remove('hidden');
}

function hideBox(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.add('hidden');
  el.innerHTML = '';
}

// --- Loan UI ---
function renderLoanForm() {
  const t = document.getElementById('loan-type').value;
  const wrap = document.getElementById('loan-form');
  hideBox('loan-result');

  if (t === 'payment') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label><input id="loan-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 200,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="loan-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 18"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ù…Ø§Ù‡)</label><input id="loan-n" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 36"></div>
      </div>
    `;
    return;
  }

  if (t === 'compare') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label><input id="loan-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 200,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ù…Ø§Ù‡)</label><input id="loan-n" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 36"></div>
        <div class="text-[11px] text-gray-400 flex items-end">Ø¯Ùˆ Ù†Ø±Ø® Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ú©Ù„ Ø³ÙˆØ¯/Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø´ÙˆØ¯.</div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ø¨Ø§Ù†Ú© A - Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="loan-ra" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 18"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ø¨Ø§Ù†Ú© B - Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="loan-rb" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 20"></div>
      </div>
    `;
    return;
  }

  if (t === 'penalty') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº Ù‚Ø³Ø·/Ø¨Ø¯Ù‡ÛŒ (ØªÙˆÙ…Ø§Ù†)</label><input id="pen-amt" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 7,500,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ø±ÙˆØ²Ù‡Ø§ÛŒ ØªØ£Ø®ÛŒØ±</label><input id="pen-days" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 12"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ø¬Ø±ÛŒÙ…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ (%)</label><input id="pen-rate" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 0.2"></div>
      </div>
      <div class="text-[11px] text-gray-400">* ÙØ±Ù…ÙˆÙ„: Ù…Ø¨Ù„Øº Ã— (Ø¬Ø±ÛŒÙ…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡/100) Ã— Ø±ÙˆØ²Ù‡Ø§ÛŒ ØªØ£Ø®ÛŒØ±</div>
    `;
    return;
  }

  if (t === 'grace') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label><input id="loan-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 200,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="loan-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 18"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª Ú©Ù„ (Ù…Ø§Ù‡)</label><input id="loan-n" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 36"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ†ÙØ³</label><input id="loan-gm" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 6"></div>
      </div>
      <div class="text-[11px] text-gray-400">Ø¯Ø± Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ†ÙØ³ ÙÙ‚Ø· Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø§ØµÙ„ Ø«Ø§Ø¨Øª Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ø› Ø³Ù¾Ø³ Ø§Ù‚Ø³Ø§Ø· Ø¹Ø§Ø¯ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    `;
    return;
  }

  if (t === 'irregular') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label><input id="loan-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 200,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="loan-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 18"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ù…Ø§Ù‡)</label><input id="loan-n" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 36"></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="irr-pre" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 20,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø¶Ø§ÙÙ‡ Ø¯Ø± Ù…Ø§Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="irr-month" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 5"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø¶Ø§ÙÙ‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="irr-extra" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 10,000,000"><div class="money-words"></div></div>
      </div>
      <div class="text-[11px] text-gray-400">Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ§Ù… Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø¶Ø§ÙÙ‡ Ø¨Ø§Ø¹Ø« Ú©Ø§Ù‡Ø´ Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ Ùˆ Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ø´Ø¯Ù† Ù…Ø¯Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    `;
    return;
  }

  if (t === 'rate') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label><input id="loan-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 200,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†)</label><input id="loan-a" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 7,500,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ù…Ø§Ù‡)</label><input id="loan-n" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 36"></div>
      </div>
    `;
    return;
  }

  if (t === 'early') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label><input id="loan-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 200,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="loan-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 18"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª Ú©Ù„ (Ù…Ø§Ù‡)</label><input id="loan-n" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 36"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ú†Ù†Ø¯ Ù‚Ø³Ø· Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ØŸ</label><input id="loan-m" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 10"></div>
      </div>
    `;
    return;
  }

  if (t === 'qard') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label><input id="loan-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 200,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ù…Ø§Ù‡)</label><input id="loan-n" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 36"></div>
      </div>
    `;
    return;
  }

  // step
  wrap.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
      <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº ÙˆØ§Ù… (ØªÙˆÙ…Ø§Ù†)</label><input id="loan-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 200,000,000"><div class="money-words"></div></div>
      <div><label class="block text-sm text-gray-300 mb-1">Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="loan-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 18"></div>
      <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ù…Ø§Ù‡)</label><input id="loan-n" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 36"></div>
      <div><label class="block text-sm text-gray-300 mb-1">Ø±Ø´Ø¯ Ø³Ø§Ù„Ø§Ù†Ù‡ Ù‚Ø³Ø· (%)</label><input id="loan-g" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 10"></div>
    </div>
    <div class="text-[11px] text-gray-400">Ù¾Ù„Ú©Ø§Ù†ÛŒ: Ù‚Ø³Ø· Ù‡Ø± Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¯Ø±ØµØ¯ Ù…Ø´Ø®Øµ Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯ (Ù‡Ø± 12 Ù…Ø§Ù‡).</div>
  `;
}

function calculateLoan() {
  const t = document.getElementById('loan-type').value;
  const resId = 'loan-result';

  // Helper: amort table + charts + smart analysis
  const renderFullLoanOutput = (title, P, schedule, extraHtml='') => {
    const totalPay = schedule.reduce((s,x)=>s + x.payment, 0);
    const totalInt = schedule.reduce((s,x)=>s + x.interest, 0);
    const totalPrn = schedule.reduce((s,x)=>s + x.principal, 0);
    const interestShare = totalPay > 0 ? (totalInt/totalPay) : 0;
    const suggestion = (() => {
      if (!Number.isFinite(interestShare)) return '';
      if (interestShare >= 0.42) return 'Ø¯Ø± Ø§ÛŒÙ† ÙˆØ§Ù… Ø¯Ø±ØµØ¯ Ø³ÙˆØ¯ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø¨Ø§Ù„Ø§Ø³Øª. Ø§Ú¯Ø± Ø§Ù…Ú©Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ Ù…Ø¯Øª ÙˆØ§Ù… Ø±Ø§ Ú©Ø§Ù‡Ø´ Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ø¨Ø®Ø´ÛŒ Ø±Ø§ Ø²ÙˆØ¯ØªØ± ØªØ³ÙˆÛŒÙ‡ Ú©Ù†ÛŒØ¯.';
      if (interestShare >= 0.30) return 'Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ Ø³ÙˆØ¯ Ú©Ù„ØŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø¶Ø§ÙÙ‡ Ø¯Ø± Ú†Ù†Ø¯ Ù…Ø§Ù‡ Ø§ÙˆÙ„ ÛŒØ§ Ú©Ø§Ù‡Ø´ Ù…Ø¯Øª ÙˆØ§Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…ÙˆØ«Ø± Ø¨Ø§Ø´Ø¯.';
      return 'Ø³Ù‡Ù… Ø³ÙˆØ¯ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ù…Ø¹Ù‚ÙˆÙ„â€ŒØªØ±ÛŒ Ø§Ø³ØªØ› Ø§Ú¯Ø± Ù‡Ø¯Ù Ú©Ø§Ù‡Ø´ Ø³ÙˆØ¯ Ú©Ù„ Ø§Ø³ØªØŒ ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¨ØªØ¯Ø§ÛŒÛŒ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ø«Ø± Ø±Ø§ Ø¯Ø§Ø±Ø¯.';
    })();

    const tableHtml = buildAmortTable(schedule);
    __lastLoanSchedule = schedule;
    __lastLoanMeta = { totalPay, totalInt, totalPrn, title };
    const chartsHtml = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
        <div class="glass rounded-xl p-2">
          <div class="text-xs text-gray-300 mb-2">Ù†Ù…ÙˆØ¯Ø§Ø± Ú©Ø§Ù‡Ø´ Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ</div>
          <canvas id="loan-chart-balance" height="140"></canvas>
        </div>
        <div class="glass rounded-xl p-2">
          <div class="text-xs text-gray-300 mb-2">Ø³Ù‡Ù… Ø³ÙˆØ¯ vs Ø§ØµÙ„ (Ø¬Ù…Ø¹ Ú©Ù„)</div>
          <canvas id="loan-chart-split" height="140"></canvas>
        </div>
      </div>
    `;

    showBox(resId, `
      <div class="font-semibold mb-2">${title}</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ú©Ù„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª: <span class="font-bold">${formatNumber(totalPay)} ØªÙˆÙ…Ø§Ù†</span></div>
        
      <div class="table-actions no-print mt-2">
        <button class="btn-mini" onclick="exportLoanCSV()">â¬‡ï¸ Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ (CSV)</button>
        <button class="btn-mini" onclick="exportLoanPDF()">ğŸ§¾ Ø®Ø±ÙˆØ¬ÛŒ PDF / Ú†Ø§Ù¾</button>
        <span class="text-[11px] text-gray-400">ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙˆÙ„: ØªÙˆÙ…Ø§Ù†</span>
      </div>
<div class="glass rounded-xl p-2">Ú©Ù„ Ø³ÙˆØ¯: <span class="font-bold">${formatNumber(totalInt)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ù…Ø¯Øª ÙˆØ§Ù‚Ø¹ÛŒ: <span class="font-bold">${toPersianNum(schedule.length)} Ù…Ø§Ù‡</span></div>
      </div>
      ${extraHtml}
      <div class="mt-3">
        <div class="text-sm font-bold mb-2">Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ø³Ø§Ø· (Amortization)</div>
        ${tableHtml}
      </div>
      ${chartsHtml}
      <div class="mt-3 glass rounded-xl p-2">
        <div class="text-xs text-gray-300 mb-1">ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯</div>
        <div class="text-sm">${toPersianNum(Math.round(interestShare*100))}% Ø§Ø² Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ Ø³ÙˆØ¯ Ø§Ø³Øª. ${suggestion}</div>
      </div>
    `);

    // charts
    setTimeout(()=>renderLoanCharts(schedule, totalInt, totalPrn), 50);
  };

  if (t === 'payment') {
    const P = nval('loan-p'), R = nval('loan-r'), N = nval('loan-n');
    if (!(P > 0 && R >= 0 && N > 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const A = calcAnnuityPayment(P, R, N);
    const schedule = buildAmortSchedule({P, annualRate:R, nMonths:N, payment:A});
    return renderFullLoanOutput('Ù†ØªÛŒØ¬Ù‡ ÙˆØ§Ù…', P, schedule, `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
        <div class="glass rounded-xl p-2">Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡: <span class="font-bold">${formatNumber(A)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ù†Ø±Ø® Ù…Ø§Ù‡Ø§Ù†Ù‡: <span class="font-bold">${formatNumber((R/12), 3)}%</span></div>
        <div class="glass rounded-xl p-2">Ø§ØµÙ„ ÙˆØ§Ù…: <span class="font-bold">${formatNumber(P)} ØªÙˆÙ…Ø§Ù†</span></div>
      </div>
    `);
  }

  if (t === 'compare') {
    const P = nval('loan-p'), N = nval('loan-n'), RA = nval('loan-ra'), RB = nval('loan-rb');
    if (!(P > 0 && N > 0 && RA >= 0 && RB >= 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const A1 = calcAnnuityPayment(P, RA, N);
    const A2 = calcAnnuityPayment(P, RB, N);
    const tot1 = A1*N, tot2 = A2*N;
    const int1 = tot1 - P, int2 = tot2 - P;
    const better = tot1 < tot2 ? 'Ø¨Ø§Ù†Ú© A' : (tot2 < tot1 ? 'Ø¨Ø§Ù†Ú© B' : 'Ù‡Ø± Ø¯Ùˆ ÛŒÚ©Ø³Ø§Ù†');
    return showBox(resId, `
      <div class="font-semibold mb-2">Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¯Ùˆ ÙˆØ§Ù…</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div class="glass rounded-xl p-2">
          <div class="font-bold mb-1">Ø¨Ø§Ù†Ú© A</div>
          <div class="text-sm">Ù‚Ø³Ø·: <span class="font-semibold">${formatNumber(A1)} ØªÙˆÙ…Ø§Ù†</span></div>
          <div class="text-sm">Ú©Ù„ Ø³ÙˆØ¯: <span class="font-semibold">${formatNumber(int1)} ØªÙˆÙ…Ø§Ù†</span></div>
          <div class="text-sm">Ú©Ù„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª: <span class="font-semibold">${formatNumber(tot1)} ØªÙˆÙ…Ø§Ù†</span></div>
        </div>
        <div class="glass rounded-xl p-2">
          <div class="font-bold mb-1">Ø¨Ø§Ù†Ú© B</div>
          <div class="text-sm">Ù‚Ø³Ø·: <span class="font-semibold">${formatNumber(A2)} ØªÙˆÙ…Ø§Ù†</span></div>
          <div class="text-sm">Ú©Ù„ Ø³ÙˆØ¯: <span class="font-semibold">${formatNumber(int2)} ØªÙˆÙ…Ø§Ù†</span></div>
          <div class="text-sm">Ú©Ù„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª: <span class="font-semibold">${formatNumber(tot2)} ØªÙˆÙ…Ø§Ù†</span></div>
        </div>
      </div>
      <div class="mt-2 glass rounded-xl p-2">Ø¨Ù‡â€ŒØµØ±ÙÙ‡â€ŒØªØ±: <span class="font-bold">${better}</span></div>
    `);
  }

  if (t === 'penalty') {
    const amt = nval('pen-amt'), days = nval('pen-days'), rate = nval('pen-rate');
    if (!(amt > 0 && days >= 0 && rate >= 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const extra = amt * (rate/100) * days;
    return showBox(resId, `
      <div class="font-semibold mb-2">Ø¬Ø±ÛŒÙ…Ù‡ Ø¯ÛŒØ±Ú©Ø±Ø¯</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ù…Ø¨Ù„Øº Ø¬Ø±ÛŒÙ…Ù‡: <span class="font-bold">${formatNumber(extra)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ø¬Ù…Ø¹ Ø¨Ø¯Ù‡ÛŒ: <span class="font-bold">${formatNumber(amt + extra)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ø±ÙˆØ²Ù‡Ø§ÛŒ ØªØ£Ø®ÛŒØ±: <span class="font-bold">${toPersianNum(days)}</span></div>
      </div>
    `);
  }

  if (t === 'grace') {
    const P = nval('loan-p'), R = nval('loan-r'), N = nval('loan-n'), gm = nval('loan-gm');
    if (!(P > 0 && R >= 0 && N > 0 && gm >= 0 && gm < N)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const A = calcAnnuityPayment(P, R, N - gm);
    const schedule = buildAmortSchedule({P, annualRate:R, nMonths:N, payment:A, graceMonths:gm});
    return renderFullLoanOutput('ÙˆØ§Ù… Ø¨Ø§ ØªÙ†ÙØ³', P, schedule, `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
        <div class="glass rounded-xl p-2">Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ†ÙØ³: <span class="font-bold">${toPersianNum(gm)} Ù…Ø§Ù‡</span></div>
        <div class="glass rounded-xl p-2">Ù‚Ø³Ø· Ù¾Ø³ Ø§Ø² ØªÙ†ÙØ³: <span class="font-bold">${formatNumber(A)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡: <span class="font-bold">${formatNumber(R,2)}%</span></div>
      </div>
    `);
  }

  if (t === 'irregular') {
    const P0 = nval('loan-p'), R = nval('loan-r'), N = nval('loan-n');
    const pre = nval('irr-pre') || 0;
    const mth = nval('irr-month');
    const extra = nval('irr-extra') || 0;
    if (!(P0 > 0 && R >= 0 && N > 0 && pre >= 0 && extra >= 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const P = Math.max(0, P0 - pre);
    if (!(P > 0)) return showBox(resId, "Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Ù†Ø¨Ø§ÛŒØ¯ Ø§Ø² Ù…Ø¨Ù„Øº ÙˆØ§Ù… Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ø¯.");
    const A = calcAnnuityPayment(P0, R, N); // payment based on original loan (as user expects)
    const extras = {};
    if (Number.isFinite(mth) && mth >= 1 && mth <= N && extra > 0) extras[Math.round(mth)] = extra;
    const schedule = buildAmortSchedule({P, annualRate:R, nMonths:N, payment:A, extras});
    return renderFullLoanOutput('ÙˆØ§Ù… Ø¨Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…Ù†Ø¸Ù…', P, schedule, `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
        <div class="glass rounded-xl p-2">Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª: <span class="font-bold">${formatNumber(pre)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ù‚Ø³Ø· Ø«Ø§Ø¨Øª: <span class="font-bold">${formatNumber(A)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø¶Ø§ÙÙ‡: <span class="font-bold">${(extra>0 && Number.isFinite(mth)) ? (formatNumber(extra)+' ØªÙˆÙ…Ø§Ù† Ø¯Ø± Ù…Ø§Ù‡ '+toPersianNum(Math.round(mth))) : 'â€”'}</span></div>
      </div>
    `);
  }

  if (t === 'rate') {
    const P = nval('loan-p'), A = nval('loan-a'), N = nval('loan-n');
    if (!(P > 0 && A > 0 && N > 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const r = solveMonthlyRate(P, A, N);
    if (!isFinite(r)) return showBox(resId, "Ø¨Ø§ Ø§ÛŒÙ† Ù…Ù‚Ø§Ø¯ÛŒØ±ØŒ Ù†Ø±Ø® Ù‚Ø§Ø¨Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†ÛŒØ³Øª. (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù‚Ø³Ø· Ø®ÛŒÙ„ÛŒ Ú©Ù…/Ø²ÛŒØ§Ø¯ Ø¨Ø§Ø´Ø¯)");
    const annual = r * 12 * 100;
    const total = A * N;
    const interest = total - P;
    return showBox(resId, `
      <div class="font-semibold mb-2">Ù†ØªÛŒØ¬Ù‡ Ù†Ø±Ø® Ø³ÙˆØ¯</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ù†Ø±Ø® Ù…Ø§Ù‡Ø§Ù†Ù‡: <span class="font-bold">${formatNumber(r*100, 3)}%</span></div>
        <div class="glass rounded-xl p-2">Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ: <span class="font-bold">${formatNumber(annual, 2)}%</span></div>
        <div class="glass rounded-xl p-2">Ú©Ù„ Ø³ÙˆØ¯: <span class="font-bold">${formatNumber(interest)} ØªÙˆÙ…Ø§Ù†</span></div>
      </div>
    `);
  }

  if (t === 'early') {
    const P = nval('loan-p'), R = nval('loan-r'), N = nval('loan-n'), M = nval('loan-m');
    if (!(P > 0 && R >= 0 && N > 0 && M >= 0 && M <= N)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const A = calcAnnuityPayment(P, R, N);
    const bal = remainingBalance(P, R, N, M);
    const schedule = buildAmortSchedule({P, annualRate:R, nMonths:M, payment:A}); // paid part
    return showBox(resId, `
      <div class="font-semibold mb-2">ØªØ³ÙˆÛŒÙ‡ Ù¾ÛŒØ´ Ø§Ø² Ù…ÙˆØ¹Ø¯</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡: <span class="font-bold">${formatNumber(A)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ Ù¾Ø³ Ø§Ø² ${toPersianNum(M)} Ù‚Ø³Ø·: <span class="font-bold">${formatNumber(Math.max(0, bal))} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ø§Ù‚Ø³Ø§Ø· Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡: <span class="font-bold">${toPersianNum(N - M)} Ù…Ø§Ù‡</span></div>
      </div>
      <div class="mt-2"><div class="text-sm font-bold mb-2">Ø¬Ø¯ÙˆÙ„ Ø§Ù‚Ø³Ø§Ø· Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡ (ØªØ§ Ù…Ø§Ù‡ ${toPersianNum(M)})</div>${buildAmortTable(schedule)}</div>
      <div class="text-[11px] text-gray-400 mt-2">* Ø¬Ø±ÛŒÙ…Ù‡/Ú©Ø§Ø±Ù…Ø²Ø¯ ØªØ³ÙˆÛŒÙ‡ (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯) ØªÙˆØ³Ø· Ø¨Ø§Ù†Ú© ØªØ¹ÛŒÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù„Ø­Ø§Ø¸ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
    `);
  }

  if (t === 'qard') {
    const P = nval('loan-p'), N = nval('loan-n');
    if (!(P > 0 && N > 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const A = P / N;
    const schedule = buildAmortSchedule({P, annualRate:0, nMonths:N, payment:A});
    return renderFullLoanOutput('Ù‚Ø±Ø¶â€ŒØ§Ù„Ø­Ø³Ù†Ù‡', P, schedule, `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
        <div class="glass rounded-xl p-2">Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡: <span class="font-bold">${formatNumber(A)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ú©Ù„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª: <span class="font-bold">${formatNumber(P)} ØªÙˆÙ…Ø§Ù†</span></div>
      </div>
    `);
  }

  // step
  const P = nval('loan-p'), R = nval('loan-r'), N = nval('loan-n'), G = nval('loan-g');
  if (!(P > 0 && R >= 0 && N > 0 && G >= 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
  const s = calcStepLoan(P, R, N, G);
  return showBox(resId, `
    <div class="font-semibold mb-2">ÙˆØ§Ù… Ù¾Ù„Ú©Ø§Ù†ÛŒ</div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
      <div class="glass rounded-xl p-2">Ù‚Ø³Ø· Ø³Ø§Ù„ Ø§ÙˆÙ„ (Ù…Ø§Ù‡Ø§Ù†Ù‡): <span class="font-bold">${formatNumber(s.A0)} ØªÙˆÙ…Ø§Ù†</span></div>
      <div class="glass rounded-xl p-2">Ù‚Ø³Ø· Ø³Ø§Ù„ Ø¢Ø®Ø± (Ù…Ø§Ù‡Ø§Ù†Ù‡): <span class="font-bold">${formatNumber(s.last)} ØªÙˆÙ…Ø§Ù†</span></div>
      <div class="glass rounded-xl p-2">Ú©Ù„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª: <span class="font-bold">${formatNumber(s.total)} ØªÙˆÙ…Ø§Ù†</span></div>
      <div class="glass rounded-xl p-2">Ú©Ù„ Ø³ÙˆØ¯: <span class="font-bold">${formatNumber(s.interest)} ØªÙˆÙ…Ø§Ù†</span></div>
    </div>
  `);
}

// --- Deposit UI ---
function renderDepositForm() {
  const t = document.getElementById('deposit-type').value;
  const wrap = document.getElementById('deposit-form');
  hideBox('deposit-result');

  if (t === 'interest') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº Ø³Ù¾Ø±Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†)</label><input id="dep-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 100,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="dep-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 20"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ø±ÙˆØ²)</label><input id="dep-d" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 365"></div>
      </div>
    `;
    return;
  }

  if (t === 'compound') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)</label><input id="cmp-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 100,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="cmp-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 20"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ø³Ø§Ù„)</label><input id="cmp-y" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 5"></div>
        <div>
          <label class="block text-sm text-gray-300 mb-1">Ù†ÙˆØ¹ Ù…Ø±Ú©Ø¨</label>
          <select id="cmp-f" class="w-full input">
            <option value="365">Ø±ÙˆØ²Ø§Ù†Ù‡</option>
            <option value="12">Ù…Ø§Ù‡Ø§Ù†Ù‡</option>
            <option value="1">Ø³Ø§Ù„Ø§Ù†Ù‡</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="cmp-c" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 2,000,000"><div class="money-words"></div></div>
        <div class="text-[11px] text-gray-400 flex items-end">Ø§Ú¯Ø± ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø±Ø§ ØµÙØ± Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ØŒ ÙÙ‚Ø· Ø±ÙˆÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
      </div>
    `;
    return;
  }

  if (t === 'fv') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº Ø§Ù…Ø±ÙˆØ² (ØªÙˆÙ…Ø§Ù†)</label><input id="fv-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 100,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="fv-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 20"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ø³Ø§Ù„)</label><input id="fv-y" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 5"></div>
        <div>
          <label class="block text-sm text-gray-300 mb-1">ØªØ±Ú©ÛŒØ¨</label>
          <select id="fv-f" class="w-full input">
            <option value="12">Ù…Ø§Ù‡Ø§Ù†Ù‡</option>
            <option value="365">Ø±ÙˆØ²Ø§Ù†Ù‡</option>
            <option value="1">Ø³Ø§Ù„Ø§Ù†Ù‡</option>
          </select>
        </div>
      </div>
    `;
    return;
  }

  if (t === 'pv') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº Ø¢ÛŒÙ†Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†)</label><input id="pv-fv" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 500,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="pv-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 20"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ø³Ø§Ù„)</label><input id="pv-y" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 5"></div>
        <div>
          <label class="block text-sm text-gray-300 mb-1">ØªØ±Ú©ÛŒØ¨</label>
          <select id="pv-f" class="w-full input">
            <option value="12">Ù…Ø§Ù‡Ø§Ù†Ù‡</option>
            <option value="365">Ø±ÙˆØ²Ø§Ù†Ù‡</option>
            <option value="1">Ø³Ø§Ù„Ø§Ù†Ù‡</option>
          </select>
        </div>
      </div>
    `;
    return;
  }

  if (t === 'inflation') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</label><input id="inf-amt" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 100,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">ØªÙˆØ±Ù… Ø³Ø§Ù„Ø§Ù†Ù‡ (%)</label><input id="inf-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 40"></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ø³Ø§Ù„)</label><input id="inf-y" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 3"></div>
      </div>
      <div class="text-[11px] text-gray-400">Ø§Ø±Ø²Ø´ ÙˆØ§Ù‚Ø¹ÛŒ = Ù…Ø¨Ù„Øº Ã· (1 + ØªÙˆØ±Ù…) ^ Ø³Ø§Ù„</div>
    `;
    return;
  }

  // rate (simple)
  wrap.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
      <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº Ø³Ù¾Ø±Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†)</label><input id="dep-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 100,000,000"><div class="money-words"></div></div>
      <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¨Ù„Øº Ø³ÙˆØ¯ (ØªÙˆÙ…Ø§Ù†)</label><input id="dep-i" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 20,000,000"><div class="money-words"></div></div>
      <div><label class="block text-sm text-gray-300 mb-1">Ù…Ø¯Øª (Ø±ÙˆØ²)</label><input id="dep-d" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 365"></div>
    </div>
  `;
}

function calculateDeposit() {
  const t = document.getElementById('deposit-type').value;
  const resId = 'deposit-result';

  if (t === 'interest') {
    const P = nval('dep-p'), R = nval('dep-r'), D = nval('dep-d');
    if (!(P > 0 && R >= 0 && D > 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const I = P * (R/100) * (D/365);
    showBox(resId, `
      <div class="font-semibold mb-2">Ø³ÙˆØ¯ Ø³Ù¾Ø±Ø¯Ù‡ (Ø³Ø§Ø¯Ù‡)</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ø³ÙˆØ¯: <span class="font-bold">${formatNumber(I)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: <span class="font-bold">${formatNumber(P+I)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ø³ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡: <span class="font-bold">${formatNumber(I/D)} ØªÙˆÙ…Ø§Ù†</span></div>
      </div>
    `);
    try{ document.getElementById('deposit-charts')?.classList.add('hidden'); }catch{};
    try{ document.getElementById('card-charts')?.classList.remove('hidden'); }catch{}
    return;

  }

  if (t === 'compound') {
    const P = nval('cmp-p'), R = nval('cmp-r'), Y = nval('cmp-y');
    const m = parseInt(document.getElementById('cmp-f')?.value || '12',10);
    const c = nval('cmp-c') || 0;
    if (!(P >= 0 && R >= 0 && Y > 0 && m > 0 && c >= 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const r = (R/100);
    const n = m * Y;
    const fvLump = P * Math.pow(1 + r/m, n);
    // monthly contribution: assume contribution frequency matches monthly (12) regardless of m
    const fvCont = c > 0 ? compoundFutureValueAnnuity(c, R, Y) : 0;
    const FV = fvLump + fvCont;
    showBox(resId, `
      <div class="font-semibold mb-2">Ø³ÙˆØ¯ Ù…Ø±Ú©Ø¨ ÙˆØ§Ù‚Ø¹ÛŒ</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ø§Ø±Ø²Ø´ Ù†Ù‡Ø§ÛŒÛŒ: <span class="font-bold">${formatNumber(FV)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ø³ÙˆØ¯ Ú©Ù„: <span class="font-bold">${formatNumber(FV - P - (c>0 ? (c*12*Y) : 0))} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ù†ÙˆØ¹ Ù…Ø±Ú©Ø¨: <span class="font-bold">${m===365?'Ø±ÙˆØ²Ø§Ù†Ù‡':(m===12?'Ù…Ø§Ù‡Ø§Ù†Ù‡':'Ø³Ø§Ù„Ø§Ù†Ù‡')}</span></div>
      </div>
      <div class="text-[11px] text-gray-400 mt-2">* ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø§ ÙØ±Ø¶ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø± Ù¾Ø§ÛŒØ§Ù† Ù‡Ø± Ù…Ø§Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
    `);
    try{ document.getElementById('deposit-charts')?.classList.remove('hidden'); }catch{}

    const labels = Array.from({length: Math.round(Y*12)+1}, (_,i)=> toPersianNum(i)+' Ù…Ø§Ù‡');
    const values = labels.map((_,i)=>{
      // approximate monthly compounding for chart (independent of m)
      const rM = (R/100)/12;
      let v = P * Math.pow(1+rM, i);
      if (c>0){
        if (Math.abs(rM) < 1e-12) v += c*i;
        else v += c * ((Math.pow(1+rM, i)-1)/rM);
      }
      return Math.round(v);
    });
    renderDepositChart(labels, values, 'ØªÙˆÙ…Ø§Ù†');
    __lastDepositSeries = values.map((v,i)=>[i, v]);
    __lastDepositMeta = { headers:['Ù…Ø§Ù‡','Ø§Ø±Ø²Ø´ (ØªÙˆÙ…Ø§Ù†)'], filename:'compound_interest.csv' };

    return;

  }

  if (t === 'fv') {
    const P = nval('fv-p'), R = nval('fv-r'), Y = nval('fv-y');
    const m = parseInt(document.getElementById('fv-f')?.value || '12',10);
    if (!(P >= 0 && R >= 0 && Y > 0 && m > 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const FV = P * Math.pow(1 + (R/100)/m, m*Y);
    showBox(resId, `
      <div class="font-semibold mb-2">Ø§Ø±Ø²Ø´ Ø¢ÛŒÙ†Ø¯Ù‡ Ù¾ÙˆÙ„ (FV)</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ø§Ø±Ø²Ø´ Ø¢ÛŒÙ†Ø¯Ù‡: <span class="font-bold">${formatNumber(FV)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ø³ÙˆØ¯: <span class="font-bold">${formatNumber(FV-P)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">ØªØ±Ú©ÛŒØ¨: <span class="font-bold">${m===365?'Ø±ÙˆØ²Ø§Ù†Ù‡':(m===12?'Ù…Ø§Ù‡Ø§Ù†Ù‡':'Ø³Ø§Ù„Ø§Ù†Ù‡')}</span></div>
      </div>
    `);
    try{ document.getElementById('deposit-charts')?.classList.remove('hidden'); }catch{}

    const labels = Array.from({length: Math.round(Y*12)+1}, (_,i)=> toPersianNum(i)+' Ù…Ø§Ù‡');
    const rM = (R/100)/12;
    const values = labels.map((_,i)=> Math.round(P*Math.pow(1+rM, i)));
    renderDepositChart(labels, values, 'ØªÙˆÙ…Ø§Ù†');
    __lastDepositSeries = values.map((v,i)=>[i, v]);
    __lastDepositMeta = { headers:['Ù…Ø§Ù‡','Ø§Ø±Ø²Ø´ Ø¢ÛŒÙ†Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†)'], filename:'future_value.csv' };

    return;

  }

  if (t === 'pv') {
    const FV = nval('pv-fv'), R = nval('pv-r'), Y = nval('pv-y');
    const m = parseInt(document.getElementById('pv-f')?.value || '12',10);
    if (!(FV > 0 && R >= 0 && Y > 0 && m > 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const PV = FV / Math.pow(1 + (R/100)/m, m*Y);
    showBox(resId, `
      <div class="font-semibold mb-2">Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ Ù¾ÙˆÙ„ (PV)</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§Ù…Ø±ÙˆØ²: <span class="font-bold">${formatNumber(PV)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ù…Ø¨Ù„Øº Ù‡Ø¯Ù: <span class="font-bold">${formatNumber(FV)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">ØªØ±Ú©ÛŒØ¨: <span class="font-bold">${m===365?'Ø±ÙˆØ²Ø§Ù†Ù‡':(m===12?'Ù…Ø§Ù‡Ø§Ù†Ù‡':'Ø³Ø§Ù„Ø§Ù†Ù‡')}</span></div>
      </div>
    `);
    try{ document.getElementById('deposit-charts')?.classList.remove('hidden'); }catch{}

    const labels = Array.from({length: Math.round(Y*12)+1}, (_,i)=> toPersianNum(i)+' Ù…Ø§Ù‡');
    const rM = (R/100)/12;
    const values = labels.map((_,i)=> Math.round(FV/Math.pow(1+rM, i)));
    renderDepositChart(labels, values, 'ØªÙˆÙ…Ø§Ù†');
    __lastDepositSeries = values.map((v,i)=>[i, v]);
    __lastDepositMeta = { headers:['Ù…Ø§Ù‡','Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ (ØªÙˆÙ…Ø§Ù†)'], filename:'present_value.csv' };

    return;

  }

  if (t === 'inflation') {
    const amt = nval('inf-amt'), R = nval('inf-r'), Y = nval('inf-y');
    if (!(amt > 0 && R >= 0 && Y > 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const real = amt / Math.pow(1 + (R/100), Y);
    showBox(resId, `
      <div class="font-semibold mb-2">Ø§Ø«Ø± ØªÙˆØ±Ù…</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ø§Ø±Ø²Ø´ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² ${toPersianNum(Y)} Ø³Ø§Ù„: <span class="font-bold">${formatNumber(real)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ú©Ø§Ù‡Ø´ Ù‚Ø¯Ø±Øª Ø®Ø±ÛŒØ¯: <span class="font-bold">${toPersianNum(Math.round((1-real/amt)*100))}%</span></div>
        <div class="glass rounded-xl p-2">Ù…Ø¨Ù„Øº Ø§Ø³Ù…ÛŒ: <span class="font-bold">${formatNumber(amt)} ØªÙˆÙ…Ø§Ù†</span></div>
      </div>
    `);
    try{ document.getElementById('deposit-charts')?.classList.remove('hidden'); }catch{}

    const labels = Array.from({length: Math.round(Y)+1}, (_,i)=> toPersianNum(i)+' Ø³Ø§Ù„');
    const values = labels.map((_,i)=> Math.round(P/Math.pow(1+(R/100), i)));
    renderDepositChart(labels, values, 'ØªÙˆÙ…Ø§Ù† (Ø§Ø±Ø²Ø´ ÙˆØ§Ù‚Ø¹ÛŒ)');
    __lastDepositSeries = values.map((v,i)=>[i, v]);
    __lastDepositMeta = { headers:['Ø³Ø§Ù„','Ø§Ø±Ø²Ø´ ÙˆØ§Ù‚Ø¹ÛŒ (ØªÙˆÙ…Ø§Ù†)'], filename:'inflation_real_value.csv' };

    return;

  }

  // rate simple
  const P = nval('dep-p'), I = nval('dep-i'), D = nval('dep-d');
  if (!(P > 0 && I >= 0 && D > 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
  const rate = (I / P) * (365 / D) * 100;
  showBox(resId, `
    <div class="font-semibold mb-2">Ù†Ø±Ø® Ø³ÙˆØ¯ (Ø³Ø§Ø¯Ù‡)</div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
      <div class="glass rounded-xl p-2">Ù†Ø±Ø® Ø³Ø§Ù„Ø§Ù†Ù‡: <span class="font-bold">${formatNumber(rate, 2)}%</span></div>
      <div class="glass rounded-xl p-2">Ø³ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡: <span class="font-bold">${formatNumber(I/D)} ØªÙˆÙ…Ø§Ù†</span></div>
      <div class="glass rounded-xl p-2">Ø³ÙˆØ¯: <span class="font-bold">${formatNumber(I)} ØªÙˆÙ…Ø§Ù†</span></div>
    </div>
  `);
}

// --- Card UI ---
function renderCardForm(){
  const t = document.getElementById('card-type')?.value || 'installment';
  const wrap = document.getElementById('card-form');
  hideBox('card-result');

  if (t === 'posfee') {
    wrap.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div><label class="block text-sm text-gray-300 mb-1">Ø­Ø¬Ù… ØªØ±Ø§Ú©Ù†Ø´ (ØªÙˆÙ…Ø§Ù†)</label><input id="pos-v" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 100,000,000"><div class="money-words"></div></div>
        <div><label class="block text-sm text-gray-300 mb-1">Ø¯Ø±ØµØ¯ Ú©Ø§Ø±Ù…Ø²Ø¯ (%)</label><input id="pos-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 0.5"></div>
        <div class="text-[11px] text-gray-400 flex items-end">Ú©Ø§Ø±Ù…Ø²Ø¯ = Ø­Ø¬Ù… Ã— (Ø¯Ø±ØµØ¯/100)</div>
      </div>
    `;
    return;
  }

  // installment
  wrap.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
      <div><label class="block text-sm text-gray-300 mb-1">Ù‚ÛŒÙ…Øª Ú©Ø§Ù„Ø§ (ØªÙˆÙ…Ø§Ù†)</label><input id="inst-p" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 80,000,000"><div class="money-words"></div></div>
      <div><label class="block text-sm text-gray-300 mb-1">Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª</label><input id="inst-d" class="w-full input money-input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 20,000,000"><div class="money-words"></div></div>
      <div><label class="block text-sm text-gray-300 mb-1">ØªØ¹Ø¯Ø§Ø¯ Ù‚Ø³Ø· (Ù…Ø§Ù‡)</label><input id="inst-n" class="w-full input" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 12"></div>
      <div><label class="block text-sm text-gray-300 mb-1">Ù†Ø±Ø® Ø³ÙˆØ¯ Ø³Ø§Ù„Ø§Ù†Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="inst-r" class="w-full input" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 18"></div>
    </div>
    <div class="text-[11px] text-gray-400">Ø§Ú¯Ø± Ù†Ø±Ø® Ø±Ø§ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ØŒ Ø§Ù‚Ø³Ø§Ø· Ø¨Ø¯ÙˆÙ† Ø³ÙˆØ¯ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
  `;
}

function calculateCard(){
  const t = document.getElementById('card-type')?.value || 'installment';
  const resId = 'card-result';

  if (t === 'posfee') {
    const V = nval('pos-v'), R = nval('pos-r');
    if (!(V > 0 && R >= 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
    const fee = V * (R/100);
    showBox(resId, `
      <div class="font-semibold mb-2">Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ú©Ø§Ø±ØªØ®ÙˆØ§Ù†</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <div class="glass rounded-xl p-2">Ú©Ø§Ø±Ù…Ø²Ø¯: <span class="font-bold">${formatNumber(fee)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ø®Ø§Ù„Øµ Ø¯Ø±ÛŒØ§ÙØªÛŒ: <span class="font-bold">${formatNumber(V - fee)} ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="glass rounded-xl p-2">Ø­Ø¬Ù… ØªØ±Ø§Ú©Ù†Ø´: <span class="font-bold">${formatNumber(V)} ØªÙˆÙ…Ø§Ù†</span></div>
      </div>
    `);
    try{ document.getElementById('card-charts')?.classList.remove('hidden'); }catch{}

    const labels = ['Ø­Ø¬Ù… ØªØ±Ø§Ú©Ù†Ø´', 'Ú©Ø§Ø±Ù…Ø²Ø¯', 'Ø®Ø§Ù„Øµ Ø¯Ø±ÛŒØ§ÙØªÛŒ'];
    const values = [Math.round(V), Math.round(fee), Math.round(V-fee)];
    renderCardChart(labels, values, 'ØªÙˆÙ…Ø§Ù†', 'bar');
    __lastCardSeries = labels.map((l,i)=>[l, values[i]]);
    __lastCardMeta = { headers:['Ø¹Ù†ÙˆØ§Ù†','Ù…Ù‚Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)'], filename:'pos_fee.csv' };

    return;

    try{ document.getElementById('deposit-charts')?.classList.add('hidden'); }catch{};
    try{ document.getElementById('card-charts')?.classList.remove('hidden'); }catch{}
    return;

  }

  // installment
  const P = nval('inst-p'), down = nval('inst-d') || 0, N = nval('inst-n');
  const R = nval('inst-r');
  if (!(P > 0 && down >= 0 && N > 0)) return showBox(resId, "Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
  const financed = Math.max(0, P - down);
  if (financed <= 0) return showBox(resId, "Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Ù†Ø¨Ø§ÛŒØ¯ Ø§Ø² Ù‚ÛŒÙ…Øª Ú©Ø§Ù„Ø§ Ø¨ÛŒØ´ØªØ± Ø¨Ø§Ø´Ø¯.");
  let A;
  if (Number.isFinite(R) && R > 0) A = calcAnnuityPayment(financed, R, N);
  else A = financed / N;
  const total = A*N + down;
  showBox(resId, `
    <div class="font-semibold mb-2">Ø®Ø±ÛŒØ¯ Ù‚Ø³Ø·ÛŒ</div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
      <div class="glass rounded-xl p-2">Ù…Ø¨Ù„Øº Ù‡Ø± Ù‚Ø³Ø·: <span class="font-bold">${formatNumber(A)} ØªÙˆÙ…Ø§Ù†</span></div>
      <div class="glass rounded-xl p-2">Ù…Ø¨Ù„Øº ØªØ§Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ: <span class="font-bold">${formatNumber(financed)} ØªÙˆÙ…Ø§Ù†</span></div>
      <div class="glass rounded-xl p-2">Ø¬Ù…Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª (Ø¨Ø§ Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª): <span class="font-bold">${formatNumber(total)} ØªÙˆÙ…Ø§Ù†</span></div>
    </div>
  `);
    try{ document.getElementById('card-charts')?.classList.remove('hidden'); }catch{}

    const labels = ['Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª', 'ØªØ£Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ', 'Ø¬Ù…Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª'];
    const values = [Math.round(down), Math.round(financed), Math.round(total)];
    renderCardChart(labels, values, 'ØªÙˆÙ…Ø§Ù†', 'bar');
    __lastCardSeries = labels.map((l,i)=>[l, values[i]]);
    __lastCardMeta = { headers:['Ø¹Ù†ÙˆØ§Ù†','Ù…Ù‚Ø¯Ø§Ø± (ØªÙˆÙ…Ø§Ù†)'], filename:'installment.csv' };

    return;

}

// --- Amortization + Charts helpers ---
function buildAmortSchedule({P, annualRate, nMonths, payment, graceMonths=0, extras={}}){
  const r = (annualRate/100)/12;
  let bal = P;
  const out = [];
  const maxIter = Math.max(1, Math.min(1200, Math.round(nMonths))); // safety cap

  for (let m=1; m<=maxIter; m++){
    if (bal <= 0) break;

    const interest = (Math.abs(r) < 1e-12) ? 0 : bal*r;
    let pay = payment;

    if (graceMonths && m <= graceMonths){
      pay = interest; // interest-only
    }

    // prevent negative amortization
    pay = Math.max(0, pay);
    let principal = Math.max(0, pay - interest);

    // extra payment
    const ex = extras?.[m] ? Number(extras[m]) : 0;
    if (ex > 0) principal += ex;

    if (principal > bal) { principal = bal; pay = interest + principal - (ex>0?ex:0); } // keep payment coherent

    bal = bal - principal;

    out.push({
      month: m,
      payment: pay + (ex>0?ex:0),
      interest,
      principal,
      balance: Math.max(0, bal)
    });
  }
  return out;
}

function buildAmortTable(schedule){
  const rows = schedule.map(x => `
    <tr class="border-b border-white/10">
      <td class="py-2 px-2 whitespace-nowrap">${toPersianNum(x.month)}</td>
      <td class="py-2 px-2 whitespace-nowrap">${formatNumber(x.payment)}</td>
      <td class="py-2 px-2 whitespace-nowrap">${formatNumber(x.interest)}</td>
      <td class="py-2 px-2 whitespace-nowrap">${formatNumber(x.principal)}</td>
      <td class="py-2 px-2 whitespace-nowrap">${formatNumber(x.balance)}</td>
    </tr>
  `).join('');

  return `
    <div class="overflow-auto max-h-[320px] rounded-xl border border-white/10">
      <table id="amort-table" class="w-full text-xs md:text-sm">
        <thead class="sticky top-0 bg-black/60 backdrop-blur">
          <tr class="text-gray-200">
            <th class="py-2 px-2 text-right">Ù‚Ø³Ø·</th>
            <th class="py-2 px-2 text-right">Ù…Ø¨Ù„Øº Ù‚Ø³Ø·</th>
            <th class="py-2 px-2 text-right">Ø³ÙˆØ¯</th>
            <th class="py-2 px-2 text-right">Ø§ØµÙ„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª</th>
            <th class="py-2 px-2 text-right">Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ</th>
          </tr>
        </thead>
        <tbody class="text-gray-100">${rows}</tbody>
      </table>
    </div>
  `;
}


// ===================== Exports (CSV / PDF) =====================
let __lastLoanSchedule = null;
let __lastLoanMeta = null;
let __lastDepositSeries = null;
let __lastDepositMeta = null;
let __lastCardSeries = null;
let __lastCardMeta = null;

function downloadTextFile(filename, text, mime='text/plain;charset=utf-8'){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

function toCSV(rows){
  return rows.map(r => r.map(v => {
    const s = (v ?? '').toString().replaceAll('"','""');
    return `"${s}"`;
  }).join(',')).join('\n');
}

function openPrintWindow(title, htmlContent){
  const w = window.open('', '_blank');
  if(!w) { alert('Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ù…Ø³Ø¯ÙˆØ¯ Ø§Ø³Øª. Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ù‡ÛŒØ¯ ØªØ§ Ù¾Ù†Ø¬Ø±Ù‡ Ú†Ø§Ù¾ Ø¨Ø§Ø² Ø´ÙˆØ¯.'); return; }
  w.document.open();
  w.document.write(`
<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>${title}</title>
  <style>
    body{font-family: Vazirmatn, sans-serif; padding:16px; color:#111}
    h1{font-size:18px; margin:0 0 10px}
    .muted{color:#555; font-size:12px; margin-bottom:10px}
    table{border-collapse:collapse; width:100%}
    th,td{border:1px solid #ddd; padding:6px; font-size:12px; text-align:right}
    th{background:#f3f4f6}
    .grid{display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:10px 0}
    .card{border:1px solid #e5e7eb; border-radius:10px; padding:10px}
    img{max-width:100%}
    @media print{ body{padding:0} .no-print{display:none} }
  </style>
</head>
<body>
  <h1>${title}</h1>
  <div class="muted">ÙˆØ§Ø­Ø¯ Ù¾ÙˆÙ„ÛŒ: ØªÙˆÙ…Ø§Ù† â€” Ø¯Ø±ØµØ¯Ù‡Ø§ Ø¨Ø§ Ø¹Ù„Ø§Ù…Øª % Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
  ${htmlContent}
  <script>window.onload=()=>{ setTimeout(()=>{ window.print(); }, 250); };<\/script>
</body>
</html>`);
  w.document.close();
}

function exportLoanCSV(){
  if(!__lastLoanSchedule){ alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙˆØ§Ù… Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.'); return; }
  const rows = [
    ['Ù‚Ø³Ø·','Ù…Ø¨Ù„Øº Ù‚Ø³Ø· (ØªÙˆÙ…Ø§Ù†)','Ø³ÙˆØ¯ (ØªÙˆÙ…Ø§Ù†)','Ø§ØµÙ„ Ø¨Ø§Ø²Ù¾Ø±Ø¯Ø§Ø®Øª (ØªÙˆÙ…Ø§Ù†)','Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ (ØªÙˆÙ…Ø§Ù†)'],
    ...__lastLoanSchedule.map(x=>[x.month, x.payment, x.interest, x.principal, x.balance])
  ];
  downloadTextFile('loan_amortization.csv', toCSV(rows), 'text/csv;charset=utf-8');
}

function exportLoanPDF(){
  const el = document.getElementById('loan-result');
  if(!el || el.classList.contains('hidden')){ alert('Ø§Ø¨ØªØ¯Ø§ Ù†ØªÛŒØ¬Ù‡ ÙˆØ§Ù… Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.'); return; }

  // include chart images if available
  const bal = document.getElementById('loan-chart-balance');
  const spl = document.getElementById('loan-chart-split');
  const balImg = bal ? bal.toDataURL('image/png', 1.0) : '';
  const splImg = spl ? spl.toDataURL('image/png', 1.0) : '';

  const charts = (balImg || splImg) ? `
    <div class="grid" style="grid-template-columns:1fr 1fr">
      ${balImg ? `<div class="card"><div class="muted">Ù†Ù…ÙˆØ¯Ø§Ø± Ú©Ø§Ù‡Ø´ Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ</div><img src="${balImg}"></div>`:''}
      ${splImg ? `<div class="card"><div class="muted">Ø³Ù‡Ù… Ø³ÙˆØ¯ vs Ø§ØµÙ„</div><img src="${splImg}"></div>`:''}
    </div>` : '';

  // clone content but drop export buttons
  const cloned = el.cloneNode(true);
  cloned.querySelectorAll('.no-print').forEach(x=>x.remove());
  openPrintWindow('Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ù…', `<div class="card">${cloned.innerHTML}</div>${charts}`);
}

function exportDepositCSV(){
  if(!__lastDepositSeries){ alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ù¾Ø±Ø¯Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.'); return; }
  const rows = [__lastDepositMeta?.headers || ['Ø¯ÙˆØ±Ù‡','Ù…Ù‚Ø¯Ø§Ø±'], ...__lastDepositSeries.map(r=>r)];
  downloadTextFile(__lastDepositMeta?.filename || 'deposit.csv', toCSV(rows), 'text/csv;charset=utf-8');
}
function exportDepositPDF(){
  const el = document.getElementById('deposit-result');
  if(!el || el.classList.contains('hidden')){ alert('Ø§Ø¨ØªØ¯Ø§ Ù†ØªÛŒØ¬Ù‡ Ø³Ù¾Ø±Ø¯Ù‡ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.'); return; }
  const c = document.getElementById('deposit-chart');
  const img = c ? c.toDataURL('image/png', 1.0) : '';
  const cloned = el.cloneNode(true);
  cloned.querySelectorAll('.no-print').forEach(x=>x.remove());
  openPrintWindow('Ú¯Ø²Ø§Ø±Ø´ Ø³Ù¾Ø±Ø¯Ù‡', `<div class="card">${cloned.innerHTML}</div>${img?`<div class="card" style="margin-top:10px"><img src="${img}"></div>`:''}`);
}
function exportCardCSV(){
  if(!__lastCardSeries){ alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ø§Ø±Øª/Ú†Ú© Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯.'); return; }
  const rows = [__lastCardMeta?.headers || ['Ø±Ø¯ÛŒÙ','Ù…Ù‚Ø¯Ø§Ø±'], ...__lastCardSeries.map(r=>r)];
  downloadTextFile(__lastCardMeta?.filename || 'card.csv', toCSV(rows), 'text/csv;charset=utf-8');
}
function exportCardPDF(){
  const el = document.getElementById('card-result');
  if(!el || el.classList.contains('hidden')){ alert('Ø§Ø¨ØªØ¯Ø§ Ù†ØªÛŒØ¬Ù‡ Ú©Ø§Ø±Øª/Ú†Ú© Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.'); return; }
  const c = document.getElementById('card-chart');
  const img = c ? c.toDataURL('image/png', 1.0) : '';
  const cloned = el.cloneNode(true);
  cloned.querySelectorAll('.no-print').forEach(x=>x.remove());
  openPrintWindow('Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±Øª Ùˆ Ú†Ú©', `<div class="card">${cloned.innerHTML}</div>${img?`<div class="card" style="margin-top:10px"><img src="${img}"></div>`:''}`);
}

let __loanCharts = { balance:null, split:null };
function renderLoanCharts(schedule, totalInterest, totalPrincipal){
  if (typeof Chart === 'undefined') return;
  const balCtx = document.getElementById('loan-chart-balance');
  const splitCtx = document.getElementById('loan-chart-split');
  if (!balCtx || !splitCtx) return;

  // destroy previous
  try{ __loanCharts.balance?.destroy(); }catch{}
  try{ __loanCharts.split?.destroy(); }catch{}

  const labels = schedule.map(x=>x.month);
  const balances = schedule.map(x=>Math.round(x.balance));

  __loanCharts.balance = new Chart(balCtx, {
    type: 'line',
    data: { labels, datasets:[{ label:'Ù…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ', data: balances, tension:0.3 }] },
    options: {
      responsive:true,
      plugins:{ legend:{ display:false } },
      scales:{
        x:{ ticks:{ color:'rgba(255,255,255,0.55)', callback:(v, i)=> (i%6===0? toPersianNum(labels[i]) : '') }, grid:{ display:false } },
        y:{ ticks:{ color:'rgba(255,255,255,0.75)', callback:(v)=> formatNumber(v)+' ØªÙˆÙ…Ø§Ù†' }, grid:{ color:'rgba(255,255,255,0.08)' } }
      }
    }
  });

  __loanCharts.split = new Chart(splitCtx, {
    type: 'doughnut',
    data: {
      labels:['Ø³ÙˆØ¯','Ø§ØµÙ„'],
      datasets:[{ data:[Math.round(totalInterest), Math.round(totalPrincipal)] }]
    },
    options:{ responsive:true, plugins:{ legend:{ position:'bottom', labels:{ color:'rgba(255,255,255,0.85)' } }, tooltip:{ callbacks:{ label:(ctx)=>{ const total = ctx.dataset.data.reduce((a,b)=>a+b,0); const val = ctx.parsed; const pct = total? Math.round((val/total)*100):0; return `${ctx.label}: ${formatNumber(val)} ØªÙˆÙ…Ø§Ù† (${toPersianNum(pct)}%)`; } } } } }
  });

// ===================== Deposit / Card Charts =====================
let __depositChart = null;
let __cardChart = null;

function renderDepositChart(labels, values, unitLabel){
  const wrap = document.getElementById('deposit-charts');
  const ctx = document.getElementById('deposit-chart');
  if(!wrap || !ctx || typeof Chart==='undefined') return;
  wrap.classList.remove('hidden');
  document.getElementById('deposit-chart-title').textContent = `Ù†Ù…ÙˆØ¯Ø§Ø± (${unitLabel})`;
  try{ __depositChart?.destroy(); }catch{}
  __depositChart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label: unitLabel, data: values, tension:0.3 }]},
    options:{
      responsive:true,
      plugins:{
        legend:{ display:false },
        tooltip:{ callbacks:{ label:(c)=> `${formatNumber(c.parsed.y)} ${unitLabel}` } }
      },
      scales:{
        x:{ ticks:{ color:'rgba(255,255,255,0.55)', callback:(v,i)=> (i%Math.max(1,Math.floor(labels.length/6))===0? labels[i]:'') }, grid:{ display:false } },
        y:{ ticks:{ color:'rgba(255,255,255,0.75)', callback:(v)=> `${formatNumber(v)} ${unitLabel}` }, grid:{ color:'rgba(255,255,255,0.08)' } }
      }
    }
  });
}

function renderCardChart(labels, values, unitLabel, type='bar'){
  const wrap = document.getElementById('card-charts');
  const ctx = document.getElementById('card-chart');
  if(!wrap || !ctx || typeof Chart==='undefined') return;
  wrap.classList.remove('hidden');
  document.getElementById('card-chart-title').textContent = `Ù†Ù…ÙˆØ¯Ø§Ø± (${unitLabel})`;
  try{ __cardChart?.destroy(); }catch{}
  __cardChart = new Chart(ctx, {
    type,
    data:{ labels, datasets:[{ label: unitLabel, data: values }]},
    options:{
      responsive:true,
      plugins:{
        legend:{ display:false },
        tooltip:{ callbacks:{ label:(c)=> `${formatNumber(c.parsed.y ?? c.parsed)} ${unitLabel}` } }
      },
      scales:{
        x:{ ticks:{ color:'rgba(255,255,255,0.55)' }, grid:{ display:false } },
        y:{ ticks:{ color:'rgba(255,255,255,0.75)', callback:(v)=> `${formatNumber(v)} ${unitLabel}` }, grid:{ color:'rgba(255,255,255,0.08)' } }
      }
    }
  });
}


}

// monthly annuity FV for monthly contributions (12 times/year)
function compoundFutureValueAnnuity(paymentMonthly, annualRate, years){
  const r = (annualRate/100)/12;
  const n = Math.round(years*12);
  if (n<=0) return 0;
  if (Math.abs(r) < 1e-12) return paymentMonthly*n;
  return paymentMonthly * ((Math.pow(1+r, n)-1)/r);
}

function calcAnnuityPayment(P, annualRate, nMonths) {
    const r = (annualRate / 100) / 12;
    if (nMonths <= 0) return NaN;
    if (Math.abs(r) < 1e-12) return P / nMonths;
    const pow = Math.pow(1 + r, nMonths);
    return P * r * pow / (pow - 1);
  }

  function remainingBalance(P, annualRate, nMonths, mPaid) {
    const r = (annualRate / 100) / 12;
    const A = calcAnnuityPayment(P, annualRate, nMonths);
    if (Math.abs(r) < 1e-12) return P - A * mPaid;
    const pow = Math.pow(1 + r, mPaid);
    return P * pow - A * (pow - 1) / r;
  }

  function solveMonthlyRate(P, A, nMonths) {
    // bisection on r in [0, 1] (0%..100% monthly) â€“ enough for consumer loans
    let lo = 0, hi = 1;
    const f = (r) => {
      if (Math.abs(r) < 1e-12) return P / nMonths - A;
      const pow = Math.pow(1 + r, nMonths);
      const pay = P * r * pow / (pow - 1);
      return pay - A;
    };
    // ensure bracket; if not, expand hi
    let flo = f(lo), fhi = f(hi);
    let tries = 0;
    while (flo * fhi > 0 && tries < 10) {
      hi *= 2;
      fhi = f(hi);
      tries++;
    }
    if (flo * fhi > 0) return NaN;

    for (let i = 0; i < 80; i++) {
      const mid = (lo + hi) / 2;
      const fm = f(mid);
      if (Math.abs(fm) < 1e-9) return mid;
      if (flo * fm <= 0) { hi = mid; fhi = fm; }
      else { lo = mid; flo = fm; }
    }
    return (lo + hi) / 2;
  }

  function calcStepLoan(P, annualRate, nMonths, yearlyGrowthPct) {
    const r = (annualRate / 100) / 12;
    const g = (yearlyGrowthPct / 100);
    // payment increases each 12 months by factor (1+g)^k
    let denom = 0;
    for (let t = 1; t <= nMonths; t++) {
      const k = Math.floor((t - 1) / 12);
      const inc = Math.pow(1 + g, k);
      const disc = Math.pow(1 + r, t);
      denom += inc / disc;
    }
    const A0 = P / denom; // first-year monthly payment
    // compute totals
    let total = 0;
    let balance = P;
    for (let t = 1; t <= nMonths; t++) {
      const k = Math.floor((t - 1) / 12);
      const pay = A0 * Math.pow(1 + g, k);
      const interest = balance * r;
      const principal = pay - interest;
      balance = balance - principal;
      total += pay;
    }
    return { A0, total, interest: total - P, last: A0 * Math.pow(1 + g, Math.floor((nMonths - 1) / 12)) };
  }




  // Init UI helpers
  initUnitDropdownHover();
  enhanceAllHorizontalScroll();

  // Start the app
  loadCrypto();
  updateDateTime();
  setInterval(updateDateTime, 1000);
  setInterval(loadCrypto, 60000);
</script>

<style>
.money-input{
    background: rgba(255,255,255,0.08) !important;
    color: #fff !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    padding: 12px;
    border-radius: 10px;
    font-size: 16px;
}
.money-input:focus{
    outline: none;
    border-color: #a855f7 !important;
    box-shadow: 0 0 10px rgba(168,85,247,0.5);
}
.money-words{
    margin-top: 6px;
    font-size: 13px;
    color: #d1c4ff;
}
</style>

<script>
// ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
function toEnglishDigits(str){
    str = String(str ?? '');
    return str.replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d))
              .replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
}

// Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø³Ù‡â€ŒØªØ§ÛŒÛŒ
function formatMoneyInput(value){
    value = toEnglishDigits(value).replace(/[^0-9]/g,'');
    if(!value) return '';
    return value.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// ØªØ¨Ø¯ÛŒÙ„ Ø¹Ø¯Ø¯ Ø¨Ù‡ Ø­Ø±ÙˆÙ ÙØ§Ø±Ø³ÛŒ (Ø³Ø§Ø¯Ù‡ ØªØ§ ØªØ±ÛŒÙ„ÛŒÙˆÙ†)
function numberToWords(num){
    num = parseInt(num);
    if(isNaN(num)) return "";
    if(num === 0) return "ØµÙØ±";
    
    const units = ["","ÛŒÚ©","Ø¯Ùˆ","Ø³Ù‡","Ú†Ù‡Ø§Ø±","Ù¾Ù†Ø¬","Ø´Ø´","Ù‡ÙØª","Ù‡Ø´Øª","Ù†Ù‡"];
    const teens = ["Ø¯Ù‡","ÛŒØ§Ø²Ø¯Ù‡","Ø¯ÙˆØ§Ø²Ø¯Ù‡","Ø³ÛŒØ²Ø¯Ù‡","Ú†Ù‡Ø§Ø±Ø¯Ù‡","Ù¾Ø§Ù†Ø²Ø¯Ù‡","Ø´Ø§Ù†Ø²Ø¯Ù‡","Ù‡ÙØ¯Ù‡","Ù‡Ø¬Ø¯Ù‡","Ù†ÙˆØ²Ø¯Ù‡"];
    const tens = ["","Ø¯Ù‡","Ø¨ÛŒØ³Øª","Ø³ÛŒ","Ú†Ù‡Ù„","Ù¾Ù†Ø¬Ø§Ù‡","Ø´ØµØª","Ù‡ÙØªØ§Ø¯","Ù‡Ø´ØªØ§Ø¯","Ù†ÙˆØ¯"];
    const hundreds = ["","ØµØ¯","Ø¯ÙˆÛŒØ³Øª","Ø³ÛŒØµØ¯","Ú†Ù‡Ø§Ø±ØµØ¯","Ù¾Ø§Ù†ØµØ¯","Ø´Ø´ØµØ¯","Ù‡ÙØªØµØ¯","Ù‡Ø´ØªØµØ¯","Ù†Ù‡ØµØ¯"];
    const scales = ["","Ù‡Ø²Ø§Ø±","Ù…ÛŒÙ„ÛŒÙˆÙ†","Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯","ØªØ±ÛŒÙ„ÛŒÙˆÙ†"];
    
    function chunkToWords(n){
        let str = "";
        if(n >= 100){
            str += hundreds[Math.floor(n/100)];
            n %= 100;
            if(n) str += " Ùˆ ";
        }
        if(n >= 20){
            str += tens[Math.floor(n/10)];
            n %= 10;
            if(n) str += " Ùˆ " + units[n];
        } else if(n >= 10){
            str += teens[n-10];
        } else if(n > 0){
            str += units[n];
        }
        return str;
    }
    
    let words = "";
    let scaleIndex = 0;
    while(num > 0){
        let chunk = num % 1000;
        if(chunk){
            let chunkWords = chunkToWords(chunk);
            if(scaleIndex) chunkWords += " " + scales[scaleIndex];
            words = chunkWords + (words ? " Ùˆ " + words : "");
        }
        num = Math.floor(num/1000);
        scaleIndex++;
    }
    return words;
}

// Ø§Ø¹Ù…Ø§Ù„ Ø±ÙˆÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø¨Ù„Øº
document.addEventListener("input", function(e){
    if(e.target.classList.contains("money-input")){
        let raw = toEnglishDigits(e.target.value).replace(/,/g,'');
        e.target.value = formatMoneyInput(raw);
        let wordsBox = e.target.parentElement.querySelector(".money-words");
        if(wordsBox){
            wordsBox.innerText = numberToWords(raw) + (raw ? " ØªÙˆÙ…Ø§Ù†" : "");
        }
    }
});
</script>

</body>
</html>
