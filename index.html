/* ========================= DateTime via WorldTimeAPI (اصلاح شده) ========================= */
/* این نسخه:
   - ساعت ایران و ساعت جهانی (UTC) را دقیق از خودِ API می‌گیرد (بدون وابستگی به Intl/timeZone مرورگر)
   - تاریخ میلادی را از API می‌گیرد
   - تاریخ شمسی را با تبدیل داخلی (بدون Intl) محاسبه می‌کند
   - بخش قمری را غیرفعال می‌کند (نمایش نمی‌دهد) چون گفتید لازم نیست
*/

const WTA_BASE = "https://worldtimeapi.org/api/timezone";
const TZ_IR = "Asia/Tehran";
const TZ_UTC = "Etc/UTC";

let timeState = {
  lastOk:false,
  timeIR:"—", timeUTC:"—",
  jalali:"—", greg:"—", hijri:"—",
  updatedAt:"—"
};

const setTimeStatus = (kind, hint="") => {
  const el = document.getElementById("timeStatusText");
  const h = document.getElementById("timeStatusHint");
  if(kind==="ok"){
    el.className="tiny text-emerald-200";
    el.textContent="اطلاعات با موفقیت دریافت شد ✅";
  }else if(kind==="warn"){
    el.className="tiny text-amber-200";
    el.textContent="هشدار: برخی داده‌ها قابل نمایش نیستند.";
  }else{
    el.className="tiny text-rose-200";
    el.textContent="خطا: دریافت اطلاعات ناموفق بود.";
  }
  h.textContent = hint || "";
};

const fmtMaybeFaDigits = (s) => {
  const cfg = elementSdk.getConfig();
  if(s==null || s==="—") return "—";
  return cfg.enable_persian_digits ? toPersianDigits(String(s)) : String(s);
};

const renderTime = () => {
  document.getElementById("todayJalali").textContent = fmtMaybeFaDigits(timeState.jalali);
  document.getElementById("todayGreg").textContent   = fmtMaybeFaDigits(timeState.greg);

  // قمری را غیرفعال کن (کلا پنهان)
  const hijriEl = document.getElementById("todayHijri");
  if (hijriEl) {
    hijriEl.textContent = "—";
    const card = hijriEl.closest(".soft");
    if (card) card.style.display = "none";
  }

  document.getElementById("timeIR").textContent      = fmtMaybeFaDigits(timeState.timeIR);
  document.getElementById("timeUTC").textContent     = fmtMaybeFaDigits(timeState.timeUTC);
  document.getElementById("timeUpdatedAt").textContent = fmtMaybeFaDigits(timeState.updatedAt);
};

const fetchWTA = async (timeZone) => {
  const url = `${WTA_BASE}/${encodeURIComponent(timeZone)}`;
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("bad_status");
  const data = await res.json();
  // datetime مثل: 2026-02-08T12:34:56.123456+03:30
  if(!data || !data.datetime) throw new Error("no_datetime");
  return {
    datetime: data.datetime,
    unixtime: data.unixtime
  };
};

// تبدیل تاریخ میلادی به شمسی (الگوریتم داخلی)
const gregorianToJalali = (gy, gm, gd) => {
  // gm: 1..12
  const g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
  let jy;
  if (gy > 1600) { jy = 979; gy -= 1600; } else { jy = 0; gy -= 621; }

  const gy2 = (gm > 2) ? (gy + 1) : gy;
  let days = 365*gy
    + Math.floor((gy2 + 3)/4)
    - Math.floor((gy2 + 99)/100)
    + Math.floor((gy2 + 399)/400)
    - 80
    + gd
    + g_d_m[gm-1];

  jy += 33 * Math.floor(days / 12053);
  days %= 12053;

  jy += 4 * Math.floor(days / 1461);
  days %= 1461;

  if (days > 365) {
    jy += Math.floor((days - 1) / 365);
    days = (days - 1) % 365;
  }

  const jm = (days < 186) ? (1 + Math.floor(days / 31)) : (7 + Math.floor((days - 186) / 30));
  const jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));

  return { jy, jm, jd };
};

const pad2 = (n) => String(n).padStart(2,"0");

// گرفتن بخش تاریخ/ساعت مستقیم از datetime API (بدون Intl)
const parseIsoLocalParts = (iso) => {
  // iso: YYYY-MM-DDTHH:mm:ss...
  const y = Number(iso.slice(0,4));
  const m = Number(iso.slice(5,7));
  const d = Number(iso.slice(8,10));
  const t = iso.slice(11,19); // HH:mm:ss
  return { y,m,d,t, ymd: iso.slice(0,10) };
};

const fetchTimeApi = async () => {
  try{
    setTimeStatus("warn","در حال دریافت از WorldTimeAPI…");
    const [ir, utc] = await Promise.all([ fetchWTA(TZ_IR), fetchWTA(TZ_UTC) ]);

    const irParts = parseIsoLocalParts(ir.datetime);
    const utcParts = parseIsoLocalParts(utc.datetime);

    // ساعت‌ها دقیقاً از خود API:
    timeState.timeIR = irParts.t;
    timeState.timeUTC = utcParts.t;

    // تاریخ میلادی (ایران) از API:
    timeState.greg = irParts.ymd;

    // تاریخ شمسی از تبدیل داخلی:
    const j = gregorianToJalali(irParts.y, irParts.m, irParts.d);
    timeState.jalali = `${j.jy}/${pad2(j.jm)}/${pad2(j.jd)}`;

    // قمری را نداریم:
    timeState.hijri = "—";

    timeState.updatedAt = `${timeState.timeIR} (ایران)`;
    timeState.lastOk = true;

    setTimeStatus("ok","هر ۳۰ ثانیه یک‌بار خودکار به‌روزرسانی می‌شود.");
    renderTime();
  }catch{
    timeState.lastOk = false;
    setTimeStatus("err","دریافت از WorldTimeAPI ناموفق بود. اینترنت/اختلال سرویس را بررسی کنید.");
    renderTime();
  }
};
